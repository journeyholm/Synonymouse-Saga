<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ELA Quest: The Synonymouse Saga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
    /* --- RUN-ON VIRUS VISUALS --- */
@keyframes glitch-red {
    0% { transform: translate(0); filter: drop-shadow(0 0 0 red); }
    20% { transform: translate(-2px, 2px); filter: drop-shadow(2px 2px 0 red); }
    40% { transform: translate(-2px, -2px); filter: drop-shadow(-2px -2px 0 red); }
    60% { transform: translate(2px, 2px); filter: drop-shadow(2px -2px 0 red); }
    80% { transform: translate(2px, -2px); filter: drop-shadow(-2px 2px 0 red); }
    100% { transform: translate(0); filter: drop-shadow(0 0 0 red); }
}

.infected-anim {
    animation: glitch-red 0.2s infinite;
    color: #ff4444 !important; /* Tint sprite red */
}

/* Red Pen Slash Animation */
@keyframes slash-anim {
    0% { transform: scale(0) rotate(-45deg); opacity: 0; }
    50% { transform: scale(1.5) rotate(-45deg); opacity: 1; }
    100% { transform: scale(1) rotate(-45deg); opacity: 0; }
}

.red-slash {
    position: absolute;
    width: 100px;
    height: 10px;
    background-color: red;
    top: 40%;
    left: 60%;
    z-index: 100;
    box-shadow: 0 0 10px red;
    animation: slash-anim 0.5s ease-out forwards;
}

.giant-period {
    position: absolute;
    font-size: 100px;
    color: red;
    top: 30%;
    left: 70%;
    z-index: 101;
    animation: drop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes drop-in {
    0% { transform: translateY(-200px); opacity: 0; }
    100% { transform: translateY(0); opacity: 1; }
}
    /* --- NEW BATTLE ANIMATIONS --- */
@keyframes throw-arc {
    0% { left: 20%; bottom: 20%; transform: scale(1) rotate(0deg); }
    50% { bottom: 60%; transform: scale(1.2) rotate(180deg); }
    100% { left: 75%; bottom: 45%; transform: scale(1) rotate(360deg); }
}

@keyframes attack-lunge-right {
    0% { transform: translateX(0); }
    50% { transform: translateX(30px); }
    100% { transform: translateX(0); }
}

@keyframes attack-lunge-left {
    0% { transform: scaleX(-1) translateX(0); } /* Keep opponent flipped */
    50% { transform: scaleX(-1) translateX(30px); }
    100% { transform: scaleX(-1) translateX(0); }
}

@keyframes catch-shake {
    0%, 100% { transform: scaleX(-1) rotate(0deg); }
    25% { transform: scaleX(-1) rotate(10deg); }
    75% { transform: scaleX(-1) rotate(-10deg); }
}

.ball-anim {
    position: absolute;
    font-size: 3rem;
    z-index: 100;
    animation: throw-arc 0.8s ease-in-out forwards;
}

.lunge-right { animation: attack-lunge-right 0.3s ease-in-out; }
.lunge-left { animation: attack-lunge-left 0.3s ease-in-out; }
.shake-catch { animation: catch-shake 0.5s ease-in-out infinite; }
    /* FALLBACK STYLES (In case School Wifi blocks Tailwind) */
body { background-color: #1a202c; color: white; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; }
#game-wrapper { width: 100%; max-width: 600px; position: relative; }
.hidden { display: none !important; }
.absolute { position: absolute; }
.inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-center { justify-content: center; }
.bg-white { background-color: white; }
.text-black { color: black; }
.p-4 { padding: 1rem; }
.rounded { border-radius: 0.25rem; }
.border-4 { border-width: 4px; }
.w-full { width: 100%; }
.text-center { text-align: center; }
button { cursor: pointer; }
        /* ANIMATIONS */
        .damage-anim { animation: shake-red 0.5s cubic-bezier(.36,.07,.19,.97) both; color: #ff0000 !important; }
        .blink-anim { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        @keyframes shake-red {
            10%, 90% { transform: translate3d(-4px, 0, 0); }
            20%, 80% { transform: translate3d(8px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-16px, 0, 0); }
            40%, 60% { transform: translate3d(16px, 0, 0); }
        }

        /* LAYOUT RESET */
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #1a202c;
            color: #fff;
            image-rendering: pixelated;
            margin: 0; padding: 0;
            overflow: hidden;
            height: 100dvh; /* Mobile viewport fix */
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* GAME WRAPPER */
        #game-wrapper {
            position: relative;
            width: 100%;
            max-width: 600px; /* Keep game restrained on big screens */
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #game-container {
            flex-grow: 1; /* Fill all available space */
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Keeps aspect ratio without stretching */
            display: block;
        }

        /* OVERLAY CONTROLS (THE FIX) */
        #touch-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none; /* Let clicks pass through empty space */
            z-index: 20;
        }
        
        /* Enable clicking ON the buttons */
        #touch-controls button { pointer-events: auto; }

        .d-pad-grid {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 5px;
        }

        .touch-btn {
            width: 60px; height: 60px;
            background-color: rgba(255, 255, 255, 0.15); /* Transparent */
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 12px;
            color: rgba(255,255,255,0.8);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            user-select: none;
            backdrop-filter: blur(2px);
        }
        .touch-btn:active { background-color: rgba(255, 255, 255, 0.4); }
        
        .action-btn-group { display: flex; gap: 15px; margin-bottom: 60px; /* Lift buttons up slightly */ }
        .touch-btn-a { width: 80px; height: 80px; background-color: rgba(239, 68, 68, 0.6); border-radius: 50%; font-size: 32px; }
        .touch-btn-b { width: 65px; height: 65px; background-color: rgba(59, 130, 246, 0.6); border-radius: 50%; font-size: 24px; }
/* --- NEW VISUAL EFFECTS --- */
/* 1. Map Transition Overlay */
#transition-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: black;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease-in-out;
    z-index: 999;
}
.fade-out { opacity: 1 !important; }

/* 2. Floating Damage Numbers */
@keyframes float-up {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    100% { transform: translateY(-40px) scale(1.5); opacity: 0; }
}
.damage-number {
    position: absolute;
    color: #ffeb3b; /* Yellow text */
    font-family: 'Press Start 2P', cursive;
    font-size: 2rem;
    font-weight: bold;
    text-shadow: 2px 2px #000; /* Black outline */
    pointer-events: none;
    z-index: 200;
    animation: float-up 0.8s ease-out forwards;
}
.heal-number { color: #4ade80; } /* Green for healing */
/* MESSAGE BOX (Bottom Overlay - Covers Controls) */
        .message-box {
            position: absolute;
            bottom: 10px; /* Anchored to the bottom */
            left: 10px;
            right: 10px;
            min-height: 100px; /* Taller to comfortably hold text */
            background: rgba(255,255,255,0.95);
            border: 4px solid #4a5568;
            border-radius: 8px;
            color: black;
            padding: 10px;
            font-size: 14px;
            z-index: 30; /* Sits ON TOP of the controls */
            display: flex;
            flex-direction: column;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.5);
        }

        /* DESKTOP TWEAKS */
        @media (min-width: 1024px) {
            #touch-controls { display: none; } /* Hide mobile controls on PC */
            .message-box { position: relative; bottom: auto; left: auto; right: auto; width: 100%; margin-top: 10px; }
        }
        
        /* SCENE & UI STYLES */
        .ui-scene { background-color: rgba(0,0,0,0.95); z-index: 50; }
        .pc-item:hover { background-color: #e2e8f0; }
        #credits-scene { color: #FFD700; font-size: 2rem; text-align: center; position: absolute; bottom: 0; left: 0; right: 0; top: 100%; animation: scroll-credits 30s linear forwards; }
        @keyframes scroll-credits { from { top: 100%; } to { top: -100%; } }
   /* --- CERTIFICATE OF MASTERY STYLES --- */
.cert-overlay {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(0, 0, 0, 0.9);
    display: flex; align-items: center; justify-content: center;
    z-index: 200; animation: fade-in 1s ease-out;
}
.cert-container {
    background: #fff; color: #1f2937;
    padding: 30px; border: 8px double #fbbf24; /* Gold Border */
    text-align: center; width: 90%; max-width: 500px;
    box-shadow: 0 0 40px rgba(251, 191, 36, 0.4);
    border-radius: 12px;
}
.cert-title {
    font-family: 'Press Start 2P', cursive;
    font-size: 20px; color: #b45309; text-decoration: underline;
    margin-bottom: 20px; text-transform: uppercase;
}
.cert-grade-box {
    display: inline-block;
    border: 4px solid #dc2626; color: #dc2626;
    font-size: 64px; font-weight: bold;
    padding: 10px 20px; border-radius: 12px;
    transform: rotate(-10deg); margin: 20px 0;
    text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
}
.cert-stats { font-size: 14px; margin: 10px 0; color: #374151; }
.cert-team { 
    display: flex; justify-content: center; gap: 15px; margin-top: 20px; 
    font-size: 32px; filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.2)); 
}
@keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
/* --- SMOOTH HEALTH BARS --- */
.health-fill {
    transition: width 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
}

/* --- SCREEN SHAKE ANIMATION --- */
@keyframes shake {
    0% { transform: translate(1px, 1px) rotate(0deg); }
    10% { transform: translate(-1px, -2px) rotate(-1deg); }
    20% { transform: translate(-3px, 0px) rotate(1deg); }
    30% { transform: translate(3px, 2px) rotate(0deg); }
    40% { transform: translate(1px, -1px) rotate(1deg); }
    50% { transform: translate(-1px, 2px) rotate(-1deg); }
    60% { transform: translate(-3px, 1px) rotate(0deg); }
    70% { transform: translate(3px, 1px) rotate(-1deg); }
    80% { transform: translate(-1px, -1px) rotate(1deg); }
    90% { transform: translate(1px, 2px) rotate(0deg); }
    100% { transform: translate(1px, -2px) rotate(-1deg); }
}

.shake {
    animation: shake 0.5s; 
    animation-iteration-count: 1; 
}
/* ADD THIS TO YOUR <style> BLOCK */

/* Layout & Grid Helpers */
.grid { display: grid; }
.grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
.grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
.grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
.gap-2 { gap: 0.5rem; }
.gap-4 { gap: 1rem; }

/* Spacing & Sizing */
.p-2 { padding: 0.5rem; }
.p-4 { padding: 1rem; }
.mb-4 { margin-bottom: 1rem; }
.mt-2 { margin-top: 0.5rem; }
.mt-4 { margin-top: 1rem; }
.w-full { width: 100%; }
.max-w-lg { max-width: 32rem; }
.max-w-md { max-width: 28rem; }
.max-w-sm { max-width: 24rem; }

/* Colors (Approximations of Tailwind Colors) */
.bg-gray-900 { background-color: #111827; }
.bg-gray-800 { background-color: #1f2937; }
.bg-gray-700 { background-color: #374151; }
.bg-gray-200 { background-color: #e5e7eb; }
.bg-blue-500, .bg-blue-600 { background-color: #2563eb; }
.bg-red-500 { background-color: #ef4444; }
.bg-green-500 { background-color: #22c55e; }
.bg-yellow-400, .bg-yellow-500 { background-color: #eab308; }
.text-white { color: white; }
.text-black { color: black; }
.text-yellow-400 { color: #facc15; }
.text-blue-300 { color: #93c5fd; }
.text-red-500 { color: #ef4444; }

/* Typography */
.text-center { text-align: center; }
.text-right { text-align: right; }
.text-xl { font-size: 1.25rem; }
.text-2xl { font-size: 1.5rem; }
.text-3xl { font-size: 1.875rem; }
.text-4xl { font-size: 2.25rem; }
.font-bold { font-weight: 700; }

/* Interactive */
.cursor-pointer { cursor: pointer; }
.hover\:bg-yellow-300:hover { background-color: #fde047; }
.hover\:bg-blue-700:hover { background-color: #1d4ed8; }
    </style>
</head>
<body class="bg-gray-900">
    <div id="transition-overlay"></div>
  <div id="game-wrapper">
        <div id="game-container">
            <canvas id="gameCanvas"></canvas>
            <button id="menu-btn" class="absolute top-4 right-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg border-2 border-white opacity-90 z-40">MENU</button>
        </div>

        <div id="touch-controls">
            <div class="d-pad-grid">
                <div></div><button id="touch-up" class="touch-btn">▲</button><div></div>
                <button id="touch-left" class="touch-btn">◀</button><div></div><button id="touch-right" class="touch-btn">▶</button>
                <div></div><button id="touch-down" class="touch-btn">▼</button><div></div>
            </div>
            
            <div class="action-btn-group">
                <button id="touch-b" class="touch-btn touch-btn-b">B</button>
                <button id="touch-a" class="touch-btn touch-btn-a">A</button>
            </div>
        </div>

        <div id="message-box" class="message-box hidden">
            <p id="message-text">Welcome to ELA Quest!</p>
            <div id="choices-box" class="grid grid-cols-1 gap-2 mt-2"></div>
        </div>
    </div>

    <div id="battle-scene" class="hidden absolute inset-0 bg-black bg-opacity-95 flex flex-col items-center justify-center p-2 z-50">
        <div class="w-full max-w-lg">
             <div class="flex justify-between items-end mb-4">
                <div id="opponent-sprite" class="text-6xl lg:text-8xl transform -scale-x-100"></div>
                <div class="text-right w-2/3">
                    <p id="opponent-name" class="text-sm lg:text-xl text-yellow-400"></p>
                    <div class="w-full bg-gray-700 rounded-full h-4 border-2 border-white"><div id="opponent-hp" class="bg-green-500 h-full rounded-full transition-all" style="width: 100%"></div></div>
                </div>
            </div>
            <div class="flex justify-between items-end mb-8">
                <div class="text-left w-2/3">
                    <p id="player-name" class="text-sm lg:text-xl text-blue-300"></p>
                    <div class="w-full bg-gray-700 rounded-full h-4 border-2 border-white"><div id="player-hp" class="bg-green-500 h-full rounded-full transition-all" style="width: 100%"></div></div>
                    <p id="player-hp-text" class="text-xs mt-1">HP</p>
                </div>
                <div id="player-sprite" class="text-6xl lg:text-8xl"></div>
            </div>
        </div>
        <div id="battle-box" class="message-box relative w-full bg-white text-black rounded p-2 !static !mt-4">
            <p id="battle-text" class="text-sm mb-2"></p>
            <div id="battle-grid" class="grid grid-cols-2 gap-2"></div>
        </div>
    </div>
    
<div id="title-scene" class="absolute inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center text-center">
        <h1 class="text-3xl md:text-6xl text-yellow-400 mb-4" style="text-shadow: 4px 4px #000;">ELA QUEST</h1>
        <p class="text-sm md:text-2xl text-white mb-12">The Synonymouse Saga</p>
        
        <p id="start-prompt" class="text-xl text-green-400 blink-anim cursor-pointer">PRESS START</p>
    </div>

<div id="menu-scene" class="hidden ui-scene absolute inset-0 p-4 flex flex-col items-center justify-center">
    <div class="w-full max-w-sm bg-white text-black rounded border-4 border-gray-600 p-4 grid grid-cols-1 gap-3">
        <h2 class="text-2xl text-center mb-1 font-bold">Menu</h2>
        
        <p id="menu-clock" class="text-center text-blue-800 font-bold text-lg mb-2 border-b-2 border-gray-300 pb-2"></p>

        <button onclick="useFastTravel()" class="w-full p-3 bg-purple-600 text-white rounded border-2 border-white">Fly / Fast Travel</button>
        <button id="menu-journal-btn" class="w-full p-3 bg-blue-500 text-white rounded">Lexicon</button>
        <button id="menu-creature-btn" class="w-full p-3 bg-blue-500 text-white rounded">Creatures</button>
        <button id="menu-inventory-btn" class="w-full p-3 bg-blue-500 text-white rounded">Inventory</button>
        <button id="menu-save-btn" class="w-full p-3 bg-green-600 text-white rounded">Save Game</button>
        <button id="menu-load-btn" class="w-full p-3 bg-yellow-600 text-white rounded">Load Game</button>
        <button onclick="resetGameData()" class="mt-4 w-full p-3 bg-red-800 text-white rounded">Reset Data (New Student)</button>
        <button id="menu-close-btn" class="mt-2 w-full p-3 bg-red-500 text-white rounded">Close</button>
    </div>
</div>
    
    <div id="inventory-scene" class="hidden ui-scene absolute inset-0 p-4 flex flex-col items-center justify-center">
        <div class="w-full max-w-md bg-white text-black rounded border-4 border-gray-600 p-4">
            <h2 class="text-2xl text-center mb-4">Inventory</h2>
            <div class="text-xl mb-4 flex justify-between"><span>Money:</span><span id="inventory-money"></span></div>
            <div id="inventory-items" class="space-y-2 max-h-64 overflow-y-auto"></div>
            <button class="ui-back-btn mt-4 w-full p-3 bg-yellow-500 text-black rounded">Back</button>
        </div>
    </div>

    <div id="creature-stats-scene" class="hidden ui-scene absolute inset-0 p-4 flex flex-col items-center justify-center">
        <div id="creature-stats-content" class="w-full max-w-md bg-white text-black rounded border-4 border-gray-600 p-4"></div>
    </div>

    <div id="journal-scene" class="hidden ui-scene absolute inset-0 p-4 flex flex-col items-center justify-center">
        <div class="w-full max-w-md bg-white text-black rounded border-4 border-gray-600 p-4">
            <h2 class="text-2xl text-center mb-4">Lexicon</h2>
            <div id="journal-entries" class="space-y-2 max-h-[60vh] overflow-y-auto"></div>
            <button class="ui-back-btn mt-4 w-full p-3 bg-yellow-500 text-black rounded">Back</button>
        </div>
    </div>

    <div id="pc-scene" class="hidden ui-scene absolute inset-0 p-4 flex flex-col items-center justify-center">
        <div class="w-full max-w-lg bg-white text-black rounded border-4 border-gray-600 p-4">
            <h2 class="text-2xl text-center mb-4">Creature Storage</h2>
            <div class="grid grid-cols-2 gap-2">
                <div><h3 class="text-xl text-center">Party</h3><div id="pc-party" class="space-y-1 mt-1"></div></div>
                <div><h3 class="text-xl text-center">Box</h3><div id="pc-box" class="space-y-1 mt-1 max-h-[40vh] overflow-y-auto"></div></div>
            </div>
            <button id="pc-close-btn" class="mt-4 w-full p-3 bg-red-500 text-white rounded">Close</button>
        </div>
    </div>
    
    <div id="credits-container" class="hidden absolute inset-0 bg-black overflow-hidden z-50">
        <div id="credits-scene">
            <p class="mb-8 text-4xl">ELA Quest</p>
            <p class="mb-4">A Game By:</p><p class="mb-12 text-yellow-300">Luke Holm</p>
            <p class="mb-4">Powered By:</p><p class="mb-12 text-yellow-300">Leveled Up Learning</p>
            <p class="mb-8">Thank you for playing!</p>
        </div>
    </div>


<script>
    // --- FORCE RECONNECT MENU BUTTONS ---
    // Paste this at the very bottom of your script to fix the 'Close' button
    
    // 1. Re-connect the Close Button
    const closeBtn = document.getElementById('menu-close-btn');
    if (closeBtn) {
        closeBtn.onclick = () => closeAllMenus();
    }

    // 2. Re-connect the Save/Load Buttons (Just to be safe)
    const saveBtn = document.getElementById('menu-save-btn');
    if (saveBtn) {
        saveBtn.onclick = () => saveGame();
    }
    
    const loadBtn = document.getElementById('menu-load-btn');
    if (loadBtn) {
        loadBtn.onclick = () => loadGame();
    }
// --- Save & Load System ---
    
    function saveGame() {
        if (gameState.inBattle) {
            startDialogue("You cannot save during a battle!");
            return;
        }
        try {
            // We save the entire gameState object as a text string
            localStorage.setItem('elaQuestSave', JSON.stringify(gameState));
            closeAllMenus();
            startDialogue("Game saved successfully!");
        } catch (e) {
            console.error(e);
            startDialogue("Save failed. Your browser storage might be full.");
        }
    }
function handleStaticSafariEncounter() {
        if (gameState.inBattle) return;
        
        startDialogue(["It's the Lord of the Jungle!", "The Auto-biogra-bee!"], () => {
             gameState.inBattle = true;
             // Force a battle with this specific strong creature
             const wildCreature = createcreature('Auto-biogra-bee', 25); 
             currentBattle = {
                opponentParty: [wildCreature],
                currentOpponentIndex: 0,
                opponentName: "Legendary",
                isSafari: true
            };
            battleScene.classList.remove('hidden');
            updateBattleSpritesSafari(wildCreature);
            showSafariMenu();
        });
        return null;
    }
function loadGame() {
        const savedData = localStorage.getItem('elaQuestSave');
        if (savedData) {
            try {
                // 1. Overwrite current state
                const loadedState = JSON.parse(savedData);
                gameState = loadedState;
                
                // 2. CRITICAL FIX: Restore the map changes!
                // This ensures holes, cut trees, and beaten bosses stay gone.
                if (typeof restoreMapState === 'function') {
                    restoreMapState();
                } else {
                    console.error("restoreMapState function is missing!");
                }

                // 3. Refresh Screen
                closeAllMenus();
                draw(); 
                startDialogue("Game loaded successfully!");
            } catch (e) {
                console.error(e);
                startDialogue("Error loading save file.");
            }
        } else {
            startDialogue("No saved game found on this device.");
        }
    }
// Add this function anywhere in your script
function restoreMapState() {
    // 1. Re-apply Earthquake 1 (Hole in Village)
    if (gameState.earthquake1Triggered) {
        maps.village.layout[5][8] = 26; 
        maps.village.objects['8,5'] = { target: 'caveLevel1', x: 2, y: 2, sprite: 'hole' };
        if(maps.village.objects['4,5']) delete maps.village.objects['4,5'];
    }
    
    // 2. Re-apply Tree Removal
    if (gameState.treeRemoved) {
        if (maps.adjectiveWoods.objects['7,1']) delete maps.adjectiveWoods.objects['7,1'];
    }

    // 3. Re-apply Boulder Removal
    if (creatureDB['Lexiconstruct'].caught) {
         maps.caveLevel1.layout[3][14] = 28; 
    }

    // 4. RESTORE PYRAMID STATE (Elite 4 & Bosses)
    // If defeated, remove them so the path is clear.
    if (gameState.defeatedTrainers.includes('eliteGrammarian')) delete maps.finalCave.objects['8,11'];
    if (gameState.defeatedTrainers.includes('eliteJournalist')) delete maps.finalCave.objects['11,11'];
    if (gameState.defeatedTrainers.includes('eliteDramatist')) delete maps.finalCave.objects['8,5'];
    if (gameState.defeatedTrainers.includes('elitePoet')) delete maps.finalCave.objects['11,5'];
    
    // Remove Final Bosses if beaten
    if (gameState.defeatedTrainers.includes('finalBoss1')) delete maps.finalCave.objects['9,2'];
    if (gameState.defeatedTrainers.includes('finalBoss2')) delete maps.finalCave.objects['10,2'];
}
    // Connect the buttons
    document.getElementById('menu-save-btn').onclick = () => saveGame();
    document.getElementById('menu-load-btn').onclick = () => loadGame();
    // --- Game Setup ---
    const canvas = document.getElementById('gameCanvas');
    const gameContainer = document.getElementById('game-container');
    const ctx = canvas.getContext('2d');
    const messageBox = document.getElementById('message-box');
    const messageText = document.getElementById('message-text');
    const choicesBox = document.getElementById('choices-box');
    const battleScene = document.getElementById('battle-scene');
    const battleBox = document.getElementById('battle-box');
    const battleText = document.getElementById('battle-text');
    const battleGrid = document.getElementById('battle-grid');
    
    const menuScene = document.getElementById('menu-scene');
    const inventoryScene = document.getElementById('inventory-scene');
    const creatureStatsScene = document.getElementById('creature-stats-scene');
    const journalScene = document.getElementById('journal-scene');
    const pcScene = document.getElementById('pc-scene');

    const tileSize = 32;
    canvas.width = 16 * tileSize; canvas.height = 14 * tileSize;

let gameState = {
    repelSteps: 0,
        safariSteps: 0,
        inSafariZone: false,
        katrinaQuest: 0,
        pickedItems: [], // This tracks what you have picked up
        currentMap: 'playerRoom',
        player: { x: 4, y: 4, sprite: 'player' },
        inDialogue: false, inBattle: false, activeScene: null,
        money: 50,
        inventory: { 
            potions: 3, wordballs: 5, greatphrases: 0, ultrasentences: 0, masterthesis: 0, 
            adjectiveElixirs: 0, thesaurusTeas: 0, escapeVerbs: 0, 
            LH01LuminousHyperbole: 0, LH02LyricalHightail: 0, boatPart: 0,
            synonymRoll: 0, luckyLure: 0, oldRod: 0, treeFlute: 0, safariBall: 0
        },
        rivalDefeated: false,
        rivalDefeatedPostGym: false,
        rivalDefeatedInSynonymCity: false,
        defeatedTrainers: [],
        journal: {}, 
        playerParty: [],
        creatureBox: [],
        gymBadges: { rhyme: false, synonym: false },
        devModeActive: false,
        hasMetDeathMasheen: false,
        teleportUnlocked: false,
        earthquake1Triggered: false,
        earthquake2Triggered: false,
        finalBossDefeated: false,
        trainingStreak: 0,
        treeRemoved: false, 
        metRivalRoute1: false
    };
    
const attacksDB = {
        'Blank Page': { type: 'Normal', name: 'Blank Page', power: 5, text: 'Causes Writer\'s Block!', effect: { type: 'status', status: 'writers_block', target: 'opponent' } },
        'Tackle': { type: 'Normal', name: 'Tackle', power: 8, text: 'A basic physical strike.' },
        'Word Strike': { type: 'Normal', name: 'Word Strike', power: 10, text: 'Channels knowledge into a jab.' },
        'Synonym Slam': { type: 'Normal', name: 'Synonym Slam', power: 15, text: 'A blow backed by similar words.' },
        'Roar of Knowledge': { type: 'Fire', name: 'Roar of Knowledge', power: 22, text: 'A stunning cry of ancient truths.'}, // Fire move!
        'Gooey Touch': { type: 'Water', name: 'Gooey Touch', power: 7, text: 'A sticky, weak jab.'}, // Water move!
        'Chameleon Color': { type: 'Grass', name: 'Chameleon Color', power: 12, text: 'Changes color to land a surprising hit.'},
        'Scale Shot': { type: 'Normal', name: 'Scale Shot', power: 18, text: 'Fires sharp scales at the foe.'},
        'Cosmic Prose': { type: 'Normal', name: 'Cosmic Prose', power: 30, text: 'An attack of legendary power.'},
        'Leer': { type: 'Normal', name: 'Leer', power: 0, text: 'Lowers enemy defense.', effect: { type: 'stat', stat: 'defense', amount: -1, target: 'opponent' } },
        'Growl': { type: 'Normal', name: 'Growl', power: 0, text: 'Lowers enemy attack.', effect: { type: 'stat', stat: 'attack', amount: -1, target: 'opponent' } },
        'Sharpen': { type: 'Normal', name: 'Sharpen', power: 0, text: 'Raises the user\'s Attack stat.', effect: { type: 'stat', stat: 'attack', amount: 1, target: 'self' } }
    };

const journalData = {
    // NIGHT EXCLUSIVES
    'Ink-ling': 'A small droplet of raw idea. It leaves messy stains wherever it goes.',
    'Ink-blot': 'It constantly changes shape. What you see in it reflects your own mind.',
    'Ink-cantation': 'A master of words that can rewrite reality with its magic ink.',
    'Whisper-wisp': 'A faint idea that floats in the wind. Hard to catch, harder to understand.',
    'Murmur-mist': 'A fog of hushed voices. It surrounds writers with doubt.',
    'Scream-of-Consciousness': 'An overwhelming flow of thoughts that cannot be stopped.',
    'Moth-if': 'A small creature that is drawn to the light of a good idea.',
    'Theme-oth': 'A majestic creature that represents the central message of the night.',
    'Owl-literation': 'It repeats the same hoot sound at the start of every breath.',
    'Hoot-dunit': 'A mysterious bird that always solves the crime before dawn.',
    'Crick-it': 'It chirps in perfect rhythm, keeping time for poetry readings.',
    'Cri-tick': 'A harsh judge of performance. Its song can be quite biting.',
    'Lun-artic': 'A creature that glows under the moon, driven mad by beautiful words.',
    'Grim-reader': 'It haunts libraries at night, finishing books left open by students.',
    'Vamp-irony': 'It expects one thing but does the opposite. It bites with sarcasm.',
    'Were-word': 'By day, a normal word. By night, it transforms into something wild.',
    'Star-syntax': 'A celestial being that arranges the stars into perfect sentence structures.',
    'Shad-ode': 'A dark poem that follows you around, mimicking your movements.',
    'Night-narrator': 'A voice in the dark that describes everything you do as you do it.',
    'Mid-night-oil': 'A candle flame that burns brightest when a student is studying late.',

    // ORIGINAL CREATURES
    'Synonymouse': 'A clever creature that finds strength in words with similar meanings.',
    'ThesaurusRex': 'The evolved form of Synonymouse. Its vast vocabulary gives it immense power.',
    'Wordworm': 'Common in grassy areas, this creature consumes letters for sustenance.',
    'Grammargoyle': 'A stoic opponent that strictly adheres to the rules of language.',
    'SimileSlime': 'A gooey creature that is *like* a puddle but *as* solid as a rock.',
    'CommaLeon': 'This creature can pause, adapt, and blend into any sentence structure.',
    'Adjectlizard': 'A reptile that describes its foes into submission with powerful adjectives.',
    'Haiku-na': 'A serene creature that attacks in a pattern of 5, then 7, then 5 syllables.',
    'Metaphorpillar': 'It believes it IS a leaf, consuming knowledge until it transforms.',
    'Hyper-bole': 'This creature is the BIGGEST, STRONGEST, and FASTEST creature in the entire universe!',
    'PronounProwler': 'A swift hunter that replaces its prey\'s name with "it" before it strikes.',
    'VerbViper': 'This serpent moves with decisive action, striking with a powerful verb-al assault.',
    'Lexiconstruct': 'A legendary golem of pure language, said to hold the secrets of all stories.',
    'Antonymph': 'A legendary fairy of opposition, its very presence inverts the world around it.',
};

    const itemsDB = {
        'redPen': { name: 'Red Pen', description: 'A powerful editing tool. Stops run-on sentences in their tracks.', price: 0, keyItem: true },
        // ... inside itemsDB ...
'peaceTreaty': { name: 'Peace Treaty', description: 'Prevents wild arguments for 150 steps.', price: 150 },
// ...
        'safariBall': { name: 'Jungle Orb', description: "A camouflage ball used only in the Genre Jungle.", bonus: 1.5 },
     'synonymRoll': { name: 'Synonym Roll', description: "A sweet pastry that swirls with knowledge. Instantly raises a creature's level by 1." },
        'luckyLure': { name: 'Lucky Lure', description: "A shiny, custom-made fishing lure found on the island." },
        'oldRod': { name: 'Old Rod', description: "A sturdy fishing rod. Allows you to encounter Water-type creatures in the Bay." },
        'treeFlute': { name: 'Nature Flute', description: "A flute carved from the blocking tree. Its melody attracts creatures with rhythm." },
        'oxfordComma': { name: 'Oxford Comma', description: "A pause that clarifies everything. Fully restores HP." },
        'redHerring': { name: 'Red Herring', description: "A very distracting fish. It seems to lead you to a false conclusion." },
        'potions': { name: 'Potion', description: "A spray that restores a creature's health, or its 'main idea.'" },
        'wordballs': { name: 'Word Ball', description: "A device for capturing and storing the essence of wild literary creatures.", bonus: 1.0 },
        'greatphrases': { name: 'Great Phrase', description: "A well-crafted sentence with a higher chance of capturing a creature.", bonus: 1.5 },
        'ultrasentences': { name: 'Ultra Sentence', description: "A complex, high-performance sentence with a very high capture rate.", bonus: 2.0 },
        'masterthesis': { name: 'Master Thesis', description: "The ultimate literary device. It will capture any creature without fail.", bonus: 255 },
        'adjectiveElixirs': { name: 'Adjective Elixir', description: "A descriptive drink that temporarily boosts a creature's Attack stat." },
        'thesaurusTeas': { name: 'Thesaurus Tea', description: "A soothing brew that cures any status conditions by finding an alternative 'state of being.'" },
        'escapeVerbs': { name: 'Escape Verb', description: "An action-packed phrase that guarantees a swift escape from a wild encounter." },
        'LH01LuminousHyperbole': { name: 'LH01 L. Hyperbole', description: "An incredibly powerful turn of phrase that can illuminate the darkest of places." },
        'LH02LyricalHightail': { name: 'LH02 L. Hightail', description: "A poetic verse that lets you instantly travel to any previously visited Word Center." },
        'boatPart': { name: 'Engine Cog', description: 'A sturdy-looking metal gear. It seems important.' }
    };

const creatureDB = {
    'InfectedWordworm': { type: 'Normal', sprite: 'wordworm', catchDifficulty: 255 }, // 255 = Hard to catch until edited
    // --- NIGHT EXCLUSIVES (20 New Creatures) ---
    
    // 3-Stage Line: The Ink Evolution (Normal)
    'Ink-ling': { type: 'Normal', sprite: 'ink-ling', evolvesAt: 12, evolvesTo: 'Ink-blot', catchDifficulty: 50 },
    'Ink-blot': { type: 'Normal', sprite: 'ink-blot', evolvesAt: 24, evolvesTo: 'Ink-cantation', catchDifficulty: 80 },
    'Ink-cantation': { type: 'Normal', sprite: 'ink-cantation', catchDifficulty: 30 },

    // 3-Stage Line: The Stream of Consciousness (Ghost)
    'Whisper-wisp': { type: 'Normal', sprite: 'whisper-wisp', evolvesAt: 15, evolvesTo: 'Murmur-mist', catchDifficulty: 50 },
    'Murmur-mist': { type: 'Normal', sprite: 'murmur-mist', evolvesAt: 30, evolvesTo: 'Scream-of-Consciousness', catchDifficulty: 70 },
    'Scream-of-Consciousness': { type: 'Fire', sprite: 'scream-of-consciousness', catchDifficulty: 20 },

    // 2-Stage Line: The Motif (Flying/Grass)
    'Moth-if': { type: 'Grass', sprite: 'moth-if', evolvesAt: 18, evolvesTo: 'Theme-oth', catchDifficulty: 60 },
    'Theme-oth': { type: 'Grass', sprite: 'theme-oth', catchDifficulty: 40 },

    // 2-Stage Line: The Mystery Owl (Flying)
    'Owl-literation': { type: 'Normal', sprite: 'owl-literation', evolvesAt: 20, evolvesTo: 'Hoot-dunit', catchDifficulty: 60 },
    'Hoot-dunit': { type: 'Normal', sprite: 'hoot-dunit', catchDifficulty: 35 },

    // 2-Stage Line: The Critic (Grass)
    'Crick-it': { type: 'Grass', sprite: 'crick-it', evolvesAt: 16, evolvesTo: 'Cri-tick', catchDifficulty: 55 },
    'Cri-tick': { type: 'Grass', sprite: 'cri-tick', catchDifficulty: 40 },

    // Single Stage Night Creatures
    'Lun-artic': { type: 'Water', sprite: 'lun-artic', catchDifficulty: 45 },
    'Grim-reader': { type: 'Normal', sprite: 'grim-reader', catchDifficulty: 35 },
    'Vamp-irony': { type: 'Fire', sprite: 'vamp-irony', catchDifficulty: 40 },
    'Were-word': { type: 'Normal', sprite: 'were-word', catchDifficulty: 40 },
    'Star-syntax': { type: 'Fire', sprite: 'star-syntax', catchDifficulty: 50 },
    'Shad-ode': { type: 'Normal', sprite: 'shad-ode', catchDifficulty: 60 },
    'Night-narrator': { type: 'Normal', sprite: 'night-narrator', catchDifficulty: 70 },
    'Mid-night-oil': { type: 'Fire', sprite: 'mid-night-oil', catchDifficulty: 50 },

    // --- ORIGINAL CREATURES ---
    'Splash-pup': { type: 'Water', sprite: 'simileslime', evolvesAt: 14, evolvesTo: 'Tidal-hound', catchDifficulty: 60 },
    'Tidal-hound': { type: 'Water', sprite: 'verbviper', catchDifficulty: 40 },
    'Bubble-bard': { type: 'Water', sprite: 'haikuna', evolvesAt: 18, evolvesTo: 'Opera-whale', catchDifficulty: 70 },
    'Opera-whale': { type: 'Water', sprite: 'hyperbole', catchDifficulty: 30 },
    'Coral-scribe': { type: 'Water', sprite: 'metaphorpillar', evolvesAt: 15, evolvesTo: 'Reef-reader', catchDifficulty: 65 },
    'Reef-reader': { type: 'Water', sprite: 'grammargoyle', catchDifficulty: 35 },
    'Fin-fiction': { type: 'Water', sprite: 'wordworm', evolvesAt: 12, evolvesTo: 'Shark-tale', catchDifficulty: 60 },
    'Shark-tale': { type: 'Water', sprite: 'thesaurusrex', catchDifficulty: 20 },
    'Kelp-ie': { type: 'Water', sprite: 'commaleon', catchDifficulty: 80 },
    'Squid-pro-quo': { type: 'Water', sprite: 'lexiconstruct', catchDifficulty: 90 }, 
    'SimileSlime': { type: 'Water', sprite: 'simileslime', catchDifficulty: 190 }, 
    'Tempo-toad': { type: 'Water', sprite: 'simileslime', catchDifficulty: 80 },
    'Fic-tion': { type: 'Normal', sprite: 'fic-tion', evolvesAt: 20, evolvesTo: 'Novel-lion', catchDifficulty: 120 },
    'Novel-lion': { type: 'Normal', sprite: 'novel-lion', catchDifficulty: 60 },
    'Mytho-log': { type: 'Grass', sprite: 'mytho-log', evolvesAt: 25, evolvesTo: 'Legend-ary', catchDifficulty: 100 },
    'Legend-ary': { type: 'Grass', sprite: 'legend-ary', catchDifficulty: 40 },
    'Biogra-bee': { type: 'Normal', sprite: 'biogra-bee', evolvesAt: 18, evolvesTo: 'Auto-biogra-bee', catchDifficulty: 110 },
    'Auto-biogra-bee': { type: 'Normal', sprite: 'auto-biogra-bee', catchDifficulty: 50 },
    'Sci-Fi-der': { type: 'Normal', sprite: 'sci-fi-der', catchDifficulty: 90 },
    'Fantasy-fox': { type: 'Normal', sprite: 'fantasy-fox', catchDifficulty: 85 },
    'Drama-llama': { type: 'Normal', sprite: 'drama-llama', catchDifficulty: 70 },
    'Poetry-can': { type: 'Normal', sprite: 'poetry-can', catchDifficulty: 60 },
    'Wordworm': { type: 'Grass', sprite: 'wordworm', catchDifficulty: 255 },
    'Metaphorpillar': { type: 'Grass', sprite: 'metaphorpillar', catchDifficulty: 255 },
    'Rhyth-mite': { type: 'Grass', sprite: 'wordworm', catchDifficulty: 60 },
    'Choral-reef': { type: 'Grass', sprite: 'metaphorpillar', catchDifficulty: 85 },
    'ThesaurusRex': { type: 'Fire', sprite: 'thesaurusrex', learnset: [{ level: 12, move: 'Roar of Knowledge' }], catchDifficulty: 25 },
    'Hyper-bole': { type: 'Fire', sprite: 'hyperbole', catchDifficulty: 120 }, 
    'VerbViper': { type: 'Fire', sprite: 'verbviper', catchDifficulty: 90 }, 
    'Vocal-cord': { type: 'Fire', sprite: 'verbviper', catchDifficulty: 70 },
    'Synonymouse': { type: 'Normal', sprite: 'synonymouse', evolvesAt: 10, evolvesTo: 'ThesaurusRex', learnset: [{ level: 7, move: 'Synonym Slam' }], catchDifficulty: 45 },
    'Grammargoyle': { type: 'Normal', sprite: 'grammargoyle', catchDifficulty: 45 },
    'CommaLeon': { type: 'Normal', sprite: 'commaleon', catchDifficulty: 90 },
    'Adjectlizard': { type: 'Normal', sprite: 'adjectlizard', learnset: [{level: 9, move: 'Scale Shot'}], catchDifficulty: 45 },
    'Haiku-na': { type: 'Normal', sprite: 'haikuna', catchDifficulty: 75 },
    'PronounProwler': { type: 'Normal', sprite: 'pronounprowler', catchDifficulty: 90 },
    'Lyrical-loon': { type: 'Normal', sprite: 'haikuna', catchDifficulty: 90 },
    'Lexiconstruct': { type: 'Normal', sprite: 'lexiconstruct', isLegendary: true, catchDifficulty: 3 },
    'Antonymph': { type: 'Normal', sprite: 'antonymph', isLegendary: true, catchDifficulty: 3 }
};
    
const createcreature = (species, level) => {
        let baseHp = 15, baseAtk = 8, baseDef = 5, attacks = ['Tackle'];
        switch(species) {
            case 'Rhyth-mite': baseHp = 25; baseAtk = 12; baseDef = 8; attacks = ['Tackle', 'Growl']; break;
            case 'Vocal-cord': baseHp = 30; baseAtk = 15; baseDef = 5; attacks = ['Roar of Knowledge', 'Tackle']; break;
            case 'Tempo-toad': baseHp = 35; baseAtk = 10; baseDef = 15; attacks = ['Tackle', 'Sharpen']; break;
            case 'Choral-reef': baseHp = 40; baseAtk = 10; baseDef = 18; attacks = ['Gooey Touch', 'Growl']; break;
            case 'Lyrical-loon': baseHp = 30; baseAtk = 18; baseDef = 10; attacks = ['Word Strike', 'Leer']; break;
            case 'Synonymouse': baseHp = 20; baseAtk = 10; baseDef = 6; attacks = ['Tackle', 'Word Strike', 'Growl']; break;
            case 'ThesaurusRex': baseHp = 40; baseAtk = 20; baseDef = 15; attacks = ['Tackle', 'Word Strike', 'Synonym Slam']; break;
            case 'Grammargoyle': baseHp = 30; baseAtk = 14; baseDef = 10; attacks = ['Tackle', 'Leer', 'Sharpen']; break;
            case 'Wordworm': baseHp = 15; baseAtk = 6; baseDef = 4; attacks = ['Tackle', 'Growl']; break;
            case 'SimileSlime': baseHp = 18; baseAtk = 7; baseDef = 8; attacks = ['Gooey Touch']; break;
            case 'CommaLeon': baseHp = 22; baseAtk = 9; baseDef = 7; attacks = ['Tackle', 'Chameleon Color']; break;
            case 'Adjectlizard': baseHp = 30; baseAtk = 12; baseDef = 9; attacks = ['Tackle', 'Leer', 'Scale Shot']; break;
            case 'Haiku-na': baseHp = 20; baseAtk = 11; baseDef = 6; break;
            case 'Metaphorpillar': baseHp = 16; baseAtk = 5; baseDef = 12; break;
            case 'Hyper-bole': baseHp = 12; baseAtk = 14; baseDef = 3; break;
            case 'PronounProwler': baseHp = 25; baseAtk = 13; baseDef = 7; attacks = ['Tackle', 'Leer']; break;
            case 'VerbViper': baseHp = 28; baseAtk = 15; baseDef = 6; attacks = ['Tackle', 'Growl']; break;
            case 'Lexiconstruct': baseHp = 100; baseAtk = 50; baseDef = 50; attacks = ['Cosmic Prose', 'Synonym Slam']; break;
            case 'Antonymph': baseHp = 100; baseAtk = 50; baseDef = 50; attacks = ['Cosmic Prose', 'Word Strike']; break;
            // Safari Creatures
            case 'Fic-tion': baseHp=22; baseAtk=10; baseDef=5; break;
            case 'Novel-lion': baseHp=40; baseAtk=20; baseDef=15; break;
            case 'Mytho-log': baseHp=25; baseAtk=12; baseDef=12; break;
            case 'Legend-ary': baseHp=50; baseAtk=25; baseDef=20; break;
            case 'Biogra-bee': baseHp=20; baseAtk=15; baseDef=5; break;
            case 'Auto-biogra-bee': baseHp=45; baseAtk=22; baseDef=18; break;
        };

        // --- NEW: FIRST EDITION LOGIC (Shiny) ---
        // 5% Chance (1 in 20) to be a "First Edition"
        const isFirstEd = Math.random() < 0.05; 
        
        let finalHp = baseHp + (level * 5);
        let finalAtk = baseAtk + (level * 2);
        let finalDef = baseDef + (level * 2);

        if (isFirstEd) {
            finalHp = Math.floor(finalHp * 1.2); // +20% Health
            finalAtk = Math.floor(finalAtk * 1.2); // +20% Attack
            finalDef = Math.floor(finalDef * 1.2); // +20% Defense
        }

        return { 
            species, 
            name: isFirstEd ? `✨ First Ed. ${species}` : species, 
            isFirstEdition: isFirstEd,
            level, 
            currentHp: finalHp, maxHp: finalHp, 
            attack: finalAtk, defense: finalDef,
            xp: 0, xpToNextLevel: 100, 
            attacks: attacks.map(a => attacksDB[a]), 
            sprite: creatureDB[species] ? creatureDB[species].sprite : species.toLowerCase(),
            statMods: { attack: 0, defense: 0 },
            status: null, 
            hasEvolved: false,
        };
};

const runOnQuestions = [
    { q: "Fix: 'I love pizza it is delicious.'", a: ["I love pizza. It is delicious.", "I love pizza it is delicious", "Pizza is delicious I love it"], c: "I love pizza. It is delicious.", ex: "Separate independent clauses with a period." },
    { q: "Fix: 'The dog ran fast he caught the ball.'", a: ["The dog ran fast; he caught the ball.", "The dog ran fast he caught the ball", "Dog ran fast caught ball"], c: "The dog ran fast; he caught the ball.", ex: "Use a semicolon to join related clauses." },
    { q: "Fix: 'School is fun I like reading.'", a: ["School is fun, and I like reading.", "School is fun I like reading", "School fun reading good"], c: "School is fun, and I like reading.", ex: "Use a comma + FANBOYS conjunction." },
    { q: "Fix: 'It is raining I will stay inside.'", a: ["It is raining, so I will stay inside.", "It is raining I will stay inside", "Raining stay inside"], c: "It is raining, so I will stay inside.", ex: "Use a coordinating conjunction." },
    { q: "Which is a Run-on Sentence?", a: ["I ran home I ate lunch.", "I ran home.", "I ran home, and I ate lunch."], c: "I ran home I ate lunch.", ex: "It fuses two sentences without punctuation." }
];

const trainersDB = {
    'hikerTom': { name: "Hiker Tom", creature: [createcreature('Wordworm', 6)], preBattle: ["A trainer! Finally a challenge! Let's battle!"], postBattle: ["Huff... puff... you're pretty strong. Keep it up!"], reward: 60 },
    'readerSue': { name: "Reader Sue", creature: [createcreature('SimileSlime', 7)], preBattle: ["Oh! You want to battle? My SimileSlime is as ready as a spring day!"], postBattle: ["Wow! Your skills are like a roaring fire!"], reward: 70 },
    'bookwormBarry': { name: "Bookworm Barry", creature: [createcreature('PronounProwler', 15)], preBattle: ["I've read about every creature! Let's see if your skills are textbook!"], postBattle: ["Wow, a real-world lesson! You're tougher than the texts said."], reward: 150 },
    'artistAdeline': { name: "Artist Adeline", creature: [createcreature('VerbViper', 17)], preBattle: ["I'm painting a picture of a perfect battle. You're my subject!"], postBattle: ["Such vivid action! You've inspired my next masterpiece."], reward: 170 },
    'profGrendel': { name: "Professor Grendel", creature: [createcreature('ThesaurusRex', 25), createcreature('VerbViper', 28)], preBattle: ["You dare challenge the master of semantics? Your story ends here!"], postBattle: ["Hmph. A mere fluke. You have not seen the last of my literary might!"], reward: 300 },
    'gymLeaderRhonda': { 
        name: "Middle School Master Rhonda", 
        creature: [createcreature('Haiku-na', 12), createcreature('Adjectlizard', 14)], 
        preBattle: ["Rhonda: 'To pass my class, you have to climb,'", "'And beat my team in a rhyme-fueled crime!'"], 
        postBattle: ["Your skills are sharp, your victory's prime,", "Here's the Rhyme Badge, for your time!"], 
        reward: 400 
    },
    'gymLeaderLex': { 
        name: "High School Hero Lex", 
        creature: [createcreature('ThesaurusRex', 30), createcreature('Grammargoyle', 28)], 
        preBattle: ["Welcome to the Honors Class!", "Let's see if your lexicon is ready for High School!"], 
        postBattle: ["Astounding!", "You have graduated with honors!", "You've earned this!"], 
        reward: 500 
    },
    'caveExplorerDon': { name: "Explorer Don", creature: [createcreature('Grammargoyle', 22)], preBattle: ["This cave is full of rare grammar! Don't get in my way!"], postBattle: ["Hmph. Fine, you can pass. But I'll find the rarest ones first!"], reward: 220 },
    'goblinBoss': { name: "Goblin Grunt", creature: [createcreature('ThesaurusRex', 32)], preBattle: ["GRAR! You found me! But you won't stop me from finding the legendary creature of language!"], postBattle: ["Grah! Beaten... But the master will succeed... You'll need this to get out of here."], reward: 1000 },
    'shipwreckedPilot': { name: "Disoriented Pilot", creature: [createcreature('Hyper-bole', 35)], preBattle: ["Who... who are you? Is this my ship? Get away from my ship!"], postBattle: ["Ugh... my head... a plane crash... I've been here for years...", "My love... in Lexington City... I have to get back!", "You... you saved me from my delirium. Take this. It's a special technique.", "I should have used it to fly home ages ago... I must see her!"], reward: 600 },
    
    // --- THE ELITE FOUR (FINAL CAVE GAUNTLET) ---
    'elitePoet': { 
        name: "Elite Poet Frost", 
        creature: [createcreature('Haiku-na', 45), createcreature('Lyrical-loon', 48)], 
        preBattle: ["Two roads diverged in a yellow wood...", "And you took the one that leads to DEFEAT!"], 
        postBattle: ["You have poetry in your soul... You may pass."], 
        reward: 1000 
    },
    'eliteDramatist': { 
        name: "Elite Actor Bard", 
        creature: [createcreature('Drama-llama', 48), createcreature('ThesaurusRex', 50)], 
        preBattle: ["All the world's a stage...", "And you are merely a player about to lose!"], 
        postBattle: ["Parting is such sweet sorrow. Go on."], 
        reward: 1100 
    },
    'eliteJournalist': { 
        name: "Elite Writer Woolf", 
        creature: [createcreature('Biogra-bee', 50), createcreature('Auto-biogra-bee', 52)], 
        preBattle: ["I only deal in cold, hard facts.", "Fact: You are underprepared."], 
        postBattle: ["This will make a great headline. Proceed."], 
        reward: 1200 
    },
    'eliteGrammarian': { 
        name: "Elite Prof. Strunk", 
        creature: [createcreature('Grammargoyle', 53), createcreature('CommaLeon', 55)], 
        preBattle: ["Your sentence structure is sloppy!", "I will correct your behavior!"], 
        postBattle: ["Perfect syntax... impressive. The King awaits."], 
        reward: 1300 
    },

    // --- FINAL BOSSES ---
    'finalBoss1': { 
        name: "Goblin General", 
        creature: [createcreature('Grammargoyle', 50)], 
        preBattle: ["Grah! You enter our domain?", "You will not pass!"], 
        postBattle: ["I have failed..."], 
        reward: 1500 
    },
    'finalBoss2': { 
        name: "Goblin King", 
        creature: [createcreature('ThesaurusRex', 60)], 
        preBattle: ["I am the King of errors!", "I will rewrite this world!"], 
        postBattle: ["Impossible... My logic... flawed...", "Take this... the ultimate knowledge..."], 
        reward: 2000 
    },
'finalRival': { 
        name: "Champion Andy", 
        creature: [createcreature('ThesaurusRex', 75), createcreature('Antonymph', 80)], 
        preBattle: ["Let's see how far we've come!"], 
        postBattle: [
            "Wow. You really are the protagonist of this story.", 
            "But hey, every hero needs a partner, right?", 
            "From now on, I've got your back. We protect this world together."
        ], 
        reward: 5000 
    }
};

const elaQuestions = [
    // --- ADVANCED GRAMMAR & MECHANICS (15 Questions) ---
    { q: "A sentence containing two independent clauses and one dependent clause is...", a: ["Compound-Complex", "Complex", "Compound", "Simple"], c: "Compound-Complex", ex: "It combines the features of both compound and complex sentences." },
    { q: "Identify the abstract noun: 'Her bravery was inspiring.'", a: ["Bravery", "Her", "Was", "Inspiring"], c: "Bravery", ex: "Abstract nouns refer to ideas or qualities you cannot touch." },
    { q: "Identify the concrete noun: 'The phone rang loudly.'", a: ["Phone", "Loudly", "Rang", "The"], c: "Phone", ex: "Concrete nouns are things you can physically sense." },
    { q: "Which punctuation mark is used to list items following an independent clause?", a: ["Colon :", "Semicolon ;", "Comma ,", "Dash -"], c: "Colon :", ex: "Colons introduce lists, quotes, or explanations." },
    { q: "What is the collective noun in: 'The flock of birds flew away.'", a: ["Flock", "Birds", "Flew", "Away"], c: "Flock", ex: "Collective nouns name a group of individuals." },
    { q: "Identify the linking verb: 'She seems happy.'", a: ["Seems", "She", "Happy", "None"], c: "Seems", ex: "Linking verbs connect the subject to a descriptor." },
    { q: "Which word is a subordinating conjunction?", a: ["Because", "And", "But", "Or"], c: "Because", ex: "Subordinating conjunctions start dependent clauses." },
    { q: "Correct the sentence: 'Him and me went to the store.'", a: ["He and I", "Him and I", "He and me", "Me and him"], c: "He and I", ex: "Use subject pronouns (He, I) as the subject." },
    { q: "What is an appositive phrase?", a: ["A noun phrase renaming another noun", "A verb phrase", "A prepositional phrase", "A clause"], c: "A noun phrase renaming another noun", ex: "Example: 'My dog, a beagle, is cute.'" },
    { q: "Which sentence uses a dangling modifier?", a: ["Walking down the street, the tree fell.", "Walking down the street, I saw a tree fall.", "I saw a tree fall walking down the street.", "The tree fell while I walked."], c: "Walking down the street, the tree fell.", ex: "Trees cannot walk down the street." },
    { q: "Identify the prepositional phrase: 'The cat is under the table.'", a: ["under the table", "The cat is", "is under", "the table"], c: "under the table", ex: "It begins with a preposition and ends with a noun." },
    { q: "What is the tense of 'She has eaten'?", a: ["Present Perfect", "Past Perfect", "Future", "Simple Past"], c: "Present Perfect", ex: "Has/Have + Past Participle = Present Perfect." },
    { q: "What is the tense of 'She had eaten'?", a: ["Past Perfect", "Present Perfect", "Future", "Simple Past"], c: "Past Perfect", ex: "Had + Past Participle = Past Perfect." },
    { q: "Which is a coordinating conjunction?", a: ["For", "Because", "Although", "Since"], c: "For", ex: "Remember FANBOYS: For, And, Nor, But, Or, Yet, So." },
    { q: "Identify the gerund: 'Swimming is fun.'", a: ["Swimming", "Is", "Fun", "None"], c: "Swimming", ex: "A gerund is a verb ending in -ing that acts as a noun." },

    // --- TEXT STRUCTURE & COMPREHENSION (15 Questions) ---
    { q: "A text structure that shows how two things are alike and different is...", a: ["Compare and Contrast", "Cause and Effect", "Sequence", "Problem and Solution"], c: "Compare and Contrast", ex: "Look for signal words like 'both', 'unlike', and 'similarly'." },
    { q: "A text structure that lists events in order is...", a: ["Chronological/Sequence", "Description", "Cause and Effect", "Argument"], c: "Chronological/Sequence", ex: "Look for dates, times, or steps." },
    { q: "A text structure that explains why something happened and the result is...", a: ["Cause and Effect", "Sequence", "Problem and Solution", "Compare and Contrast"], c: "Cause and Effect", ex: "Look for 'because', 'so', 'therefore'." },
    { q: "When you use clues from the text + your own knowledge, you are making an...", a: ["Inference", "Opinion", "Summary", "Observation"], c: "Inference", ex: "Reading between the lines." },
    { q: "A brief retelling of the main points of a text is a...", a: ["Summary", "Paraphrase", "Quote", "Critique"], c: "Summary", ex: "Summaries are short and objective." },
    { q: "Restating a specific passage in your own words is...", a: ["Paraphrasing", "Summarizing", "Quoting", "Plagiarizing"], c: "Paraphrasing", ex: "Paraphrasing keeps the detail but changes the wording." },
    { q: "The author's reason for writing (Persuade, Inform, Entertain) is...", a: ["Author's Purpose", "Theme", "Tone", "Mood"], c: "Author's Purpose", ex: "Remember P.I.E." },
    { q: "A statement that can be proven true is a...", a: ["Fact", "Opinion", "Belief", "Bias"], c: "Fact", ex: "Facts rely on evidence." },
    { q: "A statement of personal belief or feeling is an...", a: ["Opinion", "Fact", "Statistic", "Evidence"], c: "Opinion", ex: "Opinions cannot be proven true or false." },
    { q: "Prejudice in favor of or against one thing is called...", a: ["Bias", "Fact", "Objective", "Neutral"], c: "Bias", ex: "Bias prevents objective reporting." },
    { q: "Information used to support a claim is called...", a: ["Evidence", "Opinion", "Topic", "Theme"], c: "Evidence", ex: "Evidence includes facts, quotes, and statistics." },
    { q: "The primary subject being discussed in a text is the...", a: ["Main Idea", "Theme", "Detail", "Setting"], c: "Main Idea", ex: "What the text is mostly about." },
    { q: "Specific points that support the main idea are...", a: ["Supporting Details", "Themes", "Conclusions", "Introductions"], c: "Supporting Details", ex: "They provide proof or examples." },
    { q: "A source written by someone who witnessed the event is a...", a: ["Primary Source", "Secondary Source", "Tertiary Source", "Fictional Source"], c: "Primary Source", ex: "Diaries, photos, and letters are primary sources." },
    { q: "A source written about an event after it happened (like a textbook) is a...", a: ["Secondary Source", "Primary Source", "Firsthand Account", "Interview"], c: "Secondary Source", ex: "They analyze or summarize primary sources." },

    // --- ROOTS, AFFIXES & VOCABULARY (15 Questions) ---
    { q: "The root 'scrib/script' means...", a: ["Write", "See", "Sound", "Heat"], c: "Write", ex: "Examples: Scribble, Scripture, Describe." },
    { q: "The root 'phon' means...", a: ["Sound", "Light", "Life", "Earth"], c: "Sound", ex: "Examples: Telephone, Symphony, Phonics." },
    { q: "The root 'photo' means...", a: ["Light", "Picture", "Sound", "Star"], c: "Light", ex: "Examples: Photograph, Photosynthesis." },
    { q: "The root 'tele' means...", a: ["Far/Distance", "Near", "Self", "Time"], c: "Far/Distance", ex: "Examples: Telescope, Television." },
    { q: "The root 'chron' means...", a: ["Time", "Color", "Head", "Water"], c: "Time", ex: "Examples: Chronological, Synchronize." },
    { q: "The root 'auto' means...", a: ["Self", "Other", "Car", "Automatic"], c: "Self", ex: "Examples: Autobiography, Automobile." },
    { q: "The root 'bene' means...", a: ["Good", "Bad", "Small", "Big"], c: "Good", ex: "Examples: Benefit, Benevolent." },
    { q: "The root 'mal' means...", a: ["Bad", "Good", "Male", "Hammer"], c: "Bad", ex: "Examples: Malicious, Malfunction." },
    { q: "The suffix '-ology' means...", a: ["Study of", "Person who", "Fear of", "Full of"], c: "Study of", ex: "Examples: Biology, Geology." },
    { q: "The suffix '-phobia' means...", a: ["Fear of", "Love of", "Study of", "Made of"], c: "Fear of", ex: "Examples: Arachnophobia, Claustrophobia." },
    { q: "The prefix 're-' means...", a: ["Again", "Not", "Before", "After"], c: "Again", ex: "Examples: Redo, Return." },
    { q: "The prefix 'anti-' means...", a: ["Against", "Before", "Small", "Self"], c: "Against", ex: "Examples: Antibiotic, Antifreeze." },
    { q: "The prefix 'inter-' means...", a: ["Between", "Inside", "Over", "Under"], c: "Between", ex: "Examples: Interstate, Interaction." },
    { q: "The prefix 'post-' means...", a: ["After", "Before", "During", "Against"], c: "After", ex: "Examples: Postgame, Postpone." },
    { q: "Which word means 'to break into parts and examine'?", a: ["Analyze", "Summarize", "Infer", "Predict"], c: "Analyze", ex: "Analysis involves looking at the pieces." },

    // --- FIGURATIVE LANGUAGE & DEVICES II (15 Questions) ---
    { q: "A humorous imitation of a serious work is a...", a: ["Parody", "Satire", "Allegory", "Fable"], c: "Parody", ex: "Parodies exaggerate for comic effect." },
    { q: "The use of humor to criticize stupidity or vices is...", a: ["Satire", "Parody", "Irony", "Metaphor"], c: "Satire", ex: "Satire is often used in political cartoons." },
    { q: "A distinct pause or break in a line of poetry is a...", a: ["Caesura", "Stanza", "Meter", "Rhyme"], c: "Caesura", ex: "Often marked by a comma or dash in the middle of a line." },
    { q: "Poetry written without rhyme or meter is...", a: ["Free Verse", "Blank Verse", "Sonnet", "Haiku"], c: "Free Verse", ex: "It mimics natural speech." },
    { q: "A figure of speech where a part represents the whole (e.g., 'Nice wheels')...", a: ["Synecdoche", "Metonymy", "Simile", "Metaphor"], c: "Synecdoche", ex: "Wheels = Car." },
    { q: "Addressing an absent person or object (e.g., 'O Death!')...", a: ["Apostrophe", "Dialogue", "Monologue", "Personification"], c: "Apostrophe", ex: "Talking to something that cannot talk back." },
    { q: "Making something seem less important than it is...", a: ["Understatement", "Hyperbole", "Irony", "Paradox"], c: "Understatement", ex: "Opposite of hyperbole." },
    { q: "A recurring theme or image in a work of literature...", a: ["Motif", "Symbol", "Tone", "Mood"], c: "Motif", ex: "Motifs help develop the theme." },
    { q: "The emotional high point of a story is the...", a: ["Climax", "Resolution", "Exposition", "Falling Action"], c: "Climax", ex: "The turning point." },
    { q: "The villain or force opposing the main character is the...", a: ["Antagonist", "Protagonist", "Sidekick", "Hero"], c: "Antagonist", ex: "The 'bad guy' or obstacle." },
    { q: "A concise statement of a truth or principle (e.g. 'Haste makes waste')...", a: ["Aphorism", "Idiom", "Metaphor", "Simile"], c: "Aphorism", ex: "Short, wise sayings." },
    { q: "The dictionary definition of a word is its...", a: ["Denotation", "Connotation", "Implication", "Inference"], c: "Denotation", ex: "Literal meaning." },
    { q: "The implied or emotional meaning of a word is its...", a: ["Connotation", "Denotation", "Definition", "Spelling"], c: "Connotation", ex: "Associations beyond the dictionary definition." },
    { q: "A long speech by one actor in a play or movie is a...", a: ["Monologue", "Dialogue", "Soliloquy", "Aside"], c: "Monologue", ex: "Addressed to other characters or the audience." },
    { q: "A contrast between what is expected and what happens is...", a: ["Irony", "Symbolism", "Theme", "Tone"], c: "Irony", ex: "Situational irony." },
    // --- GRAMMAR EXPANSION (20 QUESTIONS) ---
    { q: "A word that joins words or phrases (e.g., and, but, or) is a...", a: ["Conjunction", "Preposition", "Interjection", "Adverb"], c: "Conjunction", ex: "Conjunctions connect ideas." },
    { q: "A word that expresses strong emotion (e.g., Wow! Ouch!) is an...", a: ["Interjection", "Conjunction", "Noun", "Verb"], c: "Interjection", ex: "Interjections are often followed by an exclamation point." },
    { q: "A word that shows position or direction (e.g., in, on, under) is a...", a: ["Preposition", "Adverb", "Adjective", "Noun"], c: "Preposition", ex: "Prepositions show the relationship between a noun and another word." },
    { q: "A sentence with one independent clause is a...", a: ["Simple Sentence", "Compound Sentence", "Complex Sentence", "Fragment"], c: "Simple Sentence", ex: "Example: 'The dog barked.'" },
    { q: "A sentence with an independent clause and a dependent clause is...", a: ["Complex", "Compound", "Simple", "Run-on"], c: "Complex", ex: "Example: 'Because I was late, I ran.'" },
    { q: "Identify the subject: 'The bright red ball rolled away.'", a: ["ball", "red", "rolled", "The"], c: "ball", ex: "The ball is what the sentence is about." },
    { q: "Identify the predicate: 'The birds flew south.'", a: ["flew south", "The birds", "birds", "The"], c: "flew south", ex: "The predicate tells what the subject did." },
    { q: "Which punctuation mark joins two independent clauses?", a: ["Semicolon ;", "Comma ,", "Colon :", "Hyphen -"], c: "Semicolon ;", ex: "A semicolon can replace a period between related sentences." },
    { q: "Which sentence is written in Passive Voice?", a: ["The cake was eaten by the boy.", "The boy ate the cake.", "The boy likes cake.", "He eats cake."], c: "The cake was eaten by the boy.", ex: "In passive voice, the subject receives the action." },
    { q: "Which is a plural noun?", a: ["Geese", "Goose", "Mouse", "Person"], c: "Geese", ex: "Geese is the plural of Goose." },
    { q: "Which is a proper noun?", a: ["Chicago", "city", "town", "village"], c: "Chicago", ex: "Proper nouns name specific places and are capitalized." },
    { q: "A fragment is a...", a: ["Incomplete sentence", "Complete sentence", "Run-on", "Paragraph"], c: "Incomplete sentence", ex: "Fragments lack a subject, a verb, or a complete thought." },
    { q: "What is the past tense of 'run'?", a: ["Ran", "Runned", "Running", "Runs"], c: "Ran", ex: "Run is an irregular verb." },
    { q: "Identify the adjective: 'The furry dog barked.'", a: ["furry", "dog", "barked", "The"], c: "furry", ex: "Furry describes the noun 'dog'." },
    { q: "Identify the adverb: 'She sang beautifully.'", a: ["beautifully", "sang", "She", "song"], c: "beautifully", ex: "Beautifully describes how she sang." },
    { q: "'Your' and 'My' are examples of...", a: ["Possessive Pronouns", "Action Verbs", "Proper Nouns", "Adverbs"], c: "Possessive Pronouns", ex: "They show ownership." },
    { q: "What is the contraction for 'will not'?", a: ["Won't", "Willn't", "Wont", "Win't"], c: "Won't", ex: "Won't is a unique contraction." },
    { q: "A sentence that asks a question is...", a: ["Interrogative", "Declarative", "Imperative", "Exclamatory"], c: "Interrogative", ex: "Interrogative sentences end with a question mark." },
    { q: "Which word should be capitalized?", a: ["Tuesday", "day", "week", "month"], c: "Tuesday", ex: "Days of the week are proper nouns." },
    { q: "Identify the direct object: 'He kicked the ball.'", a: ["ball", "kicked", "He", "the"], c: "ball", ex: "The ball received the action of the kick." },

    // --- STORY ELEMENTS EXPANSION (20 QUESTIONS) ---
    { q: "A character that changes significantly is...", a: ["Dynamic", "Static", "Flat", "Minor"], c: "Dynamic", ex: "Dynamic characters grow and change throughout the story." },
    { q: "A character that stays the same is...", a: ["Static", "Dynamic", "Round", "Protagonist"], c: "Static", ex: "Static characters do not change." },
    { q: "A fully developed, complex character is...", a: ["Round", "Flat", "Stock", "Static"], c: "Round", ex: "Round characters have many traits and layers." },
    { q: "A simple, one-dimensional character is...", a: ["Flat", "Round", "Dynamic", "Major"], c: "Flat", ex: "Flat characters usually have only one trait." },
    { q: "The introduction of the setting and characters is the...", a: ["Exposition", "Climax", "Resolution", "Falling Action"], c: "Exposition", ex: "Exposition sets the stage for the story." },
    { q: "The event that starts the conflict is the...", a: ["Inciting Incident", "Climax", "Resolution", "Conclusion"], c: "Inciting Incident", ex: "This kicks off the rising action." },
    { q: "Events leading up to the climax are the...", a: ["Rising Action", "Falling Action", "Exposition", "Resolution"], c: "Rising Action", ex: "Tension builds during the rising action." },
    { q: "Events following the climax are the...", a: ["Falling Action", "Rising Action", "Exposition", "Inciting Incident"], c: "Falling Action", ex: "Loose ends begin to tie up." },
    { q: "The final outcome of the story is the...", a: ["Resolution", "Climax", "Conflict", "Hook"], c: "Resolution", ex: "Also called the Denouement." },
    { q: "A struggle within a character's mind is...", a: ["Internal Conflict", "External Conflict", "Climax", "Theme"], c: "Internal Conflict", ex: "Character vs. Self is internal." },
    { q: "A struggle against an outside force is...", a: ["External Conflict", "Internal Conflict", "Resolution", "Theme"], c: "External Conflict", ex: "Character vs. Nature/Society/Character." },
    { q: "When a story interrupts the present to show the past...", a: ["Flashback", "Foreshadowing", "Irony", "Dialogue"], c: "Flashback", ex: "Flashbacks give background information." },
    { q: "The narrator knows the thoughts of ALL characters...", a: ["Third Person Omniscient", "Third Person Limited", "First Person", "Second Person"], c: "Third Person Omniscient", ex: "Omniscient means 'all-knowing'." },
    { q: "The narrator knows the thoughts of ONE character...", a: ["Third Person Limited", "Third Person Omniscient", "First Person", "Objective"], c: "Third Person Limited", ex: "We only see the world through one character's eyes." },
    { q: "The narrator uses 'I' and 'Me'...", a: ["First Person", "Third Person", "Second Person", "Omniscient"], c: "First Person", ex: "The narrator is a character in the story." },
    { q: "The narrator uses 'You'...", a: ["Second Person", "First Person", "Third Person", "Omniscient"], c: "Second Person", ex: "Rare in fiction, common in instructions." },
    { q: "The emotional atmosphere of a story is the...", a: ["Mood", "Tone", "Theme", "Plot"], c: "Mood", ex: "Mood is how the reader feels." },
    { q: "The author's attitude toward the subject is the...", a: ["Tone", "Mood", "Style", "Voice"], c: "Tone", ex: "Tone can be serious, sarcastic, playful, etc." },
    { q: "A concrete object representing an abstract idea is a...", a: ["Symbol", "Metaphor", "Simile", "Prop"], c: "Symbol", ex: "A broken mirror might symbolize bad luck." },
    { q: "Conversation between characters is...", a: ["Dialogue", "Monologue", "Narrative", "Exposition"], c: "Dialogue", ex: "Dialogue is usually marked by quotation marks." },

    // --- LITERARY DEVICES EXPANSION (20 QUESTIONS) ---
    { q: "A common expression not meant literally (e.g. 'Break a leg') is an...", a: ["Idiom", "Metaphor", "Simile", "Allusion"], c: "Idiom", ex: "Idioms are phrases with cultural meanings." },
    { q: "When the audience knows something the characters don't...", a: ["Dramatic Irony", "Verbal Irony", "Situational Irony", "Coincidence"], c: "Dramatic Irony", ex: "Common in horror movies and plays." },
    { q: "When the outcome is the opposite of what is expected...", a: ["Situational Irony", "Dramatic Irony", "Verbal Irony", "Sarcasm"], c: "Situational Irony", ex: "Example: A fire station burning down." },
    { q: "Saying one thing but meaning the opposite...", a: ["Verbal Irony", "Dramatic Irony", "Situational Irony", "Metaphor"], c: "Verbal Irony", ex: "Sarcasm is a form of verbal irony." },
    { q: "A recurring element that has symbolic significance...", a: ["Motif", "Theme", "Plot", "Setting"], c: "Motif", ex: "Example: Repeated mentions of 'sight' in a story." },
    { q: "A polite word used in place of a harsh one...", a: ["Euphemism", "Oxymoron", "Hyperbole", "Idiom"], c: "Euphemism", ex: "Example: 'Passed away' instead of 'died'." },
    { q: "A warning or indication of a future event...", a: ["Foreshadowing", "Flashback", "Irony", "Symbolism"], c: "Foreshadowing", ex: "Hints at what is to come." },
    { q: "Comparing two unlike things at length...", a: ["Extended Metaphor", "Simile", "Hyperbole", "Idiom"], c: "Extended Metaphor", ex: "A metaphor that continues for several lines." },
    { q: "The juxtaposition of contrasting ideas in balanced phrases...", a: ["Antithesis", "Oxymoron", "Paradox", "Repetition"], c: "Antithesis", ex: "Example: 'It was the best of times, it was the worst of times.'" },
    { q: "An overused phrase or idea...", a: ["Cliché", "Idiom", "Metaphor", "Theme"], c: "Cliché", ex: "Example: 'Happily ever after.'" },
    { q: "Two opposite terms joined together...", a: ["Oxymoron", "Paradox", "Antonym", "Synonym"], c: "Oxymoron", ex: "Example: 'Bittersweet'." },
    { q: "A play on words...", a: ["Pun", "Joke", "Riddle", "Rhyme"], c: "Pun", ex: "Puns rely on words with multiple meanings." },
    { q: "Giving human traits to animals or objects...", a: ["Anthropomorphism", "Imagery", "Simile", "Metaphor"], c: "Anthropomorphism", ex: "Like the characters in 'Zootopia'." },
    { q: "A speech given by one character alone on stage...", a: ["Soliloquy", "Dialogue", "Chorus", "Aside"], c: "Soliloquy", ex: "Reveals the character's inner thoughts." },
    { q: "A brief remark made to the audience, unheard by other characters...", a: ["Aside", "Soliloquy", "Dialogue", "Monologue"], c: "Aside", ex: "Breaks the fourth wall." },
    { q: "Repetition of a word at the beginning of clauses...", a: ["Anaphora", "Alliteration", "Rhyme", "Epistrophe"], c: "Anaphora", ex: "Example: 'I have a dream... I have a dream...'" },
    { q: "The dictionary definition of a word...", a: ["Denotation", "Connotation", "Definition", "Meaning"], c: "Denotation", ex: "The literal meaning." },
    { q: "The feelings associated with a word...", a: ["Connotation", "Denotation", "Tone", "Mood"], c: "Connotation", ex: "Example: 'Cheap' vs 'Frugal'." },
    { q: "Descriptive language appealing to the senses...", a: ["Imagery", "Symbolism", "Theme", "Plot"], c: "Imagery", ex: "Visual, auditory, tactile, etc." },
    { q: "A story with a hidden moral or political meaning...", a: ["Allegory", "Myth", "Fable", "Legend"], c: "Allegory", ex: "Example: 'Animal Farm'." },

    // --- VOCABULARY & SPELLING EXPANSION (20 QUESTIONS) ---
    { q: "Words that sound the same but have different spellings/meanings...", a: ["Homophones", "Homonyms", "Synonyms", "Antonyms"], c: "Homophones", ex: "Example: Flower and Flour." },
    { q: "Correct usage: 'They went over ___.'", a: ["There", "Their", "They're", "Thear"], c: "There", ex: "There indicates a place." },
    { q: "Correct usage: '___ going to the park.'", a: ["They're", "Their", "There", "Their's"], c: "They're", ex: "Contraction for 'They are'." },
    { q: "Correct usage: 'That is ___ car.'", a: ["Their", "There", "They're", "There's"], c: "Their", ex: "Their shows possession." },
    { q: "Which prefix means 'before'?", a: ["Pre-", "Re-", "Un-", "Dis-"], c: "Pre-", ex: "Example: Preview, Prefix." },
    { q: "Which suffix means 'one who does'?", a: ["-er", "-tion", "-ness", "-ly"], c: "-er", ex: "Example: Teacher, Baker." },
    { q: "Which root word means 'life'?", a: ["Bio", "Geo", "Graph", "Phon"], c: "Bio", ex: "Example: Biology, Biography." },
    { q: "Which root word means 'earth'?", a: ["Geo", "Bio", "Therm", "Photo"], c: "Geo", ex: "Example: Geography, Geology." },
    { q: "Correct usage: 'You are ___ than me.'", a: ["Taller", "More tall", "Tallest", "Most tall"], c: "Taller", ex: "Use -er for comparing two things." },
    { q: "Correct usage: 'She is the ___ student.'", a: ["Smartest", "Smarter", "Most smart", "More smart"], c: "Smartest", ex: "Use -est for comparing three or more." },
    { q: "Which is a synonym for 'fast'?", a: ["Rapid", "Slow", "Steady", "Heavy"], c: "Rapid", ex: "Rapid means moving with speed." },
    { q: "Which is an antonym for 'benevolent'?", a: ["Cruel", "Kind", "Nice", "Generous"], c: "Cruel", ex: "Benevolent means kind; Cruel is the opposite." },
    { q: "To 'cite' a source means to...", a: ["Give credit", "Ignore it", "Copy it", "Delete it"], c: "Give credit", ex: "Citing shows where you found information." },
    { q: "Plagiarism is...", a: ["Copying without credit", "Writing a story", "Citing sources", "Reading a book"], c: "Copying without credit", ex: "Plagiarism is stealing ideas." },
    { q: "Which word is spelled correctly?", a: ["Accommodate", "Acommodate", "Accomodate", "Acomodate"], c: "Accommodate", ex: "Two Cs, Two Ms." },
    { q: "Which word is spelled correctly?", a: ["Tomorrow", "Tommorow", "Tommorrow", "Tomorow"], c: "Tomorrow", ex: "One M, Two Rs." },
    { q: "Which word is spelled correctly?", a: ["Restaurant", "Restarant", "Resteraunt", "Resturant"], c: "Restaurant", ex: "Remember: A-U (ant) is in the restaurant." },
    { q: "The origin of a word is its...", a: ["Etymology", "Definition", "Phonetics", "Grammar"], c: "Etymology", ex: "Etymology studies word history." },
    { q: "Using context clues helps you...", a: ["Define unknown words", "Write faster", "Spell better", "Rhyme"], c: "Define unknown words", ex: "Look at the surrounding words for hints." },
    { q: "Which is a compound word?", a: ["Toothbrush", "Tooth", "Brush", "Teeth"], c: "Toothbrush", ex: "Two words combined to make one." },
    // --- POETRY EXPANSION (50 QUESTIONS) ---
    { q: "What is a group of lines in a poem called?", a: ["Stanza", "Paragraph", "Chapter", "Verse"], c: "Stanza", ex: "A stanza is like a paragraph in poetry." },
    { q: "Poetry that does not have a regular rhythm or rhyme scheme is called...", a: ["Free Verse", "Blank Verse", "Haiku", "Sonnet"], c: "Free Verse", ex: "Free verse follows the natural rhythms of speech." },
    { q: "A two-line stanza that usually rhymes is a...", a: ["Couplet", "Triplet", "Quatrain", "Sestet"], c: "Couplet", ex: "A couplet is a pair of lines, often rhyming." },
    { q: "The repetition of vowel sounds within words (e.g. 'rise high in the bright sky') is...", a: ["Assonance", "Consonance", "Alliteration", "Rhyme"], c: "Assonance", ex: "Assonance is the repetition of vowel sounds." },
    { q: "The repetition of consonant sounds at the ends of words (e.g. 'stroke of luck') is...", a: ["Consonance", "Assonance", "Alliteration", "Rhythm"], c: "Consonance", ex: "Consonance repeats consonant sounds, often at the end of words." },
    { q: "A four-line stanza is called a...", a: ["Quatrain", "Couplet", "Cinquain", "Octave"], c: "Quatrain", ex: "Quatrains are the most common stanza form." },
    { q: "What is the 'beat' or rhythmic pattern of a poem called?", a: ["Meter", "Rhyme", "Tone", "Mood"], c: "Meter", ex: "Meter is the structured rhythm of a poem." },
    { q: "A Japanese poem with 3 lines and a 5-7-5 syllable structure is a...", a: ["Haiku", "Tanka", "Limerick", "Sonnet"], c: "Haiku", ex: "Haikus focus on nature and a specific moment in time." },
    { q: "A humorous 5-line poem with an AABBA rhyme scheme is a...", a: ["Limerick", "Ballad", "Ode", "Elegy"], c: "Limerick", ex: "Limericks are funny and have a bouncy rhythm." },
    { q: "A poem that tells a story is called a...", a: ["Narrative Poem", "Lyrical Poem", "Concrete Poem", "Haiku"], c: "Narrative Poem", ex: "Narrative poems have characters, a plot, and a setting." },
    { q: "A poem that expresses personal emotions or feelings is a...", a: ["Lyrical Poem", "Narrative Poem", "Epic", "Ballad"], c: "Lyrical Poem", ex: "Lyrical poetry focuses on the speaker's emotions." },
    { q: "A long narrative poem about the deeds of a hero is an...", a: ["Epic", "Elegy", "Ode", "Sonnet"], c: "Epic", ex: " Examples include 'The Odyssey' and 'The Iliad'." },
    { q: "A poem written in the shape of its subject is a...", a: ["Concrete Poem", "Haiku", "Limerick", "Free Verse"], c: "Concrete Poem", ex: "In concrete poetry, the visual shape matches the topic." },
    { q: "What is the 'voice' that talks to the reader in a poem?", a: ["Speaker", "Author", "Narrator", "Protagonist"], c: "Speaker", ex: "In poetry, we say 'Speaker' instead of narrator." },
    { q: "A 14-line poem, often written in iambic pentameter, is a...", a: ["Sonnet", "Ballad", "Ode", "Villanelle"], c: "Sonnet", ex: "Shakespeare is famous for writing sonnets." },
    { q: "Lines of poetry are often grouped into...", a: ["Stanzas", "Sentences", "Paragraphs", "Chapters"], c: "Stanzas", ex: "Stanzas provide structure to a poem." },
    { q: "When a line of poetry continues to the next line without punctuation, it is...", a: ["Enjambment", "End-stopped", "Caesura", "Stanza"], c: "Enjambment", ex: "Enjambment creates a flowing effect." },
    { q: "A pause within a line of poetry is called a...", a: ["Caesura", "Stop", "Break", "Halt"], c: "Caesura", ex: "A caesura is often marked by punctuation in the middle of a line." },
    { q: "What is the pattern of rhymes at the end of the lines called?", a: ["Rhyme Scheme", "Rhythm", "Meter", "Flow"], c: "Rhyme Scheme", ex: "Rhyme schemes are labeled with letters (e.g., ABAB)." },
    { q: "A poem that praises a person, place, or thing is an...", a: ["Ode", "Elegy", "Epic", "Ballad"], c: "Ode", ex: "Odes are serious poems of tribute." },
    { q: "A sad poem written to mourn the dead is an...", a: ["Elegy", "Ode", "Limerick", "Sonnet"], c: "Elegy", ex: "Elegies express grief and sorrow." },
    { q: "Words that rhyme within a single line of poetry are called...", a: ["Internal Rhyme", "End Rhyme", "Slant Rhyme", "Eye Rhyme"], c: "Internal Rhyme", ex: "Example: 'Once upon a midnight dreary, while I pondered, weak and weary.'" },
    { q: "Rhymes that are not perfect but close in sound (e.g., 'shape/keep') are...", a: ["Slant Rhyme", "Perfect Rhyme", "Internal Rhyme", "Rich Rhyme"], c: "Slant Rhyme", ex: "Also called near rhyme or half rhyme." },
    { q: "A phrase or line repeated at intervals within a poem is a...", a: ["Refrain", "Chorus", "Stanza", "Couplet"], c: "Refrain", ex: "Refrains are common in ballads and songs." },
    { q: "A poem with 5 lines and a 2-4-6-8-2 syllable structure is a...", a: ["Cinquain", "Haiku", "Limerick", "Tanka"], c: "Cinquain", ex: "Cinquains are distinct from Limericks due to their syllable count." },
    { q: "Poetry written in unrhymed iambic pentameter is...", a: ["Blank Verse", "Free Verse", "Prose", "Rhyme"], c: "Blank Verse", ex: "Shakespeare's plays are mostly written in Blank Verse." },
    { q: "The dictionary definition of a word is its...", a: ["Denotation", "Connotation", "Symbolism", "Theme"], c: "Denotation", ex: "Denotation is the literal meaning." },
    { q: "The emotional feeling attached to a word is its...", a: ["Connotation", "Denotation", "Definition", "Syntax"], c: "Connotation", ex: "Home suggests warmth (connotation), not just a house (denotation)." },
    { q: "A reference to a well-known person, place, or event is an...", a: ["Allusion", "Illusion", "Allegory", "Alliteration"], c: "Allusion", ex: "Example: 'He was a real Romeo with the ladies.'" },
    { q: "Using an object to represent a larger idea is...", a: ["Symbolism", "Imagery", "Metaphor", "Simile"], c: "Symbolism", ex: "A dove often symbolizes peace." },
    { q: "Language that appeals to the five senses is...", a: ["Imagery", "Description", "Exposition", "Dialect"], c: "Imagery", ex: "Imagery helps the reader see, hear, smell, taste, or feel the scene." },
    { q: "A comparison using 'like' or 'as' is a...", a: ["Simile", "Metaphor", "Personification", "Hyperbole"], c: "Simile", ex: "Example: 'Fast as a cheetah.'" },
    { q: "A direct comparison NOT using 'like' or 'as' is a...", a: ["Metaphor", "Simile", "Analogy", "Allusion"], c: "Metaphor", ex: "Example: 'The classroom was a zoo.'" },
    { q: "Giving human qualities to non-human things is...", a: ["Personification", "Anthropomorphism", "Imagery", "Metaphor"], c: "Personification", ex: "Example: 'The wind howled.'" },
    { q: "Extreme exaggeration for effect is...", a: ["Hyperbole", "Understatement", "Irony", "Paradox"], c: "Hyperbole", ex: "Example: 'I've told you a million times.'" },
    { q: "The repetition of initial consonant sounds is...", a: ["Alliteration", "Assonance", "Rhyme", "Repetition"], c: "Alliteration", ex: "Example: 'Peter Piper picked a peck...'" },
    { q: "A word that imitates a sound is...", a: ["Onomatopoeia", "Alliteration", "Echo", "Noise"], c: "Onomatopoeia", ex: "Example: 'Buzz', 'Crash', 'Boom'." },
    { q: "The writer's attitude toward the subject is the...", a: ["Tone", "Mood", "Theme", "Style"], c: "Tone", ex: "Tone can be sarcastic, serious, humorous, etc." },
    { q: "The atmosphere or feeling created for the reader is the...", a: ["Mood", "Tone", "Setting", "Plot"], c: "Mood", ex: "Mood is how the poem makes YOU feel." },
    { q: "A poem where the first letters of each line spell a word is an...", a: ["Acrostic", "Haiku", "Sonnet", "Ballad"], c: "Acrostic", ex: "Acrostics are a form of puzzle poetry." },
    { q: "A song-like poem that tells a story, often about romance or adventure, is a...", a: ["Ballad", "Dirge", "Epic", "Ode"], c: "Ballad", ex: "Ballads often have a repeating refrain." },
    { q: "What type of rhyme occurs at the end of lines?", a: ["End Rhyme", "Internal Rhyme", "Slant Rhyme", "Rich Rhyme"], c: "End Rhyme", ex: "This is the most common type of rhyming." },
    { q: "A unit of rhythm in poetry, the pattern of the beats, is called a...", a: ["Foot", "Inch", "Meter", "Beat"], c: "Foot", ex: "An iamb is a type of foot." },
    { q: "Verse that sounds like everyday speech is...", a: ["Prose", "Poetry", "Stanza", "Rhyme"], c: "Prose", ex: "Prose is written in sentences and paragraphs, not stanzas." },
    { q: "The central message or lesson of a poem is the...", a: ["Theme", "Topic", "Subject", "Moral"], c: "Theme", ex: "Theme is the deeper meaning." },
    { q: "A play on words, often for humorous effect, is a...", a: ["Pun", "Joke", "Idiom", "Simile"], c: "Pun", ex: "Example: 'A boiled egg every morning is hard to beat.'" },
    { q: "A contradiction that reveals a truth is a...", a: ["Paradox", "Oxymoron", "Lie", "Hyperbole"], c: "Paradox", ex: "Example: 'Less is more.'" },
    { q: "Two opposite words placed side by side is an...", a: ["Oxymoron", "Paradox", "Antonym", "Synonym"], c: "Oxymoron", ex: "Example: 'Jumbo shrimp' or 'Deafening silence.'" },
    { q: "A 3-line poem with 5-7-5 syllables is a...", a: ["Haiku", "Limerick", "Sonnet", "Couplet"], c: "Haiku", ex: "Haikus originated in Japan." },
    { q: "Which of these is a sound device?", a: ["Alliteration", "Metaphor", "Symbolism", "Theme"], c: "Alliteration", ex: "Alliteration deals with the sound of words." },
        { q: "Which word is a synonym for 'happy'?", a: ["Joyful", "Sad", "Angry", "Tired"], c: "Joyful", ex: "'Joyful' means full of happiness." },
        { q: "What opposes the protagonist?", a: ["Antagonist", "Ally", "Narrator", "Mentor"], c: "Antagonist", ex: "The Antagonist is the force working against the main character." },
        { q: "Identify the verb: 'The cat quickly climbed the tree.'", a: ["climbed", "quickly", "cat", "tree"], c: "climbed", ex: "A verb is an action word. 'Climbed' is the action." },
        { q: "'The wind whispered' is an example of...?", a: ["Personification", "Metaphor", "Simile", "Hyperbole"], c: "Personification", ex: "Personification gives human qualities (whispering) to non-human things." },
        { q: "Which word is an antonym for 'begin'?", a: ["Finish", "Start", "Create", "Open"], c: "Finish", ex: "Antonyms are opposites. Finish is the opposite of Begin." },
        { q: "Which is spelled correctly?", a: ["Definitely", "Definately", "Definitly", "Definantly"], c: "Definitely", ex: "Remember: De-finite-ly." },
        { q: "What is the main idea of a story?", a: ["Theme", "Plot", "Setting", "Conflict"], c: "Theme", ex: "The Theme is the central message or lesson of the story." },
        { q: "'As brave as a lion' is an example of...?", a: ["Simile", "Metaphor", "Allusion", "Irony"], c: "Simile", ex: "Similes compare two things using the words 'like' or 'as'." },
        { q: "Choose the correct pronoun: '___ and I went to the store.'", a: ["He", "Him", "His", "Them"], c: "He", ex: "Use the subject pronoun 'He' when it is doing the action." },
        { q: "Which sentence is a compound sentence?", a: ["I like pizza, and I like tacos.", "I like pizza.", "Because I like pizza, I ate it.", "I like pizza, tacos, and burgers."], c: "I like pizza, and I like tacos.", ex: "A compound sentence joins two independent clauses with a conjunction (and)." },
        { q: "What is an 'adjective'?", a: ["A word that describes a noun", "A word for an action", "A person, place, or thing", "A word that describes a verb"], c: "A word that describes a noun", ex: "Adjectives describe or modify nouns (e.g., 'blue' sky)." },
        { q: "Which of these is NOT a genre of literature?", a: ["Mathematics", "Fantasy", "Mystery", "Biography"], c: "Mathematics", ex: "Mathematics is a subject of study, not a literary genre." },
        { q: "'Her smile is the sun' is an example of...?", a: ["Metaphor", "Simile", "Personification", "Hyperbole"], c: "Metaphor", ex: "A metaphor compares two things directly without using 'like' or 'as'." },
        { q: "Find the error: 'Their going to the park.'", a: ["Their", "going", "to", "park"], c: "Their", ex: "It should be 'They're' (They are). 'Their' shows possession." },
        { q: "What is the climax of a story?", a: ["The most exciting point", "The beginning", "The ending", "The setting"], c: "The most exciting point", ex: "The climax is the turning point or moment of highest tension." },
        { q: "Which is spelled correctly?", a: ["Receive", "Recieve", "Reiceve", "Receeve"], c: "Receive", ex: "The rule is 'I before E, except after C'." },
        { q: "What is an adverb?", a: ["A word describing a verb", "A word describing a noun", "A short exclamation", "A connecting word"], c: "A word describing a verb", ex: "Adverbs modify verbs, adjectives, or other adverbs (often ending in -ly)." },
        { q: "What type of conflict is a character struggling against nature?", a: ["Character vs. Nature", "Character vs. Self", "Character vs. Society", "Character vs. Character"], c: "Character vs. Nature", ex: "This conflict involves a struggle against forces like storms or animals." },
        { q: "Which punctuation mark ends a question?", a: ["?", ".", "!", ","], c: "?", ex: "A question mark is used at the end of an interrogative sentence." },
        { q: "An 'allusion' in literature is...", a: ["A reference to another work", "An illusion or trick", "The main character's goal", "A type of rhyme"], c: "A reference to another work", ex: "An allusion is a brief reference to a person, place, or thing in history/literature." },
        { q: "Which word is a synonym for 'brave'?", a: ["Courageous", "Cowardly", "Meek", "Timid"], c: "Courageous", ex: "Courageous and brave both mean ready to face danger." },
        { q: "What is a 'protagonist'?", a: ["The main character", "The villain", "The narrator", "A side character"], c: "The main character", ex: "The protagonist is the leading character of a story." },
        { q: "'The car engine coughed and sputtered' is an example of...?", a: ["Personification", "Simile", "Metaphor", "Onomatopoeia"], c: "Personification", ex: "Engines can't actually cough; that is a human trait." },
        { q: "Which is spelled correctly?", a: ["Separate", "Seperate", "Saperate", "Seperete"], c: "Separate", ex: "Remember: There is 'a rat' in sep-a-rat-e." },
        { q: "A 'biography' is a story of a person's life written by...", a: ["Someone else", "The person themselves", "A novelist", "An unknown author"], c: "Someone else", ex: "If they wrote it themselves, it would be an autobiography." },
        { q: "What is the setting of a story?", a: ["When and where it takes place", "The main problem", "The list of characters", "The lesson learned"], c: "When and where it takes place", ex: "Setting includes both the time period and the physical location." },
        { q: "Which word is an antonym for 'ancient'?", a: ["Modern", "Old", "Aged", "Past"], c: "Modern", ex: "Ancient means very old; Modern means new or recent." },
        { q: "'The world is a stage' is an example of...?", a: ["Metaphor", "Simile", "Alliteration", "Irony"], c: "Metaphor", ex: "It compares the world to a stage directly." },
        { q: "What is the correct use of 'its' and 'it's'?", a: ["It's a beautiful day.", "The dog wagged its tail.", "Both are correct", "Both are incorrect"], c: "Both are correct", ex: "'It's' means 'It is'. 'Its' shows possession." },
        { q: "Identify the noun: 'The quick brown fox jumps.'", a: ["fox", "quick", "brown", "jumps"], c: "fox", ex: "A noun is a person, place, or thing. A fox is a thing." },
        { q: "What does 'hyperbole' mean?", a: ["Exaggeration for effect", "A comparison using 'like'", "Giving human qualities to objects", "A question with no answer"], c: "Exaggeration for effect", ex: "Hyperbole is extreme exaggeration not meant to be taken literally." },
        { q: "'I'm so hungry I could eat a horse' is an example of...?", a: ["Hyperbole", "Simile", "Understatement", "Irony"], c: "Hyperbole", ex: "You cannot actually eat a horse; it is an exaggeration." },
        { q: "Which is spelled correctly?", a: ["Necessary", "Necesary", "Neccessary", "Necassary"], c: "Necessary", ex: "One C, two S's. It is necessary to remember that." },
        { q: "A story's sequence of events is its...", a: ["Plot", "Theme", "Setting", "Character arc"], c: "Plot", ex: "The Plot is the organized pattern or sequence of events." },
        { q: "What is a 'haiku'?", a: ["A three-line poem with a 5-7-5 syllable structure", "A four-line rhyming poem", "A long epic story", "A funny short story"], c: "A three-line poem with a 5-7-5 syllable structure", ex: "Haikus are a traditional Japanese poetic form." },
        { q: "Which word is a synonym for 'look'?", a: ["Gaze", "Speak", "Listen", "Feel"], c: "Gaze", ex: "To gaze means to look steadily and intently." },
        { q: "The perspective from which a story is told is the...", a: ["Point of View", "Climax", "Resolution", "Exposition"], c: "Point of View", ex: "POV determines who is narrating (First person, Third person, etc)." },
        { q: "What is the correct spelling?", a: ["Conscience", "Concience", "Consience", "Conscence"], c: "Conscience", ex: "Think of it as 'Con-science'." },
        { q: "The struggle between opposing forces in a story is the...", a: ["Conflict", "Theme", "Setting", "Dialogue"], c: "Conflict", ex: "Conflict drives the plot forward." },
        { q: "'The buzzing bee flew by' is an example of...?", a: ["Onomatopoeia", "Metaphor", "Simile", "Allusion"], c: "Onomatopoeia", ex: "Buzz is a word that imitates the sound it describes." },
        { q: "What is a 'verb'?", a: ["An action or state of being", "A person, place, or thing", "A descriptive word", "A connecting word"], c: "An action or state of being", ex: "Verbs describe what the subject is doing or being." },
        { q: "Which word is an antonym of 'difficult'?", a: ["Easy", "Hard", "Challenging", "Complex"], c: "Easy", ex: "Easy is the opposite of difficult." },
        { q: "What does the prefix 'un-' mean in 'unhappy'?", a: ["Not", "Very", "Again", "Before"], c: "Not", ex: "The prefix 'un-' usually means 'not' or 'opposite of'." },
        { q: "What is the correct spelling?", a: ["Embarrass", "Embarass", "Embarras", "Embaras"], c: "Embarrass", ex: "Two R's and two S's." },
        { q: "A 'sonnet' is a poem of...", a: ["14 lines", "10 lines", "20 lines", "5 lines"], c: "14 lines", ex: "Sonnets are 14-line poems, often associated with Shakespeare." },
        { q: "What type of sentence makes a command?", a: ["Imperative", "Declarative", "Interrogative", "Exclamatory"], c: "Imperative", ex: "Imperative sentences give orders or requests." },
        { q: "'Peter Piper picked a peck of pickled peppers' is an example of...?", a: ["Alliteration", "Assonance", "Metaphor", "Simile"], c: "Alliteration", ex: "Alliteration is the repetition of the first consonant sound (P)." },
        { q: "Which word is a synonym for 'big'?", a: ["Enormous", "Tiny", "Small", "Weak"], c: "Enormous", ex: "Enormous means very large." },
        { q: "A hint or clue about what will happen later in a story is...", a: ["Foreshadowing", "Flashback", "Symbolism", "Imagery"], c: "Foreshadowing", ex: "Foreshadowing gives the reader a hint of future events." },
        { q: "What is the correct spelling?", a: ["Weird", "Wierd", "Wiered", "Weired"], c: "Weird", ex: "Weird is weird because it breaks the 'I before E' rule." },
    ];
    let currentBattle = null;

const sprites = {
    // --- PLAYER OPTIONS ---
    player_bowie: '👨‍🎤', player_green: '🥷', player_boy: '👦', 
    player_girl: '👧', player_dog: '🐶', player_cat: '🐱', 
    
    // --- SAFARI ---
    safariLion: '🦁',
    
    // --- NIGHT EXCLUSIVES ---
    'ink-ling': '💧', 'ink-blot': '⚫', 'ink-cantation': '🧙',
    'whisper-wisp': '👻', 'murmur-mist': '🌫️', 'scream-of-consciousness': '😱',
    'moth-if': '🐛', 'theme-oth': '🦋',
    'owl-literation': '🦉', 'hoot-dunit': '🕵️',
    'crick-it': '🦗', 'cri-tick': '🎭',
    'lun-artic': '🐺', 'grim-reader': '🧟', 'vamp-irony': '🧛',
    'were-word': '🐕', 'star-syntax': '✨', 'shad-ode': '🌑',
    'night-narrator': '🎙️', 'mid-night-oil': '🕯️',

    // --- CREATURES ---
    'fic-tion': '📜', 'novel-lion': '🦁', 'mytho-log': '🪵', 'legend-ary': '🐉',
    'biogra-bee': '🐝', 'auto-biogra-bee': '🤖', 'sci-fi-der': '🕷️', 'fantasy-fox': '🦊',
    'drama-llama': '🦙', 'poetry-can': '🐦',
    synonymouse: '🐭', thesaurusrex: '🦖', wordworm: '🐛', grammargoyle: '🗿', 
    simileslime: '💧', commaleon: '🦎', adjectlizard: '🐊', haikuna: '🦋', 
    metaphorpillar: '🐛', hyperbole: '🐳', pronounprowler: '🐆', verbviper: '🐍', 
    lexiconstruct: '🤖', antonymph: '🧚',
    'rhyth-mite': '🐞', 'vocal-cord': '🎤', 'tempo-toad': '🐸', 
    'choral-reef': '🪸', 'lyrical-loon': '🦆',
    'splash-pup': '🐶', 'tidal-hound': '🐕', 'bubble-bard': '🫧', 'opera-whale': '🐋',
    'coral-scribe': '🦀', 'reef-reader': '🐠', 'fin-fiction': '🦈', 'shark-tale': '🦈',
    'kelp-ie': '🐎', 'squid-pro-quo': '🦑',

    // --- NPCS & OBJECTS ---
    player: '🙂', mom: '👩', professor: '👨‍🏫', rival: '🙎‍♂️', villager: '🧔', villager2: '👵', 
    hiker: '🧗', poeFan: '🧛', nurse: '👩‍⚕️', shopkeep: '🏪', gymLeader: '🏆',
    poet: '✍️', pilot: '👨‍✈️', graduate: '🎓', goblin: '👺', hippie: '☮️', fisherman: '🎣',
    teacher: '👩‍🏫', student: '🎒', shakespeare: '🎭', dickinson: '👒', hughes: '🎷', maya: '📖',

    // --- ITEMS & WORLD ---
    computer: '💻', candy: '🍬', mirror: '🪞', bookworm: '🐛', sign: '🪧', lightbulb: '💡', 
    boulder: '🪨', wordorb: '🔴', tree: '🌲', door: '🚪', bed: '🛏️', tv: '📺', bookshelf: '📚', 
    table: '🪑', dictionary: '📕', palmTree: '🌴', gate: '⛩️', stairsUp: '⏫', 
    ladder: '🪜', flower: '🌻', hole: '🕳️', boat: '🛶', skull: '💀', greenLight: '🟢', wood_floor: '🟫',
    
    // --- SURVIVAL ITEMS ---
    shell: '🐚', sparkle: '✨', ball: '🏐'
};

 const drawSprite = (spriteKey, x, y) => { 
        ctx.fillStyle = '#FFFFFF'; // Reset color to white/default
        ctx.globalAlpha = 1.0;     // FORCE 100% Opacity (Fixes the faintness)
        ctx.font = `${tileSize * 0.8}px serif`; 
        ctx.textAlign = 'center'; 
        ctx.textBaseline = 'middle'; 
        ctx.fillText(sprites[spriteKey], x * tileSize + tileSize / 2, y * tileSize + tileSize / 2); 
    };

const maps = {
    playerRoom: { 
        layout: [
            [1,1,1,1,1,1,1,1],
            [1,22,22,22,22,22,22,1],
            [1,11,0,0,10,0,9,1],
            [1,0,0,0,0,0,0,1],
            [1,22,22,0,0,22,22,1],
            [1,1,1,2,2,1,1,1]
        ], 
        objects: { 
            '4,2': { sprite: 'bed', interaction: handleBedInteraction }, 
            '6,2': { sprite: 'tv', interaction: "'The course of true love never did run smooth.' It's 'A Midsummer Night's Dream.'" }, 
            
            // MIRROR (Change Avatar)
            '1,2': { sprite: 'mirror', interaction: () => {
                showChoices("Change your look?", [
                    { text: "Rock Star (👨‍🎤)", callback: () => { sprites.player = '👨‍🎤'; gameState.player.sprite = 'player_bowie'; draw(); startDialogue("You look fabulous."); } },
                    { text: "Rebel (🧑‍🎤)",    callback: () => { sprites.player = '🧑‍🎤'; gameState.player.sprite = 'player_green'; draw(); startDialogue("Edgy look selected."); } },
                    { text: "Boy (👦)",        callback: () => { sprites.player = '👦';   gameState.player.sprite = 'player_boy';   draw(); startDialogue("Back to basics."); } },
                    { text: "Girl (👧)",       callback: () => { sprites.player = '👧';   gameState.player.sprite = 'player_girl';  draw(); startDialogue("Looking good!"); } },
                    { text: "Dog (🐶)",        callback: () => { sprites.player = '🐶';   gameState.player.sprite = 'player_dog';   draw(); startDialogue("Woof!"); } },
                    { text: "Cat (🐱)",        callback: () => { sprites.player = '🐱';   gameState.player.sprite = 'player_cat';   draw(); startDialogue("Meow."); } },
                    { text: "Cancel", callback: () => startDialogue("You look fine just the way you are.") }
                ]);
            }},
            
            '3,5': { target: 'playerHouse', x: 4, y: 5 }, 
            '4,5': { target: 'playerHouse', x: 4, y: 5 } 
        } 
    },

    playerHouse: { 
        layout: [
            [1,1,1,1,1,1,1,1],
            [1,0,0,12,0,0,0,1],
            [1,0,0,0,0,0,0,1],
            [1,13,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,1],
            [1,0,23,0,0,23,0,1],
            [1,1,1,2,2,1,1,1]
        ], 
        objects: { 
            '3,1': { sprite: 'bookshelf', interaction: "Tales of adventure: 'The Odyssey' and 'Treasure Island'." }, 
            '1,3': { sprite: 'mom', interaction: () => gameState.playerParty.length > 0 ? "Be careful out there!" : "Hurry, dear! Professor Lexicon is waiting." }, 
            '2,3': { sprite: 'dictionary', interaction: "Onomatopoeia: (n.) the formation of a word from a sound associated with what is named (e.g., cuckoo, sizzle)." }, 
            '3,5': { target: 'village', x: 10, y: 9 }, 
            '4,5': { target: 'village', x: 10, y: 9 }, 
            '4,1': { sprite: 'stairsUp', target: 'playerRoom', x: 4, y: 4 }, 
            '6,1': { sprite: 'computer', interaction: handlePCInteraction } 
        } 
    },

    village: { 
        layout: [
            [8,8,8,8,8,8,0,0,0,8,8,8,8,8,8,8],
            [8,7,7,7,7,7,0,0,0,7,7,7,7,7,7,8],
            [8,7,6,4,6,7,0,0,0,7,6,4,6,7,7,8],
            [8,7,3,5,3,7,0,0,0,7,3,5,3,7,7,8],
            [8,7,3,2,3,7,0,0,0,7,3,2,3,7,7,8],
            [8,7,7,0,0,0,0,0,0,0,0,0,0,7,7,8],
            [8,7,7,7,6,4,6,7,7,6,4,6,0,7,7,8],
            [8,7,7,7,3,5,3,7,7,3,5,3,0,7,7,8],
            [8,7,7,7,3,2,3,0,0,3,2,3,0,7,7,8],
            [8,7,7,7,7,0,0,0,0,0,0,0,0,7,7,8],
            [8,7,16,7,7,0,0,0,0,0,0,0,0,16,7,8],
            [8,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8],
            [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8]
        ],
        objects: {
            '12,2': { sprite: 'candy', interaction: () => handleCaveItem('Synonym Roll', 'synonymRoll', 1, 'village', 12, 2) },
            // The Secret Tree
            '13,8': { sprite: 'tree', interaction: "Carved into the bark: 'LH ❤️ BH'" },
            // Langston Hughes
            '6,6': { sprite: 'hughes', interaction: handleHughesInteraction },
           '6,9': { sprite: 'maya', interaction: ["Maya Angelou: 'There is no greater agony than bearing an untold story inside you.'", "Go! Write your own story, young trainer!"] },
            '3,4': { target: 'rivalsHouse', x: 4, y: 5, symbol: '', symbolOffsetY: -2 },
            '11,4': { target: 'profHouse', x: 4, y: 5, symbol: '', symbolOffsetY: -2 },
            '5,8': { target: 'villagerHouse1', x: 4, y: 5, symbol: '', symbolOffsetY: -2 },
            '10,8': { target: 'playerHouse', x: 4, y: 5, symbol: '', symbolOffsetY: -2 },
            // TUTORIAL NPC (Updated from generic villager)
            '2,9': { sprite: 'villager', interaction: handleTutorialNPC },
            '7,0': { sprite: 'gate', interaction: handleGateInteraction },
            '8,0': { sprite: 'gate', interaction: handleGateInteraction },
            '10,10': { sprite: 'sign', interaction: 'Village of Beginnings' },
            '7,12': { target: 'homeBay', x: 7, y: 1 },
            '8,12': { target: 'homeBay', x: 8, y: 1 },
            '4,5': { interaction: handleHoleEntrance }
        },
        encounters: []
    },

    homeBay: {
        layout: [
            [24,24,24,24,24,24,24,0,0,24,24,24,24,24,24,24],
            [23,23,23,23,23,24,24,0,0,24,24,23,23,23,23,23],
            [24,24,24,24,24,24,24,2,2,24,24,24,24,24,24,24],
            [24,24,24,24,24,24,24,2,2,24,24,24,24,24,24,24],
            [24,24,24,24,24,24,24,2,2,24,24,24,24,24,24,24],
            [24,24,24,24,24,24,2,2,2,2,2,2,2,24,24,24],
            [24,24,24,24,24,24,2,24,24,24,24,2,24,24,24,24],
            [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],
            [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],
            [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],
            [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24]
        ],
        objects: {
            // 9. The Great Gatsby (Green Light at end of dock)
            '8,6': { sprite: 'lightbulb', interaction: "A green light shines across the bay. It feels so close, yet impossible to grasp." },
            '6,2': { sprite: 'candy', interaction: () => handleCaveItem('Synonym Roll', 'synonymRoll', 1, 'homeBay', 2, 2) },
            '7,0': { target: 'village', x: 7, y: 12 },
            '8,0': { target: 'village', x: 8, y: 12 },
            '10,1': { sprite: 'sign', interaction: 'Village Bay' },
            '11,7': { sprite: 'boat', interaction: "It's the captain's boat. Looks like it's seen many voyages." },
            '12,5': { sprite: 'pilot', interaction: handleCaptainInteraction },
            '6,6': { sprite: 'fisherman', interaction: handleFishermanInteraction }
        }
    },

    profHouse: { layout: [[1,1,1,1,1,1,1,1],[1,12,0,0,0,0,12,1],[1,0,0,0,0,0,0,1],[1,0,15,0,15,0,15,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { 
        '4,2': { sprite: 'professor', interaction: handleProfessorInteraction }, 
        
        // 7. Moby Dick Reference 
        '1,2': { sprite: 'computer', interaction: "The screensaver is a white whale. It simply says: 'Call me Ishmael'." },
        
        // FIX: Changed these from "Empty Cases" to actual items so they disappear when clicked
        '2,3': { sprite: 'wordorb', interaction: () => handleCaveItem('Potion', 'potions', 1, 'profHouse', 2, 3) }, 
        '4,3': { sprite: 'wordorb', interaction: () => handleCaveItem('Word Ball', 'wordballs', 1, 'profHouse', 4, 3) }, 
        '6,3': { sprite: 'wordorb', interaction: () => handleCaveItem('Potion', 'potions', 1, 'profHouse', 6, 3) }, 
        
        '3,5': { target: 'village', x: 11, y: 5 }, 
        '4,5': { target: 'village', x: 11, y: 5 } 
    }
    },
    
rivalsHouse: { 
        layout: [
            [1,1,1,1,1,1,1,1],
            [1,0,0,0,0,0,0,1],
            [1,0,0,13,0,0,0,1],
            [1,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,1],
            [1,1,1,2,2,1,1,1]
        ], 
        objects: { 
            '3,2': { sprite: 'mom', interaction: "My son, Andy, is already out training. He's so eager! He wants to be the 'Leader'." }, 
            
            // Animal Farm Reference
            '6,2': { sprite: 'table', interaction: "A rulebook for the house. Someone scrawled: 'All animals are equal, but some are more equal than others.'" },
            
            '4,1': { sprite: 'stairsUp', target: 'rivalsRoom', x: 4, y: 4 }, 
            '3,5': { target: 'village', x: 3, y: 5 }, 
            '4,5': { target: 'village', x: 3, y: 5 } 
        } 
    },    
rivalsRoom: {
        layout: [[1,1,1,1,1,1,1,1],[1,22,22,22,22,22,22,1],[1,11,0,0,10,0,9,1],[1,0,0,0,0,0,0,1],[1,22,22,0,0,22,22,1],[1,1,1,2,2,1,1,1]],
        objects: {
            // 1. 1984 Reference (TV)
            '6,2': { sprite: 'tv', interaction: "The screen shows a man shouting about 'Big Brother'. It makes you want to doublethink." },
            '4,2': { sprite: 'bed', interaction: "Your rival's bed. It's surprisingly neat." },
            
            // 2. Lord of the Flies Reference (Table)
            '1,2': { sprite: 'table', interaction: "A large conch shell. It represents order, but it looks fragile." },

            // 3. ANDY'S DIARY (The Character Depth)
            '5,1': { sprite: 'bookshelf', interaction: [
                "You peek at an open notebook...",
                "Entry: 'Everyone likes the Player because they fit in. They are a Synonym.'",
                "Entry: 'I have to be different. I have to be the Antonym. Conflict creates strength!'",
                "Entry: 'I will become the strongest trainer by opposing everything.'"
            ]},
            
            '3,5': { target: 'rivalsHouse', x: 4, y: 1 },
            '4,5': { target: 'rivalsHouse', x: 4, y: 1 }
        }
    },
    route1: { 
        layout: [ 
            [8,8,8,7,7,0,0,0,0,7,7,8,8,8,8,8],
            [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
            [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
            [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
            [8,8,8,7,7,0,0,0,0,7,7,8,8,8,8,8],
            [8,8,8,8,8,0,0,0,0,8,8,8,8,8,8,8]
        ], 
        objects: { 
            '3,3': { sprite: 'candy', interaction: () => handleCaveItem('Synonym Roll', 'synonymRoll', 1, 'route1', 3, 3) },
            '12,4': { sprite: 'candy', interaction: () => handleCaveItem('Synonym Roll', 'synonymRoll', 1, 'route1', 12, 4) },
            '2,2': { sprite: 'hiker', interaction: () => handleTrainerBattle('hikerTom') }, 
            '13,2': { sprite: 'villager', interaction: () => handleTrainerBattle('readerSue') },
            '5,5': { target: 'village', x: 7, y: 1 }, '6,5': { target: 'village', x: 8, y: 1 }, 
            '5,0': { target: 'lexingtonCity', x: 7, y: 13 }, '6,0': { target: 'lexingtonCity', x: 8, y: 13 }, 
            '7,0': { target: 'lexingtonCity', x: 7, y: 13 }, '8,0': { target: 'lexingtonCity', x: 8, y: 13 }, 
            '8,4': { sprite: 'sign', interaction: 'Route 1' }
        }, 
        encounters: ['Wordworm', 'SimileSlime', 'CommaLeon', 'Hyper-bole', 'Metaphorpillar', 'Haiku-na'] 
    },

lexingtonCity: { 
        layout: [ 
            [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8], 
            [8,0,16,0,6,19,19,6,0,6,21,21,6,0,16,8], 
            [8,0,4,4,3,18,18,3,0,3,20,20,3,0,4,8], 
            [8,0,3,3,3,18,18,3,0,3,20,20,3,0,3,8], 
            [8,0,2,0,3,2,5,3,0,3,2,5,3,0,2,8], 
            [8,0,16,0,6,19,19,6,0,6,21,21,6,0,16,8], 
            [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8], 
            [8,0,4,4,0,0,0,0,0,0,0,0,4,4,0,8], 
            [8,0,3,3,0,0,0,0,0,0,0,0,3,3,0,8], 
            [8,0,2,0,0,0,0,0,0,0,0,0,0,2,0,8], 
            [8,0,16,0,0,0,0,0,0,0,0,0,0,16,0,8], 
            [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8], 
            [8,0,16,0,0,16,0,0,0,16,0,0,16,0,0,8], 
            [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8] 
        ], 
        objects: { 
            '12,12': { sprite: 'candy', interaction: () => handleCaveItem('Synonym Roll', 'synonymRoll', 1, 'lexingtonCity', 12, 12) },
'12,2': { sprite: 'flower', interaction: () => handleCaveItem('Red Herring', 'redHerring', 1, 'lexingtonCity', 12, 2) },
            // William Shakespeare
            '3,9': { sprite: 'shakespeare', interaction: handleShakespeareInteraction },
            // Pocket Center
            '2,4': { symbol: '', symbolOffsetY: -2 }, 
            '2,5': { target: 'pocketcenter', x: 4, y: 5 }, 
            // 8. Waiting for Godot Reference (NPC at 1, 8)
            '1,8': { sprite: 'villager', interaction: "I'm waiting for Godot. He said he'd be here yesterday... or was it tomorrow?" },
            // Shop
            '5,4': { symbol: '', symbolOffsetY: -2 }, 
            '5,5': { target: 'shop', x: 4, y: 5 }, 
            
            // Gym
            '10,4': { symbol: '', symbolOffsetY: -2 }, 
            '10,5': { target: 'gym', x: 4, y: 5 }, 
            
            // House 1 (Rhyme Hint)
            '13,4': { symbol: '', symbolOffsetY: -2 }, 
            '13,5': { target: 'cityHouse1', x: 4, y: 5 }, 
            
            // --- THE FIX: SCHOOL IS HERE (Replaces CityHouse2) ---
            '2,9': { symbol: '', symbolOffsetY: -2 }, 
            '2,10': { target: 'school', x: 4, y: 5 }, 
            
            // --- THE FIX: Re-Add City House 2 (Mariner House) ---
            '6,9': { symbol: '', symbolOffsetY: -2 }, 
            '6,10': { target: 'cityHouse2', x: 4, y: 5 },
            // ----------------------------------------------------

            // House 3 (Gamer/DeathMasheen)
            '13,9': { symbol: '', symbolOffsetY: -2 }, 
            '13,10': { target: 'cityHouse3', x: 4, y: 5 },

            '3,1': { sprite: 'poeFan', interaction: handlePoeInteraction }, 
            '1,10': { sprite: 'poet', interaction: ["A 5-7-5 syllable structure...", "The haiku is a gentle art.", "Even a battle can be poetry."] },
            '7,0': { sprite: 'gate', interaction: handleNorthGate }, '8,0': { sprite: 'gate', interaction: handleNorthGate },
            '7,13': { target: 'route1', x: 7, y: 0 }, '8,13': { target: 'route1', x: 8, y: 0 },
            '9,12': { sprite: 'sign', interaction: 'Lexington City' }
        } 
    },
school: { 
        layout: [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,12,0,0,0,0,0,0,0,0,0,0,12,1], 
            [1,16,0,13,0,16,0,16,0,13,0,16,1], 
            [1,0,2,2,0,2,2,0,2,2,0,2,2,1], 
            [1,0,2,2,0,2,2,0,2,2,0,2,2,1], 
            [1,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,2,2,1,1,1,1,1,1]
        ], 
        objects: { 
            // MS. KATRINA (The Quest Giver!)
            // She replaces the generic teacher interaction
            '6,2': { sprite: 'teacher', interaction: handleKatrinaInteraction }, 
            
            // BLACKBOARD
            '7,1': { sprite: 'sign', interaction: "Assignments: 1. Read 'The Giver'. 2. Find the lost student." },

            // STUDENTS
            '2,3': { sprite: 'student', interaction: "I saw a kid run towards the Adjective Woods during recess." },
            '10,4': { sprite: 'student', interaction: "Ms. Katrina is really worried about the missing student." },

            // BOOKS
            '1,1': { sprite: 'bookshelf', interaction: "Textbooks: 'Grammar for Goblins' and 'Spelling for Sprites'." },

            // EXIT
            '6,6': { target: 'lexingtonCity', x: 2, y: 10 }, 
            '7,6': { target: 'lexingtonCity', x: 2, y: 10 } 
        } 
    },
pocketcenter: { 
        layout: [
            [1,1,1,1,1,1,1,1],
            [1,12,0,0,0,0,12,1], // Bookshelves in back corners
            [1,16,0,13,0,16,0,1], // Flowers and Desk
            [1,0,2,2,0,2,2,1], // Waiting Area Chairs
            [1,16,0,0,0,0,16,1], // Plants near door
            [1,1,1,2,2,1,1,1]
        ], 
        objects: { 
            '3,2': { sprite: 'nurse', interaction: handleNurseInteraction }, 
            '1,2': { sprite: 'computer', interaction: handlePCInteraction }, 
            // New Decor
            '1,1': { sprite: 'bookshelf', interaction: "Medical Journals: 'Curing Run-on Sentences' and 'Treating Dangling Participles'." },
            '6,1': { sprite: 'bookshelf', interaction: "A poster reads: 'Reading is Fundamental to Healing.'" },
            '2,3': { sprite: 'student', interaction: "My Wordworm has a tummy ache. He ate too many adjectives." },
            '5,3': { sprite: 'synonymouse', interaction: "Synonymouse is napping. It looks peaceful... or serene... or tranquil." },
            // Exits
            '3,5': { target: 'lexingtonCity', x: 2, y: 5 }, 
            '4,5': { target: 'lexingtonCity', x: 2, y: 5 } 
        } 
    },

    shop: { 
        layout: [
            [1,1,1,1,1,1,1,1],
            [1,12,12,12,12,12,12,1], // Wall of products
            [1,0,0,13,0,0,0,1],
            [1,0,2,2,2,2,0,1], // Display tables
            [1,0,0,0,0,0,0,1],
            [1,1,1,2,2,1,1,1]
        ], 
        objects: { 
            // 10. Oliver Twist Reference
            '1,2': { sprite: 'table', interaction: "An empty bowl. You hear a ghostly whisper: 'Please, sir, I want some more.'" }, 
            '3,2': { sprite: 'shopkeep', interaction: handleShopInteraction }, 
            // New Decor
            '1,1': { sprite: 'bookshelf', interaction: "Best Sellers: 'Harry Potter and the Adverb of Fire'." },
            '2,1': { sprite: 'bookshelf', interaction: "Sale! 50% off all metaphors." },
            '5,1': { sprite: 'bookshelf', interaction: "A sign reads: 'No refunds on broken pencils.'" },
            '5,3': { sprite: 'villager', interaction: "I'm saving up for an Ultra Sentence. They are expensive!" },
            // Exits
            '3,5': { target: 'lexingtonCity', x: 5, y: 5 }, 
            '4,5': { target: 'lexingtonCity', x: 5, y: 5 } 
        } 
    },

    gym: { 
        layout: [
            [1,1,1,1,1,1,1,1],
            [1,18,0,0,0,0,18,1], // Trophies/Statues in corners
            [1,0,0,0,0,0,0,1],
            [1,22,22,0,0,22,22,1], // Rug/Mat
            [1,0,0,0,0,0,0,1],
            [1,1,1,2,2,1,1,1]
        ], 
        objects: { 
            // 14. Hamilton Reference
            '2,1': { sprite: 'sign', interaction: "A motivational poster: 'I am not throwing away my shot!'" }, 
            '4,1': { sprite: 'gymLeader', interaction: handleGymLeaderInteraction }, 
            // New Decor
            '1,1': { sprite: 'adjectlizard', interaction: "This Adjectlizard is pumping iron! It looks strong, muscular, and buff." },
            '6,1': { sprite: 'bookshelf', interaction: "Gym Records: 'Rhonda hasn't lost a battle in 3 years!'" },
            '1,3': { sprite: 'student', interaction: "I'm trying to find a rhyme for 'orange'. It's impossible!" },
            // Exits
            '3,5': { target: 'lexingtonCity', x: 10, y: 5 }, 
            '4,5': { target: 'lexingtonCity', x: 10, y: 5 } 
        } 
    },
    cityHouse1: { 
        layout: [
            [1,1,1,1,1,1,1,1],
            [1,12,0,0,0,0,12,1], 
            [1,0,0,0,0,0,0,1],
            [1,0,22,0,0,22,0,1], // Rugs
            [1,0,0,0,0,0,0,1],
            [1,1,1,2,2,1,1,1]
        ], 
        objects: { 
            // 1. The Tell-Tale Heart Reference
            '4,3': { sprite: 'wood_floor', interaction: "You step on a loose floorboard. *THUMP-THUMP*. Is that a heartbeat?" },
            
            // 2. The Raven Reference
            '6,1': { sprite: 'bookshelf', interaction: "A bust of Pallas sits on the shelf. A raven is perched on it." },
            
            // 3. The Cask of Amontillado Reference
            '1,1': { sprite: 'bookshelf', interaction: "A dusty wine rack. There is a trowel and some bricks behind it." },

            // NPC
            '3,2': { sprite: 'poeFan', interaction: "Once upon a midnight dreary... I realized I forgot to buy milk." },

            // Exit
            '3,5': { target: 'lexingtonCity', x: 13, y: 5 }, 
            '4,5': { target: 'lexingtonCity', x: 13, y: 5 } 
        } 
    },
cityHouse2: { 
        layout: [
            [1,1,1,1,1,1,1,1],
            [1,12,0,0,0,0,12,1],
            [1,0,0,0,0,0,0,1],
            [1,0,13,0,0,0,0,1],
            [1,0,0,0,0,0,0,1],
            [1,1,1,2,2,1,1,1]
        ], 
        objects: { 
            // NPC
            '2,3': { sprite: 'villager2', interaction: "My husband is a sailor. He talks about an Albatross constantly. It sounds like a burden." },
            
            // 1. Rime of the Ancient Mariner Reference
            '1,1': { sprite: 'bookshelf', interaction: "A framed quote: 'Water, water, every where, nor any drop to drink.'" },
            
            // 2. The Old Man and the Sea Reference
            '6,1': { sprite: 'bookshelf', interaction: "A book about an old man fighting a giant marlin. It looks exhausting." },

            '3,5': { target: 'lexingtonCity', x: 2, y: 10 }, 
            '4,5': { target: 'lexingtonCity', x: 2, y: 10 } 
        } 
    },
        cityHouse3: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,13,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '2,3': { sprite: 'rival', interaction: handleDeathMasheenInteraction }, '3,5': { target: 'lexingtonCity', x: 13, y: 10 }, '4,5': { target: 'lexingtonCity', x: 13, y: 10 } } },
    villagerHouse1: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { 
            // 5. The Red Wheelbarrow (William Carlos Williams)
            '3,1': { sprite: 'bookshelf', interaction: "A painting of a red wheelbarrow, glazed with rain water, beside the white chickens." }, 
            
            '1,3': { sprite: 'villager', interaction: "So many young trainers starting their journey." }, 
            
            // 6. Alice in Wonderland (Table)
            '3,3': { sprite: 'table', interaction: "A small bottle labeled 'Drink Me' and a cake labeled 'Eat Me'. Best not to touch." }, 
            
            '3,5': { target: 'village', x: 5, y: 9 }, '4,5': { target: 'village', x: 5, y: 9 } 
        } 
        },
    
    route2: {
        layout: [
            [8,8,8,7,7,0,0,0,0,7,7,8,8,8,8,8],
            [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
            [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
            [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
            [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
            [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
            [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
            [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
            [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
            [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
            [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
            [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
            [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
            [8,8,8,8,8,0,0,0,0,8,8,8,8,8,8,8]
        ],
        objects: {
            '3,10': { sprite: 'candy', interaction: () => handleCaveItem('Synonym Roll', 'synonymRoll', 1, 'route2', 3, 10) },
            '7,13': { target: 'lexingtonCity', x: 7, y: 0 },
            '8,13': { target: 'lexingtonCity', x: 8, y: 0 },
            '7,0': { target: 'adjectiveWoods', x: 7, y: 13 },
            '8,0': { target: 'adjectiveWoods', x: 8, y: 13 },
            '2,7': { sprite: 'bookworm', interaction: () => handleTrainerBattle('bookwormBarry') },
            '9,12': { sprite: 'sign', interaction: 'Route 2 - Path to the Woods' },
            '12,6': { sprite: 'graduate', interaction: handleSenseiWu } 
        },
        encounters: ['PronounProwler', 'VerbViper']
    },

adjectiveWoods: {
        layout: [
            [8,8,8,8,8,8,0,0,0,8,8,8,8,8,8,8], // Row 0 (Exit)
            [8,8,8,8,8,8,0,0,8,8,8,8,8,8,8,8], // Row 1
            [8,0,8,7,8,8,0,0,7,7,7,7,8,7,7,8], // Row 2
            [8,0,0,0,8,7,7,0,0,0,8,8,8,7,8,8],
            [8,8,8,0,8,7,8,8,8,0,8,7,7,7,7,8],
            [8,7,7,0,0,0,0,0,8,0,8,7,8,8,8,8],
            [8,7,8,8,8,8,8,0,8,0,8,7,7,7,0,8],
            [8,7,7,0,0,0,8,0,8,0,8,8,8,8,0,8],
            [8,8,8,8,8,0,8,0,8,0,7,7,7,7,7,8], // Row 8: Hiker is here at x=14
            [8,7,7,7,8,0,8,0,8,8,8,8,8,8,8,8],
            [8,7,8,7,8,0,8,0,0,0,0,0,0,0,7,8],
            [8,7,8,7,8,0,8,8,8,8,8,8,8,0,7,8],
            [8,7,8,7,7,0,0,0,0,0,0,0,8,0,7,8],
            [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8]
        ],
objects: {
    // 13. Into the Wild / Walden (Thoreau)
            '1,2': { sprite: 'sign', interaction: "I went to the woods because I wished to live deliberately." },
            // Safari Entrance (Now a Lion!)
            '14,11': { sprite: 'safariLion', interaction: handleSafariEntrance },

            // The Luminous Hyperbole Item
            '12,8': { sprite: 'lightbulb', interaction: handleLHItem },

            // Items and NPCs
            '1,3': { sprite: 'candy', interaction: () => handleCaveItem('Synonym Roll', 'synonymRoll', 1, 'adjectiveWoods', 1, 3) },
            '13,2': { sprite: 'candy', interaction: () => handleCaveItem('Synonym Roll', 'synonymRoll', 1, 'adjectiveWoods', 13, 2) },
            
            // The Tree Logic
            '7,1': { sprite: 'tree', interaction: "A massive tree blocks the path. It hums with energy." },
            '6,1': { sprite: 'hippie', interaction: handleVinnieInteraction },
            
            // Other Interactions
            '8,5': { sprite: 'hiker', interaction: ["Robert Frost: 'Two roads diverged in a wood, and I—'", "'I took the one less traveled by, And that has made all the difference.'"] },
            '3,2': { sprite: 'villager2', interaction: () => handleTrainerBattle('artistAdeline') },
            
            // Exits
            '7,13': { target: 'route2', x: 7, y: 0 },
            '8,13': { target: 'route2', x: 8, y: 0 },
            '8,0': { target: 'synonymCity', x: 8, y: 13 },
            '7,0': { target: 'synonymCity', x: 7, y: 13 },
            
            // Sign
            '9,12': { sprite: 'sign', interaction: 'Adjective Woods - Watch your descriptions!' }
        },
        encounters: ['Metaphorpillar', 'PronounProwler']
    },

genreJungle: {
        layout: [
            // --- AREA 3: THE DEEP JUNGLE (Rows 0-14) ---
            [8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],
            [8,29,29,29,8,29,29,29,29,8,29,29,29,29,5,8],
            [8,29,16,29,8,29,16,16,29,8,29,16,16,29,5,8], // Boat starts at 14,2
            [8,29,29,29,29,29,29,29,29,29,29,29,29,29,5,8],
            [8,8,8,8,8,8,0,0,8,8,8,8,8,8,5,8],
            [8,29,29,29,29,29,0,0,29,29,29,29,29,29,5,8],
            [8,29,16,29,29,29,0,0,29,29,16,16,29,29,5,8],
            [8,8,8,8,8,8,0,0,8,8,8,8,8,8,5,8],
            [8,29,29,29,8,0,0,0,0,8,29,29,29,29,5,8],
            [8,29,16,29,8,0,0,0,0,8,29,16,29,29,5,8],
            [8,29,29,29,8,0,0,0,0,8,29,29,29,29,5,8],
            [8,8,8,8,8,0,0,0,0,8,8,8,8,8,5,8],
            [8,0,0,0,0,0,0,0,0,0,0,0,0,0,5,8],
            [8,0,0,0,0,0,0,0,0,0,0,0,0,0,5,8],
            [8,8,8,8,8,8,0,0,8,8,8,8,8,8,5,8],

            // --- AREA 2: THE MID JUNGLE (Rows 15-29) ---
            [8,8,8,8,8,8,0,0,8,8,8,8,8,8,5,8],
            [8,7,7,7,7,7,0,0,7,7,7,7,7,7,5,8],
            [8,7,29,29,29,7,0,0,7,29,29,29,29,7,5,8],
            [8,7,29,16,29,7,0,0,7,29,16,16,29,7,5,8],
            [8,7,29,29,29,7,0,0,7,29,29,29,29,7,5,8],
            [8,8,8,8,8,8,0,0,8,8,8,8,8,8,5,8],
            [8,7,7,7,7,7,0,0,7,7,7,7,7,7,5,8],
            [8,7,29,29,29,29,0,0,29,29,29,29,7,5,8],
            [8,7,29,29,29,29,0,0,29,29,16,29,7,5,8],
            [8,8,8,8,8,8,0,0,8,8,8,8,8,8,5,8],
            [8,0,0,0,0,0,0,0,0,0,0,0,0,0,5,8],
            [8,0,0,0,0,0,0,0,0,0,0,0,0,0,5,8],
            [8,0,0,0,0,0,0,0,0,0,0,0,0,0,5,8],
            [8,0,0,0,0,0,0,0,0,0,0,0,0,0,5,8],
            [8,8,8,8,8,8,0,0,8,8,8,8,8,8,5,8],

            // --- AREA 1: THE ENTRANCE (Rows 30-44) ---
            [8,8,8,8,8,8,0,0,8,8,8,8,8,8,5,8],
            [8,7,7,7,7,7,0,0,7,7,7,7,7,7,5,8],
            [8,7,7,16,7,7,0,0,7,7,16,7,7,7,5,8],
            [8,7,7,7,7,7,0,0,7,7,7,7,7,7,5,8],
            [8,8,8,8,8,8,0,0,8,8,8,8,8,8,5,8],
            [8,7,7,7,7,7,0,0,7,7,7,7,7,7,5,8],
            [8,7,7,7,0,0,0,0,0,0,7,7,7,7,5,8],
            [8,7,7,7,0,7,7,7,7,0,7,7,7,7,5,8],
            [8,7,7,7,7,7,7,7,7,7,7,7,7,7,5,8],
            [8,7,7,7,7,7,7,7,7,7,7,7,7,7,5,8], 
            [8,7,7,7,7,7,7,7,7,7,7,7,7,7,5,8],
            [8,7,7,7,7,7,7,7,7,7,7,7,7,7,5,8],
            [8,8,8,8,8,8,8,13,13,8,8,8,8,8,8,8], 
            [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8]
        ],
        objects: {
            '7,43': { sprite: 'gate', interaction: handleSafariExit },
            '8,43': { sprite: 'gate', interaction: handleSafariExit },
            '8,2': { sprite: 'auto-biogra-bee', interaction: handleStaticSafariEncounter },
            '14,2': { sprite: 'boat', interaction: rideSafariBoat }, 
            
            '8,34': { sprite: 'sign', interaction: "AREA 1: The Basics" },
            '8,20': { sprite: 'sign', interaction: "AREA 2: The Exotic" },
            '8,7':  { sprite: 'sign', interaction: "AREA 3: DANGER!" },

            '2,38': { sprite: 'candy', interaction: () => handleCaveItem('Synonym Roll', 'synonymRoll', 1, 'genreJungle', 2, 38) },
            '13,22': { sprite: 'wordorb', interaction: () => handleCaveItem('Jungle Orb', 'safariBall', 5, 'genreJungle', 13, 22) }
        },
        encounters: ['Fic-tion'] 
   },

    synonymCity: {
        layout: [
            [8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],
            [8,0,0,0,0,6,19,19,6,0,0,0,0,0,0,8],
            [8,0,0,0,0,3,18,18,3,0,0,0,0,0,0,8],
            [8,0,0,0,0,3,2,2,3,0,0,0,0,0,0,8],
            [8,0,16,0,0,0,0,0,0,6,21,21,6,0,16,8],
            [8,0,4,4,3,18,18,3,0,3,20,20,3,0,4,8],
            [8,0,3,3,3,18,18,3,0,3,20,20,3,0,3,8],
            [8,0,2,0,3,2,5,3,0,3,2,5,3,0,2,8],
            [8,0,16,0,0,0,0,0,0,0,0,0,0,16,0,8],
            [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
            [8,0,19,19,0,16,0,0,0,16,0,0,16,0,0,8],
            [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
            [8,3,2,2,3,16,0,0,0,16,0,0,16,0,0,8],
            [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8]
        ],
        objects: {
            '1,2': { sprite: 'candy', interaction: () => handleCaveItem('Synonym Roll', 'synonymRoll', 1, 'synonymCity', 1, 2) },
            // Emily Dickinson (Updated)
            '2,8': { sprite: 'dickinson', interaction: handleDickinsonInteraction },
            '5,7': { symbol: '', symbolOffsetY: -2 }, '5,8': { target: 'synonymCityShop', x: 4, y: 5 }, 
            '10,7': { symbol: '', symbolOffsetY: -2 }, '10,8': { target: 'synonymCityCenter', x: 4, y: 5 }, 
            '14,10': { sprite: 'bookworm', interaction: "Synonym City is famous for its library, the largest in the region!" },
            '7,13': { target: 'adjectiveWoods', x: 7, y: 0 },
            '8,13': { target: 'adjectiveWoods', x: 8, y: 0 },
            '9,12': { sprite: 'sign', interaction: 'Synonym City - The City of Similar Words' },
            '7,2': { symbol: '', symbolOffsetY: -2 }, 
            '6,3': { target: 'synonymCityGym', x: 4, y: 5 },
            '7,3': { target: 'synonymCityGym', x: 4, y: 5 },
            '1,10': { symbol: '', symbolOffsetY: -2 },
            '2,12': { target: 'library', x: 4, y: 5 },
            '3,12': { target: 'library', x: 4, y: 5 }
        }
    },

    synonymCityGym: {
        layout: [[1,1,1,1,1,1,1,1],[1,12,0,0,0,0,12,1],[1,0,0,0,0,0,0,1],[1,12,0,0,0,0,12,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]],
        objects: {
            '4,1': { sprite: 'gymLeader', interaction: handleSynonymGymLeaderInteraction },
            '2,1': { sprite: 'bookshelf', interaction: "Books on advanced synonyms and etymology." },
            '6,1': { sprite: 'bookshelf', interaction: "A complete collection of Roget's Thesaurus." },
            '3,5': { target: 'synonymCity', x: 6, y: 3 },
            '4,5': { target: 'synonymCity', x: 7, y: 3 }
        }
    },

    synonymCityCenter: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'nurse', interaction: handleNurseInteraction }, '1,2': { sprite: 'computer', interaction: handlePCInteraction }, '3,5': { target: 'synonymCity', x: 10, y: 8 }, '4,5': { target: 'synonymCity', x: 10, y: 8 } } },
    
    synonymCityShop: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'shopkeep', interaction: handleShopInteraction }, '3,5': { target: 'synonymCity', x: 5, y: 8 }, '4,5': { target: 'synonymCity', x: 5, y: 8 } } },
    
library: {
        layout: [
            [1,1,1,1,1,1,1,1],
            [1,12,0,12,0,12,0,1],
            [1,0,0,0,0,0,0,1],
            [1,12,0,0,0,0,12,1],
            [1,0,0,0,0,0,0,1],
            [1,1,1,2,2,1,1,1]
        ],
        objects: {
            // ANDY STUDYING (Mid-Game Philosophy)
            '4,4': { sprite: 'rival', interaction: [
                "Andy: 'Oh, it's you.'",
                "'I'm researching the Legendary Antonymph.'",
                "'Synonyms are boring. They are just the same thing twice.'",
                "'Antonyms create contrast! Drama! Tension! That's what makes a story good.'",
                "'You keep trying to make friends. I'm going to make history.'"
            ]},

            

            // 11. Hitchhiker's Guide
            '5,3': { sprite: 'bookshelf', interaction: "A book with the words 'DON'T PANIC' in large, friendly letters on the cover." },
            // 12. Don Quixote
            '2,3': { sprite: 'bookshelf', interaction: "A story about a man fighting windmills. He insists they are giants." },
'4,2': { sprite: 'professor', interaction: handleDrPowersInteraction },            '1,1': { sprite: 'bookshelf', interaction: "You pull out 'The Giver'. The cover is black and white, but you swear you see a flash of red." },
            '2,1': { sprite: 'bookshelf', interaction: "It's 'The Outsiders'. Stay gold, Ponyboy." }, 
            '3,1': { sprite: 'bookshelf', interaction: () => handleLibraryPuzzle() }, 
            '5,1': { sprite: 'bookshelf', interaction: "It's 'To Kill a Mockingbird'. You shouldn't kill mockingbirds; they just sing their hearts out." },
            '6,1': { sprite: 'bookshelf', interaction: "You find 'Fahrenheit 451'. The pages feel unusually warm." },
            '1,3': { sprite: 'bookshelf', interaction: "It's 'A Wrinkle in Time'. It was a dark and stormy night..." },
            '6,3': { sprite: 'bookshelf', interaction: "You find 'The Raven' by Poe. Nevermore." },
            '3,5': { target: 'synonymCity', x: 2, y: 12 },
            '4,5': { target: 'synonymCity', x: 3, y: 12 }
        }
    },

desertedIsland: {
        layout: [
            [24,24,24,24,24,24,24,24,24,24,24,24,24,24],
            [24,24,24,24,24,23,23,23,23,24,24,24,24,24],
            [24,24,24,23,23,23,23,23,23,23,23,24,24,24],
            [24,24,23,23,23,23,23,23,23,23,23,23,24,24],
            [24,23,23,23,23,23,23,23,23,23,23,23,23,24], // y=4 (Sand is reachable here)
            [24,23,23,23,23,23,23,23,23,23,23,23,23,24],
            [24,23,23,23,23,23,23,23,23,23,23,23,23,24],
            [24,23,23,23,23,23,23,23,23,23,23,23,23,24],
            [24,24,23,23,23,23,23,23,23,23,23,24,24,24],
            [24,24,24,23,23,23,23,23,23,23,24,24,24,24],
            [24,24,24,24,24,24,24,24,24,24,24,24,24,24]
        ],
        objects: {
            // THE PILOT
            '6,4': { sprite: 'pilot', interaction: handlePilotSurvivalQuest },

            // SURVIVAL ITEMS
            '2,2': { sprite: 'shell', interaction: () => handleSurvivalItem('conch', "A Conch Shell! It represents order.") },
            '12,8': { sprite: 'sparkle', interaction: () => handleSurvivalItem('glasses', "Piggy's Glasses! We can use these to start a fire.") },
            '9,2': { sprite: 'ball', interaction: () => handleSurvivalItem('wilson', "A volleyball named Wilson.") },
            
            // --- NEW: FISHING LURE (Moved to Shore at 11,4) ---
            '11,4': { sprite: 'shell', interaction: () => handleCaveItem('Lucky Lure', 'luckyLure', 1, 'desertedIsland', 11, 4) },

            // DECORATION
            '7,3': { sprite: 'boulder', interaction: "The wreckage of the plane." },
            '9,6': { sprite: 'palmTree', interaction: "A lonely palm tree." },
            '2,5': { sprite: 'palmTree', interaction: "Nothing but ocean." }
        },
        encounters: ['Haiku-na', 'Hyper-bole', 'SimileSlime'] 
    },

    caveLevel1: {
        layout: [
            [27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27],
            [27,28,28,28,27,28,28,28,28,28,28,28,28,28,28,27],
            [27,28,27,28,27,28,27,27,27,27,27,27,27,27,28,27],
            [27,28,27,28,28,28,28,28,28,28,28,28,28,27,28,27],
            [27,28,27,27,27,27,27,28,27,27,27,27,28,27,28,27],
            [27,28,28,28,28,28,27,28,27,28,28,28,28,28,28,27],
            [27,27,27,27,27,28,27,28,27,28,27,27,27,27,27,27],
            [27,28,28,28,27,28,27,28,28,28,28,28,28,28,28,27],
            [27,28,27,28,27,28,27,27,27,27,27,28,27,27,28,27],
            [27,28,27,28,28,28,28,28,28,28,27,28,28,28,28,27],
            [27,28,27,27,27,27,27,27,27,28,27,27,27,27,28,27],
            [27,28,28,28,28,28,28,28,28,28,28,28,28,27,28,27],
            [27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27],
        ],
        objects: {
            '2,2': { sprite: 'ladder', target: 'village', x: 4, y: 7 },
            '4,8': { sprite: 'hiker', interaction: () => handleTrainerBattle('caveExplorerDon') },
            '10,2': { sprite: 'goblin', interaction: () => handleTrainerBattle('goblinBoss') },
            '14,2': { sprite: 'boulder', interaction: handleBoulderInteraction },
            '14,3': { sprite: 'lexiconstruct', interaction: handleLegendaryBattle }
        },
        encounters: ['Grammargoyle', 'VerbViper']
    },

finalCave: {
        // THE PYRAMID OF THE VOID (Sequential Gauntlet)
        layout: [
            // ROW 0-4: THE SUMMIT (The Final Climb)
            [31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31],
            [31,31,31,31,31,31,31,31,31,33,31,31,31,31,31,31,31,31,31,31], // y=1: The Throne (Thesis)
            [31,31,31,31,31,31,31,31,31,32,31,31,31,31,31,31,31,31,31,31], // y=2: Boss 2 (King)
            [31,31,31,31,31,31,31,31,31,32,31,31,31,31,31,31,31,31,31,31], // y=3: Boss 1 (General)
            [31,31,31,31,31,31,31,31,22,22,22,22,31,31,31,31,31,31,31,31], // y=4: Bridge

            // ROW 5-10: TIER 3 (Elite 3 & 4)
            [31,31,31,31,31,31,28,28,28,32,32,28,28,28,31,31,31,31,31,31],
            [31,31,31,31,31,31,28,12,28,32,32,28,12,28,31,31,31,31,31,31], // Pillars flanking carpet
            [31,31,31,31,31,31,28,28,28,32,32,28,28,28,31,31,31,31,31,31],
            [31,31,31,31,31,31,28,28,28,32,32,28,28,28,31,31,31,31,31,31], 
            [31,31,31,31,31,31,28,28,22,22,22,22,28,28,31,31,31,31,31,31], // Bridge down
            
            // ROW 11-16: TIER 2 (Elite 1 & 2)
            [31,31,31,31,28,28,28,28,28,32,32,28,28,28,28,28,31,31,31,31],
            [31,31,31,31,28,12,28,28,28,32,32,28,28,12,28,31,31,31,31,31], // Pillars flanking carpet
            [31,31,31,31,28,28,28,28,28,32,32,28,28,28,28,31,31,31,31,31],
            [31,31,31,31,28,28,28,28,28,32,32,28,28,28,28,31,31,31,31,31],
            [31,31,31,31,28,28,22,22,22,22,22,22,28,28,28,31,31,31,31,31], // Bridge down

            // ROW 17-23: BASE LEVEL (Entrance)
            [31,31,28,28,28,28,28,28,28,32,32,28,28,28,28,28,28,28,31,31],
            [31,31,28,12,28,28,28,28,28,32,32,28,28,28,28,12,28,31,31,31],
            [31,31,28,28,28,28,28,28,28,32,32,28,28,28,28,28,28,31,31,31], 
            [31,31,28,28,28,28,28,28,28,32,32,28,28,28,28,28,28,31,31,31], // Entrance y=19
            [31,31,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,31,31,31],
            [31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31] 
        ],
        objects: {
            // ENTRANCE
            '9,19': { target: 'village', x: 8, y: 6, sprite: 'ladder' },
            '10,19': { target: 'village', x: 8, y: 6, sprite: 'ladder' },
            '14,18': { sprite: 'sign', interaction: "Pyramid of the Void\nOnly the mastered may ascend." },

            // TIER 2 GUARDIANS (Blocking bridges)
            '8,11': { sprite: 'professor', interaction: () => handleEliteBattle('eliteGrammarian', 8, 11) },
            '11,11': { sprite: 'villager2', interaction: () => handleEliteBattle('eliteJournalist', 11, 11) },

            // TIER 3 GUARDIANS (Blocking bridges)
            '8,5': { sprite: 'shakespeare', interaction: () => handleEliteBattle('eliteDramatist', 8, 5) },
            '11,5': { sprite: 'poet', interaction: () => handleEliteBattle('elitePoet', 11, 5) },

            // FINAL BOSSES (STACKED SEQUENTIALLY)
            // Boss 1 blocks the path at y=3
            '9,3': { sprite: 'lexiconstruct', interaction: () => handleTrainerBattle('finalBoss1') }, 
            
            // Boss 2 blocks the path at y=2
            '9,2': { sprite: 'grim-reader', interaction: () => handleTrainerBattle('finalBoss2') },
            
            // THE ULTIMATE REWARD (At the Gold Altar, y=1)
            '9,1': { sprite: 'wordorb', interaction: () => handleCaveItem('Master Thesis', 'masterthesis', 1, 'finalCave', 9, 1) }
        },
        encounters: ['ThesaurusRex', 'Grammargoyle', 'Antonymph', 'Lexiconstruct'] 
    },
};
    
// Updated Colors for better contrast
const tileTypes = { 
        0: { color: '#d1d5db' }, // Path (Solid Gray)
        1: { color: '#a0522d', solid: true, type: 'wall' }, // House Wall (Sienna - Solid Wood)
        2: { color: '#d4a373' }, // Wood Floor
        3: { color: '#805ad5', solid: true, type: 'wall_purple' }, // Gym Wall (Solid Purple)
        4: { color: '#b91c1c', solid: true, type: 'roof' }, // Roof (Dark Red)
        5: { color: '#38bdf8', solid: true, type: 'water' }, // Pool
        6: { color: '#451a03', solid: true, type: 'wall_dark' }, // Dark Wood
        7: { color: '#22c55e', isTallGrass: true }, // Bright Green Grass
        8: { color: '#14532d', solid: true }, // Tree Base (Deep Green)
        9: { color: '#a0522d', solid: true, type: 'wall' },
        10: { color: '#1f2937', solid: true }, 
        11: { color: '#60a5fa', isWindow: true }, // Window Blue
        12: { color: '#451a03', solid: true },
        13: { color: '#d97706', solid: true }, // Door (Amber)
        14: { color: '#374151', solid: true },
        15: { color: '#e5e7eb', solid: true },
        16: { color: '#fbbf24' }, // Flower
        18: { color: '#fde68a', solid: true },
        19: { color: '#2563eb', solid: true, type: 'wall_blue' }, // Solid Blue Wall
        20: { color: '#4b5563', solid: true },
        21: { color: '#1f2937', solid: true },
        22: { color: '#d4a373'}, 
        23: { color: '#fde047'}, // Sand
        24: { color: '#1d4ed8', solid: true, type: 'ocean' }, // Deep Blue Ocean
        25: { color: '#374151', solid: true },
        26: { color: '#000000' }, // Hole
        27: { color: '#292524', solid: true, type: 'cave_wall' }, // Cave Wall
        28: { color: '#57534e' }, // Cave Floor
        29: { color: '#166534', isTallGrass: true }, // Dark Grass
        30: { color: '#052e16', isTallGrass: true }, // Deep Jungle (Very Dark Green)
        31: { color: '#090011', solid: true, type: 'void' }, // The Void (Space)
        32: { color: '#dc2626' }, // Red Carpet (Walkable, Bright Red)
    33: { color: '#fbbf24', solid: true, type: 'wall' }, // Gold Altar/Throne (Solid, Gold)
    };

    function getTile(map, x, y) { if (y >= 0 && y < map.layout.length && x >= 0 && x < map.layout[y].length) return map.layout[y][x]; return -1; }

    function gameLoop() { draw(); requestAnimationFrame(gameLoop); }

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const mapData = maps[gameState.currentMap];
    if (!mapData) return;

    if (!gameState.particles) gameState.particles = [];
    const time = Date.now();
    const realTime = new Date().getHours();
    const isNight = realTime >= 18 || realTime < 6; 

    // --- SMOOTH CAMERA LOGIC ---
    if (!gameState.camera) {
        gameState.camera = { 
            x: gameState.player.x * tileSize, 
            y: gameState.player.y * tileSize 
        };
    }

    const targetX = gameState.player.x * tileSize;
    const targetY = gameState.player.y * tileSize;

    // Smooth movement (Lerp)
    gameState.camera.x += (targetX - gameState.camera.x) * 0.1;
    gameState.camera.y += (targetY - gameState.camera.y) * 0.1;

    // FIX: Round the values to prevent "Grid Lines"
    const offsetX = Math.floor(-gameState.camera.x + canvas.width / 2 - 16);
    const offsetY = Math.floor(-gameState.camera.y + canvas.height / 2 - 16);

    ctx.save();
    ctx.translate(offsetX, offsetY);

    // --- HELPER: Draw Reflection ---
    const drawReflection = (sprite, x, y) => {
        ctx.save();
        ctx.translate(x * tileSize + tileSize/2, y * tileSize + tileSize); 
        ctx.scale(1, -0.6); 
        ctx.globalAlpha = 0.3; 
        ctx.font = `${tileSize * 0.8}px serif`;
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = '#fff';
        ctx.fillText(sprites[sprite], 0, -tileSize/2);
        ctx.restore();
    };

    // --- DRAW MAP ---
    for (let y = 0; y < mapData.layout.length; y++) {
        for (let x = 0; x < mapData.layout[y].length; x++) {
            const tileId = mapData.layout[y][x];
            const tile = tileTypes[tileId];
            const tx = x * tileSize;
            const ty = y * tileSize;

            if (tile) {
                ctx.fillStyle = tile.color || '#000';
                ctx.fillRect(tx, ty, tileSize + 1, tileSize + 1); // +1 Fixes gaps

                if (tile.type === 'void') {
                    ctx.fillStyle = `rgba(255,255,255, ${Math.abs(Math.sin((time + x*100 + y*100)/1000))})`; 
                    ctx.fillRect(tx + (x*y)%20, ty + (x+y)%20, 2, 2); 
                }
                if (tile.type === 'roof') {
                    ctx.fillStyle = 'rgba(0,0,0,0.15)'; ctx.fillRect(tx, ty + 8, tileSize, 2); ctx.fillRect(tx + 8, ty, 2, 8);
                }
                if (tile.type && tile.type.includes('wall')) {
                    ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.fillRect(tx, ty + 7, tileSize, 2);
                }
                if (tile.isWindow) {
                    ctx.fillStyle = '#1f2937'; ctx.fillRect(tx + 2, ty + 2, tileSize - 4, tileSize - 4);
                    ctx.fillStyle = isNight ? '#fde047' : '#60a5fa'; ctx.fillRect(tx + 4, ty + 4, tileSize - 8, tileSize - 8);
                }
            }
            if(tileId === 8) drawSprite('tree', x, y);
            if(tileId === 16) drawSprite('flower', x, y);
            if (mapData.encounters && (mapData.encounters.includes('Hyper-bole') || mapData.encounters.includes('PronounProwler')) && tileId === 29) {
                 drawSprite('palmTree', x, y);
            }
        }
    }

    // --- REFLECTIONS ---
    let tileUnderPlayer = getTile(mapData, gameState.player.x, gameState.player.y + 1);
    if (tileTypes[tileUnderPlayer] && (tileTypes[tileUnderPlayer].type === 'water' || tileTypes[tileUnderPlayer].type === 'void' || tileTypes[tileUnderPlayer].type === 'ocean')) {
        drawReflection(gameState.player.sprite, gameState.player.x, gameState.player.y + 1);
    }
    if (mapData.objects) {
        for (const key in mapData.objects) {
            const parts = key.split(',');
            const x = parseInt(parts[0]);
            const y = parseInt(parts[1]);
            const obj = mapData.objects[key];
            if (obj.sprite) {
                let tileUnder = getTile(mapData, x, y + 1);
                if (tileTypes[tileUnder] && (tileTypes[tileUnder].type === 'water' || tileTypes[tileUnder].type === 'void' || tileTypes[tileUnder].type === 'ocean')) {
                    drawReflection(obj.sprite, x, y + 1);
                }
            }
        }
    }

    // --- OBJECTS ---
    if (mapData.objects) {
        for (const key in mapData.objects) {
            const parts = key.split(',');
            const x = parseInt(parts[0]);
            const y = parseInt(parts[1]);
            const obj = mapData.objects[key];
            const tx = x * tileSize;
            const ty = y * tileSize;
            const uniqueID = `${gameState.currentMap}_${x}_${y}`;
            if (gameState.pickedItems && gameState.pickedItems.includes(uniqueID)) continue; 

            if (obj.sprite) {
                ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.beginPath();
                ctx.ellipse(tx + 16, ty + 28, 10, 4, 0, 0, Math.PI * 2); ctx.fill();
                drawSprite(obj.sprite, x, y);
            } 
            else if (obj.target) {
                const tileUnder = getTile(mapData, x, y);
                if (tileUnder !== 13 && tileUnder !== 26) {
                     ctx.fillStyle = '#2d1b0e'; ctx.fillRect(tx, ty, tileSize, tileSize);
                     ctx.fillStyle = '#8B4513'; ctx.fillRect(tx + 2, ty + 2, tileSize - 4, tileSize - 4);
                     ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.arc(tx + 6, ty + tileSize/2, 3, 0, Math.PI * 2); ctx.fill();
                }
                let icon = '';
                const t = obj.target.toLowerCase();
                if (t.includes('shop')) icon = '🛒';
                else if (t.includes('center')) icon = '❤️';
                else if (t.includes('gym')) icon = '💪';
                else if (t.includes('school')) icon = '🎓';
                if (icon) {
                    ctx.font = '20px serif'; ctx.textAlign = 'center';
                    const bounce = Math.sin(Date.now() / 300) * 3;
                    ctx.fillText(icon, tx + tileSize/2, ty - 5 + bounce);
                }
            }
        }
    }

    if(gameState.currentMap === 'village' && gameState.earthquake1Triggered) drawSprite('hole', 8, 5);

    // --- PLAYER ---
    ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.beginPath();
    ctx.ellipse(gameState.player.x * tileSize + 16, gameState.player.y * tileSize + 28, 10, 4, 0, 0, Math.PI * 2); ctx.fill();
    drawSprite(gameState.player.sprite, gameState.player.x, gameState.player.y);
    
    // --- WEATHER & LIGHTING ---
    if (gameState.currentMap === 'desertedIsland' || gameState.earthquake2Triggered) {
        ctx.strokeStyle = 'rgba(173, 216, 230, 0.6)'; ctx.lineWidth = 2; ctx.beginPath();
        for (let i = 0; i < 50; i++) {
            const rx = (Math.sin(i * 1321) * 1000 + time * 0.5) % (canvas.width + 200) - 100;
            const ry = (Math.cos(i * 987) * 1000 + time * 0.8) % (canvas.height + 200) - 100;
            ctx.moveTo(rx, ry); ctx.lineTo(rx - 10, ry + 20);
        }
        ctx.stroke();
    }
    
    if (gameState.currentMap === 'adjectiveWoods') {
        // Fireflies in woods
        for (let i = 0; i < 10; i++) {
            const lx = (Math.sin(i * 100) * 1000 + time * 0.05) % canvas.width;
            const ly = (Math.cos(i * 200) * 1000 + time * 0.02) % canvas.height;
            ctx.fillStyle = '#fde047'; ctx.globalAlpha = Math.abs(Math.sin(time/500)); 
            ctx.fillRect(Math.abs(lx), Math.abs(ly), 3, 3);
        }
        ctx.globalAlpha = 1.0;
    }

    const isIndoors = ['House', 'Room', 'Gym', 'center', 'Shop', 'Cave', 'library', 'school'].some(type => gameState.currentMap.toLowerCase().includes(type.toLowerCase()));
    if (isNight && !gameState.inBattle && !isIndoors) {
        ctx.fillStyle = 'rgba(0, 0, 50, 0.15)'; ctx.fillRect(offsetX - 1000, offsetY - 1000, 4000, 4000); 
    }

// --- VIGNETTE (Screen Edges) ---
    
    ctx.restore();

// --- PASTE THIS AFTER ctx.restore() ---

// 1. VIGNETTE (Cinematic Dark Corners)
const cx = canvas.width / 2;
const cy = canvas.height / 2;
const vignette = ctx.createRadialGradient(cx, cy, canvas.width * 0.5, cx, cy, canvas.width * 0.9);
vignette.addColorStop(0, 'rgba(0,0,0,0)'); 
vignette.addColorStop(1, 'rgba(0,0,0,0.4)'); 
ctx.fillStyle = vignette; 
ctx.fillRect(0, 0, canvas.width, canvas.height);

// 2. CAVE DARKNESS (Dynamic Lighting)
// Only active in Cave Level 1 if you DO NOT have the light item
if (gameState.currentMap === 'caveLevel1' && (gameState.inventory.LH01LuminousHyperbole || 0) === 0) {

    // Calculate Player's Position ON THE SCREEN (not the map)
    // formula: (WorldPos * 32) + CameraOffset + CenterOfTile
    const playerScreenX = (gameState.player.x * tileSize) + offsetX + (tileSize / 2);
    const playerScreenY = (gameState.player.y * tileSize) + offsetY + (tileSize / 2);

    // Radius: 2.5 tiles (approx 80px) + slight breathing animation
    const radius = (tileSize * 2.5) + (Math.sin(Date.now() / 200) * 2);

    // Draw the Gradient centered on the PLAYER
    const caveGrad = ctx.createRadialGradient(playerScreenX, playerScreenY, radius * 0.5, playerScreenX, playerScreenY, radius * 1.5);
    caveGrad.addColorStop(0, 'rgba(0,0,0,0)');      // Transparent center (Vision)
    caveGrad.addColorStop(1, 'rgba(0,0,0,0.98)');   // Pitch Black edges

    ctx.fillStyle = caveGrad;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
}

    // --- EPIC BATTLE PARTICLES RENDERER ---
    // (This is drawn in screen space, so we ignore camera transform)
    if (gameState.inBattle && gameState.particles.length > 0) {
        for (let i = gameState.particles.length - 1; i >= 0; i--) {
            const p = gameState.particles[i];
            p.life--;
            p.x += p.vx; 
            p.y += p.vy;
            
            // Apply Gravity if needed
            if (p.gravity) p.vy += p.gravity;

            ctx.save();
            ctx.translate(p.x, p.y);
            
            // TEXT PARTICLES (BAM!)
            if (p.type === 'text') {
                ctx.fillStyle = p.color;
                ctx.font = `bold ${p.size}px sans-serif`;
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.strokeText(p.text, 0, 0);
                ctx.fillText(p.text, 0, 0);
            }
            // LEAF PARTICLES (Spinning)
            else if (p.type === 'leaf') {
                p.rotation += p.vRot;
                ctx.rotate(p.rotation * Math.PI / 180);
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.ellipse(0, 0, p.size, p.size/2, 0, 0, Math.PI * 2);
                ctx.fill();
            }
            // FIRE PARTICLES (Shrinking Rects)
            else if (p.type === 'fire') {
                p.size *= 0.95; // Shrink
                ctx.fillStyle = p.color;
                ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
            }
            // WATER/DEFAULT (Circles)
            else {
                ctx.fillStyle = p.color;
                ctx.beginPath(); 
                ctx.arc(0, 0, p.size, 0, Math.PI * 2); 
                ctx.fill();
            }
            
            ctx.restore();

            if (p.life <= 0 || p.size < 0.5) gameState.particles.splice(i, 1);
        }
    }

    if (gameState.inSafariZone) {
        ctx.fillStyle = 'white'; ctx.strokeStyle = 'black'; ctx.lineWidth = 4;
        ctx.font = '20px sans-serif'; ctx.textAlign = 'left';
        ctx.strokeText(`Steps: ${gameState.safariSteps}`, 20, 40); ctx.fillText(`Steps: ${gameState.safariSteps}`, 20, 40);
    }
}
// --- BATTLE FX ENGINE ---
function triggerBattleFX(type, targetIsPlayer) {
    if (!gameState.particles) gameState.particles = [];
    
    // 1. Determine Origin (Who got hit?)
    // If targetIsPlayer is true, the explosion happens on the Player.
    const targetId = targetIsPlayer ? 'player-sprite' : 'opponent-sprite';
    const rect = document.getElementById(targetId).getBoundingClientRect();
    
    // Convert DOM position to Canvas position roughly
    const scaleX = canvas.width / document.body.clientWidth;
    const scaleY = canvas.height / document.body.clientHeight;
    
    // Center of the sprite
    let cx = targetIsPlayer ? canvas.width * 0.25 : canvas.width * 0.75;
    let cy = canvas.height * 0.45; // Slightly higher than feet

    // 2. Spawn Specific Particles based on Type
    let count = 20;
    
    // --- FIRE (Rising Sparks) ---
    if (type === 'Fire') {
        count = 40;
        for(let i=0; i<count; i++) {
            gameState.particles.push({
                type: 'fire',
                x: cx, y: cy,
                vx: (Math.random() - 0.5) * 15,
                vy: (Math.random() * -10) - 2, // Upward velocity
                life: 40 + Math.random() * 20,
                color: Math.random() > 0.5 ? '#ef4444' : '#fbbf24', // Red/Orange
                size: 5 + Math.random() * 5
            });
        }
    }
    
    // --- WATER (Falling Droplets with Gravity) ---
    else if (type === 'Water') {
        count = 30;
        for(let i=0; i<count; i++) {
            gameState.particles.push({
                type: 'water',
                x: cx, y: cy - 50, // Start higher
                vx: (Math.random() - 0.5) * 10,
                vy: (Math.random() * 5) - 10, // Up then down
                gravity: 0.8,
                life: 50,
                color: '#60a5fa',
                size: 4 + Math.random() * 4
            });
        }
    }
    
    // --- GRASS (Floating Leaves) ---
    else if (type === 'Grass') {
        count = 25;
        for(let i=0; i<count; i++) {
            gameState.particles.push({
                type: 'leaf',
                x: cx, y: cy - 40,
                vx: (Math.random() - 0.5) * 12,
                vy: (Math.random() - 0.5) * 12,
                rotation: Math.random() * 360,
                vRot: (Math.random() - 0.5) * 10, // Spin speed
                life: 60 + Math.random() * 20,
                color: '#22c55e',
                size: 6 + Math.random() * 4
            });
        }
    }
    
    // --- NORMAL / DEFAULT (Impact Star) ---
    else {
        count = 15;
        for(let i=0; i<count; i++) {
            gameState.particles.push({
                type: 'impact',
                x: cx, y: cy,
                vx: (Math.random() - 0.5) * 20, // Fast explode
                vy: (Math.random() - 0.5) * 20,
                life: 20 + Math.random() * 10,
                color: '#ffffff',
                size: 3 + Math.random() * 8
            });
        }
    }

    // --- ADD "POW!" TEXT PARTICLE ---
    const words = ["BAM!", "POW!", "CRASH!", "HIT!"];
    const word = words[Math.floor(Math.random() * words.length)];
    gameState.particles.push({
        type: 'text',
        text: word,
        x: cx, y: cy - 20,
        vx: (Math.random() - 0.5) * 2,
        vy: -3, // Float up
        life: 40,
        color: '#fff',
        size: 30
    });
}
    function handleConfirmAction() {
        if (gameState.inDialogue && choicesBox.children.length === 0) {
            advanceDialogue();
        } else if (!gameState.activeScene && !gameState.inBattle && !gameState.inDialogue) {
            checkForInteraction();
        }
    }

    function handleCancelAction() {
        if (gameState.activeScene) {
            closeAllMenus();
        } else if (gameState.inDialogue) {
            dialogueQueue = []; // Clear the queue
            const cb = dialogueCallback;
            gameState.inDialogue = false;
            messageText.textContent = '';
            dialogueCallback = null;
        }
    }

function handleDrPowersInteraction() {
    // STATE 2: Quest Complete (Potions Upgraded)
    if (gameState.runOnQuest === 2) {
        return "Dr. Powers: 'The virus is contained! Your potions are now 50% more effective thanks to my research.'";
    }

    // STATE 1: Quest In Progress
    if (gameState.runOnQuest === 1) {
        if ((gameState.infectedFixed || 0) >= 3) {
            // Quest Completion Trigger
            gameState.runOnQuest = 2;
            gameState.potionUpgrade = true; // Flag for improved healing
            return [
                "Dr. Powers: 'You did it! You edited the chaos into order!'",
                "Dr. Powers: 'The Wordworms are back to normal.'",
                "Dr. Powers: 'As a reward, I've used the data to improve your healing items.'",
                "Your Potions are now REVISED POTIONS! (They heal 50% more HP!)"
            ];
        } else {
            return `Dr. Powers: 'You've fixed ${gameState.infectedFixed || 0}/3 run-on sentences. Keep checking Route 2!'`;
        }
    }

    // STATE 0: Start Quest
    startDialogue([
        "Dr. Powers is pacing nervously, surrounded by glitching text.",
        "Dr. Powers: 'Oh, thank goodness you're here!'",
        "Dr. Powers: 'My research on the Infinite Run-on Sentence has leaked!'",
        "Dr. Powers: 'It has infected the Wordworms on Route 2. They won't stop! They have infinite health!'",
        "Dr. Powers: 'Take this. It's the only way to stop them.'"
    ], () => {
        gameState.inventory.redPen = 1;
        gameState.runOnQuest = 1;
        gameState.infectedFixed = 0;
        startDialogue([
            "You received the RED PEN!",
            "Dr. Powers: 'Use the Red Pen in battle to insert a Period and stop their healing loop!'",
            "Dr. Powers: 'Go to Route 2 and fix 3 Infected Wordworms!'"
        ]);
    });
    return null;
}

    function handleInput(key) {
        // Universal cancel action
        if (key === 'b' || key === 'x' || key === 'Backspace' || key === 'Escape') {
            handleCancelAction();
            return;
        }

        // Universal confirm action
        if (key === 'a' || key === 'z' || key === 'Enter') {
            handleConfirmAction();
            return;
        }
        
        // Block movement during any UI state
        if (gameState.inDialogue || gameState.inBattle || gameState.activeScene) return;

        // Handle movement
        let {x, y} = gameState.player;
        switch(key) {
            case 'ArrowUp': y--; break;
            case 'ArrowDown': y++; break;
            case 'ArrowLeft': x--; break;
            case 'ArrowRight': x++; break;
            case 'm': toggleMenu(); return;
        }
        movePlayer(x,y);
    }
    
    // Canvas click for dev mode toggle
    canvas.addEventListener('click', (event) => {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;

        const canvasX = (event.clientX - rect.left) * scaleX;
        const canvasY = (event.clientY - rect.top) * scaleY;

        const offsetX = -gameState.player.x * tileSize + canvas.width / 2;
        const offsetY = -gameState.player.y * tileSize + canvas.height / 2;

        const mapX = Math.floor((canvasX - offsetX) / tileSize);
        const mapY = Math.floor((canvasY - offsetY) / tileSize);

        // --- NEW: Final Cave BOSS SKIP Trigger ---
        // Click Top-Left (0,0) in Final Cave with Dev Mode ON
        if (gameState.currentMap === 'finalCave' && mapX === 0 && mapY === 0 && gameState.devModeActive) {
            
            // 1. Mark bosses as defeated
            if (!gameState.defeatedTrainers.includes('finalBoss1')) gameState.defeatedTrainers.push('finalBoss1');
            if (!gameState.defeatedTrainers.includes('finalBoss2')) gameState.defeatedTrainers.push('finalBoss2');

            // 2. Remove them from the map object immediately
            if(maps.finalCave.objects['9,3']) delete maps.finalCave.objects['9,3']; // Boss 1
            if(maps.finalCave.objects['9,2']) delete maps.finalCave.objects['9,2']; // Boss 2

            // 3. Update the screen
            draw();
            
            startDialogue("Dev Trigger: Final Bosses defeated! The path to the Master Thesis is open.");
        }
        
        // Original dev mode toggle
        if (gameState.currentMap === 'village' && mapX === 0 && mapY === 0) {
            toggleDevMode();
        }

        // Earthquake dev trigger in Synonym City Gym
        if (gameState.currentMap === 'synonymCityGym' && mapX === 0 && mapY === 0) {
            triggerEarthquake();
        }
        
        // Cave boss dev trigger
        if (gameState.currentMap === 'caveLevel1' && mapX === 0 && mapY === 0 && gameState.devModeActive) {
            if (gameState.inventory.boatPart === 0) {
                gameState.inventory.boatPart = 1;
                if(!gameState.defeatedTrainers.includes('goblinBoss')) {
                    gameState.defeatedTrainers.push('goblinBoss');
                }
                startDialogue("Dev Trigger: Obtained the Engine Cog!");
            } else {
                startDialogue("You already have the Engine Cog.");
            }
            // --- NEW: Final Cave Master Thesis Trigger ---
// --- NEW: Final Cave "Level Skip" Trigger ---
        if (gameState.currentMap === 'finalCave' && mapX === 0 && mapY === 0 && gameState.devModeActive) {
            // 1. Give the Item
            if ((gameState.inventory.masterthesis || 0) === 0) {
                gameState.inventory.masterthesis = 1;
                startDialogue("Dev Trigger: Obtained the Master Thesis!");
            }

            // 2. MARK ELITES AS DEFEATED
            const elites = ['elitePoet', 'eliteDramatist', 'eliteJournalist', 'eliteGrammarian'];
            elites.forEach(id => {
                if(!gameState.defeatedTrainers.includes(id)) {
                    gameState.defeatedTrainers.push(id);
                }
            });

            // 3. DELETE THEM FROM THE MAP VISUALLY
            // (We target their specific coordinates to remove the sprites)
            if(maps.finalCave.objects['12,16']) delete maps.finalCave.objects['12,16']; // Poet
            if(maps.finalCave.objects['1,13'])  delete maps.finalCave.objects['1,13'];  // Dramatist
            if(maps.finalCave.objects['12,10']) delete maps.finalCave.objects['12,10']; // Journalist
            if(maps.finalCave.objects['1,7'])   delete maps.finalCave.objects['1,7'];   // Grammarian

            draw(); // Update the screen immediately
            startDialogue("Dev Trigger: The Elite Four have been cleared! The path is open.");
        }
        }
        
        // Island boss dev trigger
        if (gameState.currentMap === 'desertedIsland' && mapX === 0 && mapY === 0 && gameState.devModeActive) {
            if (gameState.inventory.LH02LyricalHightail === 0) {
                gameState.inventory.LH02LyricalHightail = 1;
                if(!gameState.defeatedTrainers.includes('shipwreckedPilot')) {
                    gameState.defeatedTrainers.push('shipwreckedPilot');
                }
                startDialogue(["Dev Trigger: Obtained LH02 Lyrical Hightail!"], () => {
                    changeMap('village', 10, 10);
                    startDialogue("You use the pilot's plane to fly home.");
                });
            } else {
                startDialogue("You already have LH02 Lyrical Hightail.");
            }
        }
    });
// --- NEW: Final Cave Master Thesis Trigger ---
        if (gameState.currentMap === 'finalCave' && mapX === 0 && mapY === 0 && gameState.devModeActive) {
            if ((gameState.inventory.masterthesis || 0) === 0) {
                gameState.inventory.masterthesis = 1;
                startDialogue("Dev Trigger: Obtained the Master Thesis!");
            } else {
                startDialogue("You already have the Master Thesis.");
            }
        }
function toggleDevMode() {
        gameState.devModeActive = !gameState.devModeActive;
        if (gameState.devModeActive) {
            gameState.money += 5000; // Add $500
            startDialogue("Dev Mode Activated! Barriers unlocked. (+$5000 Added)");
        } else {
            startDialogue("Dev Mode Deactivated. Barriers restored to normal.");
        }
    }

    window.addEventListener('keydown', (e) => {
        let key = e.key;
        if(key === 'z') key = 'a';
        if(key === 'x' || e.key === 'Backspace') key = 'b';
        handleInput(key)
    });

    // Touch Controls Setup
    const setupTouchButton = (id, key) => {
        const button = document.getElementById(id);
        if (button) button.addEventListener('click', () => handleInput(key));
    };

    // Movement
    setupTouchButton('touch-up', 'ArrowUp');
    setupTouchButton('touch-down', 'ArrowDown');
    setupTouchButton('touch-left', 'ArrowLeft');
    setupTouchButton('touch-right', 'ArrowRight');
    setupTouchButton('touch-up-lg', 'ArrowUp');
    setupTouchButton('touch-down-lg', 'ArrowDown');
    setupTouchButton('touch-left-lg', 'ArrowLeft');
    setupTouchButton('touch-right-lg', 'ArrowRight');

    // Actions
    setupTouchButton('touch-a', 'a');
    setupTouchButton('touch-a-lg', 'a');
    setupTouchButton('touch-b', 'b');
    setupTouchButton('touch-b-lg', 'b');
    
    document.getElementById('menu-btn').addEventListener('click', toggleMenu);
    
    messageBox.addEventListener('click', (e) => {
        if (e.target.closest('#choices-box')) return;
        if (gameState.inDialogue && !gameState.inBattle) {
            advanceDialogue();
        }
    });
    
    battleBox.addEventListener('click', (e) => { 
        if (e.target.closest('#battle-grid')) return;
        if (gameState.inDialogue && gameState.inBattle) {
            advanceBattleDialogue();
        }
    });


function changeMap(mapName, newX, newY) { 
    // 1. Start Fade Out (Screen goes black)
    const overlay = document.getElementById('transition-overlay');
    if(overlay) overlay.classList.add('fade-out');

    // 2. Wait 200ms, then switch map behind the darkness
    setTimeout(() => {
        gameState.currentMap = mapName;
        gameState.player.x = newX;
        gameState.player.y = newY; 
        
        // --- FINAL BATTLE TRIGGER (Monsters Invading) ---
        if (mapName === 'village' && gameState.defeatedTrainers.includes('shipwreckedPilot') && !gameState.finalBossDefeated) {
            triggerFinalBattleScene();
        }

        // --- POST-GAME: ANDY AT THE TREE ---
        if (mapName === 'village' && gameState.defeatedTrainers.includes('finalRival')) {
            // Spawn Andy next to the carved tree (13,8)
            maps.village.objects['12,8'] = { 
                sprite: 'rival', 
                interaction: "Andy: 'Hey! I was just looking at our initials on the tree. We've come a long way, haven't we?'" 
            };
        }

// --- FINAL BOSS ROOM SPAWN LOGIC ---
        if (mapName === 'rivalsRoom') {
            // Only spawn if he invited us (Post-Thesis Dialogue)
            if (gameState.andyInvited && !gameState.defeatedTrainers.includes('finalRival')) {
                maps.rivalsRoom.objects['1,2'] = { sprite: 'rival', interaction: handleFinalRivalBattle };
            } else {
                // Ensure he is gone if we haven't invited him OR if we already beat him
                if (maps.rivalsRoom.objects['1,2']) delete maps.rivalsRoom.objects['1,2'];
            }
        }

        // Force a draw so the new map is ready before we fade in
        draw();

        // 3. Fade In (Screen reveals new map)
        setTimeout(() => {
            if(overlay) overlay.classList.remove('fade-out');
        }, 100); 

    }, 300); 
}

    let dialogueQueue = [], dialogueCallback = null;
function startDialogue(messages, onComplete = null) {
        messageBox.classList.remove('hidden'); // <--- Reveals the box over the controls
        dialogueQueue = Array.isArray(messages) ? [...messages] : [messages];
        dialogueCallback = onComplete; 
        gameState.inDialogue = true;
        messageText.textContent = dialogueQueue.shift() || ''; 
        choicesBox.innerHTML = '';
    }
function advanceDialogue() {
        if (dialogueQueue.length > 0) { 
            messageText.textContent = dialogueQueue.shift();
        } else { 
            const cb = dialogueCallback; 
            gameState.inDialogue = false;
            messageText.textContent = ''; 
            messageBox.classList.add('hidden'); // <--- Hides box to reveal controls
            dialogueCallback = null; 
            if (cb) cb(); 
        }
    }
function showChoices(prompt, choices) {
        gameState.inDialogue = true;
        messageBox.classList.remove('hidden'); // <--- THIS WAS MISSING!
        messageText.textContent = prompt; 
        choicesBox.innerHTML = '';
        choices.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = 'p-2 bg-gray-200 hover:bg-yellow-300 border-2 border-gray-400 rounded text-gray-800 text-lg';
            btn.textContent = choice.text; 
            btn.onclick = (e) => { 
                e.stopPropagation();
                choicesBox.innerHTML = ''; 
                if (choice.callback) choice.callback(); 
            };
            choicesBox.appendChild(btn);
        });
    }

    function checkForInteraction() {
        const { x, y } = gameState.player, dirs = [[0,-1], [0,1], [-1,0], [1,0]];
        for (const [dx, dy] of dirs) {
            const key = `${x + dx},${y + dy}`;
            const obj = maps[gameState.currentMap].objects[key];
            const tileId = getTile(maps[gameState.currentMap], x + dx, y + dy);
            const tile = tileTypes[tileId];

            if (obj && obj.interaction) { 
                const res = typeof obj.interaction === 'function' ? obj.interaction() : obj.interaction; 
                if (res) startDialogue(res); 
                return;
            }
             if (tile && tile.isWindow) {
                 const windowObj = Object.values(maps[gameState.currentMap].objects).find(o => o.x === (x+dx) && o.y === (y+dy));
                 if(windowObj && windowObj.interaction) {
                    startDialogue(windowObj.interaction());
                 } else {
                    startDialogue("You look out the window.");
                 }
                return;
            }
        }
    }
    
    function openScene(sceneElement) { closeAllMenus(true); gameState.activeScene = sceneElement.id; sceneElement.classList.remove('hidden'); }
    function closeAllMenus(silent = false) { [menuScene, inventoryScene, creatureStatsScene, journalScene, pcScene].forEach(s => s.classList.add('hidden')); if (!silent) gameState.activeScene = null; }
function toggleMenu() { 
    if(gameState.activeScene === 'menu-scene') {
        closeAllMenus();
    } else {
        // --- NEW: CLOCK LOGIC ---
        const now = new Date();
        let hours = now.getHours();
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        
        // Convert to 12-hour format
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        
        const timeString = `${hours}:${minutes} ${ampm}`;
        const clockEl = document.getElementById('menu-clock');
        if(clockEl) {
            clockEl.textContent = `Current Time: ${timeString}`;
            // Optional: Change color if it's Night (after 6 PM)
            if (ampm === 'PM' && (now.getHours() >= 18) || (ampm === 'AM' && now.getHours() < 6)) {
                clockEl.style.color = '#1e3a8a'; // Dark Blue for Night
                clockEl.textContent += " 🌙";
            } else {
                clockEl.style.color = '#ea580c'; // Orange for Day
                clockEl.textContent += " ☀️";
            }
        }
        
        openScene(menuScene);
    }
}
    
    document.getElementById('menu-close-btn').onclick = () => closeAllMenus();
    document.getElementById('menu-inventory-btn').onclick = () => { updateInventoryUI(); openScene(inventoryScene); };
    document.getElementById('menu-creature-btn').onclick = () => { updatecreatureStatsUI(); openScene(creatureStatsScene); };
    document.getElementById('menu-journal-btn').onclick = () => { updatejournalUI(); openScene(journalScene); };
    document.querySelectorAll('.ui-back-btn').forEach(btn => btn.onclick = () => openScene(menuScene));
    document.getElementById('pc-close-btn').onclick = () => closeAllMenus();


function updateInventoryUI() {
    document.getElementById('inventory-money').textContent = `$${gameState.money}`;
    const items = document.getElementById('inventory-items'); 
    items.innerHTML = '';

    const createItem = (key, count) => {
        if(count > 0 && itemsDB[key]){ // Added check for itemsDB[key] safety
            const itemData = itemsDB[key];
            const div = document.createElement('div'); 
            div.className = 'grid grid-cols-3 gap-2 items-center text-xl';
            div.innerHTML = `<span class="col-span-2">${itemData.name} x${count}</span>`;
            
            const btn = document.createElement('button');
            
            if (key === 'LH02LyricalHightail') {
                btn.className = 'p-2 bg-green-500 text-white rounded-lg';
                btn.textContent = 'Fly';
                btn.onclick = () => useFastTravel();
            } 
            else if (key === 'synonymRoll') {
                btn.className = 'p-2 bg-green-500 text-white rounded-lg';
                btn.textContent = 'Eat';
                btn.onclick = () => useSynonymRoll(); 
            }
            else if (key === 'peaceTreaty') {
                btn.className = 'p-2 bg-green-500 text-white rounded-lg';
                btn.textContent = 'Sign';
                btn.onclick = () => {
                    if(gameState.repelSteps > 0) {
                        startDialogue("A treaty is already in effect!");
                    } else {
                        gameState.inventory.peaceTreaty--;
                        gameState.repelSteps = 150;
                        startDialogue("You signed the Peace Treaty! No wild battles for 150 steps.");
                        updateInventoryUI();
                    }
                };
            }
            else {
                btn.className = 'p-2 bg-blue-500 text-white rounded-lg';
                btn.textContent = 'Info';
                btn.onclick = () => startDialogue(itemData.description);
            }
            
            div.appendChild(btn);
            items.appendChild(div);
        }
    };
    Object.keys(gameState.inventory).forEach(key => createItem(key, gameState.inventory[key]));
    if(items.innerHTML === '') items.innerHTML = '<p class="text-xl text-center">No items.</p>';
}

    function updatecreatureStatsUI() {
        const content = document.getElementById('creature-stats-content');
        if (gameState.playerParty.length === 0) { 
            content.innerHTML = '<h2 class="text-2xl text-center">You have no Creatures!</h2> <button class="ui-back-btn mt-6 w-full p-3 bg-yellow-500 text-black rounded-lg text-2xl">Back</button>'; 
            content.querySelector('.ui-back-btn').onclick = () => openScene(menuScene);
            return; 
        }

        content.innerHTML = '<h2 class="text-3xl text-center mb-4">Your Party</h2>';
        const partyGrid = document.createElement('div');
        partyGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
        
        gameState.playerParty.forEach(p => {
            const card = document.createElement('div');
            card.className = 'p-4 border rounded-lg border-gray-400';
            card.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="text-6xl">${sprites[p.sprite]}</div>
                    <div>
                        <h3 class="text-2xl">${p.name} <span class="text-xl text-gray-500">Lvl ${p.level}</span></h3>
                        <p class="text-lg">HP: ${Math.ceil(p.currentHp)} / ${p.maxHp}</p>
                        <div class="w-full bg-gray-300 rounded-full h-4 my-1"><div class="bg-green-500 h-full rounded-full" style="width: ${p.currentHp/p.maxHp*100}%"></div></div>
                    </div>
                </div>
            `;
            partyGrid.appendChild(card);
        });

        content.appendChild(partyGrid);
        
        const backButton = document.createElement('button');
        backButton.className = "ui-back-btn mt-6 w-full p-3 bg-yellow-500 text-black rounded-lg text-2xl";
        backButton.textContent = "Back";
        backButton.onclick = () => openScene(menuScene);
        content.appendChild(backButton);
    }
    
    function updatejournalUI() {
        const entries = document.getElementById('journal-entries'); entries.innerHTML = '';
        const seenSpecies = Object.keys(gameState.journal).sort();
        if (seenSpecies.length === 0) { entries.innerHTML = '<p class="text-xl text-center">No data yet. Encounter creatures to add them!</p>'; return; }
        
        seenSpecies.forEach(species => {
            const entry = gameState.journal[species];
            const entryDiv = document.createElement('div'); entryDiv.className = 'p-2 border rounded border-gray-400 grid grid-cols-4 gap-2 items-center';
            const caughtIcon = entry.caught ? sprites.wordorb : '○';
            entryDiv.innerHTML = ` <div class="text-5xl text-center">${sprites[creatureDB[species] ? creatureDB[species].sprite : species.toLowerCase()]}</div> <div class="col-span-3"> <h3 class="text-2xl">${species} ${caughtIcon}</h3> <p class="text-sm">${journalData[species]}</p> </div> `;
            entries.appendChild(entryDiv);
        });
    }

    function handleBedInteraction() { if (gameState.playerParty.length > 0) { gameState.playerParty.forEach(p => p.currentHp = p.maxHp); return ["You took a short nap.", "Your team is fully healed!"]; } return "A comfy bed."; }
    
    function handleProfessorInteraction() {
        if (gameState.playerParty.length > 0) {
            return "Now that you have a partner, a great adventure begins! Go on, get out there!";
        }
        startDialogue([
            "Ah, you're here! I'm Professor Lexicon.",
            "Your rival, Andy, and the other trainers were early and took the first pickings...",
            "But I saved one special creature just for you!",
            "It's a Synonymouse! Please, take good care of it.",
        ], () => {
            const newcreature = createcreature("Synonymouse", 5);
            addcreatureToParty(newcreature);
            startDialogue([
                "You got a SYNONYMOUSE!",
                "Synonymouse was added to your party."
            ]);
        });
        return null;
    }

    function handleGateInteraction() {
        if (gameState.devModeActive || gameState.rivalDefeated) {
             changeMap('route1', 7, 4);
             return null;
        }
        if (gameState.playerParty.length === 0) return "The gate is locked tight.";
        if (gameState.inBattle || gameState.inDialogue) return;
        startDialogue([ "Andy: 'Hold it right there!'", "'I've been studying! I challenge you to a battle!'" ], () => startBattle([createcreature('Grammargoyle', 7)], 'Andy'));
        return null;
    }

function handleHoleEntrance() {
        if (gameState.earthquake1Triggered) {
            changeMap('caveLevel1', 2, 2);
            return null;
        }
        return null;
    }
    
    function handleBoulderInteraction() {
        if (gameState.earthquake2Triggered && !creatureDB['Lexiconstruct'].caught) {
            maps.caveLevel1.layout[3][14] = 28; // Make boulder passable
            return "The boulder crumbles away!";
        } else if (creatureDB['Lexiconstruct'].caught) {
            return "The path to the legendary is clear."
        }
        return "A massive boulder blocks the path. It won't budge.";
    }

    function handleLegendaryBattle() {
        if(gameState.journal['Lexiconstruct']?.caught) {
            return "The pedestal is empty. The legendary creature is gone."
        }
        startDialogue(["A huge stone creature stirs...", "It's the Legendary LEXICONSTRUCT!"], () => {
            startBattle([createcreature('Lexiconstruct', 70)], "Wild Lexiconstruct");
        });
        return null;
    }
    
function handleFinalRivalBattle() {
    // 1. Check if already defeated (Post-Game Friendship)
    if (gameState.defeatedTrainers.includes('finalRival')) {
        return "Andy: 'That battle was legendary. We should team up for the sequel!'";
    }
    
    // 2. START BATTLE
    startDialogue([
        "Andy is glued to his video game.",
        "Andy: 'Just... one... more... level...'",
        "He pauses the game and spins his chair around.",
        "Andy: 'You actually came. Good.'",
        "Andy: 'I used to think being your Rival meant I had to be your enemy.'",
        "Andy: 'But I've realized... Antonyms just help define each other. You make me better.'",
        "Andy: 'I've trained my team to counter yours. Let's see if your Master Thesis can save you now!'"
    ], () => {
            startBattle(
                trainersDB.finalRival.creature.map(p => createcreature(p.species, p.level)), 
                trainersDB.finalRival.name, 
                'finalRival'
            );
    });
    return null;
}

    function useOxfordComma() {
         if ((gameState.inventory.oxfordComma || 0) > 0) {
            gameState.inventory.oxfordComma--;
            currentBattle.playercreature.currentHp = currentBattle.playercreature.maxHp; 
            currentBattle.playercreature.status = null; 
            
            updateBattleUI(); 
            currentBattle.turn = 'opponent';
            startBattleDialogue([
                "You used an Oxford Comma.", 
                "It clarified the situation!", 
                `${currentBattle.playercreature.name} is fully healed and cured!`
            ], nextBattleTurn);
        } else {
            startBattleDialogue("You don't have any!", showMainBattleMenu);
        }
    }


function handleCaptainInteraction() {
        // 1. If we have the Cog, give it to him
        if (gameState.inventory.boatPart > 0) {
            gameState.inventory.boatPart = 0;
            
            // FIX: The Captain is at '12,5', not '9,5'
            if (maps.homeBay.objects['12,5']) {
                maps.homeBay.objects['12,5'].interaction = startSailingSequence;
            }
            
            return ["Arr, what's this? This is the exact Engine Cog I need for me engine! You found it!", "Give me a moment...", "All fixed! We can set sail whenever you're ready! (Talk to me again to leave)."];
        }

        // 2. If we already gave it to him (He handles the sailing now)
        if (gameState.defeatedTrainers.includes('goblinBoss') && gameState.inventory.boatPart === 0) {
             // If we already fixed the boat, just sail
             startSailingSequence();
             return null;
        }

        // 3. Default text
        return "Arr, my boat's engine is sputtering. It's out of order right now. But I have a feeling it will be important later... that's called foreshadowing.";
    }
    
    function startSailingSequence() {
        startDialogue(["Captain: All aboard!"], () => {
            // Fake "sailing" map change could go here if we had one. For now, dialogue.
            startDialogue(["You set sail on the open sea...", "The water is calm and the sky is clear."], () => {
                setTimeout(() => {
                    startDialogue(["Suddenly, the sea begins to churn! Another earthquake!"], () => {
                        shakeScreen(3000);
                        setTimeout(() => {
                            gameState.earthquake2Triggered = true;
                            startDialogue(["A colossal wave crashes over the boat!", "Everything goes black..."], () => {
                                gameState.playerParty.forEach(p => { if (p.currentHp > 1) p.currentHp = Math.ceil(p.currentHp / 4); });
                                changeMap('desertedIsland', 3, 7);
                                startDialogue("You wake up on a sandy beach, your creatures weak...");
                            });
                        }, 3000);
                    });
                }, 2000);
            });
        });
        return null;
    }


    function handleNurseInteraction() { 
        if(gameState.playerParty.length > 0) { 
            gameState.playerParty.forEach(p => p.currentHp = p.maxHp); 
            return "Your team has been restored to full health!"; 
        } 
        return "Welcome to the Word Center!"; 
    }
    
    function confirmPurchase(itemName, price, description, onConfirm) {
        showChoices(`${itemName}: ${description} It costs $${price}. Buy it?`, [
            { text: "Yes", callback: () => {
                if (gameState.money >= price) {
                    gameState.money -= price;
                    onConfirm();
                    startDialogue(`You bought one ${itemName}.`, () => handleShopInteraction());
                } else {
                    startDialogue("Sorry, you don't have enough money.", () => handleShopInteraction());
                }
            }},
            { text: "No", callback: () => handleShopInteraction() }
        ]);
    }

function handleShopInteraction() {
    showChoices("Welcome! What can I get for you?", [
        { text: "Potion ($25)", callback: () => confirmPurchase("Potion", 25, itemsDB.potions.description, () => gameState.inventory.potions++) },
        { text: "Word Ball ($50)", callback: () => confirmPurchase("Word Ball", 50, itemsDB.wordballs.description, () => gameState.inventory.wordballs++) },
        { text: "Peace Treaty ($150)", callback: () => confirmPurchase("Peace Treaty", 150, itemsDB.peaceTreaty.description, () => gameState.inventory.peaceTreaty++) },
        { text: "Oxford Comma ($100)", callback: () => confirmPurchase("Oxford Comma", 100, itemsDB.oxfordComma.description, () => gameState.inventory.oxfordComma++) },
        { text: "Great Phrase ($200)", callback: () => confirmPurchase("Great Phrase", 200, itemsDB.greatphrases.description, () => gameState.inventory.greatphrases++) },
        { text: "Ultra Sentence ($500)", callback: () => confirmPurchase("Ultra Sentence", 500, itemsDB.ultrasentences.description, () => gameState.inventory.ultrasentences++) },
        { text: "Leave", callback: () => startDialogue("Come again!") }
    ]);
    return null;
}

    const poeQuotes = [ "Quoth the Raven, 'Nevermore.'", "All that we see or seem is but a dream within a dream.", "The boundaries which divide Life from Death are at best shadowy and vague.", "I was never really insane except upon occasions when my heart was touched.", "Words have no power to impress the mind without the exquisite horror of their reality.", "To be buried alive is, beyond question, the most terrific of these extremes which has ever fallen to the lot of mere mortality.", "I have great faith in fools - self-confidence my friends call it.", "The true genius shudders at incompleteness.", "I became insane, with long intervals of horrible sanity.", "Beauty of whatever kind, in its supreme development, invariably excites the sensitive soul to tears.", "Believe nothing you hear, and only one half that you see.", "The death of a beautiful woman is, unquestionably, the most poetical topic in the world.", "Men have called me mad; but the question is not yet settled.", "That which you mistake for madness is but over-acuteness of the senses.", "From childhood's hour I have not been as others were.", "I have no faith in human perfectibility. I think that human exertion will have no appreciable effect upon humanity.", "Sleep, those little slices of death — how I loathe them.", "The scariest monsters are the ones that lurk within our souls.", "There is no exquisite beauty without some strangeness in the proportion.", "To vilify a great man is the readiest way in which a little man can himself attain greatness." ];
    function handlePoeInteraction() { return poeQuotes[Math.floor(Math.random() * poeQuotes.length)]; }
    // --- NEW AUTHOR INTERACTIONS ---
    
    const dickinsonQuotes = [
        "Hope is the thing with feathers that perches in the soul.",
        "I'm Nobody! Who are you? Are you – Nobody – too?",
        "Forever – is composed of Nows.",
        "That it will never come again is what makes life so sweet.",
        "The Soul selects her own Society – Then – shuts the Door.",
        "To live is so startling it leaves little time for anything else.",
        "A word is dead when it is said, some say. I say it just begins to live that day."
    ];
    function handleDickinsonInteraction() { return dickinsonQuotes[Math.floor(Math.random() * dickinsonQuotes.length)]; }

    const shakespeareQuotes = [
        "To be, or not to be: that is the question.",
        "All the world's a stage, and all the men and women merely players.",
        "The course of true love never did run smooth.",
        "Parting is such sweet sorrow.",
        "Cowards die many times before their deaths; the valiant never taste of death but once.",
        "Brevity is the soul of wit.",
        "Go wisely and slowly. Those who rush stumble and fall."
    ];
    function handleShakespeareInteraction() { return shakespeareQuotes[Math.floor(Math.random() * shakespeareQuotes.length)]; }

    const hughesQuotes = [
        "Hold fast to dreams, for if dreams die, life is a broken-winged bird that cannot fly.",
        "My soul has grown deep like the rivers.",
        "I have discovered in life that there are ways of getting almost anywhere you want to go, if you really want to go.",
        "Life is for the living.",
        "Humor is your own unconscious therapy.",
        "Like a welcome summer rain, humor may suddenly cleanse and cool the earth, the air and you."
    ];
    function handleHughesInteraction() { return hughesQuotes[Math.floor(Math.random() * hughesQuotes.length)]; }
    function handleDeathMasheenInteraction() {
        if (!gameState.hasMetDeathMasheen) {
            startDialogue(
                ["DeathMasheen34: 'Leveled Up Learning is the future!'"],
                () => {
                    gameState.hasMetDeathMasheen = true;
                    const gamerObject = maps.cityHouse3.objects['2,3'];
                    gamerObject.sprite = 'graduate';
                    gamerObject.interaction = "Tom: 'I'm going to be a principal some day. Gamification rules!'";
                }
            );
            return null;
        }
        return "Tom: 'I'm going to be a principal some day. Gamification rules!'";
    }

function handleGymLeaderInteraction() {
        if (gameState.gymBadges.rhyme) return "Rhonda: 'You've already graduated Middle School. Continue your journey!'";
        if (gameState.playerParty.length === 0) return "You need a partner to challenge a Master!";
        if (gameState.playerParty.length > 0 && gameState.playerParty.every(p => p.level < 10)) return ["My rhymes are tough, my rhythm's tight,", "A level 10 you'll need to fight!"];
        
        startDialogue(trainersDB.gymLeaderRhonda.preBattle, () => startBattle(
            trainersDB.gymLeaderRhonda.creature.map(p => createcreature(p.species, p.level)), 
            'Middle School Master Rhonda', // <--- Updated Display Name
            'gymLeaderRhonda'
        ));
    }

    function handleSynonymGymLeaderInteraction() {
        if (gameState.gymBadges.synonym) return "Lex: 'Your vocabulary is college-ready. Go and continue your quest.'";
        if (gameState.playerParty.length === 0) return "You need a partner to challenge a Hero!";
        if (gameState.playerParty.length > 0 && gameState.playerParty.every(p => p.level < 25)) return ["My words are weighty, my knowledge deep.", "Return when your team's level has made a leap.", "(Recommended Level: 25+)"];
        
        startDialogue(trainersDB.gymLeaderLex.preBattle, () => startBattle(
            trainersDB.gymLeaderLex.creature.map(p => createcreature(p.species, p.level)), 
            'High School Hero Lex', // <--- Updated Display Name
            'gymLeaderLex'
        ));
    }

    function handleNorthGate() {
        if (gameState.devModeActive) { changeMap('route2', 7, 13); return null; }
        if(!gameState.gymBadges.rhyme) return "A guard blocks the way. 'Only trainers who have earned the Rhyme Badge may pass!'";
        if(!gameState.rivalDefeatedPostGym) {
            startDialogue(["Andy: 'You got a gym badge? Hah! Just lucky!'", "'Let's see how you handle a REAL battle!'"], () => {
                startBattle([createcreature('Grammargoyle', 13), createcreature('CommaLeon', 12)], 'Andy');
            });
            return null;
        }
        changeMap('route2', 7, 13);
        return null;
    }

    function handleTrainerBattle(trainerId) {
        if(gameState.defeatedTrainers.includes(trainerId)) {
            startDialogue(trainersDB[trainerId].postBattle);
            if (trainerId === 'shipwreckedPilot') {
                 startDialogue(["Pilot: It's time for me to go home."], () => {
                    changeMap('village', 10, 10);
                    startDialogue("The pilot drops you off and flies away towards Lexington City.");
                });
            }
            return null;
        }
        startDialogue(trainersDB[trainerId].preBattle, () => {
            const opponentcreatures = trainersDB[trainerId].creature.map(p => createcreature(p.species, p.level));
            startBattle(opponentcreatures, `Trainer ${trainersDB[trainerId].name}`, trainerId);
        });
        return null;
    }
function handleEliteBattle(trainerId, mapX, mapY) {
    // Safety check: If we already beat them, they shouldn't trigger battle
    if (gameState.defeatedTrainers.includes(trainerId)) return "You may pass.";
    
    startDialogue(trainersDB[trainerId].preBattle, () => {
        const opponentcreatures = trainersDB[trainerId].creature.map(p => createcreature(p.species, p.level));
        // Start the battle - Cleanup is now handled in endBattle()
        startBattle(opponentcreatures, trainersDB[trainerId].name, trainerId);
    });
    return null;
}

function handleLHItem() {
        if (gameState.inventory.LH01LuminousHyperbole > 0) {
            return "An empty pedestal. You already took the item here.";
        }
        gameState.inventory.LH01LuminousHyperbole = 1;
        
        // FIX: Delete the Lightbulb (12,8), NOT the Hiker (14,8)
        if (maps.adjectiveWoods.objects['12,8']) {
            delete maps.adjectiveWoods.objects['12,8'];
        }
        draw(); // Force the item to disappear immediately
        return [ "You found LH01 (Luminous Hyperbole)!", itemsDB.LH01LuminousHyperbole.description ];
    }
    
    function handlePCInteraction() {
        const choices = [
            { text: "Access Storage", callback: () => {
                gameState.inDialogue = false;
                messageText.textContent = '';
                updatePCUI();
                openScene(pcScene);
            }}
        ];

        if (gameState.teleportUnlocked) {
            choices.push({ text: "Home Warp", callback: () => {
                startDialogue(["You connected to the home network...", "Warping complete!"], () => {
                    changeMap('playerHouse', 4, 4);
                });
            }});
        }

        choices.push({ text: "Cancel", callback: () => {
            gameState.inDialogue = false;
            messageText.textContent = '';
        }});

        showChoices("A PC. What would you like to do?", choices);
        return null;
    }

    function updatePCUI() {
        const partyContainer = document.getElementById('pc-party');
        const boxContainer = document.getElementById('pc-box');
        partyContainer.innerHTML = '';
        boxContainer.innerHTML = '';

        gameState.playerParty.forEach((creature, index) => {
            const div = document.createElement('div');
            div.className = 'pc-item p-2 border rounded';
            div.innerHTML = `<span>${sprites[creature.sprite]} ${creature.name} Lvl ${creature.level}</span>`;
            div.onclick = () => moveFromPartyToBox(index);
            partyContainer.appendChild(div);
        });
        gameState.creatureBox.forEach((creature, index) => {
            const div = document.createElement('div');
            div.className = 'pc-item p-2 border rounded';
            div.innerHTML = `<span>${sprites[creature.sprite]} ${creature.name} Lvl ${creature.level}</span>`;
            div.onclick = () => moveFromBoxToParty(index);
            boxContainer.appendChild(div);
        });
    }

    function moveFromPartyToBox(index) {
        if (gameState.playerParty.length <= 1) {
            closeAllMenus(); startDialogue("You can't deposit your last creature!"); return;
        }
        const [movedcreature] = gameState.playerParty.splice(index, 1);
        gameState.creatureBox.push(movedcreature); updatePCUI();
    }

    function moveFromBoxToParty(index) {
        if (gameState.playerParty.length >= 6) {
            closeAllMenus(); startDialogue("Your party is full!"); return;
        }
        const [movedcreature] = gameState.creatureBox.splice(index, 1);
        gameState.playerParty.push(movedcreature); updatePCUI();
    }

    function startBattleDialogue(messages, onComplete = null) {
        dialogueQueue = Array.isArray(messages) ? [...messages] : [messages]; dialogueCallback = onComplete; gameState.inDialogue = true;
        battleText.textContent = dialogueQueue.shift(); battleGrid.innerHTML = '';
    }
    function advanceBattleDialogue() { if (dialogueQueue.length > 0) { battleText.textContent = dialogueQueue.shift(); } else { const cb = dialogueCallback; gameState.inDialogue = false; battleText.textContent = ''; dialogueCallback = null; if (cb) cb(); } }
    

    function handleOpponentFaint() {
         startBattleDialogue([`${currentBattle.opponentName}'s ${currentBattle.opponentParty[currentBattle.currentOpponentIndex].name} fainted!`], () => {
            currentBattle.currentOpponentIndex++;
            if(currentBattle.currentOpponentIndex < currentBattle.opponentParty.length){
                const newOpponent = currentBattle.opponentParty[currentBattle.currentOpponentIndex];
                newOpponent.statMods = { attack: 0, defense: 0 };
                updateBattleSprites(); updateBattleUI();
                startBattleDialogue([`${currentBattle.opponentName} sent out ${newOpponent.name}!`], () => { currentBattle.turn = 'player'; nextBattleTurn(); });
            } else {
                endBattle();
            }
         });
    }

    function handlePlayercreatureFaint() {
        startBattleDialogue([`${currentBattle.playercreature.name} fainted!`], () => {
            const canSwitch = gameState.playerParty.some(p => p.currentHp > 0);
            if (canSwitch) { showSwitchcreatureMenu(true); } else { endBattle(); }
        });
    }

    function showMainBattleMenu() {
        battleText.textContent = `What will ${currentBattle.playercreature.name} do?`; battleGrid.innerHTML = '';
        const createBtn = (text, onClick) => {
            const btn = document.createElement('button');
            btn.className = 'p-2 bg-gray-200 hover:bg-yellow-300 border-4 border-gray-400 rounded text-gray-800 text-lg';
            btn.textContent = text; btn.onclick = onClick; battleGrid.appendChild(btn);
        };
        createBtn('Fight', playerChooseAttack); createBtn('Item', showItemMenu);
        createBtn('Pokémon', () => showSwitchcreatureMenu(false)); 
        createBtn('Run', () => { 
            if(!currentBattle.trainerId) { startBattleDialogue('Got away safely!', () => endBattle(true)); } 
            else { startBattleDialogue("Can't run from a trainer battle!", showMainBattleMenu); } 
        });
    }

    function showSwitchcreatureMenu(isForced = false) {
        battleText.textContent = "Choose a creature."; battleGrid.innerHTML = '';
        gameState.playerParty.forEach((creature, index) => {
            const button = document.createElement('button');
            button.className = 'p-2 border-4 border-gray-400 rounded text-gray-800 text-lg flex justify-between items-center';
            button.innerHTML = `<div>${sprites[creature.sprite]} ${creature.name} Lvl ${creature.level}</div><div>${Math.ceil(creature.currentHp)}/${creature.maxHp} HP</div>`;
            if (creature.currentHp <= 0) { button.disabled = true; button.classList.add('bg-red-300', 'opacity-50'); } 
            else if (creature === currentBattle.playercreature) { button.disabled = true; button.classList.add('bg-yellow-200'); } 
            else { button.classList.add('bg-gray-200', 'hover:bg-yellow-300'); button.onclick = () => switchPlayercreature(index, isForced); }
            battleGrid.appendChild(button);
        });
        if (!isForced) {
            const backBtn = document.createElement('button'); backBtn.className = 'p-2 bg-yellow-400 hover:bg-yellow-500 border-4 border-gray-400 rounded text-gray-800 text-lg';
            backBtn.textContent = 'Back'; backBtn.onclick = showMainBattleMenu; battleGrid.appendChild(backBtn);
        }
    }

    function switchPlayercreature(newIndex, isForced = false) {
        const oldcreature = currentBattle.playercreature;
        const newcreature = gameState.playerParty[newIndex];
        currentBattle.playercreature = newcreature;
        currentBattle.playercreature.statMods = { attack: 0, defense: 0 };
        if (!currentBattle.participants.includes(newIndex)) currentBattle.participants.push(newIndex);
        updateBattleUI(); updateBattleSprites();
        if (isForced) { currentBattle.turn = 'player'; startBattleDialogue([`Go, ${newcreature.name}!`], nextBattleTurn); } 
        else { currentBattle.turn = 'opponent'; startBattleDialogue([`${oldcreature.name}, come back! Go, ${newcreature.name}!`], nextBattleTurn); }
    }

async function attemptCatch(ballKey) {
    const ball = itemsDB[ballKey];
    const opponent = currentBattle.opponentParty[currentBattle.currentOpponentIndex];
    
    // 1. Check for Legendaries (Master Thesis bypasses this)
    if (creatureDB[opponent.species].isLegendary && ballKey !== 'masterthesis') {
        // Legendaries are harder, but we don't auto-fail anymore. We just warn.
        // (Logic handled in calculation below)
    }

    // 2. Check Inventory
    if (gameState.inventory[ballKey] <= 0) {
        startBattleDialogue("You don't have any of those!", showItemMenu);
        return;
    }

    // 3. Throw Logic & Animation
    gameState.inventory[ballKey]--;
    
    // --- EPIC UPGRADE: CHECK FOCUS ---
    let focusMultiplier = 1;
    let throwMessage = `You threw a ${ball.name}!`;
    
    if (currentBattle.focus >= 3) {
        focusMultiplier = 2.5; // Huge bonus, but not guaranteed for Legendaries
        currentBattle.focus = 0; // CONSUME THE BAR
        throwMessage = `SCHOLAR'S FOCUS! You threw a Precision ${ball.name}!`;
        // Update UI to remove stars
        const stars = "☆☆☆"; 
        battleText.textContent = `Focus: ${stars} Throwing...`;
    }
    
    startBattleDialogue(throwMessage);
    await animateBallThrow(ballKey);

    // 4. Calculate Capture Odds
    const maxHp = opponent.maxHp;
    const currentHp = opponent.currentHp;
    const catchRate = creatureDB[opponent.species].catchDifficulty || 45;
    const safariMod = currentBattle.catchRateMod || 1;

    // The Math: (HP Factor) * (Rarity) * (Ball Quality) * (Safari Bait) * (FOCUS BONUS)
    let a = (((3 * maxHp - 2 * currentHp) * catchRate * ball.bonus * safariMod * focusMultiplier) / (3 * maxHp));
    
    if (ball.bonus === 255) a = 255; // Master Thesis always catches

    const shakeCheck = () => a >= 255 || Math.floor(Math.random() * 256) < a;

    // 5. Shake Loop with Visuals
    let shakes = 0;
    const oSprite = document.getElementById('opponent-sprite');

    for (let i = 0; i < 4; i++) {
        if (shakeCheck()) {
            shakes++;
            oSprite.classList.add('shake-catch');
            await new Promise(res => setTimeout(res, 750));
            oSprite.classList.remove('shake-catch');
            
            if (i < 3) await new Promise(res => startBattleDialogue(shakes === 3 ? "So close!" : "...", res));
        } else {
            break;
        }
    }

    // 6. Result: Catch or Fail
    if (shakes === 4) {
        const caughtcreature = opponent;
        await new Promise(res => startBattleDialogue("Gotcha!", res));
        addcreatureToParty(caughtcreature);
        await new Promise(res => startBattleDialogue(`${caughtcreature.name} was caught!`, res));
        
        if (gameState.playerParty.length <= 6) {
            await new Promise(res => startBattleDialogue(`${caughtcreature.name} was added to your party.`, res));
        } else {
            await new Promise(res => startBattleDialogue(`${caughtcreature.name} was sent to the PC.`, res));
        }

        if (creatureDB[caughtcreature.species].isLegendary) {
            if(maps.caveLevel1 && maps.caveLevel1.objects['14,3']) delete maps.caveLevel1.objects['14,3'];
        }
        endBattle(false, true);
    } else {
        await new Promise(res => startBattleDialogue("Oh no! The creature broke free!", res));
        currentBattle.turn = 'opponent';
        nextBattleTurn();
    }
}

    function playerChooseAttack() {
        battleText.textContent = `Choose an attack.`; battleGrid.innerHTML = '';
        currentBattle.playercreature.attacks.forEach(attack => {
            const button = document.createElement('button');
            button.className = 'p-2 bg-gray-200 hover:bg-yellow-300 border-4 border-gray-400 rounded text-gray-800 text-lg';
            button.textContent = attack.name; button.onclick = () => { currentBattle.chosenAttack = attack; presentQuestion(); }; battleGrid.appendChild(button);
        });
        const backBtn = document.createElement('button');
        backBtn.className = 'p-2 bg-yellow-400 hover:bg-yellow-500 border-4 border-gray-400 rounded text-gray-800 text-lg';
        backBtn.textContent = 'Back'; backBtn.onclick = showMainBattleMenu; battleGrid.appendChild(backBtn);
    }
    
    function presentQuestion() {
        const q = elaQuestions[Math.floor(Math.random() * elaQuestions.length)];
        currentBattle.currentQuestion = q; battleText.textContent = q.q; battleGrid.innerHTML = '';
        [...q.a].sort(() => Math.random() - 0.5).forEach(answer => {
            const btn = document.createElement('button');
            btn.className = 'p-2 bg-gray-200 hover:bg-yellow-300 border-4 border-gray-400 rounded text-gray-800 text-lg';
            btn.textContent = answer; btn.onclick = () => handleAnswer(answer); battleGrid.appendChild(btn);
        });
    }
    
function handleAnswer(answer) {
    let messages = [];
    const opponent = currentBattle.opponentParty[currentBattle.currentOpponentIndex];
    const q = currentBattle.currentQuestion;
    
    if (answer === q.c) {
        showFloatingText('player-sprite', "NICE!", 'heal'); // <--- VISUAL FEEDBACK
        messages.push(`Correct! ${q.ex || ''}`);
        messages.push(`${currentBattle.playercreature.name} used ${currentBattle.chosenAttack.name}!`);

        // Focus Bar Logic
        if (!currentBattle.focus) currentBattle.focus = 0;
        currentBattle.focus += 1;
        if (currentBattle.focus >= 3) messages.push("SCHOLAR'S FOCUS IS FULL! ULTIMATE READY!");
        
        // --- VISUALS ---
        const pSprite = document.getElementById('player-sprite');
        pSprite.classList.add('lunge-right');
        setTimeout(() => pSprite.classList.remove('lunge-right'), 300);
        
        // TRIGGER PARTICLES!
        const moveType = currentBattle.chosenAttack.name.includes("ULTIMATE") ? 'ULTIMATE' : (currentBattle.chosenAttack.type || 'Normal');
        triggerBattleFX(moveType, false);
        // False = Hit Enemy

        if (currentBattle.chosenAttack.power > 0) {
            const result = calculateDamage(currentBattle.chosenAttack, currentBattle.playercreature, opponent);
            opponent.currentHp -= result.damage;
            messages.push(`${currentBattle.opponentName}'s ${opponent.name} took ${result.damage} damage!`);
            if(result.message) messages.push(result.message);
            
            const oSprite = document.getElementById('opponent-sprite');
            oSprite.classList.add('damage-anim'); 
            setTimeout(() => oSprite.classList.remove('damage-anim'), 500);
        }
        messages.push(...applyAttackEffect(currentBattle.chosenAttack, currentBattle.playercreature, opponent));
    } else {
        showFloatingText('player-sprite', "MISS", 'damage'); // <--- VISUAL FEEDBACK
        messages.push(`Incorrect! ${q.ex || ''}`);
        messages.push(`${currentBattle.playercreature.name}'s attack missed...`);
        currentBattle.focus = 0;
    }
    updateBattleUI();
    currentBattle.turn = 'opponent'; 
    startBattleDialogue(messages, nextBattleTurn);
}

function calculateDamage(attack, attacker, defender) {
    // 1. Define Type Matchups
    const typeChart = {
        'Water': { strong: 'Fire', weak: 'Grass' },
        'Fire':  { strong: 'Grass', weak: 'Water' },
        'Grass': { strong: 'Water', weak: 'Fire' },
        'Normal': { strong: null, weak: null }
    };
    
    // 2. Get Types
    const moveType = attack.type || 'Normal'; 
    const defData = creatureDB[defender.species];
    const defType = defData ? (defData.type || 'Normal') : 'Normal';

    // 3. Calculate Multiplier
    let multiplier = 1;
    let message = "";
    if (typeChart[moveType]) {
        if (typeChart[moveType].strong === defType) {
            multiplier = 2;
            message = "It's Super Persuasive!!";
        } else if (typeChart[moveType].weak === defType) {
            multiplier = 0.5;
            message = "A weak argument...";
        }
    }

    // 4. Do the Math
    const attackStat = attacker.attack * (1 + attacker.statMods.attack * 0.25);
    const defenseStat = defender.defense * (1 + defender.statMods.defense * 0.25);
    const baseDamage = (attack.power * multiplier) + (attackStat / 2);
    const finalDamage = Math.max(1, Math.floor(baseDamage - (defenseStat / 4)));

    // --- NEW: Trigger Floating Text ---
    // Determine which sprite gets the number (The one getting hit)
    // If the attacker is the player, the opponent (opponent-sprite) takes damage.
    const targetId = (attacker === currentBattle.playercreature) ? 'opponent-sprite' : 'player-sprite';
    showFloatingText(targetId, `-${finalDamage}`);
    // ----------------------------------

    return { damage: finalDamage, message: message };
}

function applyAttackEffect(attack, attacker, target) {
        const effectMessages = [];
        if (attack.effect) {
            const targetcreature = (attack.effect.target === 'opponent') ? target : attacker;
            const targetName = (attack.effect.target === 'opponent') ? 'The opponent\'s' : 'Your';
            
            // STAT MODS
            if (attack.effect.type === 'stat') {
                const { stat, amount } = attack.effect;
                targetcreature.statMods[stat] = Math.max(-4, Math.min(4, targetcreature.statMods[stat] + amount));
                effectMessages.push(`${targetName} ${targetcreature.name}'s ${stat} ${amount < 0 ? 'fell' : 'rose'}!`);
            }
            // NEW: STATUS EFFECTS
            else if (attack.effect.type === 'status') {
                if(targetcreature.status === null) {
                    targetcreature.status = attack.effect.status;
                    effectMessages.push(`${targetName} ${targetcreature.name} got Writer's Block!`);
                }
            }
        }
        return effectMessages;
    }
    
    function updateBattleUI() {
        if (!currentBattle) return;
        const p = currentBattle.playercreature;
        const o = currentBattle.opponentParty[currentBattle.currentOpponentIndex];
        document.getElementById('player-hp').style.width = `${Math.max(0,(p.currentHp/p.maxHp)*100)}%`;
        document.getElementById('opponent-hp').style.width = `${Math.max(0,(o.currentHp/o.maxHp)*100)}%`;
        document.getElementById('player-name').textContent = `${p.name} Lvl ${p.level}`;
        document.getElementById('opponent-name').textContent = `${o.name} Lvl ${o.level}`;
        document.getElementById('player-hp-text').textContent = `HP: ${Math.ceil(p.currentHp)}/${p.maxHp}`;
    }

    function updateBattleSprites() {
        if (!currentBattle) return;
        document.getElementById('player-sprite').textContent = sprites[currentBattle.playercreature.sprite];
        document.getElementById('opponent-sprite').textContent = sprites[currentBattle.opponentParty[currentBattle.currentOpponentIndex].sprite];
    }
    
async function endBattle(ranAway = false, caught = false) {
        if (!currentBattle && !ranAway) return;
        if (ranAway || caught) { gameState.inBattle = false; battleScene.classList.add('hidden'); currentBattle = null; return;
        }

        const playerWon = currentBattle.playercreature.currentHp > 0;
        const oldBattle = currentBattle;
        currentBattle = null;

        if (!playerWon) {
            await new Promise(res => startBattleDialogue(["You are out of usable creatures!", "You blacked out..."], res));
            gameState.playerParty.forEach(p => p.currentHp = p.maxHp);
            changeMap('pocketcenter', 4, 4);
        } else {
            const money = oldBattle.trainerId ? trainersDB[oldBattle.trainerId].reward : 15;
            let winMsg = [];
            gameState.money += money;
            if (oldBattle.trainerId) {
                winMsg = [`You defeated ${oldBattle.opponentName}!`, `You won $${money}!`];
                if(!gameState.defeatedTrainers.includes(oldBattle.trainerId)) gameState.defeatedTrainers.push(oldBattle.trainerId);
                
                // --- MAP CLEANUP: REMOVE BOSSES & ELITES IMMEDIATELY ---
                if (gameState.currentMap === 'finalCave') {
                     // Remove Elites
                     if (oldBattle.trainerId === 'eliteGrammarian' && maps.finalCave.objects['8,11']) delete maps.finalCave.objects['8,11'];
                     if (oldBattle.trainerId === 'eliteJournalist' && maps.finalCave.objects['11,11']) delete maps.finalCave.objects['11,11'];
                     if (oldBattle.trainerId === 'eliteDramatist' && maps.finalCave.objects['8,5']) delete maps.finalCave.objects['8,5'];
                     if (oldBattle.trainerId === 'elitePoet' && maps.finalCave.objects['11,5']) delete maps.finalCave.objects['11,5'];
                     
                     // Remove Final Bosses (Stacked)
                     if (oldBattle.trainerId === 'finalBoss1' && maps.finalCave.objects['9,3']) delete maps.finalCave.objects['9,3'];
                     if (oldBattle.trainerId === 'finalBoss2' && maps.finalCave.objects['9,2']) delete maps.finalCave.objects['9,2'];
                     
                     draw(); // Force screen update
                }
                // ---------------------------------------------------

            } else {
                 winMsg = [`You defeated the wild ${oldBattle.opponentParty[0].name}!`, `You won $${money}!`];
            }
            
            const xpGained = 50 * oldBattle.opponentParty.reduce((sum, p) => sum + p.level, 0) / oldBattle.opponentParty.length;
            const uniqueParticipants = [...new Set(oldBattle.participants)].map(index => gameState.playerParty[index]).filter(p => p.currentHp > 0);
            if (uniqueParticipants.length > 0) {
                winMsg.push(`${uniqueParticipants.map(p => p.name).join(' and ')} gained ${Math.floor(xpGained)} XP!`);
            }
            
            await new Promise(res => startBattleDialogue(winMsg, res));
            winMsg = [];

            for (const p of uniqueParticipants) {
                p.xp += xpGained;
                while (p.xp >= p.xpToNextLevel) {
                    p.level++;
                    p.xp -= p.xpToNextLevel; p.xpToNextLevel = Math.floor(p.xpToNextLevel * 1.5);
                    p.maxHp += 5; p.attack += 2; p.defense += 1; p.currentHp = p.maxHp;
                    winMsg.push(`${p.name} grew to level ${p.level}!`);
                    const newMove = creatureDB[p.species]?.learnset?.find(m => m.level === p.level);
                    if (newMove && p.attacks.length < 4) { p.attacks.push(attacksDB[newMove.move]); winMsg.push(`${p.name} learned ${newMove.move}!`);
                    }
                }
            }
            if (winMsg.length > 0) await new Promise(res => startBattleDialogue(winMsg, res));
            
            // EVOLUTION CHECK
            for (let i = 0; i < gameState.playerParty.length; i++) {
                const p = gameState.playerParty[i];
                const speciesData = creatureDB[p.species];
                if (speciesData && speciesData.evolvesAt && p.level >= speciesData.evolvesAt && !p.hasEvolved) {
                    await new Promise(res => startBattleDialogue([`What? ${p.name} is evolving!`], res));
                    const oldName = p.name; const newSpecies = speciesData.evolvesTo;
                    const newcreature = createcreature(newSpecies, p.level); newcreature.xp = p.xp; newcreature.hasEvolved = true;
                    gameState.playerParty[i] = newcreature;
                    await new Promise(res => startBattleDialogue([`Congratulations! Your ${oldName} evolved into ${newSpecies}!`], res));
                }
            }

            // --- BADGES AND STORY REWARDS ---
            if (oldBattle.trainerId === 'gymLeaderRhonda' && !gameState.gymBadges.rhyme) {
                gameState.gymBadges.rhyme = true;
                await new Promise(res => startBattleDialogue(["You received the Rhyme Badge!"], res));
            }
            if (oldBattle.trainerId === 'gymLeaderLex' && !gameState.gymBadges.synonym) {
                gameState.gymBadges.synonym = true;
                await new Promise(res => startBattleDialogue(["You received the Synonym Badge!"], res));
                triggerEarthquake(); return;
            }

            // GOBLIN GRUNT LOOT DROP (ENGINE COG)
            if (oldBattle.trainerId === 'goblinBoss') {
                gameState.inventory.boatPart = 1;
                await new Promise(res => startBattleDialogue([
                    "The Goblin dropped a heavy metal object!",
                    "You obtained the Engine Cog!",
                    "This looks like it belongs to a boat..."
                ], res));
            }
            
            // FINAL BOSS 2: MASTER THESIS DROP (Moved logic here just in case, though it's on the map now)
            if (oldBattle.trainerId === 'finalBoss2') {
                 await new Promise(res => startBattleDialogue([
                    "The Goblin King falls!",
                    "The path to the ultimate knowledge is open."
                ], res));
            }

            if (oldBattle.trainerId === 'shipwreckedPilot') {
                gameState.inventory.LH02LyricalHightail = 1;
                await new Promise(res => startBattleDialogue(["You got LH02 Lyrical Hightail!"], res));
                startDialogue(["Pilot: It's time for me to go home."], () => {
                    changeMap('village', 10, 10);
                    startDialogue("The pilot drops you off and flies away towards Lexington City.");
                });
                return;
            }

            // END GAME CREDITS TRIGGER
            if (oldBattle.trainerId === 'finalRival') {
                showCredits();
                return;
            }

            // --- SENSEI WU LOGIC ---
            if (oldBattle.trainerId === 'senseiWu') {
                gameState.trainingStreak++;
                await new Promise(res => startBattleDialogue([
                    "Sensei Wu: Magnificent!",
                    "I will retreat to meditate on this loss.",
                    "Come back when you are ready for the next level."
                ], res));
                gameState.playerParty.forEach(p => p.currentHp = p.maxHp);
                await new Promise(res => startBattleDialogue(["Sensei Wu healed your party as a sign of respect."], res));
            }
            
            if (oldBattle.opponentName === 'Andy' && !gameState.rivalDefeated) gameState.rivalDefeated = true;
            if (oldBattle.opponentName === 'Andy' && gameState.gymBadges.rhyme) gameState.rivalDefeatedPostGym = true;
        }
        gameState.inBattle = false;
        battleScene.classList.add('hidden');
    }

    function addcreatureToParty(creature) {
        if (!gameState.journal[creature.species]) gameState.journal[creature.species] = { seen: true, caught: false };
        gameState.journal[creature.species].caught = true;
        if (gameState.playerParty.length < 6) gameState.playerParty.push(creature);
        else gameState.creatureBox.push(creature);
    }
    
// Paste this at the very bottom of your script if you don't have it
function shakeScreen(duration = 500) {
    const container = document.getElementById('game-container');
    container.classList.remove('shake');
    void container.offsetWidth; // Force Reflow (Reset animation)
    container.classList.add('shake');
    
    // Remove class after animation
    setTimeout(() => {
        container.classList.remove('shake');
    }, duration);
}
    
function triggerEarthquake() {
    if(gameState.earthquake1Triggered) return;
    startDialogue(["The ground begins to tremble violently!"], () => {
        shakeScreen(3000);
        setTimeout(() => {
            gameState.earthquake1Triggered = true;
            if(maps.village) {
                 // 1. OPEN HOLE IN CENTER PATH (x=8, y=5)
                 // We change the tile to black (26) so it looks like a pit
                 maps.village.layout[5][8] = 26; 
                 
                 // 2. CREATE THE WARP (Must include sprite: 'hole' to stop it from being a door)
                 maps.village.objects['8,5'] = { 
                    target: 'caveLevel1', 
                    x: 2, y: 2, 
                    sprite: 'hole' 
                 };
                 
                 // 3. PLACE WILLIAM PENN (To the right of the hole)
                 maps.village.objects['9,5'] = { 
                    sprite: 'professor', 
                    interaction: ["Geologist William Penn: Fascinating! A tectonic shift revealing a subterranean layer!"]
                 };

                 // 4. PLACE RIVAL (MOVED TO 6,5 TO PREVENT BLOCKING THE PLAYER)
                 maps.village.objects['6,5'] = {
                    sprite: 'rival',
                    interaction: [
                        "Andy: Whoa... did you feel that?",
                        "This hole just opened up right in the middle of town!",
                        "We should check it out."
                    ]
                 };

                 // 5. REMOVE OLD OBJECTS (If any existed from previous saves)
                 if(maps.village.objects['4,5']) delete maps.village.objects['4,5'];
            }
            startDialogue([
                "B-b-brrrring! B-b-brrrring!",
                "Your phone is ringing. It's Mom!",
                "Mom: 'Sweetie, are you okay?! There was a huge earthquake!'",
                "'I've enabled the Home-Warp feature on the PC network. Use it to get back safely!'"
            ], () => {
                gameState.teleportUnlocked = true;
                startDialogue("The Home-Warp feature on PCs is now online!");
            });
        }, 3000);
    });
}

function triggerFinalBattleScene() {
    // 1. Make the ground look like a hole (Tile 26)
    maps.village.layout[7][7] = 26;
    maps.village.layout[7][8] = 26;
    maps.village.layout[8][7] = 26;
    maps.village.layout[8][8] = 26;
    
    // 2. Visuals: Place sprites near the hole
    maps.village.objects['6,7'] = { sprite: 'goblin' };
    maps.village.objects['9,7'] = { sprite: 'rival' };

    // 3. TARGET: The Base of the Pyramid (9, 19)
    maps.village.objects['7,7'] = { target: 'finalCave', x: 9, y: 19, sprite: 'hole' };
    maps.village.objects['7,8'] = { target: 'finalCave', x: 10, y: 19, sprite: 'hole' };
    maps.village.objects['8,7'] = { target: 'finalCave', x: 9, y: 19, sprite: 'hole' };
    maps.village.objects['8,8'] = { target: 'finalCave', x: 10, y: 19, sprite: 'hole' };
    
    // 4. Remove old NPCs
    if(maps.village.objects['3,6']) delete maps.village.objects['3,6'];
    if(maps.village.objects['5,6']) delete maps.village.objects['5,6'];

    startDialogue([
        "Andy: There you are! I was wondering when you'd show up.",
        "These things... they came out of this new hole.",
        "I'll hold off the small ones outside. You go in and stop the leader!",
        "Head into the hole when you are ready!"
    ]);
}
    
function showCredits() {
    // 1. Calculate Score (Grade) based on Journal Completion
    // Total catchable creatures is roughly 35-40.
    const totalCaught = Object.values(gameState.journal).filter(e => e.caught).length;
    let grade = "C";
    let comment = "Good effort!";
    
    if (totalCaught >= 10) { grade = "B"; comment = "Great work!"; }
    if (totalCaught >= 20) { grade = "A"; comment = "Excellent!"; }
    if (totalCaught >= 30) { grade = "A+"; comment = "Master!"; }

    // 2. Build the Certificate HTML
    const overlay = document.createElement('div');
    overlay.className = 'cert-overlay';
    
    // Generate the emoji team display
    let teamHtml = gameState.playerParty.map(p => 
        `<div title="${p.name}">${sprites[p.sprite]}</div>`
    ).join('');

    overlay.innerHTML = `
        <div class="cert-container">
            <div class="cert-title">Certificate of Mastery</div>
            <p style="font-size: 12px; margin-bottom: 10px;">This certifies that the student has conquered</p>
            <h2 style="font-size: 24px; margin-bottom: 10px;">ELA QUEST</h2>
            
            <div class="cert-grade-box">${grade}</div>
            
            <div class="cert-stats">
                <p><strong>Lexicon Count:</strong> ${totalCaught} Creatures</p>
                <p><strong>Teacher's Note:</strong> ${comment}</p>
            </div>
            
            <p style="margin-top: 20px; font-size: 12px;">FINAL TEAM</p>
            <div class="cert-team">${teamHtml}</div>
            
            <div style="margin-top: 30px; border-top: 2px dashed #ccc; padding-top: 10px;">
                <p style="font-size: 10px; color: #666;">Take a screenshot of this screen for your teacher!</p>
            </div>
            
            <button onclick="location.reload()" style="margin-top: 20px; background: #2563eb; color: white; border: none; padding: 10px 20px; font-family: inherit; cursor: pointer; border-radius: 6px;">New Game</button>
        </div>
    `;

    // 3. Add to screen
    document.body.appendChild(overlay);
    
    // Play a little victory sound effect if you wanted (optional)
    // playMusic('bgm-victory'); 
}

// --- NEW START GAME LOGIC ---
    
    const titleScene = document.getElementById('title-scene');
    let gameHasStarted = false;

function startGame() {
        if (gameHasStarted) return;
        gameHasStarted = true;
        
        // Instead of gameLoop(), go to character select
        showCharacterSelect();
    }
function showCharacterSelect() {
        const titleDiv = document.getElementById('title-scene');
        titleDiv.innerHTML = ''; // Clear "Press Start" text
        titleDiv.classList.remove('hidden'); // Make sure it's visible
        
        const title = document.createElement('h2');
        title.className = "text-3xl text-white mb-8";
        title.textContent = "Choose Your Character";
        titleDiv.appendChild(title);

        const container = document.createElement('div');
        container.className = "grid grid-cols-2 gap-4";
        
        // --- MATCHING AVATARS ---
        // These emojis must match your 'sprites' list exactly!
        const options = [
            { id: 'player_bowie', emoji: '👨‍🎤', label: 'Rock Star' },
            { id: 'player_green', emoji: '🥷',   label: 'Rebel' }, // Ninja matches Game Sprite
            { id: 'player_boy',   emoji: '👦',   label: 'Boy' },
            { id: 'player_girl',  emoji: '👧',   label: 'Girl' },
            { id: 'player_dog',   emoji: '🐶',   label: 'Dog' },
            { id: 'player_cat',   emoji: '🐱',   label: 'Cat' }
        ];

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = "p-4 bg-gray-800 hover:bg-blue-600 border-4 border-white rounded-xl flex flex-col items-center transition-transform hover:scale-110";
            btn.innerHTML = `<span class="text-6xl mb-2">${opt.emoji}</span><span class="text-sm text-white">${opt.label}</span>`;
            
            btn.onclick = () => {
                // 1. Set the sprite
                gameState.player.sprite = opt.id; 
                sprites.player = opt.emoji; // Update the 'player' key to match
                
                // 2. Start the actual game
                titleDiv.classList.add('hidden');
                gameLoop();
                startDialogue([ 
                    "You wake up.", 
                    "Mom (downstairs): 'Breakfast is ready!'", 
                    "(Arrows: Move | Z/Enter: Interact | M: Menu)" 
                ]);
            };
            container.appendChild(btn);
        });

        titleDiv.appendChild(container);
    }

    // Listen for inputs to start the game
    window.addEventListener('keydown', () => startGame());
    document.getElementById('title-scene').addEventListener('click', () => startGame());
    document.getElementById('touch-controls').addEventListener('click', () => startGame());
function handleSenseiWu() {
        const streak = gameState.trainingStreak;
        // 1. Calculate Difficulty based on Player's Best creature
        const playerMaxLevel = Math.max(...gameState.playerParty.map(p => p.level));
        // He is always slightly stronger than your best, plus a bonus for your streak
        const enemyLevel = playerMaxLevel + 2 + Math.floor(streak / 2);
        
        // 2. Dynamic Dialogue based on Streak
        let introText = [];
        if (streak === 0) {
            introText = ["Sensei Wu: I see you have potential.", "Defeat me, and I will grow stronger.", "Are you ready for your first lesson?"];
        } else {
            introText = [`Sensei Wu: You have won ${streak} times.`, `My creatures are now Level ${enemyLevel}.`, "I have studied your technique. Let us battle again!"];
        }

        // 3. Build His Team (Progressively adds more/stronger monsters)
        let enemyParty = [];
        // Slot 1: Always a solid evolved starter
        enemyParty.push(createcreature('ThesaurusRex', enemyLevel));
        // Slot 2: Unlocks after 1 win
        if (streak >= 1) enemyParty.push(createcreature('VerbViper', enemyLevel));
        // Slot 3: Unlocks after 3 wins (High Defense)
        if (streak >= 3) enemyParty.push(createcreature('Lexiconstruct', enemyLevel));
        // Slot 4: Unlocks after 5 wins (The Legend)
        if (streak >= 5) enemyParty.push(createcreature('Antonymph', enemyLevel + 2));
        // Slot 5: ULTIMATE CHALLENGE (Streak 10+)
        if (streak >= 10) enemyParty.push(createcreature('Lexiconstruct', enemyLevel + 5)); // A second, stronger Golem!

        // 4. Start the Battle
        startDialogue(introText, () => {
            // We use a custom callback to handle the "Win" logic specifically for him
            startBattle(enemyParty, `Sensei Wu (Streak ${streak})`, 'senseiWu');
        });
    }
function handleLibraryPuzzle() {
        if(gameState.inventory.escapeVerbs > 0) return "You already found the item in this book.";
        
        // FIX: Call startDialogue directly instead of returning it
        startDialogue([
            "You pull out a book: 'The Art of Punctuation'.",
            "Passage: 'To stop a sentence in its tracks, one must use the mark that signifies the end.'",
            "Riddle: I am a dot. I stop the flow. What am I?", 
        ], () => {
            showChoices("What is the answer?", [
                { text: "Comma (,)", callback: () => startDialogue("Incorrect. A comma pauses, but does not stop.") },
                { text: "Period (.)", callback: () => {
                    gameState.inventory.escapeVerbs = 1;
                    startDialogue(["Correct! A period stops a sentence.", "You found an Escape Verb hidden in the pages!"]);
                }},
                { text: "Hyphen (-)", callback: () => startDialogue("Incorrect.") }
            ]);
        });
        
        return null; // Return null so the engine waits for the dialogue above
    }
function useFastTravel() {
    // Check if they have the item
    if ((gameState.inventory.LH02LyricalHightail || 0) <= 0) {
        closeAllMenus();
        startDialogue("You need the 'Lyrical Hightail' item to fly!");
        return;
    }

    closeAllMenus();
    const choices = [
        { text: "Village (Home)", callback: () => { changeMap('village', 10, 10); startDialogue("You recited the verse and flew home!"); }},
        { text: "Lexington City", callback: () => { changeMap('lexingtonCity', 7, 12); startDialogue("You recited the verse and flew to the city!"); }},
        { text: "Cancel", callback: () => { openScene(menuScene); } }
    ];
    
    if (gameState.gymBadges.rhyme) {
         choices.splice(2, 0, { text: "Synonym City", callback: () => { changeMap('synonymCity', 9, 11); startDialogue("You flew to Synonym City!"); }});
    }
    showChoices("Where would you like to fly?", choices);
}

    // --- SYNONYM ROLL LOGIC ---
    function useSynonymRoll() {
        if ((gameState.inventory.synonymRoll || 0) <= 0) {
            startDialogue("You don't have any Synonym Rolls!");
            return;
        }
        
        startDialogue("Who should eat the Synonym Roll?", () => {
            const choices = gameState.playerParty.map((p, index) => ({
                text: `${p.name} (Lvl ${p.level})`,
                callback: () => {
                    gameState.inventory.synonymRoll--;
                    
                    // Level Up Logic
                    p.level++;
                    p.maxHp += 5; p.attack += 2; p.defense += 1; 
                    p.currentHp = p.maxHp; 
                    p.xp = 0; 
                    p.xpToNextLevel = Math.floor(p.xpToNextLevel * 1.5);
                    
                    // Evolution Check
                    const speciesData = creatureDB[p.species]; 
                    if (speciesData && speciesData.evolvesAt && p.level >= speciesData.evolvesAt && !p.hasEvolved) {
                        startDialogue([
                            `${p.name} ate the roll and grew to Level ${p.level}!`,
                            `...Wait! ${p.name} is evolving!`,
                            `Congratulations! Your ${p.name} evolved into ${speciesData.evolvesTo}!`
                        ], () => {
                            const newSpecies = speciesData.evolvesTo;
                            const newCreature = createcreature(newSpecies, p.level);
                            newCreature.xp = p.xp; 
                            newCreature.hasEvolved = true;
                            gameState.playerParty[index] = newCreature;
                            updateInventoryUI(); 
                        });
                    } else {
                        startDialogue([`${p.name} ate the roll.`, `${p.name} grew to Level ${p.level}!`], () => updateInventoryUI());
                    }
                }
            }));
            choices.push({ text: "Cancel", callback: () => updateInventoryUI() });
            showChoices("Select a creature:", choices);
        });
    }

    function handleFishermanInteraction() {
        if (gameState.inventory.oldRod > 0) {
            return "Fisherman: 'The water is teeming with stories today! Thanks again for finding my lure.'";
        }
        if (gameState.inventory.luckyLure > 0) {
            gameState.inventory.luckyLure = 0;
            gameState.inventory.oldRod = 1;
            return [
                "Fisherman: 'By the Great Novel! That's my Lucky Lure!'",
                "'It must have washed up on the island during the storm.'",
                "'You saved my livelihood! Here, take my spare rod.'",
                "You received the OLD ROD!",
                "(Water-type creatures will now appear in Home Bay!)"
            ];
        }
        return "Fisherman: 'Sigh... I lost my lucky lure years ago. It was swept out to sea by a giant wave. I can't catch a thing without it.'";
    }

    function handleTutorialNPC() {
        startDialogue([
            "Welcome to the Village of Beginnings!",
            "I help new trainers understand how this world works.",
            "What do you need help with?"
        ], () => {
            showChoices("Select a Help Topic:", [
                { 
                    text: "How to Battle", 
                    callback: () => startDialogue([
                        "Battles are tests of your ELA knowledge!",
                        "1. Choose an attack.",
                        "2. Answer the question correctly to deal damage.",
                        "3. If you answer wrong, you miss and take damage!",
                        "Tip: Different attacks have different questions."
                    ]) 
                },
                { 
                    text: "Catching Creatures", 
                    callback: () => startDialogue([
                        "You can catch wild creatures to join your team.",
                        "1. Lower their HP (Health) first! It's hard to catch healthy ones.",
                        "2. Select 'Item' in battle, then throw a 'Word Ball'.",
                        "3. If successful, they join your party or go to the PC."
                    ]) 
                },
                { 
                    text: "Menu & Saving", 
                    callback: () => startDialogue([
                        "This is VERY important!",
                        "Press 'M' or click the 'MENU' button to open your options.",
                        "You must click 'SAVE GAME' before you leave.",
                        "If you close this tab without saving, your progress is lost forever!"
                    ]) 
                },
                { 
                    text: "Status Effects", 
                    callback: () => startDialogue([
                        "Beware of 'Writer's Block' (Paralysis).",
                        "If your creature has Writer's Block, they might not be able to move.",
                        "Use a 'Thesaurus Tea' from the item menu to cure it!"
                    ]) 
                },
                { 
                    text: "I'm good, thanks.", 
                    callback: () => startDialogue("Good luck, young writer! Go find Professor Lexicon.") 
                }
            ]);
        });
        return null;
    }
    
function handleVinnieInteraction() {
    if (gameState.treeRemoved) {
        return "Vinnie: 'The path is open, man. Let the rhythm guide you.'";
    }

    startDialogue([
        "Vinnie: 'Whoa, traveler. Bad vibes ahead.'",
        "'This ancient tree blocked the gate to Synonym City. It didn't want the noise.'",
        "'I can carve it into a flute to release its spirit, but I need new chisels.'",
        "'Can you spot me $100 for the tools?'"
    ], () => {
        const yesText = "Yes, take $100"; // Clean text for immersion
        
        showChoices("Give Vinnie $100?", [
            { 
                text: yesText, 
                callback: () => {
                    // Logic: Checks for Money OR Dev Mode silently
                    if (gameState.money >= 100 || gameState.devModeActive) {
                        
                        // 1. "Refund" Interaction (He gives it back)
                        gameState.treeRemoved = true;
                        gameState.inventory.treeFlute = 1;
                        
                        if (maps.adjectiveWoods.objects['7,1']) delete maps.adjectiveWoods.objects['7,1'];
                        draw(); 
                        
                        startDialogue([
                            "You hand Vinnie $100.",
                            "Vinnie smiles, buys the tools, and gets to work.",
                            "*CHOP* ... *WHITTLE* ... *HUM*",
                            "The huge tree is transformed! He hands you the Nature Flute.",
                            "Vinnie: 'Wait, hold on.'",
                            "Vinnie hands your $100 back.",
                            "Vinnie: 'I can't take money for art, man. It's about the vibes.'",
                            "Vinnie: 'Keep your cash. The path is open.'"
                        ]);
                    } else {
                        startDialogue([
                            "Vinnie: 'Bummer. You're short on cash.'",
                            "Vinnie: 'I can't buy the tools without the funds. Come back when you have $100.'"
                        ]);
                    }
                }
            },
            { 
                text: "No way.", 
                callback: () => {
                    startDialogue([
                        "Vinnie: 'It's cool. The tree stays until the universe provides.'"
                    ]);
                } 
            }
        ]);
    });
    return null;
}

    function handleRoute1Rival() {
        if (gameState.metRivalRoute1) {
            return "Andy: 'Stop dawdling. The Gym Leader in the city is tough.'";
        }
        startDialogue([
            "Andy: 'Yo! You're finally here?'",
            "Andy: 'I've already caught three creatures while you were looking at trees.'",
            "Andy: 'You're gonna need this if you want to keep up with me.'",
            "Andy tosses you a Potion!"
        ], () => {
            gameState.metRivalRoute1 = true;
            gameState.inventory.potions++;
            startDialogue(["You put the Potion in your bag.", "Andy: 'Don't faint on me, okay? You're my rival, don't be boring!'"]);
        });
        return null;
    }

    function handleKatrinaInteraction() {
        if (gameState.katrinaQuest === 3) return "Ms. Katrina: 'Thanks again! The munchkins are finally settling down.'";
        if (gameState.katrinaQuest === 2) {
            gameState.katrinaQuest = 3;
            gameState.inventory.synonymRoll = (gameState.inventory.synonymRoll || 0) + 1;
            return ["Ms. Katrina: 'Oh, thank goodness! He came back.'", "You received a SYNONYM ROLL!"];
        }
        if (gameState.katrinaQuest === 1) return "Ms. Katrina: 'Please check the Adjective Woods!'";
        startDialogue([
            "Ms. Katrina: 'Oh dear... one of my students wandered off to the Adjective Woods.'",
            "'Could you find him for me?'"
        ], () => {
            gameState.katrinaQuest = 1;
            maps.adjectiveWoods.objects['1,12'] = { sprite: 'student', interaction: handleLostStudentInteraction };
            startDialogue("You promised to look for the lost student.");
        });
        return null;
    }

    function handleLostStudentInteraction() {
        startDialogue(["Student: 'Uh oh! Ms. Katrina is looking for me?'", "The student runs back to school."], () => {
            delete maps.adjectiveWoods.objects['1,12'];
            gameState.katrinaQuest = 2;
        });
        return null;
    }
    // --- ISLAND SURVIVAL QUEST LOGIC ---
    function handleSurvivalItem(itemKey, message) {
        // Initialize the tracking object if it doesn't exist
        if (!gameState.islandQuest) gameState.islandQuest = { conch: false, glasses: false, wilson: false };

        if (gameState.islandQuest[itemKey]) {
            return "You already found this item.";
        }

        gameState.islandQuest[itemKey] = true;
        
        // Remove the item visually by marking it as 'picked up' in the global tracker
        // We construct a fake ID for it so the map knows to hide it
        // Note: The coordinates here must match the map object coordinates above!
        let x = 0, y = 0;
        if(itemKey === 'conch') { x=2; y=2; }
        if(itemKey === 'glasses') { x=12; y=8; }
        if(itemKey === 'wilson') { x=9; y=2; }
        
        if (!gameState.pickedItems) gameState.pickedItems = [];
        gameState.pickedItems.push(`desertedIsland_${x}_${y}`);
        draw(); 

        // Check progress
        const found = Object.values(gameState.islandQuest).filter(v => v).length;
        
        if (found === 3) {
            return [message, "That's the last item!", "You should head back to the Pilot!"];
        }
        
        return [message, `Survival Items Found: ${found}/3`];
    }

    function handlePilotSurvivalQuest() {
        // 1. Check if we already finished the quest (Flying Home)
        if (gameState.inventory.LH02LyricalHightail > 0) {
             startDialogue(["Pilot: 'Buckle up! We are heading back to civilization!'"], () => {
                changeMap('village', 10, 10);
                startDialogue("The pilot drops you off and flies away towards Lexington City.");
            });
            return null;
        }

        // 2. Initialize quest if not started
        if (!gameState.islandQuest) gameState.islandQuest = { conch: false, glasses: false, wilson: false };
        const found = Object.values(gameState.islandQuest).filter(v => v).length;

        // 3. Quest Complete Trigger
        if (found >= 3) {
            // Give the reward/flight item
            gameState.inventory.LH02LyricalHightail = 1;
            if(!gameState.defeatedTrainers.includes('shipwreckedPilot')) {
                gameState.defeatedTrainers.push('shipwreckedPilot');
            }

            return startDialogue([
                "Pilot: 'You found them! The glasses to start a fire...'",
                "'The conch to call for help... and Wilson for moral support!'",
                "The Pilot tinkers with the radio using the glasses.",
                "*KRRRZZT* ... 'Help is on the way!'",
                "You received LH02 Lyrical Hightail!",
                "(Talk to the Pilot again to fly home!)"
            ]);
        }

        // 4. Quest Not Done
        if (found === 0) {
            return [
                "Pilot: 'My head... I can't fly like this.'",
                "'We are stranded here forever... unless...'",
                "'If you can find 3 Survival Items, maybe we can signal for help.'",
                "'Look for a Shell, some Glasses, and... my friend Wilson.'"
            ];
        }

        return [`Pilot: 'You've found ${found}/3 items. Keep looking! We need all of them to survive!'`];
    }
// --- CORRECTED ITEM PICKUP LOGIC ---
function handleCaveItem(itemName, itemKey, quantity, mapName, x, y) {
        const pickId = `${mapName}_${x}_${y}`;
        // Safety check: ensure the list exists
        if (!gameState.pickedItems) gameState.pickedItems = [];
        // 1. Check if we already picked this up
        if (gameState.pickedItems.includes(pickId)) {
            return "It's empty.";
        }

        // 2. Add item to inventory
        gameState.inventory[itemKey] = (gameState.inventory[itemKey] || 0) + quantity;
        // 3. Mark it as picked up so draw() knows to hide it
        gameState.pickedItems.push(pickId);
        // 4. Force a redraw of the screen to show it's gone
        draw();
        
        // --- NEW: ANDY POST-THESIS TRIGGER ---
        if (itemKey === 'masterthesis') {
            // Spawn Andy on the bridge below (blocking the way down at 9,4)
            if (maps.finalCave) {
                maps.finalCave.objects['9,4'] = { 
                    sprite: 'rival', 
                    interaction: handleAndyThesisDialogue 
                };
            }
            return [`You found ${quantity} ${itemName}(s)!`, "As you grab the orb, you hear footsteps approaching..."];
        }
        // -------------------------------------

        return [`You found ${quantity} ${itemName}(s)!`, `It was added to your inventory.`];
    }

    function handleAndyThesisDialogue() {
        startDialogue([
            "Andy walks up to you, eyeing the glowing orb.",
            "Andy: 'So... you actually did it.'",
            "Andy: 'You defeated the Goblins and found the Master Thesis.'",
            "Andy: 'Hmph. Now that you have that, battling you might actually be worth my time.'",
            "Andy: 'Come get me when you're ready. I'll be gaming in my bedroom.'",
            "Andy turns and walks away."
        ], () => {
            // 1. Remove Andy from the cave visually
            if (maps.finalCave.objects['9,4']) delete maps.finalCave.objects['9,4'];
            
            // 2. Set the flag that he is now in his room
            gameState.andyInvited = true;
            
            // 3. Update screen
            draw();
        });
        return null;
    }

    // --- SAFARI ZONE LOGIC ---
function handleSafariEntrance() {
        if (gameState.inSafariZone) return "You are already in the zone!";
        
        startDialogue([
            "Welcome to the GENRE JUNGLE!",
            "Here, you don't pay an entrance fee.",
            "Instead, you buy STEPS to explore.",
            "Rate: $10 per Step.",
            "How many steps would you like to buy?"
        ], () => {
            showChoices("Buy Steps ($10 each)", [
                { text: "50 Steps ($500)", callback: () => buySafariSteps(50, 500) },
                { text: "100 Steps ($1000)", callback: () => buySafariSteps(100, 1000) },
                { text: "200 Steps ($2000)", callback: () => buySafariSteps(200, 2000) },
                { text: "Cancel", callback: () => startDialogue("Please come back again!") }
            ]);
        });
        return null;
    }

    function buySafariSteps(steps, cost) {
        if (gameState.money >= cost) {
            gameState.money -= cost;
            enterSafariZone(steps);
        } else {
            startDialogue(`You need $${cost} for that package!`);
        }
    }

function enterSafariZone(steps) {
        gameState.inSafariZone = true;
        gameState.safariSteps = steps;
        gameState.inventory.safariBall = 30; 
        
        // FIX: Warp to 7, 42 (Safe grass just above the gate)
        changeMap('genreJungle', 7, 42); 
        
        startDialogue([
            "PA: Ding-dong!",
            `You have purchased ${steps} steps.`,
            "Welcome to Area 1. The rare creatures are deep in the north!",
            "Good luck!"
        ]);
    }

    function handleSafariExit() {
        showChoices("Leave the Safari Zone early?", [
            { text: "Yes", callback: () => exitSafariZone() },
            { text: "No", callback: () => startDialogue("Keep exploring!") }
        ]);
        return null;
    }

    function exitSafariZone() {
        gameState.inSafariZone = false;
        gameState.safariSteps = 0;
        gameState.inventory.safariBall = 0; // Remove leftover balls
        
        changeMap('adjectiveWoods', 13, 8); // Warp back to entrance
        
        startDialogue([
            "PA: Ding-dong!",
            "Your Jungle Adventure is over.",
            "We hope you had a good time!"
        ]);
    }

function movePlayer(newX, newY) {
    if (gameState.inDialogue || gameState.inBattle || gameState.activeScene) return;
    const map = maps[gameState.currentMap];
    if (!map) return;
    
    const object = map.objects[`${newX},${newY}`];
    // 1. Check for Doors/Warps first
    if (object && object.target) {
        changeMap(object.target, object.x, object.y);
        return;
    }

    // 2. Boundary Check
    if (newY < 0 || newY >= map.layout.length || newX < 0 || newX >= map.layout[0].length) return;
    const tileId = getTile(map, newX, newY);
    const tile = tileTypes[tileId];

    // 3. Collision Check (Check if item picked up OR Trainer Defeated)
    const pickId = `${gameState.currentMap}_${newX}_${newY}`;
    const isPickedUp = gameState.pickedItems && gameState.pickedItems.includes(pickId);
    
    // --- PATHING FIX: Allow walking through beaten Elite Four members ---
    let isDefeatedTrainer = false;
    if (object && object.interaction) {
        // Check if we are in the Final Cave and this specific trainer is beaten
        if (gameState.currentMap === 'finalCave') {
            if (object.sprite === 'professor' && gameState.defeatedTrainers.includes('eliteGrammarian')) isDefeatedTrainer = true;
            if (object.sprite === 'villager2' && gameState.defeatedTrainers.includes('eliteJournalist')) isDefeatedTrainer = true;
            if (object.sprite === 'shakespeare' && gameState.defeatedTrainers.includes('eliteDramatist')) isDefeatedTrainer = true;
            if (object.sprite === 'poet' && gameState.defeatedTrainers.includes('elitePoet')) isDefeatedTrainer = true;
        }
    }
    // -------------------------------------------------------------------

    if (tile.solid || (object && object.sprite && !isPickedUp && !isDefeatedTrainer)) return;

    // --- REPEL & SAFARI LOGIC ---
    let skipEncounter = false;
    if (gameState.inSafariZone) {
        gameState.safariSteps--;
        if (gameState.safariSteps <= 0) {
            exitSafariZone();
            return;
        }
        if (gameState.safariSteps % 100 === 0) {
             startDialogue(`PA: You have ${gameState.safariSteps} steps remaining.`);
        }
    } else if (gameState.repelSteps > 0) {
        // REPEL IS ACTIVE: Count down and skip encounter
        gameState.repelSteps--;
        if (gameState.repelSteps === 0) {
            startDialogue("The Peace Treaty expired. Wild arguments may resume.");
        }
        skipEncounter = true; 
    }

    gameState.player.x = newX;
    gameState.player.y = newY;
    
    // Wild Encounters (Only runs if NOT skipping)
    if (!skipEncounter && (tile.isTallGrass || tileId === 29) && Math.random() < 0.2) { 
        if (gameState.inSafariZone) {
            startSafariBattle();
        } else if (gameState.playerParty.length > 0) {
            startWildBattle();
        }
    }
}

function startSafariBattle() {
        if (gameState.inBattle) return;
        gameState.inBattle = true; // Lock movement

        // DETERMINE AREA BASED ON Y-COORDINATE
        // The map is 45 tiles high.
        // Area 3: y < 15
        // Area 2: y < 30
        // Area 1: y >= 30
        
        let encounterPool = [];
        let areaLevelBonus = 0;
        const y = gameState.player.y;

        if (y < 15) {
            // AREA 3 (Hardest)
            encounterPool = ['Novel-lion', 'Legend-ary', 'Auto-biogra-bee'];
            areaLevelBonus = 10;
        } else if (y < 30) {
            // AREA 2 (Medium)
            encounterPool = ['Sci-Fi-der', 'Fantasy-fox', 'Drama-llama', 'Poetry-can'];
            areaLevelBonus = 5;
        } else {
            // AREA 1 (Easy/Start)
            encounterPool = ['Fic-tion', 'Mytho-log', 'Biogra-bee'];
            areaLevelBonus = 0;
        }

        const species = encounterPool[Math.floor(Math.random() * encounterPool.length)];
        const level = Math.floor(Math.random() * 5) + 15 + areaLevelBonus; // Levels get higher further in
        
        const wildCreature = createcreature(species, level);

        currentBattle = {
            opponentParty: [wildCreature],
            currentOpponentIndex: 0,
            opponentName: "Wild",
            isSafari: true
        };

        battleScene.classList.remove('hidden');
        updateBattleSpritesSafari(wildCreature);
        showSafariMenu();
    }

    function updateBattleSpritesSafari(creature) {
        // Simplified visual update for safari
        document.getElementById('opponent-sprite').textContent = sprites[creature.sprite];
        document.getElementById('opponent-name').textContent = creature.name;
        document.getElementById('opponent-hp').style.width = "100%"; // Always full in safari
        
        // Hide player HUD for Safari
        document.getElementById('player-sprite').textContent = sprites.player; // Show player, not pokemon
        document.getElementById('player-name').textContent = "Player";
        document.getElementById('player-hp').style.width = "100%";
    }

    function showSafariMenu() {
        battleText.textContent = `Wild ${currentBattle.opponentParty[0].name} appeared! Balls: ${gameState.inventory.safariBall}`;
        battleGrid.innerHTML = '';
        
        const createBtn = (text, onClick) => {
            const btn = document.createElement('button');
            btn.className = 'p-2 bg-green-200 hover:bg-green-400 border-4 border-green-600 rounded text-black text-lg';
            btn.textContent = text; 
            btn.onclick = onClick; 
            battleGrid.appendChild(btn);
        };

        createBtn('Throw Jungle Orb', throwSafariBall);
        createBtn('Throw Bait', () => safariAction("Bait"));
        createBtn('Throw Rock', () => safariAction("Rock"));
        createBtn('Run', () => endBattle(true));
    }
async function safariAction(type) {
    const creature = currentBattle.opponentParty[0];
    
    // Initialize modifiers if they don't exist
    if (!currentBattle.catchRateMod) currentBattle.catchRateMod = 1;
    if (!currentBattle.fleeRateMod) currentBattle.fleeRateMod = 1;

    // 1. PLAY ANIMATION
    if (type === "Bait") {
        await animateBallThrow('bait'); // Throws 🍖
        
        currentBattle.catchRateMod = 0.5; // Harder to catch
        currentBattle.fleeRateMod = 0.5;  // Less likely to run
        startBattleDialogue([`You threw bait. ${creature.name} is eating!`, "It's less likely to flee, but harder to catch."], showSafariMenu);
    
    } else {
        await animateBallThrow('rock'); // Throws 🪨
        
        currentBattle.catchRateMod = 1.5; // Easier to catch
        currentBattle.fleeRateMod = 2.0;  // More likely to run
        startBattleDialogue([`You threw a rock. ${creature.name} is angry!`, "It's easier to catch, but might flee!"], showSafariMenu);
    }
}

function throwSafariBall() {
        if (gameState.inventory.safariBall <= 0) {
            exitSafariZone();
            return;
        }

        gameState.inventory.safariBall--;
        
        // EXPANDED GENRE QUESTIONS (30 Total)
        const genres = [
            // 1-5: The Basics
            { q: "Which genre features magic and mythical creatures?", a: ["Fantasy", "Sci-Fi", "Biography"], c: "Fantasy" },
            { q: "Which genre is a true story about a person's life?", a: ["Biography", "Fiction", "Mystery"], c: "Biography" },
            { q: "Which genre uses advanced technology and space travel?", a: ["Sci-Fi", "Fantasy", "History"], c: "Sci-Fi" },
            { q: "Which genre is designed to be acted out on stage?", a: ["Drama", "Poetry", "Novel"], c: "Drama" },
            { q: "Which genre uses stanzas and rhythm?", a: ["Poetry", "Prose", "Textbook"], c: "Poetry" },
            
            // 6-10: Fiction Sub-genres
            { q: "A story about solving a crime or puzzle is...", a: ["Mystery", "Thriller", "Horror"], c: "Mystery" },
            { q: "A story set in the past with fictional characters is...", a: ["Historical Fiction", "Non-fiction", "Science Fiction"], c: "Historical Fiction" },
            { q: "A story intended to scare or unsettle the reader is...", a: ["Horror", "Comedy", "Romance"], c: "Horror" },
            { q: "A suspenseful story with high stakes and excitement is a...", a: ["Thriller", "Comedy", "Drama"], c: "Thriller" },
            { q: "A story focusing on love and relationships is...", a: ["Romance", "Horror", "Satire"], c: "Romance" },

            // 11-15: Traditional Literature
            { q: "A traditional story explaining natural or social phenomenon is...", a: ["Myth", "Tall Tale", "Biography"], c: "Myth" },
            { q: "A short story with animals conveying a moral is a...", a: ["Fable", "Legend", "Essay"], c: "Fable" },
            { q: "A humorous story with extreme exaggeration is a...", a: ["Tall Tale", "Myth", "Auto-biography"], c: "Tall Tale" },
            { q: "A story passed down from the past, often about a hero, is a...", a: ["Legend", "Fable", "Essay"], c: "Legend" },
            { q: "A story passed down orally through generations is a...", a: ["Folktale", "Novel", "Article"], c: "Folktale" },

            // 16-20: Non-Fiction & Formats
            { q: "Writing that deals with real people, events, and facts is...", a: ["Non-fiction", "Fiction", "Fantasy"], c: "Non-fiction" },
            { q: "A story written by a person about their OWN life is an...", a: ["Auto-biography", "Biography", "Memoir"], c: "Auto-biography" },
            { q: "A collection of personal memories from specific times is a...", a: ["Memoir", "Biography", "Myth"], c: "Memoir" },
            { q: "A short piece of non-fiction writing on a specific topic is an...", a: ["Essay", "Novel", "Poem"], c: "Essay" },
            { q: "A daily record of personal events and thoughts is a...", a: ["Diary/Journal", "Essay", "Article"], c: "Diary/Journal" },

            // 21-25: Tone & Style
            { q: "Ordinary writing (sentences/paragraphs) is called...", a: ["Prose", "Poetry", "Stanza"], c: "Prose" },
            { q: "A funny play or movie is a...", a: ["Comedy", "Tragedy", "Documentary"], c: "Comedy" },
            { q: "A play with a sorrowful or disastrous ending is a...", a: ["Tragedy", "Comedy", "Satire"], c: "Tragedy" },
            { q: "A story that uses humor to criticize or mock society is...", a: ["Satire", "Drama", "Mystery"], c: "Satire" },
            { q: "A humorous imitation of another work is a...", a: ["Parody", "Tragedy", "Sequel"], c: "Parody" },

            // 26-30: Modern & Specialized
            { q: "A story set in a frightening, oppressive future society is...", a: ["Dystopian", "Utopian", "Historical"], c: "Dystopian" },
            { q: "A story told using comic-strip formats is a...", a: ["Graphic Novel", "Essay", "Play"], c: "Graphic Novel" },
            { q: "A story focusing on exciting risks and physical danger is...", a: ["Adventure", "Romance", "Comedy"], c: "Adventure" },
            { q: "A book collecting many poems or stories by different authors is an...", a: ["Anthology", "Novel", "Diary"], c: "Anthology" },
            { q: "A story written in the form of letters or documents is...", a: ["Epistolary", "Narrative", "Expository"], c: "Epistolary" }
        ];

        const q = genres[Math.floor(Math.random() * genres.length)];
        
        battleText.textContent = q.q;
        battleGrid.innerHTML = '';
        q.a.forEach(ans => {
            const btn = document.createElement('button');
            btn.className = 'p-2 bg-blue-200 hover:bg-blue-400 border-2 border-blue-600 rounded';
            btn.textContent = ans;
            btn.onclick = () => resolveSafariCatch(ans === q.c, currentBattle.opponentParty[0]);
            battleGrid.appendChild(btn);
        });
    }

    async function resolveSafariCatch(correct, creature) {
        battleGrid.innerHTML = '';
        
        if (correct) {
            await new Promise(res => startBattleDialogue(["Correct! You threw the ball with perfect aim!"], res));
            // High Catch Chance
            if (Math.random() < 0.8) {
                await new Promise(res => startBattleDialogue(["Gotcha!", `${creature.name} was caught!`], res));
                addcreatureToParty(creature);
                endBattle(false, true);
            } else {
                await new Promise(res => startBattleDialogue(["Darn! It broke free!"], res));
                checkFlee(creature);
            }
        } else {
            await new Promise(res => startBattleDialogue(["Incorrect aim...", "The ball missed the mark."], res));
            // Low Catch Chance
            if (Math.random() < 0.1) {
                await new Promise(res => startBattleDialogue(["Miraculously, you caught it!"], res));
                addcreatureToParty(creature);
                endBattle(false, true);
            } else {
                await new Promise(res => startBattleDialogue(["It broke free!"], res));
                checkFlee(creature);
            }
        }
    }

function checkFlee(creature) {
        const mod = currentBattle.fleeRateMod || 1;
        // Base flee chance 50% * modifier
        if (Math.random() < (0.5 * mod)) {
            startBattleDialogue([`Wild ${creature.name} ran away!`], () => endBattle(true));
        } else {
            showSafariMenu();
        }
    }
// --- SAFARI BOAT RIDE ANIMATION ---
function rideSafariBoat() {
    console.log("Starting Straight Boat Ride..."); // Check your console to see if this runs!
    
    startDialogue(["You found a canoe!", "Hop in for a ride downstream?"], () => {
        showChoices("Ride the river?", [
            { text: "Yes!", callback: () => {
                // 1. Lock controls
                gameState.activeScene = 'cutscene'; 
                
                // 2. Visual Setup: Snap Player to the new straight river (Column 14)
                const originalSprite = gameState.player.sprite;
                gameState.player.sprite = 'boat';
                gameState.player.x = 14; 
                gameState.player.y = 2; 
                
                draw(); // Update visuals immediately

                // 3. Animation Loop (Straight Down)
                let rideInterval = setInterval(() => {
                    gameState.player.y += 1; 
                    draw();

                    // 4. Stop at the bottom (Row 40)
                    if (gameState.player.y >= 40) {
                        clearInterval(rideInterval);
                        gameState.player.x = 13; // Step off onto the grass
                        gameState.player.sprite = originalSprite; // Restore human sprite
                        gameState.activeScene = null; // Unlock controls
                        startDialogue("What a rush! You are back in Area 1.");
                    }
                }, 50); // Speed of boat
            }},
            { text: "No", callback: () => startDialogue("The view is nice from up here anyway.") }
        ]);
    });
    return null;
}
    // --- RESET DATA FUNCTION (For Shared Classroom Computers) ---
function resetGameData() {
    // 1. Close the menu so we can see the warning clearly
    closeAllMenus();

    // 2. First Warning
    startDialogue([
        "WARNING: You are about to DELETE your save file.",
        "This will erase all your creatures and badges.",
        "This cannot be undone."
    ], () => {
        // 3. The "Are you sure?" Choice
        showChoices("Are you sure you want to start over?", [
            { 
                text: "Yes, Delete Everything", 
                callback: () => {
                    // 4. Second "Double Check" for safety
                    showChoices("Really? Final Warning!", [
                        {
                            text: "Yes, I'm a New Student",
                            callback: () => {
                                localStorage.removeItem('elaQuestSave');
                                location.reload(); // Reloads the page to start fresh
                            }
                        },
                        {
                            text: "No! Save my game!",
                            callback: () => startDialogue("Phew! Your data is safe.")
                        }
                    ]);
                } 
            },
            { 
                text: "No, Cancel", 
                callback: () => startDialogue("Phew! Your data is safe.") 
            }
        ]);
    });
}
function animateBallThrow(ballType = 'wordorb') {
    return new Promise(resolve => {
        const battleScene = document.getElementById('battle-scene');
        const ball = document.createElement('div');
        
        // Pick the right emoji based on the type
        let emoji = '🔴'; // Default Word Ball
        if (ballType === 'safariBall') emoji = '🟢'; // Camo Ball
        if (ballType === 'masterthesis') emoji = '🟣'; // Master Ball
        
        // --- NEW TYPES ADDED HERE ---
        if (ballType === 'rock') emoji = '🪨';
        if (ballType === 'bait') emoji = '🍖'; 
        // ---------------------------
        
        ball.textContent = emoji;
        ball.className = 'ball-anim'; // Re-uses your existing fly animation
        
        // Starting Position (Player side)
        ball.style.left = '20%';
        ball.style.bottom = '20%';
        
        battleScene.appendChild(ball);

        // Remove item after animation ends
        setTimeout(() => {
            ball.remove();
            resolve();
        }, 800);
    });
}

function showFloatingText(elementId, text, type = 'damage') {
    const target = document.getElementById(elementId);
    if (!target) return;

    const rect = target.getBoundingClientRect();
    const floatEl = document.createElement('div');
    floatEl.textContent = text;
    floatEl.className = type === 'heal' ? 'damage-number heal-number' : 'damage-number';
    
    // Position slightly above the sprite
    floatEl.style.left = (rect.left + rect.width / 2 - 20) + 'px';
    floatEl.style.top = (rect.top) + 'px';
    
    document.body.appendChild(floatEl);

    // Remove after animation
    setTimeout(() => floatEl.remove(), 800);
}
// --- FORCE RIVER STRAIGHTENING ---
// Paste this at the bottom of your script
if (maps.genreJungle) {
    // This loop goes through every single row of the jungle map
    for (let r = 0; r < maps.genreJungle.layout.length; r++) {
        const row = maps.genreJungle.layout[r];
        if (row.length > 14) {
            row[13] = 29; // Left Bank (Dark Grass)
            row[14] = 5;  // THE RIVER (Water) - Forces a straight line
            row[15] = 8;  // Right Bank (Tree)
        }
    }
    // Force the boat start position to be water too
    maps.genreJungle.objects['14,2'] = { sprite: 'boat', interaction: rideSafariBoat };
}
// --- FIX: GREEN LIGHT & POSITION ---
if (maps.homeBay) {
    if (maps.homeBay.objects['11,6']) delete maps.homeBay.objects['11,6'];
    if (maps.homeBay.objects['8,6']) delete maps.homeBay.objects['8,6'];

    maps.homeBay.objects['8,6'] = { 
        sprite: 'greenLight', 
        interaction: "A green light shines across the bay. It feels so close, yet impossible to grasp." 
    };
}

// ==========================================
// PASTE THIS AT THE BOTTOM OF YOUR SCRIPT
// ==========================================

// 1. START WILD BATTLE (Spawns the Virus!)
function startWildBattle() {
    if (gameState.inBattle || gameState.inDialogue) return;
    
    // --- QUEST LOGIC: RUN-ON OUTBREAK ---
    // If quest is active (1) and we are in Route 2
    if (gameState.runOnQuest === 1 && gameState.currentMap === 'route2') {
        // 60% chance to find infected creature
        if (Math.random() < 0.6) {
            startDialogue(["The air is filled with endless words...", "An Infected Wordworm appeared!"], () => {
                startBattle([createcreature('InfectedWordworm', 15)], "Run-on Sentence");
            });
            return;
        }
    }

    // Standard Encounter Logic
    const currentMapData = maps[gameState.currentMap];
    let encounterPool = [...(currentMapData.encounters || [])];
    
    // Night Logic
    const hour = new Date().getHours(); 
    const isNight = hour >= 18 || hour < 6;
    if (isNight) {
        if (gameState.currentMap === 'route1' || gameState.currentMap === 'route2') encounterPool.push('Ink-ling', 'Moth-if', 'Crick-it');
        if (gameState.currentMap === 'adjectiveWoods') encounterPool.push('Owl-literation', 'Whisper-wisp', 'Were-word');
        if (gameState.currentMap === 'caveLevel1' || gameState.currentMap === 'finalCave') encounterPool.push('Vamp-irony', 'Shad-ode', 'Grim-reader');
        if (gameState.currentMap === 'homeBay' || gameState.currentMap === 'desertedIsland') encounterPool.push('Lun-artic', 'Star-syntax');
    }

    if (encounterPool.length === 0) return;
    const species = encounterPool[Math.floor(Math.random() * encounterPool.length)];
    let level = Math.floor(Math.random() * 3) + 8;
    
    // Scale levels
    if (gameState.currentMap === 'caveLevel1') level += 10;
    if (gameState.currentMap === 'finalCave') level += 35;
    if (gameState.currentMap === 'desertedIsland') level += 25;

    startDialogue([`A wild ${species} appeared!`], () => startBattle([createcreature(species, level)], `Wild ${species}`));
}

// 2. START BATTLE (Initializes Run-on Status)
function startBattle(opponents, opponentName, trainerId = null) {
    if (gameState.playerParty.length === 0) { startDialogue("You have no creatures to battle with!"); return; }
    gameState.inBattle = true;
    const opponentParty = (Array.isArray(opponents) ? opponents : [opponents])
        .map(op => (op.species ? op : createcreature(op.species, op.level)));
    const firstOpponent = opponentParty[0];

    if (!gameState.journal[firstOpponent.species]) gameState.journal[firstOpponent.species] = { seen: false, caught: false };
    gameState.journal[firstOpponent.species].seen = true;
    
    currentBattle = { 
        playercreature: gameState.playerParty.find(p => p.currentHp > 0), 
        opponentParty: opponentParty,
        currentOpponentIndex: 0,
        opponentName, 
        trainerId, 
        turn: 'player',
        focus: 0,
        participants: [gameState.playerParty.findIndex(p => p.currentHp > 0)],
        // NEW FLAGS
        isRunOn: opponentParty[0].species === 'InfectedWordworm', 
        isEdited: false 
    };
    
    currentBattle.playercreature.statMods = { attack: 0, defense: 0 };
    firstOpponent.statMods = { attack: 0, defense: 0 };

    // VISUALS: Add glitch effect if infected
    setTimeout(() => {
        if(currentBattle.isRunOn) {
            document.getElementById('opponent-sprite').classList.add('infected-anim');
        }
    }, 100);

    battleScene.classList.remove('hidden');
    updateBattleSprites();
    updateBattleUI(); 
    nextBattleTurn();
}

// 3. NEXT BATTLE TURN (The Infinite Healing Logic)
function nextBattleTurn() {
    if (!currentBattle) return;

    // --- RUN-ON VIRUS CHECK ---
    // If it's the Player's turn (meaning the Enemy just finished),
    // and the enemy is infected + not fixed yet:
    if (currentBattle.isRunOn && !currentBattle.isEdited && currentBattle.turn === 'player') {
        
        // If they are damaged, they heal back to full
        if (currentBattle.opponentParty[0].currentHp < currentBattle.opponentParty[0].maxHp) {
            startBattleDialogue([
                "The sentence refuses to end!", 
                "The Infected Wordworm healed back to full!"
            ], () => {
                currentBattle.opponentParty[0].currentHp = currentBattle.opponentParty[0].maxHp;
                updateBattleUI();
                // Restart the turn loop
                nextBattleTurn(); 
            });
            return; 
        }
    }

    // 1. CHECK PLAYER (Your Turn)
    if (currentBattle.turn === 'player') {
        // Writer's Block Check
        if (currentBattle.playercreature.status === 'writers_block') {
            if(Math.random() < 0.5) {
                startBattleDialogue([`${currentBattle.playercreature.name} has Writer's Block!`], () => {
                    currentBattle.turn = 'opponent'; nextBattleTurn(); 
                });
                return;
            } else {
                currentBattle.playercreature.status = null;
                startBattleDialogue([`${currentBattle.playercreature.name} broke through!`], showMainBattleMenu);
                return;
            }
        }
        showMainBattleMenu();
    } 
    // 2. CHECK OPPONENT (Enemy Turn)
    else {
         const currentOpponent = currentBattle.opponentParty[currentBattle.currentOpponentIndex];
        // Writer's Block Check for Enemy
        if (currentOpponent.status === 'writers_block') {
             if(Math.random() < 0.5) {
                startBattleDialogue([`${currentBattle.opponentName}'s ${currentOpponent.name} is blocked!`], () => {
                    currentBattle.turn = 'player'; nextBattleTurn();
                });
                return;
             } else {
                currentOpponent.status = null;
            }
        }

        // Faint Checks
        if (currentBattle.playercreature.currentHp <= 0) { handlePlayercreatureFaint(); return; }
        if (currentOpponent.currentHp <= 0) { handleOpponentFaint(); return; }

        setTimeout(() => {
            const attacker = currentOpponent;
            const atk = attacker.attacks[Math.floor(Math.random()*attacker.attacks.length)];
            
            const oppSprite = document.getElementById('opponent-sprite');
            oppSprite.classList.add('lunge-left');
            setTimeout(() => oppSprite.classList.remove('lunge-left'), 300);

            triggerBattleFX(atk.type || 'Normal', true); // Hit Player

            let messages = [`${currentBattle.opponentName}'s ${attacker.name} used ${atk.name}!`];
            if(atk.power > 0) {
                const result = calculateDamage(atk, attacker, currentBattle.playercreature);
                currentBattle.playercreature.currentHp -= result.damage;
                messages.push(`${currentBattle.playercreature.name} took ${result.damage} damage!`);
                if(result.message) messages.push(result.message);
                
                const pSprite = document.getElementById('player-sprite');
                pSprite.classList.add('damage-anim');
                setTimeout(() => pSprite.classList.remove('damage-anim'), 500);
            }
            messages.push(...applyAttackEffect(atk, attacker, currentBattle.playercreature));
            updateBattleUI();
            startBattleDialogue(messages, () => { currentBattle.turn = 'player'; nextBattleTurn(); });
        }, 1000);
    }
}

// 4. USE RED PEN (The Cure)
function useRedPen() {
    // 1. Visual Effect
    const battleScene = document.getElementById('battle-scene');
    
    // Create Slash
    const slash = document.createElement('div');
    slash.className = 'red-slash';
    battleScene.appendChild(slash);
    
    // Create Period
    const period = document.createElement('div');
    period.className = 'giant-period';
    period.textContent = '.';
    battleScene.appendChild(period);

    // 2. Logic Update
    currentBattle.isEdited = true;
    currentBattle.opponentParty[0].catchDifficulty = 20; // Easy to catch now!
    
    // 3. Remove Glitch Visual
    document.getElementById('opponent-sprite').classList.remove('infected-anim');

    // 4. Dialogue
    setTimeout(() => {
        if(slash) slash.remove();
        if(period) period.remove();
        startBattleDialogue([
            "You used the Red Pen!",
            "You inserted a Period and stopped the run-on sentence!",
            "The Wordworm is vulnerable now!"
        ], () => {
            // End turn, allowing you to attack next
            nextBattleTurn();
        });
    }, 1000);
}

// 5. UPDATE ITEM MENU (To show the button)
// We replace showItemMenu to include the Red Pen button if valid
function showItemMenu() {
    const choices = [];
    
    // RED PEN LOGIC
    if (gameState.inventory.redPen > 0 && currentBattle.isRunOn && !currentBattle.isEdited) {
        choices.push({ text: "Red Pen (Edit!)", callback: useRedPen });
    }

    if (gameState.inventory.potions > 0) {
        choices.push({ text: `Potion (x${gameState.inventory.potions})`, callback: usePotionInBattle });
    }
    if (gameState.inventory.wordballs > 0) {
        choices.push({ text: `Word Ball (x${gameState.inventory.wordballs})`, callback: () => useBall('wordballs') });
    }
    // ... add other items here if you have them in battle ...
    
    choices.push({ text: "Back", callback: showMainBattleMenu });
    
    // Manually create buttons since we are in battle UI
    battleText.textContent = "Choose an item:";
    battleGrid.innerHTML = '';
    choices.forEach(choice => {
        const btn = document.createElement('button');
        btn.className = 'p-2 bg-gray-200 hover:bg-blue-300 border-2 border-gray-400 rounded text-black text-xs lg:text-sm';
        btn.textContent = choice.text;
        btn.onclick = choice.callback;
        battleGrid.appendChild(btn);
    });
}

</script>

</body>
</html>