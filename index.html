<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELA Quest: The Synonymouse Saga</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #000;
            color: #fff;
            image-rendering: pixelated;
            overflow: hidden;
            touch-action: manipulation;
        }
        #page-layout {
            width: 100vw;
            height: 100vh;
        }
        #game-container {
            width: 100%;
            max-width: 512px;
            aspect-ratio: 16 / 14;
            position: relative;
            transition: transform 0.05s linear;
        }
        canvas {
            width: 100%;
            height: 100%;
            display: block;
            background-color: #000;
        }
        .message-box {
            border: 8px solid #4a5568;
            border-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0 H80 V80 H0 Z' fill='%234a5568'/%3E%3Cpath d='M8 8 H72 V72 H8 Z' fill='white'/%3E%3C/svg%3E") 8 stretch;
            cursor: pointer;
            flex-shrink: 0;
        }
        .ui-scene {
            background-color: rgba(0,0,0,0.9);
        }
        .xp-bar-bg { background-color: #a0a0a0; }
        .xp-bar-fill { background-color: #60a5fa; }
        .pc-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .pc-item:hover {
            background-color: #e2e8f0;
        }
        .touch-btn {
            width: 60px;
            height: 60px;
            background-color: rgba(128, 128, 128, 0.5);
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        .touch-btn-a {
             width: 80px;
            height: 80px;
            background-color: rgba(239, 68, 68, 0.7);
        }
        .touch-btn-b {
             width: 70px;
            height: 70px;
            background-color: rgba(68, 138, 239, 0.7);
        }
        #credits-scene {
            color: #FFD700;
            font-size: 2rem;
            text-align: center;
            overflow: hidden;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            top: 100%;
            animation: scroll-credits 30s linear forwards;
        }
        @keyframes scroll-credits {
            from { top: 100%; }
            to { top: -100%; }
        }
        .damage-flash { animation: flash 0.3s; }
        @keyframes flash { 50% { filter: brightness(3); } }

        .faint-animation { animation: faint 0.5s forwards; }
        @keyframes faint {
            to { transform: scale(0); opacity: 0; }
        }

        .attack-animation { animation: lunge 0.4s; }
        @keyframes lunge {
            50% { transform: translateX(20px) scale(1.1); }
        }
        .attack-animation-opponent { animation: lunge-opponent 0.4s; }
        @keyframes lunge-opponent {
            50% { transform: translateX(-20px) scale(1.1) scaleX(-1); }
        }
        .type-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            line-height: 1rem;
            margin-left: 4px;
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .type-Noun { background-color: #A8A878; }
        .type-Verb { background-color: #F08030; }
        .type-Adjective { background-color: #6890F0; }
        .type-Syntax { background-color: #705898; }

        .battle-start-zoom { animation: zoomIn 0.5s ease-out forwards; }
        @keyframes zoomIn {
            from { transform: scale(1.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .pokeball-sprite {
            position: absolute;
            font-size: 32px;
            z-index: 100;
        }

        .throw-animation {
            animation: throw-ball 0.8s ease-out forwards;
        }
        @keyframes throw-ball {
            0% {
                bottom: 15%; left: 20%;
                transform: scale(1.5) rotate(0deg);
            }
            50% {
                bottom: 60%; left: 50%;
                transform: scale(1) rotate(-180deg);
            }
            100% {
                bottom: 45%; left: 75%;
                transform: scale(1) rotate(-360deg);
            }
        }

        .suck-in-effect {
            animation: suck-in 0.5s ease-in forwards;
        }
        @keyframes suck-in {
            from { transform: scale(1) rotate(0) scaleX(-1); opacity: 1; }
            to { transform: scale(0) rotate(360deg) scaleX(-1); opacity: 0; }
        }

        .wiggle-animation {
            animation: wiggle 0.8s linear 3; /* Wiggles 3 times */
        }
        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(15deg); }
            75% { transform: rotate(-15deg); }
        }

        .capture-success-animation {
            animation: capture-flash 1s forwards;
        }
        @keyframes capture-flash {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(5) drop-shadow(0 0 10px white); }
        }
        .status-badge {
            font-size: 0.7rem;
            padding: 1px 4px;
            border-radius: 4px;
            margin-left: 8px;
            color: white;
        }
        .status-BRD { background-color: #6b7280; }
        .status-CFS { background-color: #f59e0b; }
        .status-WB { background-color: #8b5cf6; }
        
        .map-cell {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            text-align: center;
            line-height: 1;
            padding: 2px;
            overflow: hidden;
            word-break: break-word;
        }
        .map-cell-discovered {
            background-color: #a0aec0;
            border: 1px solid #718096;
        }
        .map-cell-undiscovered {
            background-color: #4a5568;
        }
        .map-cell-player {
            background-color: #f6e05e;
            box-shadow: 0 0 10px #f6e05e;
            z-index: 10;
        }
        .blinking-text {
            animation: blink 1.5s step-start 0s infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="title-screen" class="absolute inset-0 bg-black flex flex-col items-center justify-center z-50">
        <h1 class="text-5xl text-yellow-300 mb-4">ELA Quest</h1>
        <h2 class="text-2xl text-blue-400 mb-12">The Synonymouse Saga</h2>

        <div id="title-options" class="hidden flex flex-col gap-4 w-64">
            <button id="continue-btn" class="p-3 bg-green-600 text-white rounded-lg text-2xl border-4 border-white">Continue</button>
            <button id="new-game-title-btn" class="p-3 bg-blue-600 text-white rounded-lg text-2xl border-4 border-white">New Game</button>
        </div>
        
        <div id="new-game-confirm" class="hidden flex flex-col items-center gap-4 w-72">
            <p class="text-xl text-center">Start a new game? All saved progress will be lost.</p>
            <div class="flex gap-4 w-full">
                <button id="confirm-yes-btn" class="w-full p-3 bg-red-600 text-white rounded-lg text-2xl border-4 border-white">Yes</button>
                <button id="confirm-no-btn" class="w-full p-3 bg-gray-600 text-white rounded-lg text-2xl border-4 border-white">No</button>
            </div>
        </div>

        <p id="press-key-prompt" class="mt-12 text-xl blinking-text">Press Any Key</p>

    </div>

    <div id="page-layout" class="hidden flex flex-col lg:flex-row items-center justify-center lg:justify-evenly w-screen h-screen p-4 gap-4">
        
        <div class="hidden lg:flex w-48 h-48 pointer-events-auto">
            <div class="grid grid-cols-3 grid-rows-3 gap-2 w-full h-full">
                <div></div>
                <button id="touch-up-lg" class="touch-btn">▲</button>
                <div></div>
                <button id="touch-left-lg" class="touch-btn">◀</button>
                <div></div>
                <button id="touch-right-lg" class="touch-btn">▶</button>
                <div></div>
                <button id="touch-down-lg" class="touch-btn">▼</button>
                <div></div>
            </div>
        </div>

        <div class="flex flex-col items-center justify-center">
            <div id="game-container">
                <canvas id="gameCanvas"></canvas>
                <div id="animation-layer" class="absolute inset-0 pointer-events-none"></div>
                 <!-- Reserve Mode UI -->
                <div id="reserve-ui" class="hidden absolute top-0 left-0 right-0 p-2 bg-black bg-opacity-50 text-white text-lg flex justify-between">
                    <div>Time: <span id="reserve-timer">30</span>s</div>
                    <div>Strikes: <span id="reserve-strikes">0</span>/3</div>
                </div>
                <button id="menu-btn" class="absolute top-2 right-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg border-4 border-white">Menu</button>
            </div>

            <div id="message-box" class="message-box w-full max-w-xl min-h-[8rem] p-4 mt-2 bg-white text-gray-800 rounded-lg text-xl leading-snug">
                <p id="message-text">Welcome to ELA Quest!</p>
                <div id="choices-box" class="mt-4 grid grid-cols-2 gap-4"></div>
            </div>
        </div>
        
        <div class="hidden lg:flex items-center gap-4 pointer-events-auto">
             <button id="touch-b-lg" class="touch-btn touch-btn-b text-3xl">B</button>
             <button id="touch-a-lg" class="touch-btn touch-btn-a text-3xl">A</button>
        </div>

        <div id="touch-controls" class="lg:hidden fixed bottom-0 left-0 right-0 p-4 flex justify-between items-end pointer-events-none">
            <div class="grid grid-cols-3 grid-rows-3 gap-2 w-48 h-48 pointer-events-auto">
                <div></div>
                <button id="touch-up" class="touch-btn">▲</button>
                <div></div>
                <button id="touch-left" class="touch-btn">◀</button>
                <div></div>
                <button id="touch-right" class="touch-btn">▶</button>
                <div></div>
                <button id="touch-down" class="touch-btn">▼</button>
                <div></div>
            </div>
            <div class="flex items-center gap-4 pointer-events-auto">
                <button id="touch-b" class="touch-btn touch-btn-b text-3xl">B</button>
                <button id="touch-a" class="touch-btn touch-btn-a text-3xl">A</button>
            </div>
        </div>
    </div>
    
    <div id="battle-scene" class="hidden absolute inset-0 bg-black bg-opacity-90 flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-4xl">
            <div class="flex justify-between items-end">
                <div id="opponent-sprite" class="text-8xl w-1/4 transform -scale-x-100"></div>
                <div class="text-right mb-4 w-3/4">
                    <div id="opponent-name-container" class="flex justify-end items-center"></div>
                    <div class="w-full bg-gray-600 rounded-full h-6 border-4 border-gray-400">
                        <div id="opponent-hp" class="bg-green-500 h-full rounded-full transition-all duration-500" style="width: 100%"></div>
                    </div>
                </div>
            </div>
             <div id="opponent2-info" class="hidden flex justify-between items-end mt-2">
                <div id="opponent2-sprite" class="text-8xl w-1/4 transform -scale-x-100"></div>
                <div class="text-right mb-4 w-3/4">
                    <div id="opponent2-name-container" class="flex justify-end items-center"></div>
                    <div class="w-full bg-gray-600 rounded-full h-6 border-4 border-gray-400">
                        <div id="opponent2-hp" class="bg-green-500 h-full rounded-full transition-all duration-500" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-end mt-12">
                <div class="text-left w-3/4">
                    <div id="player-name-container" class="flex justify-start items-center"></div>
                    <div class="w-full bg-gray-600 rounded-full h-6 border-4 border-gray-400">
                        <div id="player-hp" class="bg-green-500 h-full rounded-full transition-all duration-500" style="width: 100%"></div>
                    </div>
                     <p id="player-hp-text" class="text-lg text-right"></p>
                </div>
                <div id="player-sprite" class="text-8xl w-1/4"></div>
            </div>
             <div id="ally-info" class="hidden flex justify-between items-end mt-2">
                 <div class="text-left w-3/4">
                    <div id="ally-name-container" class="flex justify-start items-center"></div>
                    <div class="w-full bg-gray-600 rounded-full h-6 border-4 border-gray-400">
                        <div id="ally-hp" class="bg-green-500 h-full rounded-full transition-all duration-500" style="width: 100%"></div>
                    </div>
                </div>
                <div id="ally-sprite" class="text-8xl w-1/4"></div>
            </div>
        </div>

        <div id="battle-box" class="message-box w-full max-w-4xl mx-auto min-h-48 p-4 mt-8 bg-white text-gray-800 rounded-lg">
            <p id="battle-text" class="text-xl mb-4"></p>
            <div id="battle-grid" class="grid grid-cols-2 gap-4">
            </div>
        </div>
    </div>
    
    <div id="menu-scene" class="hidden ui-scene absolute inset-0 p-8 flex flex-col items-center justify-center">
        <div class="w-full max-w-sm bg-white text-black rounded-lg border-8 border-gray-500 p-6 grid grid-cols-1 gap-4">
            <h2 class="text-3xl text-center mb-2">Menu</h2>
            <button id="menu-pokedex-btn" class="w-full p-3 bg-blue-500 text-white rounded-lg text-2xl">Lexicon</button>
            <button id="menu-pokemon-btn" class="w-full p-3 bg-blue-500 text-white rounded-lg text-2xl">Creatures</button>
            <button id="menu-inventory-btn" class="w-full p-3 bg-blue-500 text-white rounded-lg text-2xl">Inventory</button>
            <button id="menu-map-btn" class="w-full p-3 bg-indigo-500 text-white rounded-lg text-2xl">World Map</button>
            <button id="menu-journal-btn" class="w-full p-3 bg-yellow-600 text-white rounded-lg text-2xl">Journal</button>
            <button id="menu-save-btn" class="w-full p-3 bg-green-500 text-white rounded-lg text-2xl">Save Game</button>
            <button id="menu-new-game-btn" class="w-full p-3 bg-purple-600 text-white rounded-lg text-2xl">New Game</button>
            <button id="menu-close-btn" class="mt-4 w-full p-3 bg-red-500 text-white rounded-lg text-2xl">Close</button>
        </div>
    </div>
    
    <div id="inventory-scene" class="hidden ui-scene absolute inset-0 p-8 flex flex-col items-center justify-center">
        <div class="w-full max-w-2xl bg-white text-black rounded-lg border-8 border-gray-500 p-6">
            <h2 class="text-3xl text-center mb-4">Inventory</h2>
            <div class="text-2xl mb-6 flex justify-between">
                <span>Money:</span>
                <span id="inventory-money"></span>
            </div>
            <div id="inventory-items" class="space-y-4 min-h-[100px]"></div>
            <button class="ui-back-btn mt-6 w-full p-3 bg-yellow-500 text-black rounded-lg text-2xl">Back</button>
        </div>
    </div>

    <div id="pokemon-stats-scene" class="hidden ui-scene absolute inset-0 p-8 flex flex-col items-center justify-center">
        <div class="w-full max-w-3xl bg-white text-black rounded-lg border-8 border-gray-500 p-6 flex flex-col">
            <div id="pokemon-stats-content" class="overflow-y-auto max-h-[60vh]">
            </div>
            <button class="ui-back-btn mt-6 w-full p-3 bg-yellow-500 text-black rounded-lg text-2xl">Back</button>
        </div>
    </div>

    <div id="pokedex-scene" class="hidden ui-scene absolute inset-0 p-8 flex flex-col items-center justify-center">
        <div class="w-full max-w-3xl bg-white text-black rounded-lg border-8 border-gray-500 p-6">
            <h2 class="text-3xl text-center mb-4">Lexicon</h2>
            <div id="pokedex-entries" class="space-y-4 max-h-[60vh] overflow-y-auto"></div>
            <button class="ui-back-btn mt-6 w-full p-3 bg-yellow-500 text-black rounded-lg text-2xl">Back</button>
        </div>
    </div>

    <div id="pc-scene" class="hidden ui-scene absolute inset-0 p-8 flex flex-col items-center justify-center">
        <div class="w-full max-w-4xl bg-white text-black rounded-lg border-8 border-gray-500 p-6">
            <h2 class="text-3xl text-center mb-4">Creature Storage</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <h3 class="text-2xl text-center">Party</h3>
                    <div id="pc-party" class="space-y-2 mt-2"></div>
                </div>
                <div>
                    <h3 class="text-2xl text-center">Box</h3>
                    <div id="pc-box" class="space-y-2 mt-2 max-h-[40vh] overflow-y-auto"></div>
                </div>
            </div>
            <button id="pc-close-btn" class="mt-6 w-full p-3 bg-red-500 text-white rounded-lg text-2xl">Close</button>
        </div>
    </div>
    
    <div id="map-scene" class="hidden ui-scene absolute inset-0 p-8 flex flex-col items-center justify-center">
        <div class="w-full max-w-2xl bg-white text-black rounded-lg border-8 border-gray-500 p-6 flex flex-col">
            <h2 class="text-3xl text-center mb-4">World Map</h2>
            <div class="overflow-y-auto max-h-[60vh]">
                <div id="world-map-grid" class="grid grid-cols-5 gap-1 bg-gray-700 p-1 border-2 border-gray-500">
                    <!-- Map cells will be generated here by JavaScript -->
                </div>
            </div>
            <p class="text-center mt-2 text-sm"><span class="inline-block w-3 h-3 bg-yellow-400 border border-black align-middle"></span> = Your Location</p>
            <button class="ui-back-btn mt-6 w-full p-3 bg-yellow-500 text-black rounded-lg text-2xl">Back</button>
        </div>
    </div>

    <div id="journal-scene" class="hidden ui-scene absolute inset-0 p-8 flex flex-col items-center justify-center">
        <div class="w-full max-w-2xl bg-white text-black rounded-lg border-8 border-gray-500 p-6">
            <h2 class="text-3xl text-center mb-4">Journal</h2>
            <div id="journal-entries" class="space-y-4 max-h-[60vh] overflow-y-auto"></div>
            <button class="ui-back-btn mt-6 w-full p-3 bg-yellow-500 text-black rounded-lg text-2xl">Back</button>
        </div>
    </div>
    
    <div id="credits-container" class="hidden absolute inset-0 bg-black overflow-hidden">
        <div id="credits-scene">
            <p class="mb-8 text-4xl">ELA Quest</p>
            <p class="mb-4">A Game By:</p>
            <p class="mb-12 text-yellow-300">Luke Holm</p>

            <p class="mb-4">Powered By:</p>
            <p class="mb-12 text-yellow-300">Leveled Up Learning</p>
            
            <p class="mb-8">Thank you for playing!</p>
            
            <p class="text-sm">Please check out our other gamified lessons, reviews, and quizzes!</p>
        </div>
    </div>


<script>
(function() {
    // --- DOM Elements & Canvas Setup ---
    const canvas = document.getElementById('gameCanvas');
    const gameContainer = document.getElementById('game-container');
    const ctx = canvas.getContext('2d');
    const messageBox = document.getElementById('message-box');
    const messageText = document.getElementById('message-text');
    const choicesBox = document.getElementById('choices-box');
    const battleScene = document.getElementById('battle-scene');
    const battleBox = document.getElementById('battle-box');
    const battleText = document.getElementById('battle-text');
    const battleGrid = document.getElementById('battle-grid');
    
    const menuScene = document.getElementById('menu-scene');
    const inventoryScene = document.getElementById('inventory-scene');
    const pokemonStatsScene = document.getElementById('pokemon-stats-scene');
    const pokedexScene = document.getElementById('pokedex-scene');
    const pcScene = document.getElementById('pc-scene');
    const mapScene = document.getElementById('map-scene');
    const journalScene = document.getElementById('journal-scene');
    
    const titleScreen = document.getElementById('title-screen');
    const pageLayout = document.getElementById('page-layout');

    const tileSize = 32;
    canvas.width = 16 * tileSize; 
    canvas.height = 14 * tileSize;

    // --- Save/Load Functions ---
    function getSaveData() {
        return localStorage.getItem('elaQuestSaveData');
    }

    function saveGame() {
        try {
            localStorage.setItem('elaQuestSaveData', JSON.stringify(gameState));
            console.log("Game saved!");
        } catch (e) {
            console.error("Failed to save game:", e);
        }
    }

    function loadGame() {
        try {
            const savedData = getSaveData();
            if (savedData) {
                const loadedState = JSON.parse(savedData);
                // Merge loaded state into the default gameState.
                // This preserves any new properties from code updates.
                Object.assign(gameState, loadedState);
                console.log("Game loaded successfully!");
                return true;
            }
        } catch (e) {
            console.error("Failed to load game:", e);
        }
        return false;
    }
    
    function getDefaultGameState() {
        return {
            currentMap: 'playerRoom',
            player: { x: 4, y: 4, sprite: 'player', walkFrame: 0 },
            inDialogue: false, inBattle: false, activeScene: null,
            timeOfDay: 'day',
            money: 50,
            inventory: { 
                potions: 3, wordballs: 5, greatphrases: 0, ultrasentences: 0, masterthesis: 0, 
                lexiconLollies: 0, adjectiveElixirs: 0, thesaurusTeas: 0, escapeVerbs: 0, 
                LH01LuminousHyperbole: 0, LH02LyricalHightail: 0, airplanePropeller: 0, overdueBook: 0,
                deliciousDefinitions: 0, oldRod: 0, luckyLure: 0,
            },
            rivalDefeated: false,
            rivalDefeatedPostGym: false,
            rivalDefeatedInSynonymCity: false,
            defeatedTrainers: [],
            pokedex: {},
            playerParty: [],
            pokemonBox: [],
            gymBadges: { rhyme: false, synonym: false },
            devModeActive: false,
            hasMetDeathMasheen: false,
            teleportUnlocked: false,
            earthquake1Triggered: false,
            earthquake2Triggered: false,
            finalBossDefeated: false,
            initialized: false,
            foundItems: [],
            quests: {
                overdueBook: 'notStarted',
                islandCooperation: 'notStarted', 
                poetInspiration: 'notStarted',
                chefsMenu: 'notStarted',
                fishermansLure: 'notStarted',
            },
            inReserveMode: false,
            reserveChallenge: null,
            discoveredLocations: ['playerRoom', 'playerHouse', 'village'],
        };
    }

    // --- Game State ---
    let gameState = getDefaultGameState();
    let partySelectionIndex = null;
    
    const questDB = {
        'overdueBook': {
            'started': "Return the 'Epic of Gilgamesh' to the Synonym City Library.",
            'completed': "You returned the overdue book to the librarian."
        },
        'islandCooperation': {
            'started': "You and Andy are stranded! Work together to find a way off the island.",
            'completed': "You and Andy escaped the deserted island."
        },
        'poetInspiration': {
            'started': "Show a Haiku-na to the poet in Lexington City.",
            'completed': "You inspired the poet with the graceful Haiku-na."
        },
        'chefsMenu': {
            'started': "Show an Adjectlizard to the chef in Synonym City.",
            'completed': "You helped the chef create a wonderfully descriptive menu."
        },
        'fishermansLure': {
            'started': "Find the Fisherman's lost Lucky Lure.",
            'completed': "You returned the lure and received an Old Rod!"
        }
    };

    // --- Databases & Game Data ---
    const typeChart = {
        'Verb': { effective: ['Noun'], ineffective: ['Adjective'] },
        'Noun': { effective: ['Adjective'], ineffective: ['Verb'] },
        'Adjective': { effective: ['Verb'], ineffective: ['Noun'] },
        'Syntax': { effective: [], ineffective: [] },
    };

    const attacksDB = {
        'Tackle': { name: 'Tackle', type: 'Noun', power: 8, text: 'A basic physical strike.' },
        'Word Strike': { name: 'Word Strike', type: 'Noun', power: 10, text: 'Channels knowledge into a jab.' },
        'Synonym Slam': { name: 'Synonym Slam', type: 'Noun', power: 15, text: 'A blow backed by similar words.' },
        'Vicious Lunge': { name: 'Vicious Lunge', type: 'Verb', power: 12, text: 'A swift, action-based strike.' },
        'Roar of Knowledge': { name: 'Roar of Knowledge', type: 'Syntax', power: 22, text: 'A stunning cry of ancient truths.'},
        'Gooey Touch': { name: 'Gooey Touch', type: 'Adjective', power: 7, text: 'A sticky, weak jab.'},
        'Chameleon Color': {name: 'Chameleon Color', type: 'Adjective', power: 12, text: 'Changes color to land a surprising hit.'},
        'Scale Shot': {name: 'Scale Shot', type: 'Noun', power: 18, text: 'Fires sharp scales at the foe.'},
        'Cosmic Prose': {name: 'Cosmic Prose', type: 'Syntax', power: 30, text: 'An attack of legendary power.'},
        'Leer': { name: 'Leer', type: 'Syntax', power: 0, text: 'Lowers enemy defense.', effect: { type: 'stat', stat: 'defense', amount: -1, target: 'opponent' } },
        'Growl': { name: 'Growl', type: 'Syntax', power: 0, text: 'Lowers enemy attack.', effect: { type: 'stat', stat: 'attack', amount: -1, target: 'opponent' } },
        'Sharpen': { name: 'Sharpen', type: 'Syntax', power: 0, text: 'Raises the user\'s Attack stat.', effect: { type: 'stat', stat: 'attack', amount: 1, target: 'self' } },
        'Jumbled Jargon': { name: 'Jumbled Jargon', type: 'Syntax', power: 0, text: 'Confuses the opponent with nonsense.', effect: { type: 'status', status: 'confused', chance: 0.5 } },
        'Dull Drone': { name: 'Dull Drone', type: 'Noun', power: 0, text: 'Bores the opponent to sleep.', effect: { type: 'status', status: 'boredom', chance: 0.6 } },
        'Ink Stain': { name: 'Ink Stain', type: 'Noun', power: 5, text: 'A messy attack that causes writer\'s block.', effect: { type: 'status', status: 'writersBlock', chance: 0.9 } },
    };

    const pokedexData = {
        'Synonymouse': 'A clever creature that evolves into the powerful Syntar.',
        'Syntar': 'A rare evolution of Synonymouse. It is a master of syntax and evolves into Paradoxos.',
        'Paradoxos': 'The final form of Synonymouse. A legendary creature whose very existence is a contradiction.',
        'Wordworm': 'Common in grassy areas, this creature consumes letters for sustenance.',
        'Grammargoyle': 'A stoic opponent that evolves into Dictionare.',
        'Dictionare': 'The evolved form of Grammargoyle. It is a living dictionary that evolves into Enigmalith.',
        'Enigmalith': 'The final form of Grammargoyle. A being of pure, unbreakable grammar.',
        'SimileSlime': 'A gooey creature that is *like* a puddle but *as* solid as a rock.',
        'CommaLeon': 'This creature can pause, adapt, and blend into any sentence structure.',
        'Adjectlizard': 'A reptile that describes its foes into submission with powerful adjectives.',
        'Haiku-na': 'A serene creature that attacks in a pattern of 5, then 7, then 5 syllables.',
        'EpicAvis': 'When Haiku-na evolves, it becomes a master of long-form poetry and epic tales.',
        'Metaphorpillar': 'It believes it IS a leaf, consuming knowledge until it transforms.',
        'Analofly': 'The beautiful evolution of Metaphorpillar. It draws comparisons to overwhelm its foes.',
        'Hyper-bole': 'This creature is the BIGGEST, STRONGEST, and FASTEST creature in the entire universe! (Or so it claims).',
        'PronounProwler': 'A swift hunter that replaces its prey\'s name with "it" before it strikes.',
        'VerbViper': 'This serpent moves with decisive action, striking with a powerful verb-al assault.',
        'Lexiconstruct': 'A legendary golem of pure language, said to hold the secrets of all stories.',
        'Antonymph': 'A legendary fairy of opposition, its very presence inverts the world around it.',
        'Nomenowl': 'This wise creature can name anything it sees, making it a master of nouns.',
        'Rhymoceros': 'With a horn as hard as a perfect rhyme, it charges with poetic force.',
        'Adjectoad': 'Its colorful skin changes to describe its mood. A truly expressive creature.',
        'Stalagmight': 'Formed over centuries in deep caves, its body is as solid as grammatical law.',
        'Conjun-gull': 'This seabird connects ideas as it soars, linking thoughts across the sky.',
        'Allegator': 'Its stories and growls often have a hidden, deeper meaning.',
        'Alliteration': 'The two heads of this creature constantly create cunning, complex consonances.',
        'Fablion': 'A proud creature whose roars tell tales with strong moral lessons.',
        'Mythical': 'An evolution of Fablion, its very existence is a story passed down through generations, explaining natural phenomena.',
        'Pun-guin': 'It uses clever wordplay and puns to confuse its opponents in battle.',
        'Irony': 'Its battle style is the opposite of what you\'d expect, making it a tricky and unpredictable foe.',
        'Buzzword': "This small, insectoid creature communicates entirely through buzzing onomatopoeia. It's often found in noisy, bustling places.",
        'Droneme': "The evolution of Buzzword. Its constant, rhythmic droning can mesmerize opponents, making it difficult to focus in battle.",
        'Omen': "A mysterious, spectral creature that appears briefly before important events. Its presence is considered a sign of things to come.",
        'Racecar': "A strange, mechanical creature that moves with incredible speed, both forwards and backwards. It's perfectly symmetrical.",
        'Gerundile': 'This creature is in constant motion, rolling on its wheel-like feet. It represents a verb acting as a noun.',
        'Infinotaur': 'The evolved form of Gerundile. A powerful being that embodies the core concept of a verb: to be, or to do.',
        'Dramask': 'This creature of the stage can mimic the actions of its opponents. It is a master of verbs.',
        'Catalist': 'A feisty creature that loves to start things. Its very presence can be the catalyst for a chain of events.',
        'Chain Re-Action': 'The evolution of Catalist. A single one of its actions can cause a cascade of consequences for its opponents.',
    };

    const itemsDB = {
        'potions': { name: 'Potion', description: "A spray that restores a creature's health, or its 'main idea.'" },
        'wordballs': { name: 'Word Ball', description: "A device for capturing and storing the essence of wild literary creatures.", bonus: 1.0 },
        'greatphrases': { name: 'Great Phrase', description: "A well-crafted sentence with a higher chance of capturing a creature.", bonus: 1.5 },
        'ultrasentences': { name: 'Ultra Sentence', description: "A complex, high-performance sentence with a very high capture rate.", bonus: 2.0 },
        'masterthesis': { name: 'Master Thesis', description: "The ultimate literary device. It will capture any creature without fail.", bonus: 255 },
        'lexiconLollies': { name: 'Lexicon Lolly', description: "A sweet treat that instantly raises a creature's level by one." },
        'adjectiveElixirs': { name: 'Adjective Elixir', description: "A descriptive drink that temporarily boosts a creature's Attack stat." },
        'thesaurusTeas': { name: 'Thesaurus Tea', description: "A soothing brew that cures any status conditions by finding an alternative 'state of being.'" },
        'escapeVerbs': { name: 'Escape Verb', description: "An action-packed phrase that guarantees a swift escape from a wild encounter." },
        'LH01LuminousHyperbole': { name: 'LH01 L. Hyperbole', description: "An incredibly powerful turn of phrase that can illuminate the darkest of places." },
        'LH02LyricalHightail': { name: 'LH02 L. Hightail', description: "A poetic verse that lets you instantly travel to any previously visited Word Center." },
        'boatPart': { name: 'Engine Cog', description: 'A sturdy-looking metal gear. It seems important.' },
        'overdueBook': { name: 'Overdue Book', description: "A rare copy of 'The Epic of Gilgamesh'. The librarian wants this back!"},
        'deliciousDefinitions': { name: 'Delicious Definition', description: "A tasty treat used to lure rare creatures in the Wild Word Reserve." },
    };

    const pokemonDB = {
        'Synonymouse': { sprite: 'synonymouse', types: ['Noun'], evolvesAt: 10, evolvesTo: 'Syntar', learnset: [{ level: 7, move: 'Synonym Slam' }], catchDifficulty: 45 },
        'Syntar': { sprite: 'syntar', types: ['Syntax', 'Verb'], evolvesAt: 25, evolvesTo: 'Paradoxos', learnset: [], catchDifficulty: 25 },
        'Paradoxos': { sprite: 'paradoxos', types: ['Syntax', 'Adjective'], learnset: [], catchDifficulty: 10 },
        'Wordworm': { sprite: 'wordworm', types: ['Noun'], catchDifficulty: 255 },
        'Grammargoyle': { sprite: 'grammargoyle', types: ['Syntax'], evolvesAt: 10, evolvesTo: 'Dictionare', catchDifficulty: 45 },
        'Dictionare': { sprite: 'dictionare', types: ['Syntax', 'Noun'], evolvesAt: 25, evolvesTo: 'Enigmalith', catchDifficulty: 20 },
        'Enigmalith': { sprite: 'enigmalith', types: ['Syntax', 'Noun'], learnset: [], catchDifficulty: 10 },
        'SimileSlime': { sprite: 'simileslime', types: ['Adjective'], catchDifficulty: 190 },
        'CommaLeon': { sprite: 'commaleon', types: ['Adjective'], catchDifficulty: 90 },
        'Adjectlizard': {sprite: 'adjectlizard', types: ['Adjective', 'Noun'], learnset: [{level: 9, move: 'Scale Shot'}], catchDifficulty: 45 },
        'Haiku-na': { sprite: 'haikuna', types: ['Syntax'], evolvesAt: 20, evolvesTo: 'EpicAvis', catchDifficulty: 75 },
        'EpicAvis': { sprite: 'epicavis', types: ['Syntax', 'Noun'], catchDifficulty: 40 },
        'Metaphorpillar': { sprite: 'metaphorpillar', types: ['Adjective'], evolvesAt: 12, evolvesTo: 'Analofly', catchDifficulty: 255 },
        'Analofly': { sprite: 'analofly', types: ['Adjective', 'Syntax'], catchDifficulty: 120 },
        'Hyper-bole': { sprite: 'hyperbole', types: ['Adjective'], catchDifficulty: 120 },
        'PronounProwler': { sprite: 'pronounprowler', types: ['Noun'], catchDifficulty: 90 },
        'VerbViper': { sprite: 'verbviper', types: ['Verb'], catchDifficulty: 90 },
        'Lexiconstruct': { sprite: 'lexiconstruct', types: ['Syntax'], isLegendary: true, catchDifficulty: 3 },
        'Antonymph': { sprite: 'antonymph', types: ['Syntax'], isLegendary: true, catchDifficulty: 3 },
        'Nomenowl': { sprite: 'nomenowl', types: ['Noun'], catchDifficulty: 220 },
        'Rhymoceros': { sprite: 'rhymoceros', types: ['Syntax'], catchDifficulty: 60 },
        'Adjectoad': { sprite: 'adjectoad', types: ['Adjective'], catchDifficulty: 180 },
        'Stalagmight': { sprite: 'stalagmight', types: ['Noun', 'Syntax'], catchDifficulty: 100 },
        'Conjun-gull': { sprite: 'conjungull', types: ['Verb'], catchDifficulty: 150 },
        'Allegator': { sprite: 'allegator', types: ['Noun'], evolvesAt: 16, evolvesTo: 'Alliteration', catchDifficulty: 75 },
        'Alliteration': { sprite: 'alliteration', types: ['Noun', 'Syntax'], catchDifficulty: 45 },
        'Fablion': { sprite: 'fablion', types: ['Noun'], evolvesAt: 22, evolvesTo: 'Mythical', catchDifficulty: 60 },
        'Mythical': { sprite: 'mythical', types: ['Noun', 'Verb'], catchDifficulty: 30 },
        'Pun-guin': { sprite: 'penguin', types: ['Syntax'], evolvesAt: 28, evolvesTo: 'Irony', catchDifficulty: 90 },
        'Irony': { sprite: 'irony', types: ['Syntax', 'Adjective'], catchDifficulty: 45 },
        'Buzzword': { sprite: 'buzzword', types: ['Noun', 'Syntax'], evolvesAt: 24, evolvesTo: 'Droneme', catchDifficulty: 190 },
        'Droneme': { sprite: 'droneme', types: ['Noun', 'Syntax'], catchDifficulty: 90 },
        'Omen': { sprite: 'omen', types: ['Syntax'], catchDifficulty: 120 },
        'Racecar': { sprite: 'racecar', types: ['Noun', 'Verb'], catchDifficulty: 60 },
        'Gerundile': { sprite: 'gerundile', types: ['Verb', 'Noun'], evolvesAt: 18, evolvesTo: 'Infinotaur', catchDifficulty: 100 },
        'Infinotaur': { sprite: 'infinotaur', types: ['Verb', 'Noun'], catchDifficulty: 50 },
        'Dramask': { sprite: 'dramask', types: ['Verb', 'Syntax'], catchDifficulty: 75 },
        'Catalist': { sprite: 'catalist', types: ['Verb'], evolvesAt: 26, evolvesTo: 'Chain Re-Action', catchDifficulty: 80 },
        'Chain Re-Action': { sprite: 'chainreaction', types: ['Verb', 'Syntax'], catchDifficulty: 40 },
    };
    
    const createPokemon = (species, level) => {
        let baseHp = 15, baseAtk = 8, baseDef = 5, attacks = ['Tackle'];
        switch(species) {
            case 'Synonymouse': baseHp = 20; baseAtk = 10; baseDef = 6; attacks = ['Tackle', 'Word Strike', 'Growl']; break;
            case 'Syntar': baseHp = 40; baseAtk = 18; baseDef = 17; attacks = ['Vicious Lunge', 'Word Strike', 'Roar of Knowledge']; break;
            case 'Paradoxos': baseHp = 60; baseAtk = 28; baseDef = 25; attacks = ['Cosmic Prose', 'Roar of Knowledge', 'Sharpen']; break;
            case 'Grammargoyle': baseHp = 30; baseAtk = 14; baseDef = 10; attacks = ['Tackle', 'Leer', 'Sharpen', 'Jumbled Jargon']; break;
            case 'Dictionare': baseHp = 50; baseAtk = 20; baseDef = 25; attacks = ['Synonym Slam', 'Sharpen', 'Ink Stain']; break;
            case 'Enigmalith': baseHp = 70; baseAtk = 25; baseDef = 35; attacks = ['Synonym Slam', 'Roar of Knowledge', 'Leer']; break;
            case 'Wordworm': baseHp = 15; baseAtk = 6; baseDef = 4; attacks = ['Tackle', 'Growl']; break;
            case 'SimileSlime': baseHp = 18; baseAtk = 7; baseDef = 8; attacks = ['Gooey Touch', 'Dull Drone']; break;
            case 'CommaLeon': baseHp = 22; baseAtk = 9; baseDef = 7; attacks = ['Tackle', 'Chameleon Color']; break;
            case 'Adjectlizard': baseHp = 30; baseAtk = 12; baseDef = 9; attacks = ['Tackle', 'Leer', 'Scale Shot']; break;
            case 'Haiku-na': baseHp = 20; baseAtk = 11; baseDef = 6; attacks = ['Tackle', 'Dull Drone']; break;
            case 'EpicAvis': baseHp = 42; baseAtk = 23; baseDef = 14; attacks = ['Word Strike', 'Vicious Lunge']; break;
            case 'Metaphorpillar': baseHp = 16; baseAtk = 5; baseDef = 12; break;
            case 'Analofly': baseHp = 35; baseAtk = 15; baseDef = 20; attacks = ['Chameleon Color', 'Gooey Touch']; break;
            case 'Hyper-bole': baseHp = 12; baseAtk = 14; baseDef = 3; break;
            case 'PronounProwler': baseHp = 25; baseAtk = 13; baseDef = 7; attacks = ['Tackle', 'Leer']; break;
            case 'VerbViper': baseHp = 28; baseAtk = 15; baseDef = 6; attacks = ['Tackle', 'Vicious Lunge', 'Growl']; break;
            case 'Lexiconstruct': baseHp = 100; baseAtk = 50; baseDef = 50; attacks = ['Cosmic Prose', 'Synonym Slam']; break;
            case 'Antonymph': baseHp = 100; baseAtk = 50; baseDef = 50; attacks = ['Cosmic Prose', 'Word Strike']; break;
            case 'Nomenowl': baseHp = 18; baseAtk = 9; baseDef = 5; attacks = ['Tackle', 'Leer']; break;
            case 'Rhymoceros': baseHp = 35; baseAtk = 15; baseDef = 12; attacks = ['Tackle', 'Synonym Slam']; break;
            case 'Adjectoad': baseHp = 20; baseAtk = 8; baseDef = 10; attacks = ['Gooey Touch', 'Growl']; break;
            case 'Stalagmight': baseHp = 25; baseAtk = 10; baseDef = 20; attacks = ['Tackle', 'Sharpen']; break;
            case 'Conjun-gull': baseHp = 22; baseAtk = 12; baseDef = 8; attacks = ['Tackle', 'Vicious Lunge']; break;
            case 'Allegator': baseHp = 28; baseAtk = 14; baseDef = 10; attacks = ['Tackle', 'Leer']; break;
            case 'Alliteration': baseHp = 45; baseAtk = 22; baseDef = 18; attacks = ['Word Strike', 'Synonym Slam']; break;
            case 'Fablion': baseHp = 32; baseAtk = 16; baseDef = 9; attacks = ['Tackle', 'Roar of Knowledge']; break;
            case 'Mythical': baseHp = 50; baseAtk = 25; baseDef = 15; attacks = ['Vicious Lunge', 'Word Strike']; break;
            case 'Pun-guin': baseHp = 25; baseAtk = 10; baseDef = 13; attacks = ['Gooey Touch', 'Growl']; break;
            case 'Irony': baseHp = 48; baseAtk = 20; baseDef = 22; attacks = ['Synonym Slam', 'Chameleon Color']; break;
            case 'Buzzword': baseHp = 20; baseAtk = 11; baseDef = 8; attacks = ['Tackle', 'Growl']; break;
            case 'Droneme': baseHp = 40; baseAtk = 22; baseDef = 16; attacks = ['Vicious Lunge', 'Jumbled Jargon']; break;
            case 'Omen': baseHp = 30; baseAtk = 15; baseDef = 5; attacks = ['Leer', 'Dull Drone']; break;
            case 'Racecar': baseHp = 25; baseAtk = 18; baseDef = 10; attacks = ['Tackle', 'Vicious Lunge']; break;
            case 'Gerundile': baseHp = 28; baseAtk = 15; baseDef = 11; attacks = ['Tackle', 'Vicious Lunge']; break;
            case 'Infinotaur': baseHp = 52; baseAtk = 26; baseDef = 20; attacks = ['Synonym Slam', 'Vicious Lunge']; break;
            case 'Dramask': baseHp = 26; baseAtk = 12; baseDef = 14; attacks = ['Leer', 'Jumbled Jargon']; break;
            case 'Catalist': baseHp = 27; baseAtk = 16; baseDef = 9; attacks = ['Tackle', 'Sharpen']; break;
            case 'Chain Re-Action': baseHp = 50; baseAtk = 28; baseDef = 18; attacks = ['Vicious Lunge', 'Synonym Slam']; break;
        }
        return { 
            species, name: species, level, 
            types: pokemonDB[species].types,
            currentHp: baseHp + (level * 5), maxHp: baseHp + (level * 5), 
            attack: baseAtk + (level * 2), defense: baseDef + (level * 2),
            xp: 0, xpToNextLevel: 100, 
            attacks: attacks.map(a => attacksDB[a]), 
            sprite: pokemonDB[species] ? pokemonDB[species].sprite : species.toLowerCase(),
            statMods: { attack: 0, defense: 0 },
            hasEvolved: false,
            status: null,
            statusTurns: 0,
        };
    };

    const trainersDB = {
        'hikerTom': { name: "Hiker Tom", pokemon: [{species: 'Wordworm', level: 6}], preBattle: ["A trainer! Finally a challenge! Let's battle!"], postBattle: ["Huff... puff... you're pretty strong. Keep it up!"], reward: 60 },
        'readerSue': { name: "Reader Sue", pokemon: [{species: 'SimileSlime', level: 7}], preBattle: ["Oh! You want to battle? My SimileSlime is as ready as a spring day!"], postBattle: ["Wow! Your skills are like a roaring fire!"], reward: 70 },
        'bookwormBarry': { name: "Bookworm Barry", pokemon: [{species: 'PronounProwler', level: 15}], preBattle: ["I've read about every creature! Let's see if your skills are textbook!"], postBattle: ["Wow, a real-world lesson! You're tougher than the texts said."], reward: 150 },
        'artistAdeline': { name: "Artist Adeline", pokemon: [{species: 'VerbViper', level: 17}], preBattle: ["I'm painting a picture of a perfect battle. You're my subject!"], postBattle: ["Such vivid action! You've inspired my next masterpiece."], reward: 170 },
        'profGrendel': { name: "Professor Grendel", pokemon: [{species: 'Dictionare', level: 25}, {species: 'VerbViper', level: 28}], preBattle: ["You dare challenge the master of semantics? Your story ends here!"], postBattle: ["Hmph. A mere fluke. You have not seen the last of my literary might!"], reward: 300 },
        'gymLeaderRhonda': { name: "Gym Leader Rhonda", pokemon: [{species: 'Haiku-na', level: 12}, {species: 'Adjectlizard', level: 14}], preBattle: ["Rhonda: 'To earn my badge, you have to climb,'", "'And beat my team in a rhyme-fueled crime!'"], postBattle: ["Your skills are sharp, your victory's prime,", "Here's the Rhyme Badge, for your time!"], reward: 400 },
        'gymLeaderLex': { name: "Gym Leader Lex", pokemon: [{species: 'Dictionare', level: 30}, {species: 'Grammargoyle', level: 28}], preBattle: ["Welcome to the grand library of battle! Let's see if your lexicon is as mighty as your creatures!"], postBattle: ["Astounding! Your command of language is impressive! You've earned this!"], reward: 500 },
        'caveExplorerDon': { name: "Explorer Don", pokemon: [{species: 'Grammargoyle', level: 22}], preBattle: ["This cave is full of rare grammar! Don't get in my way!"], postBattle: ["Hmph. Fine, you can pass. But I'll find the rarest ones first!"], reward: 220 },
        'goblinBoss': { name: "Goblin Grunt", pokemon: [{species: 'Dictionare', level: 32}], preBattle: ["GRAR! You found me! But you won't stop me from finding the legendary creature of language!"], postBattle: ["Grah! Beaten... But the master will succeed... You'll need this to get out of here."], reward: 1000 },
        'shipwreckedPilot': { name: "Disoriented Pilot", pokemon: [{species: 'Hyper-bole', level: 35}], preBattle: ["Who... who are you? Is this my ship? Get away from my ship!"], postBattle: ["Ugh... my head... a plane crash... I've been here for years...", "My love... in Lexington City... I have to get back!", "You... you saved me from my delirium. Take this. It's a special technique.", "I should have used it to fly home ages ago... I must see her!"], reward: 600 },
        'finalBosses': { name: "Goblin Rulers", pokemon: [{species: 'Dictionare', level: 50}, {species: 'Enigmalith', level: 55}], preBattle: [], postBattle: [], reward: 3500 },
        'finalRival': { name: "Champion Andy", pokemon: [{species: 'Enigmalith', level: 65}, {species: 'Antonymph', level: 70}], preBattle: ["We've come a long way. Let's see who the real champion of ELA Quest is!"], postBattle: ["Wow... You really are the best. It's been an honor."], reward: 5000 },
    };

    const elaQuestions = [
        { q: "Which word is a synonym for 'happy'?", a: ["Joyful", "Sad", "Angry", "Tired"], c: "Joyful" },
        { q: "What opposes the protagonist?", a: ["Antagonist", "Ally", "Narrator", "Mentor"], c: "Antagonist" },
        { q: "Identify the verb: 'The cat quickly climbed the tree.'", a: ["climbed", "quickly", "cat", "tree"], c: "climbed" },
        { q: "'The wind whispered' is an example of...?", a: ["Personification", "Metaphor", "Simile", "Hyperbole"], c: "Personification" },
        { q: "Which word is an antonym for 'begin'?", a: ["Finish", "Start", "Create", "Open"], c: "Finish" },
        { q: "Which is spelled correctly?", a: ["Definitely", "Definately", "Definitly", "Definantly"], c: "Definitely" },
        { q: "What is the main idea of a story?", a: ["Theme", "Plot", "Setting", "Conflict"], c: "Theme" },
        { q: "'As brave as a lion' is an example of...?", a: ["Simile", "Metaphor", "Allusion", "Irony"], c: "Simile" },
        { q: "Choose the correct pronoun: '___ and I went to the store.'", a: ["He", "Him", "His", "Them"], c: "He" },
        { q: "Which sentence is a compound sentence?", a: ["I like pizza, and I like tacos.", "I like pizza.", "Because I like pizza, I ate it.", "I like pizza, tacos, and burgers."], c: "I like pizza, and I like tacos." },
        { q: "What is an 'adjective'?", a: ["A word that describes a noun", "A word for an action", "A person, place, or thing", "A word that describes a verb"], c: "A word that describes a noun" },
        { q: "Which of these is NOT a genre of literature?", a: ["Mathematics", "Fantasy", "Mystery", "Biography"], c: "Mathematics" },
        { q: "'Her smile is the sun' is an example of...?", a: ["Metaphor", "Simile", "Personification", "Hyperbole"], c: "Metaphor" },
        { q: "Find the error: 'Their going to the park.'", a: ["Their", "going", "to", "park"], c: "Their" },
        { q: "What is the climax of a story?", a: ["The most exciting point", "The beginning", "The ending", "The setting"], c: "The most exciting point" },
        { q: "Which is spelled correctly?", a: ["Receive", "Recieve", "Reiceve", "Receeve"], c: "Receive" },
        { q: "What is an adverb?", a: ["A word describing a verb", "A word describing a noun", "A short exclamation", "A connecting word"], c: "A word describing a verb" },
        { q: "What type of conflict is a character struggling against nature?", a: ["Character vs. Nature", "Character vs. Self", "Character vs. Society", "Character vs. Character"], c: "Character vs. Nature" },
        { q: "Which punctuation mark ends a question?", a: ["?", ".", "!", ","], c: "?" },
        { q: "An 'allusion' in literature is...", a: ["A reference to another work", "An illusion or trick", "The main character's goal", "A type of rhyme"], c: "A reference to another work" },
        { q: "Which word is a synonym for 'brave'?", a: ["Courageous", "Cowardly", "Meek", "Timid"], c: "Courageous" },
        { q: "What is a 'protagonist'?", a: ["The main character", "The villain", "The narrator", "A side character"], c: "The main character" },
        { q: "'The car engine coughed and sputtered' is an example of...?", a: ["Personification", "Simile", "Metaphor", "Onomatopoeia"], c: "Personification" },
        { q: "Which is spelled correctly?", a: ["Separate", "Seperate", "Saperate", "Seperete"], c: "Separate" },
        { q: "A 'biography' is a story of a person's life written by...", a: ["Someone else", "The person themselves", "A novelist", "An unknown author"], c: "Someone else" },
        { q: "What is the setting of a story?", a: ["When and where it takes place", "The main problem", "The list of characters", "The lesson learned"], c: "When and where it takes place" },
        { q: "Which word is an antonym for 'ancient'?", a: ["Modern", "Old", "Aged", "Past"], c: "Modern" },
        { q: "'The world is a stage' is an example of...?", a: ["Metaphor", "Simile", "Alliteration", "Irony"], c: "Metaphor" },
        { q: "Choose the correct use of 'its' or 'it's': 'The dog wagged ___ tail.'", a: ["its", "it's", "it is", "its'"], c: "its" },
        { q: "Identify the noun: 'The quick brown fox jumps.'", a: ["fox", "quick", "brown", "jumps"], c: "fox" },
        { q: "What does 'hyperbole' mean?", a: ["Exaggeration for effect", "A comparison using 'like'", "Giving human qualities to objects", "A question with no answer"], c: "Exaggeration for effect" },
        { q: "'I'm so hungry I could eat a horse' is an example of...?", a: ["Hyperbole", "Simile", "Understatement", "Irony"], c: "Hyperbole" },
        { q: "Which is spelled correctly?", a: ["Necessary", "Necesary", "Neccessary", "Necassary"], c: "Necessary" },
        { q: "A story's sequence of events is its...", a: ["Plot", "Theme", "Setting", "Character arc"], c: "Plot" },
        { q: "What is a 'haiku'?", a: ["A three-line poem with a 5-7-5 syllable structure", "A four-line rhyming poem", "A long epic story", "A funny short story"], c: "A three-line poem with a 5-7-5 syllable structure" },
        { q: "Which word is a synonym for 'look'?", a: ["Gaze", "Speak", "Listen", "Feel"], c: "Gaze" },
        { q: "The perspective from which a story is told is the...", a: ["Point of View", "Climax", "Resolution", "Exposition"], c: "Point of View" },
        { q: "What is the correct spelling?", a: ["Conscience", "Concience", "Consience", "Conscence"], c: "Conscience" },
        { q: "The struggle between opposing forces in a story is the...", a: ["Conflict", "Theme", "Setting", "Dialogue"], c: "Conflict" },
        { q: "'The buzzing bee flew by' is an example of...?", a: ["Onomatopoeia", "Metaphor", "Simile", "Allusion"], c: "Onomatopoeia" },
        { q: "What is a 'verb'?", a: ["An action or state of being", "A person, place, or thing", "A descriptive word", "A connecting word"], c: "An action or state of being" },
        { q: "Which word is an antonym of 'difficult'?", a: ["Easy", "Hard", "Challenging", "Complex"], c: "Easy" },
        { q: "What does the prefix 'un-' mean in 'unhappy'?", a: ["Not", "Very", "Again", "Before"], c: "Not" },
        { q: "What is the correct spelling?", a: ["Embarrass", "Embarass", "Embarras", "Embaras"], c: "Embarrass" },
        { q: "A 'sonnet' is a poem of...", a: ["14 lines", "10 lines", "20 lines", "5 lines"], c: "14 lines" },
        { q: "What type of sentence makes a command?", a: ["Imperative", "Declarative", "Interrogative", "Exclamatory"], c: "Imperative" },
        { q: "'Peter Piper picked a peck of pickled peppers' is an example of...?", a: ["Alliteration", "Assonance", "Metaphor", "Simile"], c: "Alliteration" },
        { q: "Which word is a synonym for 'big'?", a: ["Enormous", "Tiny", "Small", "Weak"], c: "Enormous" },
        { q: "A hint or clue about what will happen later in a story is...", a: ["Foreshadowing", "Flashback", "Symbolism", "Imagery"], c: "Foreshadowing" },
        { q: "What is the correct spelling?", a: ["Weird", "Wierd", "Wiered", "Weired"], c: "Weird" },
        { q: "The general feeling or atmosphere of a story is its...", a: ["Mood", "Tone", "Theme", "Genre"], c: "Mood" },
        { q: "An author's attitude towards a subject is their...", a: ["Tone", "Mood", "Style", "Voice"], c: "Tone" },
        { q: "Choose the correct word: 'Please put the book over ___.'", a: ["there", "their", "they're", "theyr"], c: "there" },
        { q: "Which of these is a preposition?", a: ["under", "run", "beautiful", "quickly"], c: "under" },
        { q: "A comparison between two unlike things WITHOUT using 'like' or 'as' is a...", a: ["Metaphor", "Simile", "Analogy", "Allegory"], c: "Metaphor" },
        { q: "What is the plural of 'goose'?", a: ["geese", "gooses", "geeses", "goose"], c: "geese" },
        { q: "Which word is a homophone for 'ate'?", a: ["eight", "eat", "late", "it"], c: "eight" },
        { q: "The main character in a story is called the...", a: ["Protagonist", "Antagonist", "Foil", "Narrator"], c: "Protagonist" },
        { q: "What is the purpose of an exclamation mark (!)?", a: ["To show strong feeling", "To end a question", "To create a pause", "To list items"], c: "To show strong feeling" },
        { q: "Which is an example of a simple sentence?", a: ["The dog barked.", "The dog barked, and the cat ran.", "When the dog barked, the cat ran.", "The dog barked loudly."], c: "The dog barked." },
        { q: "What is the definition of 'irony'?", a: ["A contrast between expectation and reality", "A funny or amusing situation", "A sad or tragic event", "A description of a person"], c: "A contrast between expectation and reality" },
        { q: "The words 'affect' and 'effect' are often confused. 'Affect' is usually a...", a: ["Verb", "Noun", "Adjective", "Pronoun"], c: "Verb" },
        { q: "A group of lines in a poem is called a...", a: ["Stanza", "Paragraph", "Sentence", "Chapter"], c: "Stanza" },
        { q: "Which is spelled correctly?", a: ["Accommodation", "Acommodation", "Accomodation", "Acomodation"], c: "Accommodation" },
        { q: "The author's main message or moral is the story's...", a: ["Theme", "Plot", "Setting", "Climax"], c: "Theme" },
        { q: "What is the past tense of 'run'?", a: ["ran", "runned", "running", "runs"], c: "ran" },
        { q: "A 'foil' character is a character who...", a: ["Contrasts with another character", "Is the hero's best friend", "Tells the story", "Is secretly the villain"], c: "Contrasts with another character" },
        { q: "Which punctuation is used to show possession?", a: ["Apostrophe", "Comma", "Period", "Semicolon"], c: "Apostrophe" },
        { q: "What is the synonym for 'smart'?", a: ["Intelligent", "Foolish", "Brave", "Kind"], c: "Intelligent" },
        { q: "'The sun smiled down on us' is an example of...", a: ["Personification", "Metaphor", "Alliteration", "Onomatopoeia"], c: "Personification" },
        { q: "What does the suffix '-ful' mean in 'beautiful'?", a: ["Full of", "Without", "Able to be", "In the style of"], c: "Full of" },
        { q: "Which sentence uses 'your' and 'you're' correctly?", a: ["You're going to love your new creature.", "Your going to love you're new creature.", "You're going to love you're new creature.", "Your going to love your new creature."], c: "You're going to love your new creature." },
        { q: "What is the purpose of a paragraph?", a: ["To group related sentences", "To make the text longer", "To end a chapter", "To introduce a character"], c: "To group related sentences" },
        { q: "The word 'autobiography' means the story of a person's life written by...", a: ["Themselves", "Someone else", "A historian", "A journalist"], c: "Themselves" },
        { q: "What part of speech is 'happily' in 'She skipped happily'?", a: ["Adverb", "Verb", "Adjective", "Noun"], c: "Adverb" },
        { q: "An 'antonym' is a word that has the ___ meaning.", a: ["opposite", "same", "similar", "related"], c: "opposite" },
        { q: "Which is spelled correctly?", a: ["Mischievous", "Mischevious", "Mischievious", "Mischeivous"], c: "Mischievous" },
        { q: "A 'symbol' in literature is an object that...", a: ["Represents a larger idea", "Is described in great detail", "Is a main part of the plot", "Talks to the characters"], c: "Represents a larger idea" },
        { q: "What is a 'conjunction'?", a: ["A word that connects words or phrases", "A descriptive word", "A person, place, or thing", "A word of action"], c: "A word that connects words or phrases" },
        { q: "Which of the following is a coordinating conjunction?", a: ["but", "because", "although", "while"], c: "but" },
        { q: "The end of the story where the conflict is resolved is the...", a: ["Resolution", "Climax", "Exposition", "Rising Action"], c: "Resolution" },
        { q: "A 'first-person' narrator uses which pronouns?", a: ["I, me, my", "He, she, they", "You, your", "It, its"], c: "I, me, my" },
        { q: "Which is the correct spelling?", a: ["Privilege", "Privelege", "Privilage", "Priviledge"], c: "Privilege" },
        { q: "The use of 'and' or 'but' to join two simple sentences creates a...", a: ["Compound sentence", "Complex sentence", "Simple sentence", "Fragment"], c: "Compound sentence" },
        { q: "What is the antonym of 'expand'?", a: ["Contract", "Grow", "Widen", "Stretch"], c: "Contract" },
        { q: "The reason an author writes something is their...", a: ["Purpose", "Audience", "Genre", "Format"], c: "Purpose" },
        { q: "'Bam!' and 'Swoosh!' are examples of...", a: ["Onomatopoeia", "Alliteration", "Assonance", "Simile"], c: "Onomatopoeia" },
        { q: "What is the superlative form of 'good'?", a: ["best", "better", "gooder", "goodest"], c: "best" },
        { q: "Choose the correct word: 'I have ___ homework to do.'", a: ["too much", "to much", "two much", "twoo much"], c: "too much" },
        { q: "A story passed down through generations is often called...", a: ["Folklore", "A novel", "A biography", "An essay"], c: "Folklore" },
        { q: "What is a 'rhyme scheme'?", a: ["The pattern of rhymes in a poem", "A type of stanza", "The rhythm of a poem", "A poem with no rhymes"], c: "The pattern of rhymes in a poem" },
        { q: "Which is spelled correctly?", a: ["Rhythm", "Rythm", "Rhythim", "Rhythem"], c: "Rhythm" },
        { q: "A 'dramatic monologue' is a speech by...", a: ["One character to a silent audience", "Two characters to each other", "The narrator of a story", "A group of characters"], c: "One character to a silent audience" },
        { q: "The dictionary definition of a word is its...", a: ["Denotation", "Connotation", "Etymology", "Context"], c: "Denotation" },
        { q: "The feeling or idea a word suggests is its...", a: ["Connotation", "Denotation", "Syllable", "Pronunciation"], c: "Connotation" },
        { q: "What is an 'oxymoron'?", a: ["A figure of speech with contradictory terms", "An extreme exaggeration", "A reference to another work", "A funny comparison"], c: "A figure of speech with contradictory terms" },
        { q: "Which of these is an oxymoron?", a: ["Jumbo shrimp", "Huge mouse", "Brave lion", "Fast turtle"], c: "Jumbo shrimp" },
        { q: "What is the plural of 'cactus'?", a: ["cacti", "cactuses", "cactus", "cactuss"], c: "cacti" },
        { q: "Which is spelled correctly?", a: ["Conscientious", "Conciencious", "Consentious", "Conscentious"], c: "Conscientious" },
        { q: "The repetition of vowel sounds in nearby words is...", a: ["Assonance", "Alliteration", "Consonance", "Rhyme"], c: "Assonance" },
        { q: "What is a 'euphemism'?", a: ["A mild phrase used for a harsh one", "A word that sounds like its meaning", "A long and boring speech", "A logical fallacy"], c: "A mild phrase used for a harsh one" },
        { q: "What is the comparative form of 'bad'?", a: ["worse", "badder", "more bad", "worst"], c: "worse" },
        { q: "The main point of a non-fiction text is the...", a: ["Central Idea", "Theme", "Plot", "Conclusion"], c: "Central Idea" },
        { q: "Which sentence is punctuated correctly?", a: ["Let's eat, Grandma.", "Lets eat Grandma.", "Let's eat Grandma.", "Lets eat, Grandma."], c: "Let's eat, Grandma." },
        { q: "A word that imitates a sound is an...", a: ["Onomatopoeia", "Adjective", "Interjection", "Pronoun"], c: "Onomatopoeia" },
        { q: "In 'To Kill a Mockingbird', who is the narrator?", a: ["Scout", "Atticus", "Jem", "Boo Radley"], c: "Scout" },
        { q: "What is a 'palindrome'?", a: ["A word read the same forwards and backward", "A word with multiple meanings", "A rhyming couplet", "A type of metaphor"], c: "A word read the same forwards and backward" },
        { q: "Which word is a palindrome?", a: ["level", "word", "grammar", "test"], c: "level" },
        { q: "What is a 'verb tense'?", a: ["It shows the time an action occurred", "It shows who performed an action", "It describes the action", "It modifies the action"], c: "It shows the time an action occurred" },
        { q: "Which is spelled correctly?", a: ["Irresistible", "Irresistable", "Iresistible", "Iresisteble"], c: "Irresistible" },
        { q: "The 'rising action' of a plot is where...", a: ["The conflict builds", "The story concludes", "The characters are introduced", "The conflict is resolved"], c: "The conflict builds" },
        { q: "Choose the correct word: 'The book had a profound ___ on me.'", a: ["effect", "affect", "affects", "effects"], c: "effect" },
        { q: "What is a 'dangling modifier'?", a: ["A descriptive phrase that doesn't modify anything", "A phrase that modifies the wrong word", "A phrase at the end of a sentence", "A very long adjective"], c: "A phrase that modifies the wrong word" },
        { q: "Which is an example of 'dramatic irony'?", a: ["The audience knows something the character doesn't", "A character says the opposite of what they mean", "A fire station burns down", "A character's name reflects their personality"], c: "The audience knows something the character doesn't" },
        { q: "What does the root word 'port' mean, as in 'portable'?", a: ["carry", "see", "hear", "make"], c: "carry" },
        { q: "Which is spelled correctly?", a: ["Millennium", "Millenium", "Milennium", "Milennium"], c: "Millennium" },
        { q: "A 'soliloquy' is a speech where a character speaks their thoughts...", a: ["Aloud, when they are alone", "To another character", "Directly to the audience", "In a song"], c: "Aloud, when they are alone" },
        { q: "The opposite of 'protagonist' is...", a: ["Antagonist", "Deuteragonist", "Tritagonist", "Narrator"], c: "Antagonist" },
        { q: "What should be used to separate two independent clauses in a sentence?", a: ["Semicolon", "Comma", "Hyphen", "Apostrophe"], c: "Semicolon" },
        { q: "Which sentence uses a semicolon correctly?", a: ["I like grammar; it's fun.", "I like grammar; and it's fun.", "I like; grammar it's fun.", "I like grammar,; it's fun."], c: "I like grammar; it's fun." },
        { q: "The word 'unbelievable' has how many morphemes?", a: ["3 (un-believe-able)", "1", "2", "4"], c: "3 (un-believe-able)" },
        { q: "What is the study of word origins called?", a: ["Etymology", "Entomology", "Ecology", "Epistemology"], c: "Etymology" },
        { q: "Which is spelled correctly?", a: ["Occurrence", "Occurence", "Ocurrence", "Occurrance"], c: "Occurrence" },
        { q: "A 'thesis statement' is found in an...", a: ["Essay", "Poem", "Short story", "Play"], c: "Essay" },
        { q: "The phrase 'I've told you a million times' is an example of...", a: ["Hyperbole", "Understatement", "Irony", "Paradox"], c: "Hyperbole" },
        { q: "What is the function of a 'colon' (:)?", a: ["To introduce a list or explanation", "To show possession", "To separate two related sentences", "To create a long pause"], c: "To introduce a list or explanation" },
        { q: "A 'complex sentence' contains...", a: ["An independent and a dependent clause", "Two independent clauses", "Only one clause", "Two dependent clauses"], c: "An independent and a dependent clause" },
        { q: "What is an 'epiphany' in literature?", a: ["A character's sudden realization", "The end of the story", "A conversation between two characters", "A recurring symbol"], c: "A character's sudden realization" }
    ];
    let currentBattle = null;

    const sprites = {
        player: '👨‍🎤', mom: '👩', professor: '👨‍🏫', rival: '😒', friend: '😊', villager: '🧔', villager2: '👱‍♀️', hiker: '🥾', poeFan: '🧛', nurse: '👩‍⚕️', shopkeep: '🏪', gymLeader: '🏆', chef: '👨‍🍳',
        poet: '✒️', computer: '💻', bookworm: '🐛', sign: '🪧', lightbulb: '💡', boat: '⛵️', boulder: '🪨', pilot: '👨‍✈️',
        pokeball: '🔴', tree: '🌳', door: '🚪', bed: '🛏️', tv: '📺', bookshelf: '📚', table: '🍽️', dictionary: '📖', palmTree: '🌴',
        gate: '🚧', stairsUp: '⬆️', ladder: '🪜', flower: '🌼', graduate: '🧑‍🎓', hole: '⚫️', goblin: '👺', ranger: '🤠', bait: '🍎',
        synonymouse: '🐭', thesaurusrex: '🦖', wordworm: '🐛', grammargoyle: '👹', simileslime: '💧', commaleon: '🦎', adjectlizard: '🐊',
        haikuna: '🕊️', metaphorpillar: '🦋', hyperbole: '🐂', pronounprowler: '🐆', verbviper: '🐍', lexiconstruct: '🗿', antonymph: '🧚',
        nomenowl: '🦉', rhymoceros: '🦏', adjectoad: '🐸', stalagmight: '⛰️', conjungull: '🐦', allegator: '🐊', alliteration: '🐉', fablion: '🦁', mythical: '🦄', penguin: '🐧', irony: '🎭',
        buzzword: '🐝', droneme: '🤖', omen: '👻', racecar: '🏎️', gerundile: '🛹', infinotaur: '🐃', dramask: '🎭', catalist: '🐈', 'chainreaction': '🐅'
    };

    const drawSprite = (spriteKey, x, y, walkOffset = 0) => { 
        ctx.font = `${tileSize * 0.8}px serif`; 
        ctx.textAlign = 'center'; 
        ctx.textBaseline = 'middle'; 
        ctx.fillText(sprites[spriteKey], x * tileSize + tileSize / 2, y * tileSize + tileSize / 2 + walkOffset); 
    };

    const maps = {
        playerRoom: { layout: [[1,1,1,1,1,1,1,1],[1,22,22,22,22,22,22,1],[1,11,0,0,10,0,9,1],[1,0,0,0,0,0,0,1],[1,22,22,0,0,22,22,1],[1,1,1,2,2,1,1,1]], objects: { '4,2': { sprite: 'bed', interaction: handleBedInteraction }, '6,2': { sprite: 'tv', interaction: "'The course of true love never did run smooth.' It's 'A Midsummer Night's Dream.'" }, '1,2': { interaction: "You see strange creatures hopping in the tall grass." }, '3,5': { target: 'playerHouse', x: 4, y: 5 }, '4,5': { target: 'playerHouse', x: 4, y: 5 } } },
        playerHouse: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,13,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,23,0,0,23,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,1': { sprite: 'bookshelf', interaction: "It's an old children's book. 'The Language of the World.' It says that all living things were born from words spoken at the beginning of time. It mentions creatures made of pure ideas." }, '1,3': { sprite: 'mom', interaction: () => gameState.playerParty.length > 0 ? "Be careful out there!" : "Hurry, dear! Professor Lexicon is waiting." }, '2,3': { sprite: 'dictionary', interaction: "Onomatopoeia: (n.) the formation of a word from a sound associated with what is named (e.g., cuckoo, sizzle)." }, '3,6': { target: 'village', x: 10, y: 9 }, '4,6': { target: 'village', x: 10, y: 9 }, '4,1': { sprite: 'stairsUp', target: 'playerRoom', x: 4, y: 4 }, '6,1': { sprite: 'computer', interaction: handlePCInteraction } } },
        village: { 
            layout: [
                [8,8,8,8,8,8,0,0,0,8,8,8,8,8,8,8],
                [8,7,7,7,7,7,0,0,0,7,7,7,7,7,7,8],
                [8,7,6,4,6,7,0,0,0,7,6,4,6,7,7,8],
                [8,7,3,5,3,7,0,0,0,7,3,5,3,7,7,8],
                [8,7,3,2,3,7,0,0,0,7,3,2,3,7,7,8],
                [8,7,7,0,0,0,0,0,0,0,0,0,0,7,7,8],
                [8,7,7,7,6,4,6,7,7,6,4,6,0,7,7,8],
                [8,7,7,7,3,5,3,7,7,3,5,3,0,7,7,8],
                [8,7,7,7,3,2,3,0,0,3,2,3,0,7,7,8],
                [8,7,7,7,7,0,0,0,0,0,0,0,0,7,7,8],
                [8,7,16,7,7,0,0,0,0,0,0,0,0,16,7,8],
                [8,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8],
                [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8]
            ],
            objects: {
                '3,4': { target: 'rivalsHouse', x: 4, y: 5, symbol: '🏠', symbolOffsetY: -2 },
                '11,4': { target: 'profHouse', x: 4, y: 5, symbol: '🔬', symbolOffsetY: -2 },
                '5,8': { target: 'villagerHouse1', x: 4, y: 5, symbol: '🏠', symbolOffsetY: -2 },
                '10,8': { target: 'playerHouse', x: 4, y: 5, symbol: '🏠', symbolOffsetY: -2 },
                '2,9': { sprite: 'villager', interaction: "Lowering an opponent's stats can be more effective than a direct attack!" },
                '7,0': { sprite: 'gate', interaction: handleGateInteraction },
                '8,0': { sprite: 'gate', interaction: handleGateInteraction },
                '10,10': { sprite: 'sign', interaction: 'Village of Beginnings' },
                '7,12': { target: 'homeBay', x: 7, y: 1 },
                '8,12': { target: 'homeBay', x: 8, y: 1 },
                '4,5': { interaction: handleHoleEntrance }
            },
            encounters: []
        },
        profHouse: { layout: [[1,1,1,1,1,1,1,1],[1,12,0,0,0,0,12,1],[1,0,0,0,0,0,0,1],[1,0,15,0,15,0,15,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '4,2': { sprite: 'professor', interaction: handleProfessorInteraction }, '2,3': { sprite: 'pokeball', interaction: "It's an empty Word Ball case." }, '4,3': { sprite: 'pokeball', interaction: "It's an empty Word Ball case." }, '6,3': { sprite: 'pokeball', interaction: "It's an empty Word Ball case." }, '3,5': { target: 'village', x: 11, y: 5 }, '4,5': { target: 'village', x: 11, y: 5 } } },
        rivalsHouse: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'mom', interaction: "My son, Andy, is already out training. He's so eager!" }, '6,2': { sprite: 'table', interaction: "A textbook on 'Advanced Antonyms' is left open." }, '4,1': { sprite: 'stairsUp', target: 'rivalsRoom', x: 4, y: 4 }, '3,5': { target: 'village', x: 3, y: 5 }, '4,5': { target: 'village', x: 3, y: 5 } } },
        rivalsRoom: {
            layout: [
                [1,1,1,1,1,1,1,1],
                [1,22,22,22,22,22,22,1],
                [1,11,0,0,10,0,9,1],
                [1,0,0,0,0,0,0,1],
                [1,22,22,0,0,22,22,1],
                [1,1,1,2,2,1,1,1]
            ],
            objects: {
                '6,2': { sprite: 'tv', interaction: "The screen shows a creepy doll shop. A girl who looks just like one of the dolls touches it, and her soul is sucked inside, trapping her forever. The doll is then placed in the window, awaiting its next victim. It gives you chills." },
                '4,2': { sprite: 'bed', interaction: "Your rival's bed. It's surprisingly neat." },
                '1,2': { sprite: 'rival', interaction: handleFinalRivalBattle },
                '3,5': { target: 'rivalsHouse', x: 4, y: 1 },
                '4,5': { target: 'rivalsHouse', x: 4, y: 1 }
            }
        },
        route1: { 
            layout: [ 
                [8,8,8,7,7,0,0,0,0,7,7,8,8,8,8,8], 
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8], 
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8], 
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8], 
                [8,8,8,7,7,0,0,0,0,7,7,8,8,8,8,8], 
                [8,8,8,8,8,0,0,0,0,8,8,8,8,8,8,8] 
            ], 
            objects: { 
                '2,2': { sprite: 'hiker', interaction: () => handleTrainerBattle('hikerTom') }, 
                '13,2': { sprite: 'villager', interaction: () => handleTrainerBattle('readerSue') },
                '5,5': { target: 'village', x: 7, y: 1 }, '6,5': { target: 'village', x: 8, y: 1 }, 
                '5,0': { target: 'lexingtonCity', x: 7, y: 13 }, '6,0': { target: 'lexingtonCity', x: 8, y: 13 }, 
                '7,0': { target: 'lexingtonCity', x: 7, y: 13 }, '8,0': { target: 'lexingtonCity', x: 8, y: 13 }, 
                '8,4': { sprite: 'sign', interaction: 'Route 1' },
                '1,1': { sprite: 'pokeball', interaction: () => handleFoundItem('route1Lolly', 'lexiconLollies', 'Lexicon Lolly') }
            }, 
            encounters: ['Wordworm', 'SimileSlime', 'Nomenowl', 'Fablion'] 
        },
        lexingtonCity: { 
            layout: [ 
                [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8], 
                [8,0,16,0,6,19,19,6,0,6,21,21,6,0,16,8], 
                [8,0,4,4,3,18,18,3,0,3,20,20,3,0,4,8], 
                [8,0,3,3,3,18,18,3,0,3,20,20,3,0,3,8], 
                [8,0,2,0,3,2,5,3,0,3,2,5,3,0,2,8], 
                [8,0,16,0,6,19,19,6,0,6,21,21,6,0,16,8], 
                [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8], 
                [8,0,4,4,0,0,0,0,0,0,0,0,4,4,0,8], 
                [8,0,3,3,0,0,0,0,0,0,0,0,3,3,0,8], 
                [8,0,2,0,0,0,0,0,0,0,0,0,0,2,0,8], 
                [8,0,16,0,0,0,0,0,0,0,0,0,0,16,0,8], 
                [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8], 
                [8,0,16,0,0,16,0,0,0,16,0,0,16,0,0,8], 
                [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8] 
            ], 
            objects: { 
                '2,4': { symbol: '❤️', symbolOffsetY: -2 }, '2,5': { target: 'pokecenter', x: 4, y: 5 }, 
                '5,4': { symbol: '🛒', symbolOffsetY: -2 }, '5,5': { target: 'shop', x: 4, y: 5 }, 
                '10,4': { symbol: '🏆', symbolOffsetY: -2 }, '10,5': { target: 'gym', x: 4, y: 5 }, 
                '13,4': { symbol: '🏠', symbolOffsetY: -2 }, '13,5': { target: 'cityHouse1', x: 4, y: 5 }, 
                '2,9': { symbol: '🏠', symbolOffsetY: -2 }, '2,10': { target: 'cityHouse2', x: 4, y: 5 }, 
                '13,9': { symbol: '🏠', symbolOffsetY: -2 }, '13,10': { target: 'cityHouse3', x: 4, y: 5 },
                '3,1': { sprite: 'poeFan', interaction: handlePoeInteraction }, 
                '1,10': { sprite: 'poet', interaction: handlePoetInteraction },
                '7,0': { sprite: 'gate', interaction: handleNorthGate }, '8,0': { sprite: 'gate', interaction: handleNorthGate },
                '7,13': { target: 'route1', x: 7, y: 0 }, 
                '8,13': { target: 'route1', x: 8, y: 0 },
                '9,12': { sprite: 'sign', interaction: 'Lexington City' }
            } 
        },
        pokecenter: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'nurse', interaction: handleNurseInteraction }, '1,2': { sprite: 'computer', interaction: handlePCInteraction }, '2,2': { sprite: 'synonymouse', interaction: "A healthy-looking Synonymouse is resting here." }, '3,5': { target: 'lexingtonCity', x: 2, y: 5 }, '4,5': { target: 'lexingtonCity', x: 2, y: 5 } } },
        shop: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'shopkeep', interaction: handleShopInteraction }, '3,5': { target: 'lexingtonCity', x: 5, y: 5 }, '4,5': { target: 'lexingtonCity', x: 5, y: 5 } } },
        gym: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '4,1': { sprite: 'gymLeader', interaction: handleGymLeaderInteraction }, '3,5': { target: 'lexingtonCity', x: 10, y: 5 }, '4,5': { target: 'lexingtonCity', x: 10, y: 5 } } },
        cityHouse1: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,13,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '2,3': { sprite: 'villager', interaction: "The gym leader here, Rhonda, loves rhymes. A well-constructed couplet might impress her!" }, '3,5': { target: 'lexingtonCity', x: 13, y: 5 }, '4,5': { target: 'lexingtonCity', x: 13, y: 5 } } },
        cityHouse2: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,13,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '2,3': { sprite: 'villager2', interaction: "She looks out the window. 'The waves are so restless today... I hope my sailor returns from the sea soon.'" }, '3,5': { target: 'lexingtonCity', x: 2, y: 10 }, '4,5': { target: 'lexingtonCity', x: 2, y: 10 } } },
        cityHouse3: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,13,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '2,3': { sprite: 'rival', interaction: handleDeathMasheenInteraction }, '3,5': { target: 'lexingtonCity', x: 13, y: 10 }, '4,5': { target: 'lexingtonCity', x: 13, y: 10 } } },
        villagerHouse1: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,1': { sprite: 'bookshelf', interaction: "A collection of poetry. 'The road not taken...' seems well-read." }, '1,3': { sprite: 'villager', interaction: "So many young trainers starting their journey." }, '3,3': { sprite: 'table', interaction: "A half-eaten plate of grammar-ham crackers." }, '3,5': { target: 'village', x: 5, y: 9 }, '4,5': { target: 'village', x: 5, y: 9 } } },
        route2: {
            layout: [
                [8,8,8,7,7,0,0,0,0,7,7,8,8,8,8,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,8,8,8,8,0,0,0,0,8,8,8,8,8,8,8]
            ],
            objects: {
                '7,13': { target: 'lexingtonCity', x: 7, y: 0 },
                '8,13': { target: 'lexingtonCity', x: 8, y: 0 },
                '7,0': { target: 'adjectiveWoods', x: 7, y: 13 },
                '8,0': { target: 'adjectiveWoods', x: 8, y: 13 },
                '2,7': { sprite: 'bookworm', interaction: () => handleTrainerBattle('bookwormBarry') },
                '9,12': { sprite: 'sign', interaction: 'Route 2 - Path to the Woods' }
            },
            encounters: ['PronounProwler', 'VerbViper', 'Rhymoceros', 'Haiku-na']
        },
        adjectiveWoods: {
            layout: [
                [8,8,8,8,8,8,0,0,0,8,8,8,8,8,8,8],
                [8,0,8,7,7,7,7,8,8,8,8,7,7,7,8,8],
                [8,0,8,7,8,8,8,8,7,7,7,7,8,7,7,8],
                [8,0,0,0,8,7,7,0,0,0,8,8,8,7,8,8],
                [8,8,8,0,8,7,8,8,8,0,8,7,7,7,7,8],
                [8,7,7,0,0,0,0,0,8,0,8,7,8,8,8,8],
                [8,7,8,8,8,8,8,0,8,0,8,7,7,7,0,8],
                [8,7,7,0,0,0,8,0,8,0,8,8,8,8,0,8],
                [8,8,8,8,8,0,8,0,8,0,7,7,7,7,7,8],
                [8,7,7,7,8,0,8,0,8,8,8,8,8,8,8,8],
                [8,7,8,7,8,0,8,0,0,0,0,0,0,0,7,8],
                [8,7,8,7,8,0,8,8,8,8,8,8,8,0,7,8],
                [8,7,8,7,7,0,0,0,0,0,0,0,8,0,7,8],
                [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8]
            ],
            objects: {
                '7,13': { target: 'route2', x: 7, y: 0 },
                '8,13': { target: 'route2', x: 8, y: 0 },
                '1,2': { sprite: 'villager2', interaction: () => handleTrainerBattle('artistAdeline') },
                '8,0': { target: 'synonymCity', x: 8, y: 13 },
                '7,0': { target: 'synonymCity', x: 7, y: 13 },
                '9,12': { sprite: 'sign', interaction: 'Adjective Woods - Watch your descriptions!' },
                '14,8': { sprite: 'lightbulb', interaction: handleLHItem },
                '14,7': { sprite: 'pokeball', interaction: () => handleFoundItem('adjectiveWoodsLolly', 'lexiconLollies', 'Lexicon Lolly') }
            },
            encounters: ['Metaphorpillar', 'PronounProwler', 'Adjectoad', 'Adjectlizard']
        },
        synonymCity: {
            layout: [
                [8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],
                [8,0,0,0,0,6,19,19,6,0,0,0,0,0,0,8],
                [8,0,0,0,0,3,18,18,3,0,0,0,0,0,0,8],
                [8,0,0,0,0,3,2,2,3,0,0,0,0,0,0,8],
                [8,0,16,0,0,0,0,0,0,6,21,21,6,0,16,8],
                [8,0,4,4,3,18,18,3,0,3,20,20,3,0,4,8],
                [8,0,3,3,3,18,18,3,0,3,20,20,3,0,3,8],
                [8,0,2,0,3,2,5,3,0,3,2,5,3,0,2,8],
                [8,0,16,0,0,0,0,0,0,0,0,0,0,16,0,8],
                [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
                [8,0,19,19,0,16,0,0,0,16,0,0,16,0,0,8],
                [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
                [8,3,2,2,3,16,0,0,0,16,0,0,16,0,0,8],
                [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8]
            ],
            objects: {
                '2,7': { symbol: '🍴', symbolOffsetY: -2 }, '2,8': { target: 'restaurant', x: 4, y: 5 },
                '5,7': { symbol: '🛒', symbolOffsetY: -2 }, '5,8': { target: 'synonymCityShop', x: 4, y: 5 }, 
                '10,7': { symbol: '❤️', symbolOffsetY: -2 }, '10,8': { target: 'synonymCityCenter', x: 4, y: 5 }, 
                '14,10': { sprite: 'bookworm', interaction: "Synonym City is famous for its library, the largest in the region!" },
                '7,13': { target: 'adjectiveWoods', x: 7, y: 0 },
                '8,13': { target: 'adjectiveWoods', x: 8, y: 0 },
                '9,12': { sprite: 'sign', interaction: 'Synonym City - The City of Similar Words' },
                '7,2': { symbol: '🏆', symbolOffsetY: -2 }, 
                '6,3': { target: 'synonymCityGym', x: 4, y: 5 },
                '7,3': { target: 'synonymCityGym', x: 4, y: 5 },
                '1,10': { symbol: '📚', symbolOffsetY: -2 },
                '2,12': { target: 'library', x: 4, y: 5 },
                '3,12': { target: 'library', x: 4, y: 5 },
                '14,12': { sprite: 'pokeball', interaction: () => handleFoundItem('synonymCityLolly', 'lexiconLollies', 'Lexicon Lolly') }
            }
        },
        synonymCityGym: {
            layout: [[1,1,1,1,1,1,1,1],[1,12,0,0,0,0,12,1],[1,0,0,0,0,0,0,1],[1,12,0,0,0,0,12,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]],
            objects: {
                '4,1': { sprite: 'gymLeader', interaction: handleSynonymGymLeaderInteraction },
                '2,1': { sprite: 'bookshelf', interaction: "Books on advanced synonyms and etymology." },
                '6,1': { sprite: 'bookshelf', interaction: "A complete collection of Roget's Thesaurus." },
                '3,5': { target: 'synonymCity', x: 6, y: 3 },
                '4,5': { target: 'synonymCity', x: 7, y: 3 }
            }
        },
        synonymCityCenter: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'nurse', interaction: handleNurseInteraction }, '1,2': { sprite: 'computer', interaction: handlePCInteraction }, '3,5': { target: 'synonymCity', x: 10, y: 8 }, '4,5': { target: 'synonymCity', x: 10, y: 8 } } },
        synonymCityShop: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'shopkeep', interaction: handleShopInteraction }, '3,5': { target: 'synonymCity', x: 5, y: 8 }, '4,5': { target: 'synonymCity', x: 5, y: 8 } } },
        library: {
            layout: [
                [1,1,1,1,1,1,1,1],
                [1,12,0,12,0,12,0,1],
                [1,0,0,0,0,0,0,1],
                [1,12,0,0,0,0,12,1],
                [1,0,0,0,0,0,0,1],
                [1,1,1,2,2,1,1,1]
            ],
            objects: {
                '4,2': { sprite: 'professor', interaction: ["Dr Powers: Shh! I'm on the verge of a scientific breakthrough!"] },
                '1,1': { sprite: 'bookshelf', interaction: "From 'A Natural History of ELA': 'The creatures of this land are not flesh and bone... They are linguistic constructs, given form by a powerful, unseen energy that resonates with the concepts they embody.'" },
                '3,1': { sprite: 'bookshelf', interaction: "'On the Goblins': '...these crude beings lack sophisticated language. They communicate in grunts and snarls. It is theorized they resent the structured nature of our world and seek to return it to a state of pre-linguistic chaos.'" },
                '5,1': { sprite: 'bookshelf', interaction: "A forbidden text, 'The Un-Spelling.' It speaks of a 'Syntactic Core' at the world's center. 'To shatter the Core,' it reads, 'is to shatter meaning itself. The recent seismic activity is a worrying omen...'" },
                '1,3': { sprite: 'bookshelf', interaction: "'The Evolution of Ideas': '...as a Synonymouse gains experience, its understanding of language deepens. This conceptual growth triggers its physical evolution into a Syntar, a being that can manipulate the very rules of grammar.'" },
                '6,3': { sprite: 'bookshelf', interaction: "'The Legendary Golems': 'Ancient texts speak of two beings, Lexiconstruct and Antonymph, who act as guardians of the Syntactic Core. They are living language, embodying the principles of definition and opposition.'" },
                '2,3': { sprite: 'bookshelf', interaction: "'A Hero With A Thousand Faces' - it's a classic." },
                '3,5': { target: 'synonymCity', x: 2, y: 12 },
                '4,5': { target: 'synonymCity', x: 3, y: 12 }
            }
        },
        restaurant: {
            layout: [[1,1,1,1,1,1,1,1],[1,0,13,0,13,0,0,1],[1,0,0,0,0,0,0,1],[1,13,0,0,0,13,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]],
            objects: {
                '2,2': { sprite: 'chef', interaction: handleChefInteraction },
                '1,3': { sprite: 'table' },
                '5,3': { sprite: 'table' },
                '3,5': { target: 'synonymCity', x: 2, y: 8 },
                '4,5': { target: 'synonymCity', x: 2, y: 8 }
            }
        },
        homeBay: {
            layout: [
                [24,24,24,24,24,24,24,0,0,24,24,24,24,24,24,24],
                [23,23,23,23,23,24,24,0,0,24,24,23,23,23,23,23],
                [24,24,24,24,24,24,24,2,2,24,24,24,24,24,24,24],
                [24,24,24,24,24,24,24,2,2,24,24,24,24,24,24,24],
                [24,24,24,24,24,24,24,2,2,24,24,24,24,24,24,24],
                [24,24,24,24,24,24,2,2,2,2,2,2,2,24,24,24],
                [24,24,24,24,24,24,2,24,24,24,24,2,24,24,24,24],
                [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],
                [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],
                [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],
            ],
            objects: {
                '7,0': { target: 'village', x: 7, y: 12 },
                '8,0': { target: 'village', x: 8, y: 12 },
                '10,1': { sprite: 'sign', interaction: 'Village Bay' },
                '11,5': { sprite: 'boat', interaction: "It's the captain's boat. Looks like it's seen many voyages." },
                '9,5': { sprite: 'villager', interaction: handleCaptainInteraction },
            }
        },
        caveLevel1: {
            layout: [
                [27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27],
                [27,28,28,28,27,28,28,28,28,28,28,28,28,28,28,27],
                [27,28,27,28,27,28,27,27,27,27,27,27,27,27,28,27],
                [27,28,27,28,28,28,28,28,28,28,28,28,28,27,28,27],
                [27,28,27,27,27,27,27,28,27,27,27,27,28,27,28,27],
                [27,28,28,28,28,28,27,28,27,28,28,28,28,28,28,27],
                [27,27,27,27,27,28,27,28,27,28,27,27,27,27,27,27],
                [27,28,28,28,27,28,27,28,28,28,28,28,28,28,28,27],
                [27,28,27,28,27,28,27,27,27,27,27,28,27,27,28,27],
                [27,28,27,28,28,28,28,28,28,28,27,28,28,28,28,27],
                [27,28,27,27,27,27,27,27,27,28,27,27,27,27,28,27],
                [27,28,28,28,28,28,28,28,28,28,28,28,28,27,28,27],
                [27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27],
            ],
            objects: {
                '2,2': { sprite: 'ladder', target: 'village', x: 4, y: 7 },
                '4,8': { sprite: 'hiker', interaction: () => handleTrainerBattle('caveExplorerDon') },
                '10,2': { sprite: 'goblin', interaction: () => handleTrainerBattle('goblinBoss') },
                '14,2': { sprite: 'boulder', interaction: handleBoulderInteraction },
                '14,3': { sprite: 'lexiconstruct', interaction: handleLegendaryBattle },
                '1,11': { sprite: 'pokeball', interaction: () => handleFoundItem('cave1GreatPhrase', 'greatphrases', 'Great Phrase') }
            },
            encounters: ['Grammargoyle', 'VerbViper', 'Stalagmight']
        },
        desertedIsland: {
            layout: [
                [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],
                [24,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24],
                [24,23,29,29,23,29,29,23,23,29,29,23,29,29,23,24],
                [24,23,29,23,23,23,29,23,23,29,23,23,23,29,23,24],
                [24,23,23,23,29,23,23,23,23,23,23,29,23,23,23,24],
                [24,23,29,23,23,23,29,23,23,29,23,23,23,29,23,24],
                [24,23,29,29,23,29,29,23,23,29,29,23,29,29,23,24],
                [24,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24],
                [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],
            ],
            objects: {
                '8,4': { sprite: 'rival', interaction: ["Andy: We're... alive. Unbelievable.", "We have to work together to figure out where we are. And how to get off this island."] },
                '13,2': { sprite: 'pilot', interaction: () => handleTrainerBattle('shipwreckedPilot') },
                '1,7': { sprite: 'pokeball', interaction: () => handleFoundItem('islandLolly', 'lexiconLollies', 'Lexicon Lolly') }
            },
            encounters: ['Hyper-bole', 'PronounProwler', 'Conjun-gull']
        },
        finalCave: {
            layout: [
                [27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27],
                [27,28,28,28,28,28,28,28,28,28,28,28,28,28,28,27],
                [27,28,27,27,27,28,27,27,27,27,27,27,27,27,28,27],
                [27,28,27,28,28,28,28,28,28,28,28,28,28,27,28,27],
                [27,28,28,28,27,27,27,27,27,27,27,27,28,27,28,27],
                [27,27,27,28,27,28,28,28,28,28,28,28,28,28,28,27],
                [27,28,28,28,27,28,27,27,27,27,27,28,27,27,27,27],
                [27,28,27,27,27,28,27,28,28,28,27,28,28,28,28,27],
                [27,28,28,28,28,28,27,28,27,28,27,27,27,27,28,27],
                [27,27,27,27,27,27,27,28,27,28,28,28,28,28,28,27],
                [27,28,28,28,28,28,28,28,27,27,27,27,27,27,28,27],
                [27,28,27,27,27,27,27,27,27,28,28,28,28,28,28,27],
                [27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27],
            ],
            objects: {
                '14,11': { sprite: 'ladder', target: 'village', x: 7, y: 9 }, // Exit ladder
                '8,2': { sprite: 'goblin', interaction: startFinalBattle },
                '7,2': { sprite: 'goblin', interaction: startFinalBattle },
                '1,6': { sprite: 'pokeball', interaction: () => handleFoundItem('finalCaveUltraSentence', 'ultrasentences', 'Ultra Sentence') }
            }
        }
    };
    
    const tileTypes = { 0: { color: '#d3d3d3' }, 1: { color: '#605040', solid: true }, 2: { color: '#c0a080' }, 3: { color: '#D2B48C', solid: true }, 4: { color: '#B22222', solid: true }, 5: { color: '#87CEEB', solid: true }, 6: { color: '#8B4513', solid: true }, 7: { color: '#38a169', isTallGrass: true }, 8: { color: '#2f855a', solid: true }, 9: { color: '#c0a080', solid: true }, 10: { color: '#333333', solid: true }, 11: { color: '#a0e0f0', isWindow: true }, 12: { color: '#806040', solid: true }, 13: { color: '#f0d0b0', solid: true }, 14: { color: '#4a5568', solid: true }, 15: { color: '#e2e8f0', solid: true }, 16: { color: '#FFD700' }, 18: { color: '#F5F5DC', solid: true }, 19: { color: '#4169E1', solid: true }, 20: { color: '#708090', solid: true }, 21: { color: '#2F4F4F', solid: true }, 22: { color: '#deb887'}, 23: { color: '#f5f5dc'}, 24: { color: '#4682B4', solid: true }, 25: { color: '#4a5568', solid: true }, 26: { color: '#2d3748' }, 27: { color: '#4a2a0c', solid: true }, 28: { color: '#8b5a2b' }, 29: { color: '#228B22', isTallGrass: true } };

    function getTile(map, x, y) { if (y >= 0 && y < map.layout.length && x >= 0 && x < map.layout[y].length) return map.layout[y][x]; return -1; }

    function gameLoop() { 
        if (gameState.activeScene !== 'title') {
            draw(); 
        }
        requestAnimationFrame(gameLoop); 
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const mapData = maps[gameState.currentMap];
        if (!mapData) return;
        const offsetX = -gameState.player.x * tileSize + canvas.width / 2;
        const offsetY = -gameState.player.y * tileSize + canvas.height / 2;
        ctx.save();
        ctx.translate(offsetX, offsetY);
        for (let y = 0; y < mapData.layout.length; y++) {
            for (let x = 0; x < mapData.layout[y].length; x++) {
                const tileId = mapData.layout[y][x];
                const tile = tileTypes[tileId];
                if (tile) { 
                    ctx.fillStyle = tile.color; 
                    ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize); 
                    if (tile.isWindow) {
                        ctx.fillStyle = '#a0e0f0';
                        ctx.fillRect(x * tileSize + 4, y * tileSize + 4, tileSize - 8, tileSize - 8);
                        ctx.fillStyle = '#605040';
                        ctx.fillRect(x * tileSize + tileSize/2 - 2, y * tileSize, 4, tileSize);
                        ctx.fillRect(x * tileSize, y * tileSize + tileSize/2 - 2, tileSize, 4);
                    }
                }
                if(tileId === 8) drawSprite('tree', x, y);
                if(tileId === 16) drawSprite('flower', x, y);
                 if (mapData.encounters && (mapData.encounters.includes('Hyper-bole') || mapData.encounters.includes('PronounProwler')) && tileId === 29) {
                     drawSprite('palmTree', x, y);
                }
            }
        }
        for (const key in mapData.objects) {
            const [x, y] = key.split(',').map(Number);
            const obj = mapData.objects[key];
            if (obj.sprite) drawSprite(obj.sprite, x, y);
            if (obj.symbol) {
                ctx.font = `${tileSize * 0.9}px serif`;
                const offsetY = obj.symbolOffsetY || -2;
                ctx.fillText(obj.symbol, x * tileSize + tileSize / 2, (y + offsetY) * tileSize + tileSize/2);
            }
        }
        if(gameState.currentMap === 'village' && gameState.earthquake1Triggered) {
             drawSprite('hole', 4, 5);
        }

        const walkBob = Math.sin(gameState.player.walkFrame / 2) * 2;
        drawSprite(gameState.player.sprite, gameState.player.x, gameState.player.y, walkBob);
        ctx.restore();

        // Darkness Effect
        if ((gameState.currentMap === 'caveLevel1' || gameState.currentMap === 'finalCave') && gameState.inventory.LH01LuminousHyperbole === 0) {
            const playerCanvasX = canvas.width / 2;
            const playerCanvasY = canvas.height / 2;
            
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.rect(0, 0, canvas.width, canvas.height);
            ctx.arc(playerCanvasX, playerCanvasY, tileSize * 2, 0, Math.PI * 2, true);
            ctx.fill();
        }
    }

    function handleConfirmAction() {
        if (gameState.inDialogue && choicesBox.children.length === 0) {
            advanceDialogue();
        } else if (!gameState.activeScene && !gameState.inBattle && !gameState.inDialogue) {
            checkForInteraction();
        }
    }

    function handleCancelAction() {
        if (gameState.activeScene) {
            closeAllMenus();
        } else if (gameState.inDialogue) {
            dialogueQueue = []; // Clear the queue
            const cb = dialogueCallback;
            gameState.inDialogue = false;
            messageText.textContent = '';
            dialogueCallback = null;
        }
    }


    function handleInput(key) {
        // Universal cancel action
        if (key === 'b' || key === 'x' || key === 'Backspace' || key === 'Escape') {
            handleCancelAction();
            return;
        }

        // Universal confirm action
        if (key === 'a' || key === 'z' || key === 'Enter') {
            handleConfirmAction();
            return;
        }
        
        // Block movement during any UI state
        if (gameState.inDialogue || gameState.inBattle || gameState.activeScene) return;

        // Handle movement
        let {x, y} = gameState.player;
        switch(key) {
            case 'ArrowUp': y--; break;
            case 'ArrowDown': y++; break;
            case 'ArrowLeft': x--; break;
            case 'ArrowRight': x++; break;
            case 'm': toggleMenu(); return;
        }
        movePlayer(x,y);
    }
    
    // Canvas click for dev mode toggle
    canvas.addEventListener('click', (event) => {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;

        const canvasX = (event.clientX - rect.left) * scaleX;
        const canvasY = (event.clientY - rect.top) * scaleY;

        const offsetX = -gameState.player.x * tileSize + canvas.width / 2;
        const offsetY = -gameState.player.y * tileSize + canvas.height / 2;

        const mapX = Math.floor((canvasX - offsetX) / tileSize);
        const mapY = Math.floor((canvasY - offsetY) / tileSize);
        
        // Original dev mode toggle
        if (gameState.currentMap === 'village' && mapX === 0 && mapY === 0) {
            toggleDevMode();
        }

        // Earthquake dev trigger in Synonym City Gym
        if (gameState.currentMap === 'synonymCityGym' && mapX === 0 && mapY === 0) {
            triggerEarthquake();
        }
        
        // Cave boss dev trigger
        if (gameState.currentMap === 'caveLevel1' && mapX === 0 && mapY === 0 && gameState.devModeActive) {
            if (gameState.inventory.boatPart === 0) {
                gameState.inventory.boatPart = 1;
                if(!gameState.defeatedTrainers.includes('goblinBoss')) {
                    gameState.defeatedTrainers.push('goblinBoss');
                }
                startDialogue("Dev Trigger: Obtained the Engine Cog!");
            } else {
                startDialogue("You already have the Engine Cog.");
            }
        }
        
        // Island boss dev trigger
        if (gameState.currentMap === 'desertedIsland' && mapX === 0 && mapY === 0 && gameState.devModeActive) {
            if (gameState.inventory.LH02LyricalHightail === 0) {
                gameState.inventory.LH02LyricalHightail = 1;
                if(!gameState.defeatedTrainers.includes('shipwreckedPilot')) {
                    gameState.defeatedTrainers.push('shipwreckedPilot');
                }
                startDialogue(["Dev Trigger: Obtained LH02 Lyrical Hightail!"], () => {
                    changeMap('village', 10, 10);
                    startDialogue("You use the pilot's plane to fly home.");
                });
            } else {
                startDialogue("You already have LH02 Lyrical Hightail.");
            }
        }
    });

    function toggleDevMode() {
        gameState.devModeActive = !gameState.devModeActive;
        if (gameState.devModeActive) {
            startDialogue("Dev Mode Activated! Event barriers are unlocked.");
        } else {
            startDialogue("Dev Mode Deactivated. Barriers restored to normal.");
        }
    }

    window.addEventListener('keydown', (e) => {
        let key = e.key;
        if(key === 'z') key = 'a';
        if(key === 'x' || e.key === 'Backspace') key = 'b';
        handleInput(key)
    });

    // Touch Controls Setup
    const setupTouchButton = (id, key) => {
        const button = document.getElementById(id);
        if (button) button.addEventListener('click', () => handleInput(key));
    };

    // Movement
    setupTouchButton('touch-up', 'ArrowUp');
    setupTouchButton('touch-down', 'ArrowDown');
    setupTouchButton('touch-left', 'ArrowLeft');
    setupTouchButton('touch-right', 'ArrowRight');
    setupTouchButton('touch-up-lg', 'ArrowUp');
    setupTouchButton('touch-down-lg', 'ArrowDown');
    setupTouchButton('touch-left-lg', 'ArrowLeft');
    setupTouchButton('touch-right-lg', 'ArrowRight');

    // Actions
    setupTouchButton('touch-a', 'a');
    setupTouchButton('touch-a-lg', 'a');
    setupTouchButton('touch-b', 'b');
    setupTouchButton('touch-b-lg', 'b');
    
    document.getElementById('menu-btn').addEventListener('click', toggleMenu);
    
    messageBox.addEventListener('click', (e) => {
        if (e.target.closest('#choices-box')) return;
        if (gameState.inDialogue && !gameState.inBattle) {
            advanceDialogue();
        }
    });
    
    battleBox.addEventListener('click', (e) => { 
        if (e.target.closest('#battle-grid')) return;
        if (gameState.inDialogue && gameState.inBattle) {
            advanceBattleDialogue();
        }
    });

    function movePlayer(newX, newY) {
        if (gameState.inDialogue || gameState.inBattle || gameState.activeScene) return;
        const map = maps[gameState.currentMap];
        if (!map) return;
        
        const object = map.objects[`${newX},${newY}`];

        // This collision check now runs for everyone, dev mode or not.
        if (object && object.interaction) {
            const res = typeof object.interaction === 'function' ? object.interaction() : object.interaction;
            if (res) startDialogue(res);
            return;
        }

        // Check for target transition first
        if (object && object.target) {
            changeMap(object.target, object.x, object.y);
            return;
        }

        // Now check map boundaries
        if (newY < 0 || newY >= map.layout.length || newX < 0 || newX >= map.layout[0].length) {
            return;
        }

        const tileId = getTile(map, newX, newY);
        const tile = tileTypes[tileId];

        // Standard collision
        if (tile.solid || (object && object.sprite)) {
            return;
        }
        
        // If we've reached this point, movement is allowed.
        gameState.player.x = newX; 
        gameState.player.y = newY;
        gameState.player.walkFrame = (gameState.player.walkFrame + 1) % 100; // Animate walk
        
        // Trigger wild battle
        if (tile.isTallGrass && gameState.playerParty.length > 0 && Math.random() < 0.2) {
            startWildBattle();
        }
    }

    function changeMap(mapName, newX, newY) { 
        gameState.currentMap = mapName; 
        gameState.player.x = newX;
        gameState.player.y = newY; 

        if (!gameState.discoveredLocations.includes(mapName)) {
            gameState.discoveredLocations.push(mapName);
        }
        
        // Check for final battle trigger when returning home
        if (mapName === 'village' && gameState.defeatedTrainers.includes('shipwreckedPilot') && !gameState.finalBossDefeated) {
            triggerFinalBattleScene();
        }
        saveGame();
    }

    let dialogueQueue = [], dialogueCallback = null;
    function startDialogue(messages, onComplete = null) {
        dialogueQueue = Array.isArray(messages) ? [...messages] : [messages];
        dialogueCallback = onComplete; gameState.inDialogue = true;
        messageText.textContent = dialogueQueue.shift() || ''; choicesBox.innerHTML = '';
    }
    function advanceDialogue() {
        if (dialogueQueue.length > 0) { messageText.textContent = dialogueQueue.shift(); } 
        else { const cb = dialogueCallback; gameState.inDialogue = false; messageText.textContent = ''; dialogueCallback = null; if (cb) cb(); }
    }
    function showChoices(prompt, choices) {
        gameState.inDialogue = true; 
        messageText.textContent = prompt; 
        choicesBox.innerHTML = '';
        choices.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = 'w-full p-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-xl border-2 border-blue-700 shadow-md';
            btn.textContent = choice.text; 
            btn.onclick = (e) => { 
                e.stopPropagation();
                choicesBox.innerHTML = ''; 
                if (choice.callback) choice.callback(); 
            };
            choicesBox.appendChild(btn);
        });
    }

    function handleFoundItem(itemId, inventoryKey, itemName) {
        if (gameState.foundItems.includes(itemId)) {
            return "It's an empty item ball.";
        }
        gameState.inventory[inventoryKey]++;
        gameState.foundItems.push(itemId);
        saveGame();
        return `You found a ${itemName}!`;
    }

    function checkForInteraction() {
        const { x, y } = gameState.player, dirs = [[0,-1], [0,1], [-1,0], [1,0]];
        for (const [dx, dy] of dirs) {
            const key = `${x + dx},${y + dy}`;
            const obj = maps[gameState.currentMap].objects[key];
            const tileId = getTile(maps[gameState.currentMap], x + dx, y + dy);
            const tile = tileTypes[tileId];

            if (obj && obj.interaction) { 
                const res = typeof obj.interaction === 'function' ? obj.interaction() : obj.interaction; 
                if (res) startDialogue(res); 
                return;
            }
             if (tile && tile.isWindow) {
                 const windowObj = Object.values(maps[gameState.currentMap].objects).find(o => o.x === (x+dx) && o.y === (y+dy));
                 if(windowObj && windowObj.interaction) {
                    startDialogue(windowObj.interaction());
                 } else {
                    startDialogue("You look out the window.");
                 }
                return;
            }
        }
    }
    
    function openScene(sceneElement) { closeAllMenus(true); gameState.activeScene = sceneElement.id; sceneElement.classList.remove('hidden'); }
    function closeAllMenus(silent = false) { 
        [menuScene, inventoryScene, pokemonStatsScene, pokedexScene, pcScene, mapScene, journalScene].forEach(s => s.classList.add('hidden')); 
        if (!silent) {
            gameState.activeScene = null;
            saveGame();
        }
    }
    function toggleMenu() { if(gameState.activeScene === 'menu-scene') closeAllMenus(); else openScene(menuScene); }
    
    document.getElementById('menu-close-btn').onclick = () => closeAllMenus();
    document.getElementById('menu-inventory-btn').onclick = () => { updateInventoryUI(); openScene(inventoryScene); };
    document.getElementById('menu-pokemon-btn').onclick = () => { updatePokemonStatsUI(); openScene(pokemonStatsScene); };
    document.getElementById('menu-pokedex-btn').onclick = () => { updatePokedexUI(); openScene(pokedexScene); };
    document.getElementById('menu-map-btn').onclick = () => { updateWorldMapUI(); openScene(mapScene); };
    document.getElementById('menu-journal-btn').onclick = () => { updateJournalUI(); openScene(journalScene); };
    document.getElementById('menu-save-btn').onclick = () => {
        saveGame();
        closeAllMenus();
        startDialogue("Your game has been saved!");
    };
    document.getElementById('menu-new-game-btn').onclick = () => {
        closeAllMenus();
        showChoices("Start a new game? All saved progress will be lost!", [
            { text: "Yes, start over", callback: () => {
                localStorage.removeItem('elaQuestSaveData');
                window.location.reload();
            }},
            { text: "No, cancel", callback: () => {
                gameState.inDialogue = false;
                messageText.textContent = '';
            }}
        ]);
    };
    
    // Explicitly set back button functionality for each scene
    document.getElementById('inventory-scene').querySelector('.ui-back-btn').onclick = () => openScene(menuScene);
    document.getElementById('pokemon-stats-scene').querySelector('.ui-back-btn').onclick = () => openScene(menuScene);
    document.getElementById('pokedex-scene').querySelector('.ui-back-btn').onclick = () => openScene(menuScene);
    document.getElementById('map-scene').querySelector('.ui-back-btn').onclick = () => openScene(menuScene);
    document.getElementById('journal-scene').querySelector('.ui-back-btn').onclick = () => openScene(menuScene);

    document.getElementById('pc-close-btn').onclick = () => closeAllMenus();


    function updateInventoryUI() {
        document.getElementById('inventory-money').textContent = `$${gameState.money}`;
        const items = document.getElementById('inventory-items'); items.innerHTML = '';
        const createItem = (key, count) => {
            if(count > 0){
                const itemData = itemsDB[key];
                const div = document.createElement('div'); div.className = 'grid grid-cols-3 gap-2 items-center text-xl';
                div.innerHTML = `<span class="col-span-2">${itemData.name} x${count}</span>`;
                const btn = document.createElement('button'); btn.className = 'p-2 bg-blue-500 text-white rounded-lg'; btn.textContent = 'Check';
                btn.onclick = () => startDialogue(itemData.description);
                div.appendChild(btn);
                items.appendChild(div);
            }
        };
        Object.keys(gameState.inventory).forEach(key => createItem(key, gameState.inventory[key]));

        if(items.innerHTML === '') items.innerHTML = '<p class="text-xl text-center">No items.</p>';
    }

    function getTypeBadges(types) {
        return types.map(t => `<span class="type-badge type-${t}">${t}</span>`).join('');
    }

    function updatePokemonStatsUI() {
        const content = document.getElementById('pokemon-stats-content');
        if (gameState.playerParty.length === 0) { 
            content.innerHTML = '<h2 class="text-2xl text-center">You have no Creatures!</h2>'; 
            return; 
        }

        content.innerHTML = '<h2 class="text-3xl text-center mb-4">Your Party</h2>';
        const partyGrid = document.createElement('div');
        partyGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
        
        gameState.playerParty.forEach(p => {
            const card = document.createElement('div');
            card.className = 'p-4 border rounded-lg border-gray-400';
            card.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="text-6xl">${sprites[p.sprite]}</div>
                    <div>
                        <h3 class="text-2xl flex items-center">${p.name} <span class="text-xl text-gray-500 ml-2">Lvl ${p.level}</span></h3>
                        <div>${getTypeBadges(p.types)}</div>
                        <p class="text-lg mt-2">HP: ${Math.ceil(p.currentHp)} / ${p.maxHp}</p>
                        <div class="w-full bg-gray-300 rounded-full h-4 my-1"><div class="bg-green-500 h-full rounded-full" style="width: ${p.currentHp/p.maxHp*100}%"></div></div>
                    </div>
                </div>
            `;
            partyGrid.appendChild(card);
        });

        content.appendChild(partyGrid);
    }
    
    function updatePokedexUI() {
        const entries = document.getElementById('pokedex-entries'); entries.innerHTML = '';
        const seenSpecies = Object.keys(gameState.pokedex).sort();
        if (seenSpecies.length === 0) { entries.innerHTML = '<p class="text-xl text-center">No data yet. Encounter creatures to add them!</p>'; return; }
        
        seenSpecies.forEach(species => {
            const entry = gameState.pokedex[species];
            const speciesData = pokemonDB[species];
            const entryDiv = document.createElement('div'); entryDiv.className = 'p-2 border rounded border-gray-400 grid grid-cols-4 gap-2 items-center';
            const caughtIcon = entry.caught ? sprites.pokeball : '○';
            entryDiv.innerHTML = ` <div class="text-5xl text-center">${sprites[speciesData ? speciesData.sprite : species.toLowerCase()]}</div> <div class="col-span-3"> <h3 class="text-2xl flex items-center">${species} ${caughtIcon}</h3> <div>${getTypeBadges(speciesData.types)}</div> <p class="text-sm mt-1">${pokedexData[species]}</p> </div> `;
            entries.appendChild(entryDiv);
        });
    }
    
    const worldMapLayout = [
        [null, null, 'synonymCity', null, null],
        [null, null, 'adjectiveWoods', null, null],
        [null, null, 'route2', null, null],
        ['desertedIsland', null, 'lexingtonCity', null, null],
        [null, null, 'route1', null, null],
        [null, 'homeBay', 'village', 'caveLevel1', null],
    ];

    function updateWorldMapUI() {
        const grid = document.getElementById('world-map-grid');
        grid.innerHTML = '';
        grid.style.gridTemplateRows = `repeat(${worldMapLayout.length}, minmax(0, 1fr))`;

        worldMapLayout.forEach(row => {
            row.forEach(cellId => {
                const cell = document.createElement('div');
                cell.className = 'map-cell';
                if (cellId && gameState.discoveredLocations.includes(cellId)) {
                    cell.classList.add('map-cell-discovered');
                    let displayName = cellId.replace(/([A-Z])/g, ' $1').replace(/(\d)/g, ' $1').trim();
                    displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
                    cell.textContent = displayName;

                    if (gameState.currentMap === cellId) {
                        cell.classList.add('map-cell-player');
                    }
                } else {
                    cell.classList.add('map-cell-undiscovered');
                    if (cellId) {
                       cell.textContent = '???';
                    }
                }
                grid.appendChild(cell);
            });
        });
    }

    function updateJournalUI() {
        const entriesContainer = document.getElementById('journal-entries');
        entriesContainer.innerHTML = '';

        const activeQuests = [];
        const completedQuests = [];

        for (const questId in gameState.quests) {
            const status = gameState.quests[questId];
            if (status !== 'notStarted') {
                const questInfo = questDB[questId];
                if (questInfo) {
                    if (status === 'completed') {
                        completedQuests.push(questInfo.completed);
                    } else if (questInfo[status]) {
                        activeQuests.push(questInfo[status]);
                    }
                }
            }
        }
        
        let html = '';
        if (activeQuests.length > 0) {
            html += '<h3 class="text-2xl text-yellow-700 border-b-2 border-yellow-700 mb-2">Active Quests</h3>';
            html += '<ul class="list-disc list-inside space-y-2">';
            activeQuests.forEach(desc => { html += `<li>${desc}</li>`; });
            html += '</ul>';
        }

        if (completedQuests.length > 0) {
            html += '<h3 class="text-2xl text-green-700 border-b-2 border-green-700 mt-4 mb-2">Completed Quests</h3>';
            html += '<ul class="list-disc list-inside space-y-2 text-gray-500">';
            completedQuests.forEach(desc => { html += `<li>${desc}</li>`; });
            html += '</ul>';
        }

        if (html === '') {
            html = '<p class="text-xl text-center">No active quests. Explore the world to find new adventures!</p>';
        }

        entriesContainer.innerHTML = html;
    }

    function handlePoetInteraction() {
        if (gameState.quests.poetInspiration === 'completed') {
            return "Thank you again. My mind is overflowing with verses!";
        }

        const hasHaikuna = gameState.playerParty.some(p => p.species === 'Haiku-na');

        if (gameState.quests.poetInspiration === 'started' && hasHaikuna) {
            startDialogue([
                "Poet: Is that... a Haiku-na? Its form... so perfect!",
                "Five syllables... then seven... then five once more...",
                "Oh, inspiration flows! Thank you, young wordsmith!",
                "Please, take this for your troubles."
            ], () => {
                gameState.quests.poetInspiration = 'completed';
                gameState.inventory.greatphrases += 1;
                gameState.money += 200;
                saveGame();
                startDialogue("You received a Great Phrase and $200!");
            });
            return null;
        }

        if (gameState.quests.poetInspiration === 'started') {
            return "Please, find me a Haiku-na. The sight of one would be a symphony to my soul.";
        }

        showChoices("Poet: Alas, my muse has fled! I long to see a living poem... a Haiku-na! If only I could see one, my inspiration would surely return! Will you help me?", [
            {
                text: "Yes",
                callback: () => {
                    gameState.quests.poetInspiration = 'started';
                    saveGame();
                    startDialogue("Poet: Oh, thank you! I shall await the day you return with that graceful creature.");
                }
            },
            {
                text: "No",
                callback: () => {
                    startDialogue("Poet: *sigh* I understand. Art cannot be rushed.");
                }
            }
        ]);
        return null;
    }

    function handleChefInteraction() {
        if (gameState.quests.chefsMenu === 'completed') {
            return "Chef: The customers love the new menu! It's all thanks to you!";
        }

        const hasAdjectlizard = gameState.playerParty.some(p => p.species === 'Adjectlizard');

        if (gameState.quests.chefsMenu === 'started' && hasAdjectlizard) {
            startDialogue([
                "Chef: Magnifique! An Adjectlizard! Look at its descriptive colors, its detailed scales!",
                "It's... it's... magnificent! Scaly! Colorful! It's perfect!",
                "Now I know what to write! 'A *magnificent*, *scaly* sea bass with *colorful* vegetables!'",
                "You have saved my restaurant! Please, take this for your help."
            ], () => {
                gameState.quests.chefsMenu = 'completed';
                gameState.inventory.lexiconLollies += 3;
                gameState.money += 300;
                saveGame();
                startDialogue("You received 3 Lexicon Lollies and $300!");
            });
            return null;
        }

        if (gameState.quests.chefsMenu === 'started') {
            return "Chef: My menu... so bland. Please, I need to see an Adjectlizard to get some descriptive words!";
        }

        showChoices("Chef: Mon dieu! My menu is a disaster! 'Good soup', 'Nice steak'... it's so... boring! I need powerful adjectives! A creature that embodies description... like an Adjectlizard! Could you show me one?", [
            {
                text: "Oui, chef!",
                callback: () => {
                    gameState.quests.chefsMenu = 'started';
                    saveGame();
                    startDialogue("Chef: Merci! I will be waiting with bated breath!");
                }
            },
            {
                text: "Non.",
                callback: () => {
                    startDialogue("Chef: *Sigh* The world will never know the true beauty of my cooking.");
                }
            }
        ]);
        return null;
    }

    function handleBedInteraction() { if (gameState.playerParty.length > 0) { gameState.playerParty.forEach(p => p.currentHp = p.maxHp); return ["You took a short nap.", "Your team is fully healed!"]; } return "A comfy bed."; }
    
    function handleProfessorInteraction() {
        if (gameState.playerParty.length > 0) {
            return "Now that you have a partner, a great adventure begins! Go on, get out there!";
        }
        startDialogue([
            "Ah, you're here! I'm Professor Lexicon.",
            "Your rival, Andy, and the other trainers were early and took the first pickings...",
            "But I saved one special creature just for you!",
            "It's a Synonymouse! Please, take good care of it.",
        ], () => {
            const newPokemon = createPokemon("Synonymouse", 5);
            addPokemonToParty(newPokemon);
            saveGame();
            startDialogue([
                "You got a SYNONYMOUSE!",
                "Synonymouse was added to your party."
            ]);
        });
        return null;
    }

    function handleGateInteraction() {
        if (gameState.devModeActive || gameState.rivalDefeated) {
             changeMap('route1', 7, 4);
             return null;
        }
        if (gameState.playerParty.length === 0) return "The gate is locked tight.";
        if (gameState.inBattle || gameState.inDialogue) return;
        startDialogue([ "Andy: 'Hold it right there!'", "'I've been studying! I challenge you to a battle!'" ], () => startBattle([createPokemon('Grammargoyle', 7)], 'Andy'));
        return null;
    }

    function handleHoleEntrance() {
        if (gameState.earthquake1Triggered) {
            changeMap('caveLevel1', 2, 2);
            return null;
        }
        return null; // No interaction before earthquake
    }
    
    function handleBoulderInteraction() {
        if (gameState.earthquake2Triggered && !pokemonDB['Lexiconstruct'].caught) {
            maps.caveLevel1.layout[3][14] = 28; // Make boulder passable
            return "The boulder crumbles away!";
        } else if (pokemonDB['Lexiconstruct'].caught) {
            return "The path to the legendary is clear."
        }
        return "A massive boulder blocks the path. It won't budge.";
    }

    function handleLegendaryBattle() {
        if(gameState.pokedex['Lexiconstruct']?.caught) {
            return "The pedestal is empty. The legendary creature is gone."
        }
        startDialogue(["A huge stone creature stirs...", "It's the Legendary LEXICONSTRUCT!"], () => {
            startBattle([createPokemon('Lexiconstruct', 70)], "Wild Lexiconstruct");
        });
        return null;
    }
    
    function handleFinalRivalBattle() {
        if (!gameState.pokedex['Lexiconstruct']?.caught) {
            return "Andy: 'Whoa, you caught it! Amazing! I need to get stronger before I can challenge you again.'";
        }
        if (gameState.defeatedTrainers.includes('finalRival')) {
            return "Andy: 'That was the best battle of my life. Thanks, friend.'";
        }
        startDialogue(trainersDB.finalRival.preBattle, () => {
             startBattle(trainersDB.finalRival.pokemon.map(p => createPokemon(p.species, p.level)), trainersDB.finalRival.name, 'finalRival');
        });
        return null;
    }


    function handleCaptainInteraction() {
        if (gameState.inventory.boatPart > 0) {
            gameState.inventory.boatPart = 0;
            const captainObject = maps.homeBay.objects['9,5'];
            captainObject.interaction = startSailingSequence;
            saveGame();
            return ["Arr, what's this? This is the exact Engine Cog I need for me engine! You found it!", "Give me a moment...", "All fixed! We can set sail whenever you're ready! (Talk to me again to leave)."];
        }
        if (gameState.defeatedTrainers.includes('goblinBoss') && gameState.inventory.boatPart === 0) {
            startSailingSequence();
            return null;
        }

        return "Arr, my boat's engine is sputtering. It's out of order right now. But I have a feeling it will be important later... that's called foreshadowing.";
    }
    
    function startSailingSequence() {
        startDialogue(["Captain: All aboard!"], () => {
            startDialogue(["You set sail on the open sea...", "The water is calm and the sky is clear."], () => {
                setTimeout(() => {
                    startDialogue(["Suddenly, the sea begins to churn! Another earthquake!"], () => {
                        shakeScreen(3000);
                        setTimeout(() => {
                            gameState.earthquake2Triggered = true;
                            startDialogue(["A colossal wave crashes over the boat!", "Everything goes black..."], () => {
                                gameState.playerParty.forEach(p => { if (p.currentHp > 1) p.currentHp = Math.ceil(p.currentHp / 4); });
                                changeMap('desertedIsland', 3, 7);
                                startDialogue("You wake up on a sandy beach, your creatures weak...");
                            });
                        }, 3000);
                    });
                }, 2000);
            });
        });
        return null;
    }


    function handleNurseInteraction() { 
        if(gameState.playerParty.length > 0) { 
            gameState.playerParty.forEach(p => p.currentHp = p.maxHp); 
            saveGame();
            return "Your team has been restored to full health!"; 
        } 
        return "Welcome to the Word Center!"; 
    }
    
    function confirmPurchase(itemName, price, description, onConfirm) {
        showChoices(`${itemName}: ${description} It costs $${price}. Buy it?`, [
            { text: "Yes", callback: () => {
                if (gameState.money >= price) {
                    gameState.money -= price;
                    onConfirm();
                    saveGame();
                    startDialogue(`You bought one ${itemName}.`, () => handleShopInteraction());
                } else {
                    startDialogue("Sorry, you don't have enough money.", () => handleShopInteraction());
                }
            }},
            { text: "No", callback: () => handleShopInteraction() }
        ]);
    }

    function handleShopInteraction() {
        showChoices("Welcome! What can I get for you?", [
            { text: "Potion", callback: () => confirmPurchase("Potion", 25, itemsDB.potions.description, () => gameState.inventory.potions++) },
            { text: "Word Ball", callback: () => confirmPurchase("Word Ball", 50, itemsDB.wordballs.description, () => gameState.inventory.wordballs++) },
            { text: "Great Phrase", callback: () => confirmPurchase("Great Phrase", 200, itemsDB.greatphrases.description, () => gameState.inventory.greatphrases++) },
            { text: "Ultra Sentence", callback: () => confirmPurchase("Ultra Sentence", 500, itemsDB.ultrasentences.description, () => gameState.inventory.ultrasentences++) },
            { text: "Leave", callback: () => startDialogue("Come again!") }
        ]); return null;
    }

    const poeQuotes = [ "Quoth the Raven, 'Nevermore.'", "All that we see or seem is but a dream within a dream.", "The boundaries which divide Life from Death are at best shadowy and vague.", "I was never really insane except upon occasions when my heart was touched.", "Words have no power to impress the mind without the exquisite horror of their reality.", "To be buried alive is, beyond question, the most terrific of these extremes which has ever fallen to the lot of mere mortality.", "I have great faith in fools - self-confidence my friends call it.", "The true genius shudders at incompleteness.", "I became insane, with long intervals of horrible sanity.", "Beauty of whatever kind, in its supreme development, invariably excites the sensitive soul to tears.", "Believe nothing you hear, and only one half that you see.", "The death of a beautiful woman is, unquestionably, the most poetical topic in the world.", "Men have called me mad; but the question is not yet settled.", "That which you mistake for madness is but over-acuteness of the senses.", "From childhood's hour I have not been as others were.", "I have no faith in human perfectibility. I think that human exertion will have no appreciable effect upon humanity.", "Sleep, those little slices of death — how I loathe them.", "The scariest monsters are the ones that lurk within our souls.", "There is no exquisite beauty without some strangeness in the proportion.", "To vilify a great man is the readiest way in which a little man can himself attain greatness." ];
    function handlePoeInteraction() { return poeQuotes[Math.floor(Math.random() * poeQuotes.length)]; }
    
    function handleDeathMasheenInteraction() {
        if (!gameState.hasMetDeathMasheen) {
            startDialogue(
                ["DeathMasheen34: 'Leveled Up Learning is the future!'"],
                () => {
                    gameState.hasMetDeathMasheen = true;
                    const gamerObject = maps.cityHouse3.objects['2,3'];
                    gamerObject.sprite = 'graduate';
                    gamerObject.interaction = "Tom: 'I'm going to be a principal some day. Gamification rules!'";
                }
            );
            return null;
        }
        return "Tom: 'I'm going to be a principal some day. Gamification rules!'";
    }

    function handleGymLeaderInteraction() {
        if (gameState.gymBadges.rhyme) return "You've earned the Rhyme Badge. Continue your journey!";
        if (gameState.playerParty.length === 0) return "You need a partner to challenge a gym!";
        if (gameState.playerParty.length > 0 && gameState.playerParty.every(p => p.level < 10)) return ["My rhymes are tough, my rhythm's tight,", "A level 10 you'll need to fight!"];
        startDialogue(trainersDB.gymLeaderRhonda.preBattle, () => startBattle(trainersDB.gymLeaderRhonda.pokemon.map(p => createPokemon(p.species, p.level)), 'Gym Leader Rhonda', 'gymLeaderRhonda'));
    }

    function handleSynonymGymLeaderInteraction() {
        if (gameState.gymBadges.synonym) return "Your vocabulary is truly vast. Go and continue your quest.";
        if (gameState.playerParty.length === 0) return "You need a partner to challenge a gym!";
        if (gameState.playerParty.length > 0 && gameState.playerParty.every(p => p.level < 25)) return ["My words are weighty, my knowledge deep.", "Return when your team's level has made a leap.", "(Recommended Level: 25+)"];
        startDialogue(trainersDB.gymLeaderLex.preBattle, () => startBattle(trainersDB.gymLeaderLex.pokemon.map(p => createPokemon(p.species, p.level)), 'Gym Leader Lex', 'gymLeaderLex'));
    }

    function handleNorthGate() {
        if (gameState.devModeActive) { changeMap('route2', 7, 13); return null; }
        if(!gameState.gymBadges.rhyme) return "A guard blocks the way. 'Only trainers who have earned the Rhyme Badge may pass!'";
        if(!gameState.rivalDefeatedPostGym) {
            startDialogue(["Andy: 'You got a gym badge? Hah! Just lucky!'", "'Let's see how you handle a REAL battle!'"], () => {
                startBattle([createPokemon('Grammargoyle', 13), createPokemon('CommaLeon', 12)], 'Andy');
            });
            return null;
        }
        changeMap('route2', 7, 13);
        return null;
    }

    function handleTrainerBattle(trainerId) {
        if(gameState.defeatedTrainers.includes(trainerId)) {
            startDialogue(trainersDB[trainerId].postBattle);
            if (trainerId === 'shipwreckedPilot') {
                 startDialogue(["Pilot: It's time for me to go home."], () => {
                    changeMap('village', 10, 10);
                    startDialogue("The pilot drops you off and flies away towards Lexington City.");
                });
            }
            return null;
        }
        startDialogue(trainersDB[trainerId].preBattle, () => {
            const opponentPokemons = trainersDB[trainerId].pokemon.map(p => createPokemon(p.species, p.level));
            startBattle(opponentPokemons, `Trainer ${trainersDB[trainerId].name}`, trainerId);
        });
        return null;
    }

    function handleLHItem() {
        if (gameState.inventory.LH01LuminousHyperbole > 0) {
            return "An empty pedestal. You already took the item here.";
        }
        gameState.inventory.LH01LuminousHyperbole = 1;
        delete maps.adjectiveWoods.objects['14,8'];
        saveGame();
        return [ "You found LH01 (Luminous Hyperbole)!", itemsDB.LH01LuminousHyperbole.description ];
    }
    
    function handlePCInteraction() {
        const choices = [
            { text: "Access Storage", callback: () => {
                gameState.inDialogue = false;
                messageText.textContent = '';
                updatePCUI();
                openScene(pcScene);
            }},
            { text: "Save Game", callback: () => {
                saveGame();
                startDialogue("Game saved successfully!");
            }}
        ];

        if (gameState.teleportUnlocked) {
            choices.push({ text: "Home Warp", callback: () => {
                startDialogue(["You connected to the home network...", "Warping complete!"], () => {
                    changeMap('playerHouse', 4, 4);
                });
            }});
        }

        choices.push({ text: "Cancel", callback: () => {
            gameState.inDialogue = false;
            messageText.textContent = '';
        }});

        showChoices("A PC. What would you like to do?", choices);
        return null;
    }

    function updatePCUI() {
        const partyContainer = document.getElementById('pc-party');
        const boxContainer = document.getElementById('pc-box');
        partyContainer.innerHTML = '';
        boxContainer.innerHTML = '';

        gameState.playerParty.forEach((pokemon, index) => {
            const div = document.createElement('div');
            div.className = 'pc-item p-2 border rounded';
            div.innerHTML = `<span>${sprites[pokemon.sprite]} ${pokemon.name} Lvl ${pokemon.level}</span>`;
            div.onclick = () => moveFromPartyToBox(index);
            partyContainer.appendChild(div);
        });
        gameState.pokemonBox.forEach((pokemon, index) => {
            const div = document.createElement('div');
            div.className = 'pc-item p-2 border rounded';
            div.innerHTML = `<span>${sprites[pokemon.sprite]} ${pokemon.name} Lvl ${pokemon.level}</span>`;
            div.onclick = () => moveFromBoxToParty(index);
            boxContainer.appendChild(div);
        });
    }

    function moveFromPartyToBox(index) {
        if (gameState.playerParty.length <= 1) {
            closeAllMenus(); startDialogue("You can't deposit your last creature!"); return;
        }
        const [movedPokemon] = gameState.playerParty.splice(index, 1);
        gameState.pokemonBox.push(movedPokemon); updatePCUI();
    }

    function moveFromBoxToParty(index) {
        if (gameState.playerParty.length >= 6) {
            closeAllMenus(); startDialogue("Your party is full!"); return;
        }
        const [movedPokemon] = gameState.pokemonBox.splice(index, 1);
        gameState.playerParty.push(movedPokemon); updatePCUI();
    }

    function startBattleDialogue(messages, onComplete = null) {
        dialogueQueue = Array.isArray(messages) ? [...messages] : [messages]; dialogueCallback = onComplete; gameState.inDialogue = true;
        battleText.textContent = dialogueQueue.shift(); battleGrid.innerHTML = '';
    }
    function advanceBattleDialogue() { if (dialogueQueue.length > 0) { battleText.textContent = dialogueQueue.shift(); } else { const cb = dialogueCallback; gameState.inDialogue = false; battleText.textContent = ''; dialogueCallback = null; if (cb) cb(); } }
    
    function startWildBattle() {
        if (gameState.inBattle || gameState.inDialogue || gameState.inReserveMode) return;
        const currentMapData = maps[gameState.currentMap];
        const encounterList = currentMapData.encounters;
        if (!encounterList || encounterList.length === 0) return;

        const species = encounterList[Math.floor(Math.random() * encounterList.length)];
        const level = gameState.currentMap === 'route1' ? Math.floor(Math.random() * 3) + 3 : Math.floor(Math.random() * 3) + 8;
        startDialogue([`A wild ${species} appeared!`], () => startBattle([createPokemon(species, level)], `Wild ${species}`));
    }
    
    function startBattle(opponents, opponentName, trainerId = null) {
        if (gameState.playerParty.length === 0) { startDialogue("You have no creatures to battle with!"); return; }
        gameState.inBattle = true;
        
        const opponentParty = (Array.isArray(opponents) ? opponents : [opponents])
            .map(op => (op.species ? op : createPokemon(op.species, op.level)));
        
        const firstOpponent = opponentParty[0];

        if (!gameState.pokedex[firstOpponent.species]) gameState.pokedex[firstOpponent.species] = { seen: false, caught: false };
        gameState.pokedex[firstOpponent.species].seen = true;
        
        currentBattle = { 
            playerPokemon: gameState.playerParty.find(p => p.currentHp > 0), 
            opponentParty: opponentParty,
            currentOpponentIndex: 0,
            opponentName, 
            trainerId, 
            turn: 'player',
            participants: [gameState.playerParty.findIndex(p => p.currentHp > 0)]
        };
        
        currentBattle.playerPokemon.statMods = { attack: 0, defense: 0 };
        firstOpponent.statMods = { attack: 0, defense: 0 };

        battleScene.classList.remove('hidden');
        updateBattleSprites();
        updateBattleUI(); 
        nextBattleTurn();
    }
    
    async function nextBattleTurn() {
        if (!currentBattle) return;
        const currentOpponent = currentBattle.opponentParty[currentBattle.currentOpponentIndex];

        if (currentBattle.playerPokemon.currentHp <= 0) { await handlePlayerPokemonFaint(); return; }
        if (currentOpponent.currentHp <= 0) { await handleOpponentFaint(); return; }

        if (currentBattle.turn === 'player') {
            showMainBattleMenu();
        } else {
            await new Promise(resolve => setTimeout(resolve, 500));
            const attacker = currentOpponent;
            const target = currentBattle.playerPokemon;
            const atk = attacker.attacks[Math.floor(Math.random()*attacker.attacks.length)];
            
            let messages = [`${currentBattle.opponentName}'s ${attacker.name} used ${atk.name}!`];
            await new Promise(res => startBattleDialogue(messages, res));
            await animateAttack(document.getElementById('opponent-sprite'), document.getElementById('player-sprite'), true);
            
            let result;
            if(atk.power > 0) {
                result = calculateDamage(atk, attacker, target);
                target.currentHp -= result.damage;
                messages = [`${target.name} took ${result.damage} damage!`];
            } else { messages = []; result = { message: '' }; }

            if(result.message) messages.push(result.message);
            messages.push(...applyAttackEffect(atk, attacker, target));

            updateBattleUI();
            startBattleDialogue(messages, () => { currentBattle.turn = 'player'; nextBattleTurn(); });
        }
    }

    async function handleOpponentFaint() {
        const faintedOpponent = currentBattle.opponentParty[currentBattle.currentOpponentIndex];
        await animateFaint(document.getElementById('opponent-sprite'));
        await new Promise(res => startBattleDialogue([`${currentBattle.opponentName}'s ${faintedOpponent.name} fainted!`], res));
        
        currentBattle.currentOpponentIndex++;
        if(currentBattle.currentOpponentIndex < currentBattle.opponentParty.length){
            const newOpponent = currentBattle.opponentParty[currentBattle.currentOpponentIndex];
            newOpponent.statMods = { attack: 0, defense: 0 };
            updateBattleSprites(); updateBattleUI();
            startBattleDialogue([`${currentBattle.opponentName} sent out ${newOpponent.name}!`], () => { currentBattle.turn = 'player'; nextBattleTurn(); });
        } else {
            endBattle();
        }
    }

    async function handlePlayerPokemonFaint() {
        await animateFaint(document.getElementById('player-sprite'));
        await new Promise(res => startBattleDialogue([`${currentBattle.playerPokemon.name} fainted!`], res));
        
        const canSwitch = gameState.playerParty.some(p => p.currentHp > 0);
        if (canSwitch) { showSwitchPokemonMenu(true); } else { endBattle(); }
    }
    
    function animateAttack(attackerEl, targetEl, isOpponent) {
        return new Promise(resolve => {
            attackerEl.classList.add(isOpponent ? 'attack-animation-opponent' : 'attack-animation');
            setTimeout(() => {
                targetEl.classList.add('damage-flash');
                setTimeout(() => {
                    attackerEl.classList.remove(isOpponent ? 'attack-animation-opponent' : 'attack-animation');
                    targetEl.classList.remove('damage-flash');
                    resolve();
                }, 300);
            }, 200);
        });
    }

    function animateFaint(spriteEl) {
        return new Promise(resolve => {
            spriteEl.classList.add('faint-animation');
            setTimeout(() => {
                spriteEl.classList.remove('faint-animation');
                resolve();
            }, 500);
        });
    }


    function showMainBattleMenu() {
        battleText.textContent = `What will ${currentBattle.playerPokemon.name} do?`; battleGrid.innerHTML = '';
        const createBtn = (text, onClick) => {
            const btn = document.createElement('button');
            btn.className = 'p-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg text-lg border-2 border-slate-900';
            btn.textContent = text; btn.onclick = onClick; battleGrid.appendChild(btn);
        };
        createBtn('Fight', playerChooseAttack); createBtn('Item', showItemMenu);
        createBtn('Pokémon', () => showSwitchPokemonMenu(false)); 
        createBtn('Run', () => { 
            if(!currentBattle.trainerId) { startBattleDialogue('Got away safely!', () => endBattle(true)); } 
            else { startBattleDialogue("Can't run from a trainer battle!", showMainBattleMenu); } 
        });
    }

    function showSwitchPokemonMenu(isForced = false) {
        battleText.textContent = "Choose a creature."; battleGrid.innerHTML = '';
        const baseButtonClass = 'p-2 rounded text-lg flex justify-between items-center w-full border-2';
        gameState.playerParty.forEach((pokemon, index) => {
            const button = document.createElement('button');
            button.innerHTML = `<div>${sprites[pokemon.sprite]} ${pokemon.name} Lvl ${pokemon.level}</div><div>${Math.ceil(pokemon.currentHp)}/${pokemon.maxHp} HP</div>`;
            if (pokemon.currentHp <= 0) { 
                button.disabled = true; 
                button.className = `${baseButtonClass} bg-red-800 text-gray-400 opacity-60 border-red-900`; 
            } 
            else if (pokemon === currentBattle.playerPokemon) { 
                button.disabled = true; 
                button.className = `${baseButtonClass} bg-yellow-800 text-white border-yellow-900`; 
            } 
            else { 
                button.className = `${baseButtonClass} bg-slate-700 hover:bg-slate-600 text-white border-slate-900`;
                button.onclick = () => switchPlayerPokemon(index, isForced); 
            }
            battleGrid.appendChild(button);
        });
        if (!isForced) {
            const backBtn = document.createElement('button');
            backBtn.className = 'p-2 bg-yellow-500 hover:bg-yellow-600 text-black rounded-lg text-lg border-2 border-yellow-700';
            backBtn.textContent = 'Back'; backBtn.onclick = showMainBattleMenu; battleGrid.appendChild(backBtn);
        }
    }

    function switchPlayerPokemon(newIndex, isForced = false) {
        const oldPokemon = currentBattle.playerPokemon;
        const newPokemon = gameState.playerParty[newIndex];
        currentBattle.playerPokemon = newPokemon;
        currentBattle.playerPokemon.statMods = { attack: 0, defense: 0 };
        if (!currentBattle.participants.includes(newIndex)) currentBattle.participants.push(newIndex);
        updateBattleUI(); updateBattleSprites();
        if (isForced) { currentBattle.turn = 'player'; startBattleDialogue([`Go, ${newPokemon.name}!`], nextBattleTurn); } 
        else { currentBattle.turn = 'opponent'; startBattleDialogue([`${oldPokemon.name}, come back! Go, ${newPokemon.name}!`], nextBattleTurn); }
    }

    function showItemMenu() {
        battleText.textContent = "Choose an item."; battleGrid.innerHTML = '';
        const createItemButton = (text, onClick, count) => {
            if (count > 0) {
                const button = document.createElement('button');
                button.className = 'p-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg text-lg border-2 border-slate-900';
                button.textContent = text; button.onclick = onClick; battleGrid.appendChild(button);
            }
        };
        createItemButton(`Potion x${gameState.inventory.potions}`, usePotionInBattle, gameState.inventory.potions);
        if (!currentBattle.trainerId) {
            createItemButton(`Word Ball x${gameState.inventory.wordballs}`, () => attemptCatch('wordballs'), gameState.inventory.wordballs);
            createItemButton(`Great Phrase x${gameState.inventory.greatphrases}`, () => attemptCatch('greatphrases'), gameState.inventory.greatphrases);
            createItemButton(`Ultra Sentence x${gameState.inventory.ultrasentences}`, () => attemptCatch('ultrasentences'), gameState.inventory.ultrasentences);
            createItemButton(`Master Thesis x${gameState.inventory.masterthesis}`, () => attemptCatch('masterthesis'), gameState.inventory.masterthesis);
        }
        const backBtn = document.createElement('button');
        backBtn.className = 'p-2 bg-yellow-500 hover:bg-yellow-600 text-black rounded-lg text-lg border-2 border-yellow-700';
        backBtn.textContent = 'Back'; backBtn.onclick = showMainBattleMenu; battleGrid.appendChild(backBtn);
    }

    function usePotionInBattle() {
         if (gameState.inventory.potions > 0 && currentBattle.playerPokemon.currentHp < currentBattle.playerPokemon.maxHp) {
            gameState.inventory.potions--;
            const healAmount = Math.floor(currentBattle.playerPokemon.maxHp * 0.5);
            currentBattle.playerPokemon.currentHp = Math.min(currentBattle.playerPokemon.maxHp, currentBattle.playerPokemon.currentHp + healAmount);
            updateBattleUI(); currentBattle.turn = 'opponent';
            startBattleDialogue([`You used a Potion.`, `${currentBattle.playerPokemon.name} recovered health!`], nextBattleTurn);
        } else {
            startBattleDialogue(currentBattle.playerPokemon.currentHp === currentBattle.playerPokemon.maxHp ? "It won't have any effect!" : "You have no potions!", showMainBattleMenu);
        }
    }

    async function attemptCatch(ballKey) {
        const ball = itemsDB[ballKey];
        const opponent = currentBattle.opponentParty[currentBattle.currentOpponentIndex];

        if (pokemonDB[opponent.species].isLegendary && ballKey !== 'masterthesis') {
            startBattleDialogue(["The ball was deflected! It seems a normal ball won't work..."], () => {
                currentBattle.turn = 'opponent'; nextBattleTurn();
            });
            return;
        }

        if (gameState.inventory[ballKey] <= 0) { startBattleDialogue("You don't have any of those!", showMainBattleMenu); return; }
        gameState.inventory[ballKey]--;
        await new Promise(res => startBattleDialogue(`You threw a ${ball.name}!`, res));
        
        const maxHp = opponent.maxHp, currentHp = opponent.currentHp;
        const catchRate = pokemonDB[opponent.species].catchDifficulty || 45; 
        let a = (((3 * maxHp - 2 * currentHp) * catchRate * ball.bonus) / (3 * maxHp));
        if (ball.bonus === 255) a = 255; // Master ball logic

        const shakeCheck = () => a >= 255 || Math.floor(Math.random() * 256) < a;
        let shakes = 0;
        for (let i = 0; i < 4; i++) {
            if (shakeCheck()) { shakes++; await new Promise(res => setTimeout(res, 750)); if (i < 3) await new Promise(res => startBattleDialogue("...", res)); } 
            else { break; }
        }

        if (shakes === 4) {
            const caughtPokemon = opponent;
            await new Promise(res => startBattleDialogue("Gotcha!", res));
            addPokemonToParty(caughtPokemon);
            await new Promise(res => startBattleDialogue(`${caughtPokemon.name} was caught!`, res));
            if (gameState.playerParty.length <= 6) await new Promise(res => startBattleDialogue(`${caughtPokemon.name} was added to your party.`, res));
            else await new Promise(res => startBattleDialogue(`${caughtPokemon.name} was sent to the PC.`, res));
             // After catching legendary, remove it from the map
            if (pokemonDB[caughtPokemon.species].isLegendary) {
                delete maps.caveLevel1.objects['14,3'];
            }
            endBattle(false, true); 
        } else {
            await new Promise(res => startBattleDialogue("Oh no! The creature broke free!", res));
            currentBattle.turn = 'opponent'; nextBattleTurn();
        }
    }

    async function playerChooseAttack() {
        battleText.textContent = `Choose an attack.`; battleGrid.innerHTML = '';
        currentBattle.playerPokemon.attacks.forEach(attack => {
            const button = document.createElement('button');
            button.className = 'p-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg text-lg border-2 border-slate-900 flex justify-between items-center';
            button.innerHTML = `<span>${attack.name}</span> <span class="type-badge type-${attack.type}">${attack.type}</span>`;
            button.onclick = () => { currentBattle.chosenAttack = attack; presentQuestion(); };
            battleGrid.appendChild(button);
        });
        const backBtn = document.createElement('button');
        backBtn.className = 'p-2 bg-yellow-500 hover:bg-yellow-600 text-black rounded-lg text-lg border-2 border-yellow-700';
        backBtn.textContent = 'Back'; backBtn.onclick = showMainBattleMenu; battleGrid.appendChild(backBtn);
    }
    
    function presentQuestion() {
        const q = elaQuestions[Math.floor(Math.random() * elaQuestions.length)];
        currentBattle.currentQuestion = q;
        battleText.textContent = q.q;
        battleGrid.innerHTML = '';
        [...q.a].sort(() => Math.random() - 0.5).forEach(answer => {
            const btn = document.createElement('button');
            btn.className = 'p-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg text-lg border-2 border-slate-900';
            btn.textContent = answer;
            btn.onclick = () => handleAnswer(answer);
            battleGrid.appendChild(btn);
        });
    }
    
    async function handleAnswer(answer) {
        battleGrid.innerHTML = ''; // Clear answers
        const opponent = currentBattle.opponentParty[currentBattle.currentOpponentIndex];
        let effectivenessMessage = '';

        if (answer === currentBattle.currentQuestion.c) {
            await new Promise(res => startBattleDialogue([`Correct! ${currentBattle.playerPokemon.name} used ${currentBattle.chosenAttack.name}!`], res));
            await animateAttack(document.getElementById('player-sprite'), document.getElementById('opponent-sprite'), false);

            if (currentBattle.chosenAttack.power > 0) {
                const result = calculateDamage(currentBattle.chosenAttack, currentBattle.playerPokemon, opponent);
                opponent.currentHp -= result.damage;
                effectivenessMessage = result.message;
                await new Promise(res => startBattleDialogue([`${currentBattle.opponentName}'s ${opponent.name} took ${result.damage} damage!`], res));
            }

            if (effectivenessMessage) {
                await new Promise(res => startBattleDialogue([effectivenessMessage], res));
            }
            
            const effectMessages = applyAttackEffect(currentBattle.chosenAttack, currentBattle.playerPokemon, opponent);
            if (effectMessages.length > 0) {
                await new Promise(res => startBattleDialogue(effectMessages, res));
            }

        } else {
            await new Promise(res => startBattleDialogue([`Incorrect! ${currentBattle.playerPokemon.name}'s attack missed...`], res));
        }
        updateBattleUI();
        currentBattle.turn = 'opponent';
        nextBattleTurn();
    }

    function calculateDamage(attack, attacker, defender) {
        const attackStat = attacker.attack * (1 + attacker.statMods.attack * 0.25);
        const defenseStat = defender.defense * (1 + defender.statMods.defense * 0.25);
        const baseDamage = attack.power + (attackStat / 2);
        
        let effectiveness = 1;
        let message = '';
        const attackType = attack.type;
        const defenderTypes = defender.types;

        defenderTypes.forEach(defType => {
            if (typeChart[attackType]?.effective.includes(defType)) {
                effectiveness *= 2;
            }
            if (typeChart[attackType]?.ineffective.includes(defType)) {
                effectiveness *= 0.5;
            }
        });

        if (effectiveness > 1) {
            message = "It's super effective!";
        } else if (effectiveness < 1 && effectiveness > 0) {
            message = "It's not very effective...";
        }

        const finalDamage = Math.floor(Math.max(1, baseDamage - (defenseStat / 4)) * effectiveness);

        return { damage: Math.max(1, finalDamage), message };
    }

    function applyAttackEffect(attack, attacker, target) {
        const effectMessages = [];
        if (attack.effect) {
            const targetPokemon = (attack.effect.target === 'opponent') ? target : attacker;
            const targetName = (attack.effect.target === 'opponent') ? 'The opponent\'s' : 'Your';
            if (attack.effect.type === 'stat') {
                const { stat, amount } = attack.effect;
                targetPokemon.statMods[stat] = Math.max(-4, Math.min(4, targetPokemon.statMods[stat] + amount));
                effectMessages.push(`${targetName} ${targetPokemon.name}'s ${stat} ${amount < 0 ? 'fell' : 'rose'}!`);
            }
        }
        return effectMessages;
    }
    
    function updateBattleUI() {
        if (!currentBattle) return;
        const p = currentBattle.playerPokemon;
        const o = currentBattle.opponentParty[currentBattle.currentOpponentIndex];

        document.getElementById('player-hp').style.width = `${Math.max(0,(p.currentHp/p.maxHp)*100)}%`;
        document.getElementById('opponent-hp').style.width = `${Math.max(0,(o.currentHp/o.maxHp)*100)}%`;
        
        const playerNameContainer = document.getElementById('player-name-container');
        playerNameContainer.innerHTML = `<p class="text-2xl">${p.name} Lvl ${p.level}</p>${getTypeBadges(p.types)}`;
        
        const oppNameContainer = document.getElementById('opponent-name-container');
        oppNameContainer.innerHTML = `<p class="text-2xl">${o.name} Lvl ${o.level}</p>${getTypeBadges(o.types)}`;

        document.getElementById('player-hp-text').textContent = `HP: ${Math.ceil(p.currentHp)}/${p.maxHp}`;
    }

    function updateBattleSprites() {
        if (!currentBattle) return;
        document.getElementById('player-sprite').textContent = sprites[currentBattle.playerPokemon.sprite];
        document.getElementById('opponent-sprite').textContent = sprites[currentBattle.opponentParty[currentBattle.currentOpponentIndex].sprite];
    }
    
    async function endBattle(ranAway = false, caught = false) {
        if (!currentBattle && !ranAway) return;
        if (ranAway || caught) { gameState.inBattle = false; battleScene.classList.add('hidden'); currentBattle = null; saveGame(); return; }

        const playerWon = currentBattle.playerPokemon.currentHp > 0;
        const oldBattle = currentBattle; currentBattle = null;

        if (!playerWon) {
            await new Promise(res => startBattleDialogue(["You are out of usable creatures!", "You blacked out..."], res));
            gameState.playerParty.forEach(p => p.currentHp = p.maxHp);
            changeMap('pokecenter', 4, 4);
        } else {
            const money = oldBattle.trainerId ? trainersDB[oldBattle.trainerId].reward : 15;
            let winMsg = [];
            gameState.money += money; 
            if (oldBattle.trainerId) {
                winMsg = [`You defeated ${oldBattle.opponentName}!`, `You won $${money}!`];
                if(!gameState.defeatedTrainers.includes(oldBattle.trainerId)) gameState.defeatedTrainers.push(oldBattle.trainerId);
            } else {
                 winMsg = [`You defeated the wild ${oldBattle.opponentParty[0].name}!`, `You won $${money}!`];
            }
            
            const xpGained = 50 * oldBattle.opponentParty.reduce((sum, p) => sum + p.level, 0) / oldBattle.opponentParty.length;
            const uniqueParticipants = [...new Set(oldBattle.participants)].map(index => gameState.playerParty[index]).filter(p => p.currentHp > 0);
            
            if (uniqueParticipants.length > 0) {
                winMsg.push(`${uniqueParticipants.map(p => p.name).join(' and ')} gained ${Math.floor(xpGained)} XP!`);
            }
             await new Promise(res => startBattleDialogue(winMsg, res)); winMsg = [];

            for (const p of uniqueParticipants) {
                p.xp += xpGained;
                while (p.xp >= p.xpToNextLevel) {
                    p.level++; p.xp -= p.xpToNextLevel; p.xpToNextLevel = Math.floor(p.xpToNextLevel * 1.5);
                    p.maxHp += 5; p.attack += 2; p.defense += 1; p.currentHp = p.maxHp;
                    winMsg.push(`${p.name} grew to level ${p.level}!`);
                    const newMove = pokemonDB[p.species]?.learnset?.find(m => m.level === p.level);
                    if (newMove && p.attacks.length < 4) { p.attacks.push(attacksDB[newMove.move]); winMsg.push(`${p.name} learned ${newMove.move}!`); }
                }
            }
            if (winMsg.length > 0) await new Promise(res => startBattleDialogue(winMsg, res)); winMsg = [];

            for (let i = 0; i < gameState.playerParty.length; i++) {
                const p = gameState.playerParty[i];
                const speciesData = pokemonDB[p.species];
                if (speciesData && speciesData.evolvesAt && p.level >= speciesData.evolvesAt && !p.hasEvolved) {
                    await new Promise(res => startBattleDialogue([`What? ${p.name} is evolving!`], res));
                    const oldName = p.name; const newSpecies = speciesData.evolvesTo;
                    const newPokemon = createPokemon(newSpecies, p.level); newPokemon.xp = p.xp; newPokemon.hasEvolved = true;
                    gameState.playerParty[i] = newPokemon;
                    await new Promise(res => startBattleDialogue([`Congratulations! Your ${oldName} evolved into ${newSpecies}!`], res));
                }
            }

            if (oldBattle.trainerId === 'gymLeaderRhonda' && !gameState.gymBadges.rhyme) {
                gameState.gymBadges.rhyme = true; winMsg.push("You received the Rhyme Badge!");
            }
            if (oldBattle.trainerId === 'gymLeaderLex' && !gameState.gymBadges.synonym) {
                gameState.gymBadges.synonym = true; winMsg.push("You received the Synonym Badge!");
                await new Promise(res => startBattleDialogue(winMsg, res));
                triggerEarthquake(); return;
            }
            if (oldBattle.trainerId === 'goblinBoss') {
                winMsg.push("The Goblin dropped a strange metal object...");
                gameState.inventory.boatPart = 1;
            }
             if (oldBattle.trainerId === 'shipwreckedPilot') {
                winMsg.push("You got LH02 Lyrical Hightail!");
                gameState.inventory.LH02LyricalHightail = 1;
                await new Promise(res => startBattleDialogue(winMsg, res)); winMsg = [];
                 startDialogue(["Pilot: It's time for me to go home."], () => {
                    changeMap('village', 10, 10);
                    startDialogue("The pilot drops you off and flies away towards Lexington City.");
                });
                return;
            }
            if (oldBattle.trainerId === 'finalRival') {
                showCredits();
                return;
            }
            if (oldBattle.opponentName === 'Andy' && !gameState.rivalDefeated) gameState.rivalDefeated = true;
            if (oldBattle.opponentName === 'Andy' && gameState.gymBadges.rhyme) gameState.rivalDefeatedPostGym = true;
            
            if(winMsg.length > 0) await new Promise(res => startBattleDialogue(winMsg, res));
        }
        gameState.inBattle = false; battleScene.classList.add('hidden');
        saveGame();
    }

    function addPokemonToParty(pokemon) {
        if (!gameState.pokedex[pokemon.species]) gameState.pokedex[pokemon.species] = { seen: true, caught: false };
        gameState.pokedex[pokemon.species].caught = true;
        if (gameState.playerParty.length < 6) gameState.playerParty.push(pokemon);
        else gameState.pokemonBox.push(pokemon);
    }
    
    function shakeScreen(duration) {
        let startTime = Date.now();
        function shake() {
            let elapsed = Date.now() - startTime;
            if (elapsed < duration) {
                const x = (Math.random() - 0.5) * 10;
                const y = (Math.random() - 0.5) * 10;
                gameContainer.style.transform = `translate(${x}px, ${y}px)`;
                requestAnimationFrame(shake);
            } else {
                gameContainer.style.transform = 'translate(0, 0)';
            }
        }
        shake();
    }
    
    function triggerEarthquake() {
        if(gameState.earthquake1Triggered) return;
        startDialogue(["The ground begins to tremble violently!"], () => {
            shakeScreen(2000);
            setTimeout(() => {
                gameState.earthquake1Triggered = true;
                if(maps.village) {
                     maps.village.layout[5][4] = 26;
                     maps.village.objects['4,5'] = { target: 'caveLevel1', x: 2, y: 2 };
                     maps.village.objects['5,6'] = { 
                        sprite: 'professor', 
                        interaction: ["Geologist William Penn Budd IV: Fascinating! I've never seen anything like it!"]
                     };
                     maps.village.objects['3,6'] = {
                        sprite: 'rival',
                        interaction: [
                            "Andy: Whoa... did you feel that?",
                            "This hole... it's huge. Right in front of my house.",
                            "Look, I know we're rivals and all... but this is bigger than us.",
                            "On the battlefield, I'm still going to crush you.",
                            "But out here... if things are getting dangerous... we need to watch each other's backs. Got it?"
                        ]
                     };
                }
                startDialogue([
                    "B-b-brrrring! B-b-brrrring!",
                    "Your phone is ringing. It's Mom!",
                    "Mom: 'Sweetie, are you okay?! There was a huge earthquake! Please get home right away!'",
                    "'I've enabled the Home-Warp feature on the PC network. Use it to get back safely!'"
                ], () => {
                    gameState.teleportUnlocked = true;
                    saveGame();
                    startDialogue("The Home-Warp feature on PCs is now online!");
                });
            }, 2000);
        });
    }

    function triggerFinalBattleScene() {
        // Make the final hole and place NPCs
        maps.village.layout[7][7] = 26;
        maps.village.layout[7][8] = 26;
        maps.village.layout[8][7] = 26;
        maps.village.layout[8][8] = 26;
        
        const holeInteraction = { target: 'finalCave', x: 14, y: 11 };
        maps.village.objects['7,7'] = holeInteraction;
        maps.village.objects['8,7'] = holeInteraction;
        maps.village.objects['7,8'] = holeInteraction;
        maps.village.objects['8,8'] = holeInteraction;

        // Move Andy
        maps.village.objects['6,8'] = { 
            sprite: 'rival', 
            interaction: [
                "Andy: You're back! Another, bigger hole appeared!",
                "I saw two of those goblin things go down there. They look like they mean business.",
                "This has to be the source of the earthquakes. We have to stop them!",
                "I'll be right behind you!"
            ]
        };

        // Remove old NPCs
        delete maps.village.objects['3,6'];
        delete maps.village.objects['5,6'];
    }

    function startFinalBattle() {
        startDialogue([
            "Goblin Boss: You're too late! The final earthquake will bring our master!",
            "Goblin King: And you won't live to see it!",
            "Andy: We'll see about that! Let's get 'em!",
        ], () => {
            // This is a temporary auto-win for testing. We will build the 2v2 battle logic next.
            gameState.finalBossDefeated = true; 
            gameState.inventory.masterthesis = 1;
            startDialogue(["You and Andy fought bravely and defeated the Goblins!", "Andy: We did it! They dropped this... it looks powerful. You should have it. You earned it.", "You got the Master Thesis!", "Andy: Well, I guess this makes us friends, not just rivals. Go on, there's a legendary creature you need to catch."], () => {
                // Remove Goblins from cave
                delete maps.finalCave.objects['8,2'];
                delete maps.finalCave.objects['7,2'];
                // Remove Andy from the village map
                delete maps.village.objects['6,8'];
                saveGame();
            });
        });
        return null;
    }
    
    function showCredits() {
        document.getElementById('credits-container').classList.remove('hidden');
    }

    function init() {
        document.addEventListener('DOMContentLoaded', () => {
            // Title Screen Logic
            gameState.activeScene = 'title';
            const continueBtn = document.getElementById('continue-btn');
            const newGameBtn = document.getElementById('new-game-title-btn');
            const titleOptions = document.getElementById('title-options');
            const pressKeyPrompt = document.getElementById('press-key-prompt');
            const newGameConfirm = document.getElementById('new-game-confirm');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmNoBtn = document.getElementById('confirm-no-btn');

            const showTitleOptions = () => {
                pressKeyPrompt.classList.add('hidden');
                titleOptions.classList.remove('hidden');
                if (!getSaveData()) {
                    continueBtn.style.display = 'none';
                }
            };

            const keydownHandler = () => {
                showTitleOptions();
                window.removeEventListener('keydown', keydownHandler);
                window.removeEventListener('click', keydownHandler);
            };

            window.addEventListener('keydown', keydownHandler);
            window.addEventListener('click', keydownHandler);


            continueBtn.onclick = () => {
                if (loadGame()) {
                    startGame(false); // Don't show intro dialogue
                }
            };

            newGameBtn.onclick = () => {
                titleOptions.classList.add('hidden');
                newGameConfirm.classList.remove('hidden');
            };

            confirmYesBtn.onclick = () => {
                localStorage.removeItem('elaQuestSaveData');
                gameState = getDefaultGameState(); // Reset state
                startGame(true); // Show intro dialogue
            };

            confirmNoBtn.onclick = () => {
                newGameConfirm.classList.add('hidden');
                titleOptions.classList.remove('hidden');
            };
        });
    }
    
    function startGame(isNewGame) {
        titleScreen.classList.add('hidden');
        pageLayout.classList.remove('hidden');
        pageLayout.classList.add('flex');


        if (gameState.hasMetDeathMasheen) {
            const gamerObject = maps.cityHouse3.objects['2,3'];
            gamerObject.sprite = 'graduate';
            gamerObject.interaction = "Tom: 'I'm going to be a principal some day. Gamification rules!'";
        }

        if (isNewGame && !gameState.initialized) {
            startDialogue([ "You wake up.", "Mom (downstairs): 'Breakfast is ready!'", "(Arrows: Move | A/Enter: Interact | M: Menu)" ]); 
            gameState.initialized = true;
        } else {
             startDialogue("Welcome back!");
        }
        
        gameLoop(); 
    }

    init();
})();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELA Quest: The Synonymouse Saga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #000;
            color: #fff;
            image-rendering: pixelated;
            overflow: hidden;
            touch-action: manipulation;
        }
        #page-layout {
            width: 100vw;
            height: 100vh;
        }
        #game-container {
            width: 100%;
            max-width: 512px;
            aspect-ratio: 16 / 14;
            position: relative;
            transition: transform 0.05s linear;
        }
        canvas {
            width: 100%;
            height: 100%;
            display: block;
            background-color: #000;
        }
        .message-box {
            border: 8px solid #4a5568;
            border-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0 H80 V80 H0 Z' fill='%234a5568'/%3E%3Cpath d='M8 8 H72 V72 H8 Z' fill='white'/%3E%3C/svg%3E") 8 stretch;
            cursor: pointer;
            flex-shrink: 0;
        }
        .ui-scene {
            background-color: rgba(0,0,0,0.9);
        }
        .xp-bar-bg { background-color: #a0a0a0; }
        .xp-bar-fill { background-color: #60a5fa; }
        .pc-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .pc-item:hover {
            background-color: #e2e8f0;
        }
        .touch-btn {
            width: 60px;
            height: 60px;
            background-color: rgba(128, 128, 128, 0.5);
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        .touch-btn-a {
             width: 80px;
            height: 80px;
            background-color: rgba(239, 68, 68, 0.7);
        }
        .touch-btn-b {
             width: 70px;
            height: 70px;
            background-color: rgba(68, 138, 239, 0.7);
        }
        #credits-scene {
            color: #FFD700;
            font-size: 2rem;
            text-align: center;
            overflow: hidden;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            top: 100%;
            animation: scroll-credits 30s linear forwards;
        }
        @keyframes scroll-credits {
            from { top: 100%; }
            to { top: -100%; }
        }
        .damage-flash { animation: flash 0.3s; }
        @keyframes flash { 50% { filter: brightness(3); } }

        .faint-animation { animation: faint 0.5s forwards; }
        @keyframes faint {
            to { transform: scale(0); opacity: 0; }
        }

        .attack-animation { animation: lunge 0.4s; }
        @keyframes lunge {
            50% { transform: translateX(20px) scale(1.1); }
        }
        .attack-animation-opponent { animation: lunge-opponent 0.4s; }
        @keyframes lunge-opponent {
            50% { transform: translateX(-20px) scale(1.1) scaleX(-1); }
        }
        .type-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            line-height: 1rem;
            margin-left: 4px;
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .type-Noun { background-color: #A8A878; }
        .type-Verb { background-color: #F08030; }
        .type-Adjective { background-color: #6890F0; }
        .type-Syntax { background-color: #705898; }

        .battle-start-zoom { animation: zoomIn 0.5s ease-out forwards; }
        @keyframes zoomIn {
            from { transform: scale(1.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .pokeball-sprite {
            position: absolute;
            font-size: 32px;
            z-index: 100;
        }

        .throw-animation {
            animation: throw-ball 0.8s ease-out forwards;
        }
        @keyframes throw-ball {
            0% {
                bottom: 15%; left: 20%;
                transform: scale(1.5) rotate(0deg);
            }
            50% {
                bottom: 60%; left: 50%;
                transform: scale(1) rotate(-180deg);
            }
            100% {
                bottom: 45%; left: 75%;
                transform: scale(1) rotate(-360deg);
            }
        }

        .suck-in-effect {
            animation: suck-in 0.5s ease-in forwards;
        }
        @keyframes suck-in {
            from { transform: scale(1) rotate(0) scaleX(-1); opacity: 1; }
            to { transform: scale(0) rotate(360deg) scaleX(-1); opacity: 0; }
        }

        .wiggle-animation {
            animation: wiggle 0.8s linear 3; /* Wiggles 3 times */
        }
        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(15deg); }
            75% { transform: rotate(-15deg); }
        }

        .capture-success-animation {
            animation: capture-flash 1s forwards;
        }
        @keyframes capture-flash {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(5) drop-shadow(0 0 10px white); }
        }
        .status-badge {
            font-size: 0.7rem;
            padding: 1px 4px;
            border-radius: 4px;
            margin-left: 8px;
            color: white;
        }
        .status-BRD { background-color: #6b7280; }
        .status-CFS { background-color: #f59e0b; }
        .status-WB { background-color: #8b5cf6; }
        
        .map-cell {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            text-align: center;
            line-height: 1;
            padding: 2px;
            overflow: hidden;
            word-break: break-word;
        }
        .map-cell-discovered {
            background-color: #a0aec0;
            border: 1px solid #718096;
        }
        .map-cell-undiscovered {
            background-color: #4a5568;
        }
        .map-cell-player {
            background-color: #f6e05e;
            box-shadow: 0 0 10px #f6e05e;
            z-index: 10;
        }
        .blinking-text {
            animation: blink 1.5s step-start 0s infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }

        /* Custom Scrollbar */
        .scrollable-content::-webkit-scrollbar {
            width: 16px;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: #4a5568;
            border-radius: 8px;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 8px;
            border: 4px solid #4a5568;
        }
        .scrollable-content {
            scrollbar-width: thin;
            scrollbar-color: #a0aec0 #4a5568;
        }

        #message-text, #battle-text {
            word-break: break-word;
            color: #2d3748; /* text-gray-800 */
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="title-screen" class="absolute inset-0 bg-black flex flex-col items-center justify-center z-50">
        <h1 class="text-5xl text-yellow-400 mb-4">ELA Quest</h1>
        <h2 class="text-2xl text-cyan-400 mb-12">The Synonymouse Saga</h2>

        <div id="title-options" class="hidden flex flex-col gap-4 w-64">
            <button id="continue-btn" class="p-3 bg-green-600 text-white rounded-lg text-2xl border-4 border-white">Continue</button>
            <button id="new-game-title-btn" class="p-3 bg-blue-600 text-white rounded-lg text-2xl border-4 border-white">New Game</button>
        </div>
        
        <div id="new-game-confirm" class="hidden flex flex-col items-center gap-4 w-72">
            <p class="text-xl text-center">Start a new game? All saved progress will be lost.</p>
            <div class="flex gap-4 w-full">
                <button id="confirm-yes-btn" class="w-full p-3 bg-red-600 text-white rounded-lg text-2xl border-4 border-white">Yes</button>
                <button id="confirm-no-btn" class="w-full p-3 bg-gray-600 text-white rounded-lg text-2xl border-4 border-white">No</button>
            </div>
        </div>

        <p id="press-key-prompt" class="mt-12 text-xl blinking-text text-gray-300">Press Any Key or Click to Start</p>

    </div>

    <div id="page-layout" class="hidden flex flex-col lg:flex-row items-center lg:justify-center justify-start w-screen h-screen p-4 gap-4 overflow-y-auto">
        
        <div class="hidden lg:flex w-48 h-48 pointer-events-auto">
            <div class="grid grid-cols-3 grid-rows-3 gap-2 w-full h-full">
                <div></div>
                <button id="touch-up-lg" class="touch-btn">▲</button>
                <div></div>
                <button id="touch-left-lg" class="touch-btn">◀</button>
                <div></div>
                <button id="touch-right-lg" class="touch-btn">▶</button>
                <div></div>
                <button id="touch-down-lg" class="touch-btn">▼</button>
                <div></div>
            </div>
        </div>

        <div class="flex flex-col items-center justify-center">
            <div id="game-container">
                <canvas id="gameCanvas"></canvas>
                <div id="animation-layer" class="absolute inset-0 pointer-events-none"></div>
                 <!-- Reserve Mode UI -->
                <div id="reserve-ui" class="hidden absolute top-0 left-0 right-0 p-2 bg-black bg-opacity-50 text-white text-lg flex justify-between">
                    <div>Time: <span id="reserve-timer">300</span>s</div>
                    <div>Strikes: <span id="reserve-strikes">0</span>/3</div>
                </div>
                <button id="menu-btn" class="absolute top-2 right-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg border-4 border-white">Menu</button>
            </div>

            <div id="message-box" class="message-box w-full max-w-xl min-h-[12rem] p-4 mt-2 bg-white text-gray-800 rounded-lg text-lg leading-snug flex flex-col">
                <div class="flex-grow overflow-y-auto scrollable-content p-2 min-h-0">
                    <p id="message-text">Welcome to ELA Quest!</p>
                </div>
                <div id="choices-box" class="mt-2 grid grid-cols-2 gap-4 flex-shrink-0"></div>
            </div>
        </div>
        
        <div class="hidden lg:flex items-center gap-4 pointer-events-auto">
             <button id="touch-b-lg" class="touch-btn touch-btn-b text-3xl">B</button>
             <button id="touch-a-lg" class="touch-btn touch-btn-a text-3xl">A</button>
        </div>

        <div id="touch-controls" class="lg:hidden fixed bottom-0 left-0 right-0 p-4 flex justify-between items-end pointer-events-none">
            <div class="grid grid-cols-3 grid-rows-3 gap-2 w-48 h-48 pointer-events-auto">
                <div></div>
                <button id="touch-up" class="touch-btn">▲</button>
                <div></div>
                <button id="touch-left" class="touch-btn">◀</button>
                <div></div>
                <button id="touch-right" class="touch-btn">▶</button>
                <div></div>
                <button id="touch-down" class="touch-btn">▼</button>
                <div></div>
            </div>
            <div class="flex items-center gap-4 pointer-events-auto">
                <button id="touch-b" class="touch-btn touch-btn-b text-3xl">B</button>
                <button id="touch-a" class="touch-btn touch-btn-a text-3xl">A</button>
            </div>
        </div>
        <!-- Spacer for mobile touch controls -->
        <div class="h-52 lg:hidden flex-shrink-0"></div>
    </div>
    
    <div id="battle-scene" class="hidden absolute inset-0 bg-black bg-opacity-90 flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-4xl">
            <div class="flex justify-between items-end">
                <div id="opponent-sprite" class="text-8xl w-1/4 transform -scale-x-100"></div>
                <div class="text-right mb-4 w-3/4">
                    <div id="opponent-name-container" class="flex justify-end items-center"></div>
                    <div class="w-full bg-gray-600 rounded-full h-6 border-4 border-gray-400">
                        <div id="opponent-hp" class="bg-green-500 h-full rounded-full transition-all duration-500" style="width: 100%"></div>
                    </div>
                </div>
            </div>
             <div id="opponent2-info" class="hidden flex justify-between items-end mt-2">
                <div id="opponent2-sprite" class="text-8xl w-1/4 transform -scale-x-100"></div>
                <div class="text-right mb-4 w-3/4">
                    <div id="opponent2-name-container" class="flex justify-end items-center"></div>
                    <div class="w-full bg-gray-600 rounded-full h-6 border-4 border-gray-400">
                        <div id="opponent2-hp" class="bg-green-500 h-full rounded-full transition-all duration-500" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-end mt-12">
                <div class="text-left w-3/4">
                    <div id="player-name-container" class="flex justify-start items-center"></div>
                    <div class="w-full bg-gray-600 rounded-full h-6 border-4 border-gray-400">
                        <div id="player-hp" class="bg-green-500 h-full rounded-full transition-all duration-500" style="width: 100%"></div>
                    </div>
                     <p id="player-hp-text" class="text-lg text-right"></p>
                </div>
                <div id="player-sprite" class="text-8xl w-1/4"></div>
            </div>
             <div id="ally-info" class="hidden flex justify-between items-end mt-2">
                 <div class="text-left w-3/4">
                    <div id="ally-name-container" class="flex justify-start items-center"></div>
                    <div class="w-full bg-gray-600 rounded-full h-6 border-4 border-gray-400">
                        <div id="ally-hp" class="bg-green-500 h-full rounded-full transition-all duration-500" style="width: 100%"></div>
                    </div>
                </div>
                 <div id="ally-sprite" class="text-8xl w-1/4"></div>
            </div>
        </div>

        <div id="battle-box" class="message-box w-full max-w-4xl mx-auto h-64 p-4 mt-8 bg-white text-gray-800 rounded-lg flex flex-col">
            <p id="battle-text" class="text-xl flex-grow overflow-y-auto scrollable-content pr-2"></p>
            <div id="battle-grid" class="grid grid-cols-2 gap-4 mt-4 flex-shrink-0">
            </div>
        </div>
    </div>
    
    <div id="menu-scene" class="hidden ui-scene absolute inset-0 p-4 sm:p-8 flex flex-col items-center justify-start overflow-y-auto">
        <div class="w-full max-w-sm bg-white text-black rounded-lg border-8 border-gray-500 p-6 grid grid-cols-1 gap-4">
            <h2 class="text-3xl text-center mb-2">Menu</h2>
            <button id="menu-pokedex-btn" class="w-full p-3 bg-blue-500 text-white rounded-lg text-2xl">Lexicon</button>
            <button id="menu-pokemon-btn" class="w-full p-3 bg-blue-500 text-white rounded-lg text-2xl">Creatures</button>
            <button id="menu-inventory-btn" class="w-full p-3 bg-blue-500 text-white rounded-lg text-2xl">Inventory</button>
            <button id="menu-map-btn" class="w-full p-3 bg-indigo-500 text-white rounded-lg text-2xl">World Map</button>
            <button id="menu-journal-btn" class="w-full p-3 bg-yellow-600 text-white rounded-lg text-2xl">Journal</button>
            <button id="menu-save-btn" class="w-full p-3 bg-green-500 text-white rounded-lg text-2xl">Save Game</button>
            <button id="menu-new-game-btn" class="w-full p-3 bg-purple-600 text-white rounded-lg text-2xl">New Game</button>
            <button id="menu-close-btn" class="mt-4 w-full p-3 bg-red-500 text-white rounded-lg text-2xl">Close</button>
        </div>
    </div>
    
    <div id="inventory-scene" class="hidden ui-scene absolute inset-0 p-4 sm:p-8 flex flex-col items-center justify-start overflow-y-auto">
        <div class="w-full max-w-2xl bg-white text-black rounded-lg border-8 border-gray-500 p-6">
            <h2 class="text-3xl text-center mb-4">Inventory</h2>
            <div class="text-2xl mb-6 flex justify-between">
                <span>Money:</span>
                <span id="inventory-money"></span>
            </div>
            <div id="inventory-items" class="scrollable-content space-y-4 min-h-[100px] max-h-[40vh] overflow-y-auto pr-2"></div>
            <button class="ui-back-btn mt-6 w-full p-3 bg-yellow-500 text-black rounded-lg text-2xl">Back</button>
        </div>
    </div>

    <div id="pokemon-stats-scene" class="hidden ui-scene absolute inset-0 p-4 sm:p-8 flex flex-col items-center justify-start overflow-y-auto">
        <div class="w-full max-w-3xl bg-white text-black rounded-lg border-8 border-gray-500 p-6 flex flex-col">
            <div id="pokemon-stats-content" class="scrollable-content overflow-y-auto max-h-[60vh] pr-2">
            </div>
            <button class="ui-back-btn mt-6 w-full p-3 bg-yellow-500 text-black rounded-lg text-2xl">Back</button>
        </div>
    </div>

    <div id="pokedex-scene" class="hidden ui-scene absolute inset-0 p-4 sm:p-8 flex flex-col items-center justify-start overflow-y-auto">
        <div class="w-full max-w-3xl bg-white text-black rounded-lg border-8 border-gray-500 p-6">
            <h2 class="text-3xl text-center mb-4">Lexicon</h2>
            <div id="pokedex-entries" class="scrollable-content space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
            <button class="ui-back-btn mt-6 w-full p-3 bg-yellow-500 text-black rounded-lg text-2xl">Back</button>
        </div>
    </div>

    <div id="pc-scene" class="hidden ui-scene absolute inset-0 p-4 sm:p-8 flex flex-col items-center justify-start overflow-y-auto">
        <div class="w-full max-w-4xl bg-white text-black rounded-lg border-8 border-gray-500 p-6">
            <h2 class="text-3xl text-center mb-4">Creature Storage</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <h3 class="text-2xl text-center">Party</h3>
                    <div id="pc-party" class="space-y-2 mt-2"></div>
                </div>
                <div>
                    <h3 class="text-2xl text-center">Box</h3>
                    <div id="pc-box" class="scrollable-content space-y-2 mt-2 max-h-[40vh] overflow-y-auto pr-2"></div>
                </div>
            </div>
            <button id="pc-close-btn" class="mt-6 w-full p-3 bg-red-500 text-white rounded-lg text-2xl">Close</button>
        </div>
    </div>
    
    <div id="map-scene" class="hidden ui-scene absolute inset-0 p-4 sm:p-8 flex flex-col items-center justify-start overflow-y-auto">
        <div class="w-full max-w-2xl bg-white text-black rounded-lg border-8 border-gray-500 p-6 flex flex-col">
            <h2 class="text-3xl text-center mb-4">World Map</h2>
            <div class="scrollable-content overflow-y-auto max-h-[60vh] pr-2">
                <div id="world-map-grid" class="grid grid-cols-5 gap-1 bg-gray-700 p-1 border-2 border-gray-500">
                    <!-- Map cells will be generated here by JavaScript -->
                </div>
            </div>
            <p class="text-center mt-2 text-sm"><span class="inline-block w-3 h-3 bg-yellow-400 border border-black align-middle"></span> = Your Location</p>
            <button class="ui-back-btn mt-6 w-full p-3 bg-yellow-500 text-black rounded-lg text-2xl">Back</button>
        </div>
    </div>

    <div id="journal-scene" class="hidden ui-scene absolute inset-0 p-4 sm:p-8 flex flex-col items-center justify-start overflow-y-auto">
        <div class="w-full max-w-2xl bg-white text-black rounded-lg border-8 border-gray-500 p-6">
            <h2 class="text-3xl text-center mb-4">Journal</h2>
            <div id="journal-entries" class="scrollable-content space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
            <button class="ui-back-btn mt-6 w-full p-3 bg-yellow-500 text-black rounded-lg text-2xl">Back</button>
        </div>
    </div>
    
    <div id="credits-container" class="hidden absolute inset-0 bg-black overflow-hidden">
        <div id="credits-scene">
            <p class="mb-8 text-4xl">ELA Quest</p>
            <p class="mb-4">A Game By:</p>
            <p class="mb-12 text-yellow-300">Luke Holm</p>

            <p class="mb-4">Powered By:</p>
            <p class="mb-12 text-yellow-300">Leveled Up Learning</p>
            
            <p class="mb-8">Thank you for playing!</p>
            
            <p class="text-sm">Please check out our other gamified lessons, reviews, and quizzes!</p>
        </div>
    </div>


<script>
(function() {
    // --- DOM Elements & Canvas Setup ---
    const canvas = document.getElementById('gameCanvas');
    const gameContainer = document.getElementById('game-container');
    const ctx = canvas.getContext('2d');
    const messageBox = document.getElementById('message-box');
    const messageText = document.getElementById('message-text');
    const choicesBox = document.getElementById('choices-box');
    const battleScene = document.getElementById('battle-scene');
    const battleBox = document.getElementById('battle-box');
    const battleText = document.getElementById('battle-text');
    const battleGrid = document.getElementById('battle-grid');
    
    const menuScene = document.getElementById('menu-scene');
    const inventoryScene = document.getElementById('inventory-scene');
    const pokemonStatsScene = document.getElementById('pokemon-stats-scene');
    const pokedexScene = document.getElementById('pokedex-scene');
    const pcScene = document.getElementById('pc-scene');
    const mapScene = document.getElementById('map-scene');
    const journalScene = document.getElementById('journal-scene');
    
    const titleScreen = document.getElementById('title-screen');
    const pageLayout = document.getElementById('page-layout');

    const tileSize = 32;
    canvas.width = 16 * tileSize; 
    canvas.height = 14 * tileSize;

    // --- Save/Load Functions ---
    function getSaveData() {
        return localStorage.getItem('elaQuestSaveData');
    }

    function saveGame() {
        try {
            localStorage.setItem('elaQuestSaveData', JSON.stringify(gameState));
            console.log("Game saved!");
        } catch (e) {
            console.error("Failed to save game:", e);
        }
    }

    function loadGame() {
        try {
            const savedData = getSaveData();
            if (savedData) {
                const loadedState = JSON.parse(savedData);
                Object.assign(gameState, loadedState);
                console.log("Game loaded successfully!");
                return true;
            }
        } catch (e) {
            console.error("Failed to load game:", e);
        }
        return false;
    }
    
    function getDefaultGameState() {
        return {
            currentMap: 'playerRoom',
            player: { x: 4, y: 4, sprite: 'player', walkFrame: 0 },
            inDialogue: false, inBattle: false, activeScene: null,
            timeOfDay: 'day',
            money: 50,
            inventory: { 
                potions: 3, wordballs: 5, greatphrases: 0, ultrasentences: 0, masterthesis: 0, 
                lexiconLollies: 0, adjectiveElixirs: 0, thesaurusTeas: 0, escapeVerbs: 0, 
                LH01LuminousHyperbole: 0, LH02LyricalHightail: 0, engineCog: 0, overdueBook: 0,
                deliciousDefinitions: 0, oldRod: 0, luckyLure: 0,
            },
            rivalDefeated: false,
            rivalDefeatedPostGym: false,
            rivalDefeatedInSynonymCity: false,
            defeatedTrainers: [],
            pokedex: {},
            playerParty: [],
            pokemonBox: [],
            gymBadges: { rhyme: false, synonym: false },
            devModeActive: false,
            hasMetDeathMasheen: false,
            teleportUnlocked: false,
            earthquake1Triggered: false,
            earthquake2Triggered: false,
            finalBossDefeated: false,
            initialized: false,
            foundItems: [],
            quests: {
                overdueBook: 'notStarted',
                islandCooperation: 'notStarted', 
                poetInspiration: 'notStarted',
                chefsMenu: 'notStarted',
                fishermansLure: 'notStarted',
            },
            inReserveMode: false,
            reserveChallenge: null,
            discoveredLocations: ['playerRoom', 'playerHouse', 'village'],
        };
    }

    // --- Game State ---
    let gameState = getDefaultGameState();
    let partySelectionIndex = null;
    
    const questDB = {
        'overdueBook': {
            'started': "Return the 'Epic of Gilgamesh' to the Synonym City Library.",
            'completed': "You returned the overdue book to the librarian."
        },
        'islandCooperation': {
            'started': "You and Andy are stranded! Work together to find a way off the island.",
            'completed': "You and Andy escaped the deserted island."
        },
        'poetInspiration': {
            'started': "Show a Haiku-na to the poet in Lexington City.",
            'completed': "You inspired the poet with the graceful Haiku-na."
        },
        'chefsMenu': {
            'started': "Show an Adjectlizard to the chef in Synonym City.",
            'completed': "You helped the chef create a wonderfully descriptive menu."
        },
        'fishermansLure': {
            'started': "Find the Fisherman's lost Lucky Lure.",
            'completed': "You returned the lure and received an Old Rod!"
        }
    };

    // --- Databases & Game Data ---
    const typeChart = {
        'Verb': { effective: ['Noun'], ineffective: ['Adjective'] },
        'Noun': { effective: ['Adjective'], ineffective: ['Verb'] },
        'Adjective': { effective: ['Verb'], ineffective: ['Noun'] },
        'Syntax': { effective: [], ineffective: [] },
    };

    const attacksDB = {
        'Tackle': { name: 'Tackle', type: 'Noun', power: 8, text: 'A basic physical strike.' },
        'Word Strike': { name: 'Word Strike', type: 'Noun', power: 10, text: 'Channels knowledge into a jab.' },
        'Synonym Slam': { name: 'Synonym Slam', type: 'Noun', power: 15, text: 'A blow backed by similar words.' },
        'Vicious Lunge': { name: 'Vicious Lunge', type: 'Verb', power: 12, text: 'A swift, action-based strike.' },
        'Roar of Knowledge': { name: 'Roar of Knowledge', type: 'Syntax', power: 22, text: 'A stunning cry of ancient truths.'},
        'Gooey Touch': { name: 'Gooey Touch', type: 'Adjective', power: 7, text: 'A sticky, weak jab.'},
        'Chameleon Color': {name: 'Chameleon Color', type: 'Adjective', power: 12, text: 'Changes color to land a surprising hit.'},
        'Scale Shot': {name: 'Scale Shot', type: 'Noun', power: 18, text: 'Fires sharp scales at the foe.'},
        'Cosmic Prose': {name: 'Cosmic Prose', type: 'Syntax', power: 30, text: 'An attack of legendary power.'},
        'Leer': { name: 'Leer', type: 'Syntax', power: 0, text: 'Lowers enemy defense.', effect: { type: 'stat', stat: 'defense', amount: -1, target: 'opponent' } },
        'Growl': { name: 'Growl', type: 'Syntax', power: 0, text: 'Lowers enemy attack.', effect: { type: 'stat', stat: 'attack', amount: -1, target: 'opponent' } },
        'Sharpen': { name: 'Sharpen', type: 'Syntax', power: 0, text: 'Raises the user\'s Attack stat.', effect: { type: 'stat', stat: 'attack', amount: 1, target: 'self' } },
        'Jumbled Jargon': { name: 'Jumbled Jargon', type: 'Syntax', power: 0, text: 'Confuses the opponent with nonsense.', effect: { type: 'status', status: 'confused', chance: 0.5 } },
        'Dull Drone': { name: 'Dull Drone', type: 'Noun', power: 0, text: 'Bores the opponent to sleep.', effect: { type: 'status', status: 'boredom', chance: 0.6 } },
        'Ink Stain': { name: 'Ink Stain', type: 'Noun', power: 5, text: 'A messy attack that causes writer\'s block.', effect: { type: 'status', status: 'writersBlock', chance: 0.9 } },
        'Definition Strike': { name: 'Definition Strike', type: 'Noun', power: 7, text: 'A precise strike that reveals a foe\'s weakness.', effect: { type: 'stat', stat: 'defense', amount: -1, target: 'opponent', chance: 0.7 } },
        'Heavy Tome': { name: 'Heavy Tome', type: 'Noun', power: 25, text: 'A crushing blow from a weighty book.' },
        'Proper Punch': { name: 'Proper Punch', type: 'Noun', power: 14, text: 'A formal, well-aimed punch that never misses.' },
        'Fragmented Strike': { name: 'Fragmented Strike', type: 'Noun', power: 10, text: 'A quick but incomplete jab.' },
        'Action Rush': { name: 'Action Rush', type: 'Verb', power: 6, text: 'A flurry of quick actions.' },
        'Swift Sentence': { name: 'Swift Sentence', type: 'Verb', power: 0, text: 'A quickly spoken phrase that boosts the user\'s resolve.', effect: { type: 'stat', stat: 'attack', amount: 2, target: 'self' } },
        'Imperative Urge': { name: 'Imperative Urge', type: 'Verb', power: 18, text: 'A commanding strike that demands attention.' },
        'Descriptive Drain': { name: 'Descriptive Drain', type: 'Adjective', power: 12, text: 'Drains the foe\'s vitality with vivid language.' },
        'Vivid Flash': { name: 'Vivid Flash', type: 'Adjective', power: 0, text: 'A blinding flash of color that muddles the foe.', effect: { type: 'status', status: 'confused', chance: 0.8 } },
        'Solid Stance': { name: 'Solid Stance', type: 'Adjective', power: 0, text: 'The user braces, becoming a descriptive fortress.', effect: { type: 'stat', stat: 'defense', amount: 2, target: 'self' } },
        'Piercing Gaze': { name: 'Piercing Gaze', type: 'Adjective', power: 16, text: 'An intense look that finds a weak point.' },
        'Commanding Voice': { name: 'Commanding Voice', type: 'Syntax', power: 0, text: 'A powerful voice that lowers the foe\'s will to fight.', effect: { type: 'stat', stat: 'attack', amount: -2, target: 'opponent', chance: 0.8 } },
        'Grammar Shield': { name: 'Grammar Shield', type: 'Syntax', power: 0, text: 'A shield of pure grammar raises defense.', effect: { type: 'stat', stat: 'defense', amount: 2, target: 'self' } },
        'Paradigm Shift': { name: 'Paradigm Shift', type: 'Syntax', power: 10, text: 'A confusing shift in logic that may muddle the foe.', effect: { type: 'status', status: 'confused', chance: 0.4 } },
        'Pun Power': { name: 'Pun Power', type: 'Syntax', power: 20, text: 'An attack that\'s amusingly effective.' },
        'Concrete Slam': { name: 'Concrete Slam', type: 'Noun', power: 20, text: 'A powerful, tangible strike.' },
        'Abstract Idea': { name: 'Abstract Idea', type: 'Noun', power: 5, text: 'A confusing thought that may muddle the foe.', effect: { type: 'status', status: 'confused', chance: 0.3 } },
        'Possessive Jab': { name: 'Possessive Jab', type: 'Noun', power: 10, text: 'A selfish strike that drains some health from the target.' },
        'Noun Swarm': { name: 'Noun Swarm', type: 'Noun', power: 5, text: 'Overwhelms the foe with a flurry of nouns, hitting 2-5 times.' },
        'Headlunge': { name: 'Headlunge', type: 'Noun', power: 22, text: 'A reckless, powerful headfirst charge.' },
        'Collective Crush': { name: 'Collective Crush', type: 'Noun', power: 12, text: 'A group effort results in a solid blow.' },
        'Proper Power': { name: 'Proper Power', type: 'Noun', power: 16, text: 'A specific, targeted, and powerful strike.' },
        'Accelerate': { name: 'Accelerate', type: 'Verb', power: 0, text: 'The user acts quickly, raising its Attack stat.', effect: { type: 'stat', stat: 'attack', amount: 1, target: 'self' } },
        'Linking Verb': { name: 'Linking Verb', type: 'Verb', power: 0, text: 'Connects concepts to sharply raise Defense.', effect: { type: 'stat', stat: 'defense', amount: 2, target: 'self' } },
        'Action Verb': { name: 'Action Verb', type: 'Verb', power: 15, text: 'A dynamic strike with a high chance for a critical hit.' },
        'Transitive Takedown': { name: 'Transitive Takedown', type: 'Verb', power: 14, text: 'An action that requires a direct object--the foe!' },
        'Intransitive Strike': { name: 'Intransitive Strike', type: 'Verb', power: 25, text: 'A powerful blow that causes recoil damage to the user.' },
        'Gerund Grind': { name: 'Gerund Grind', type: 'Verb', power: 11, text: 'A continuous, grinding verb-al assault.' },
        'Imperative Command': { name: 'Imperative Command', type: 'Verb', power: 20, text: 'A forceful command that strikes with authority.' },
        'Colorful Curse': { name: 'Colorful Curse', type: 'Adjective', power: 0, text: 'Vividly describes the foe\'s flaws, lowering Attack and Defense.', effect: { type: 'stat', stat: 'attack', amount: -1, target: 'opponent' } },
        'Dazzling Gleam': { name: 'Dazzling Gleam', type: 'Adjective', power: 14, text: 'A flash of brilliant language that damages the foe.' },
        'Sharp Wit': { name: 'Sharp Wit', type: 'Adjective', power: 10, text: 'A cutting remark with a high critical hit ratio.' },
        'Superlative Strike': { name: 'Superlative Strike', type: 'Adjective', power: 28, text: 'The BEST, most powerful descriptive attack.' },
        'Comparative Clash': { name: 'Comparative Clash', type: 'Adjective', power: 15, text: 'A strike that is better than a basic one.' },
        'Descriptive Verse': { name: 'Descriptive Verse', type: 'Adjective', power: 0, text: 'A soothing description that restores a small amount of HP.', effect: { type: 'heal', amount: 0.25, target: 'self' } },
        'Vague Description': { name: 'Vague Description', type: 'Adjective', power: 0, text: 'A hazy description that lowers the foe\'s Defense.', effect: { type: 'stat', stat: 'defense', amount: -1, target: 'opponent' } },
        'Semicolon Splice': { name: 'Semicolon Splice', type: 'Syntax', power: 12, text: 'Joins two powerful ideas to strike twice.' },
        'Comma Splice': { name: 'Comma Splice', type: 'Syntax', power: 0, text: 'An incorrect pause that lowers the foe\'s Defense.', effect: { type: 'stat', stat: 'defense', amount: -1, target: 'opponent' } },
        'Run-on Rant': { name: 'Run-on Rant', type: 'Syntax', power: 6, text: 'A long, rambling attack that hits 2-5 times.' },
        'Full Stop': { name: 'Full Stop', type: 'Syntax', power: 35, text: 'A powerful, conclusive blow that is hard to land.' },
        'Interjection Burst': { name: 'Interjection Burst', type: 'Syntax', power: 9, text: 'A sudden, surprising burst of energy! Wow!' },
        'Parenthetical Pinch': { name: 'Parenthetical Pinch', type: 'Syntax', power: 13, text: 'An aside that adds a little extra damage.' },
        'Exclamatory Cry': { name: 'Exclamatory Cry', type: 'Syntax', power: 0, text: 'An excited shout that sharply raises the user\'s Attack.', effect: { type: 'stat', stat: 'attack', amount: 2, target: 'self' } },
        'Rhetorical Question': { name: 'Rhetorical Question', type: 'Syntax', power: 0, text: 'Asks a question that makes the foe ponder, confusing them.', effect: { type: 'status', status: 'confused', chance: 0.9 } },
        'Poetic Justice': { name: 'Poetic Justice', type: 'Syntax', power: 18, text: 'A fitting strike that deals more damage when the user\'s HP is low.' },
        'Dialogue Dash': { name: 'Dialogue Dash', type: 'Syntax', power: 15, text: 'A quick dash that always strikes first.' },
        'Clause Connector': { name: 'Clause Connector', type: 'Syntax', power: 18, text: 'Connects two powerful ideas into one forceful strike.' },
        'Plot Twist': { name: 'Plot Twist', type: 'Syntax', power: 25, text: 'A shocking development that may confuse the user.', effect: { type: 'status', status: 'confused', chance: 0.3, target: 'self' } },
        'Etymology Etch': { name: 'Etymology Etch', type: 'Noun', power: 15, text: "Reveals a foe's roots, lowering their Defense.", effect: { type: 'stat', stat: 'defense', amount: -1, target: 'opponent', chance: 0.9 } },
        'Vernacular Venom': { name: 'Vernacular Venom', type: 'Verb', power: 8, text: "A folksy phrase that inflicts Writer's Block.", effect: { type: 'status', status: 'writersBlock', chance: 0.8 } },
        'Homeric Hymn': { name: 'Homeric Hymn', type: 'Syntax', power: 0, text: 'An ancient, epic song that restores HP.', effect: { type: 'heal', amount: 0.5, target: 'self' } },
        'Satire Slap': { name: 'Satire Slap', type: 'Adjective', power: 10, text: "A witty slap that mocks the foe, lowering their Attack.", effect: { type: 'stat', stat: 'attack', amount: -1, target: 'opponent', chance: 1.0 } },
        'Iambic Kick': { name: 'Iambic Kick', type: 'Syntax', power: 10, text: 'A rhythmic kick that strikes twice.' },
        'Thesis Thrust': { name: 'Thesis Thrust', type: 'Noun', power: 30, text: 'A powerful, well-argued point that causes recoil damage.' },
        'Foil Fence': { name: 'Foil Fence', type: 'Verb', power: 0, text: "The user contrasts itself, sharply raising Defense.", effect: { type: 'stat', stat: 'defense', amount: 2, target: 'self' } },
        'Couplet Cut': { name: 'Couplet Cut', type: 'Syntax', power: 12, text: 'A quick, rhyming jab that always strikes first.' },
        'Antithesis': { name: 'Antithesis', type: 'Adjective', power: 20, text: 'An opposing idea that strikes with balanced force.' },
        'Protagonist Power': { name: 'Protagonist Power', type: 'Noun', power: 20, text: "A heroic strike that raises the user's Defense.", effect: { type: 'stat', stat: 'defense', amount: 1, target: 'self', chance: 0.8 } },
        'Antagonist Ambush': { name: 'Antagonist Ambush', type: 'Verb', power: 22, text: 'A sneaky, powerful strike with a high critical hit ratio.' },
        'Symbolic Strike': { name: 'Symbolic Strike', type: 'Syntax', power: 18, text: "An attack with a deeper meaning that may lower the foe's Attack.", effect: { type: 'stat', stat: 'attack', amount: -1, target: 'opponent', chance: 0.3 } },
        'Dramatic Irony': { name: 'Dramatic Irony', type: 'Adjective', power: 0, text: "The user feigns weakness, lowering its Defense but sharply raising Attack.", effect: { type: 'stat', stat: 'defense', amount: -1, target: 'self' }, effect2: { type: 'stat', stat: 'attack', amount: 2, target: 'self' } },
        'Foreshadowing Flash': { name: 'Foreshadowing Flash', type: 'Syntax', power: 0, text: "A glimpse of the future that raises the user's Attack.", effect: { type: 'stat', stat: 'attack', amount: 1, target: 'self' } },
        'Deus Ex Machina': { name: 'Deus Ex Machina', type: 'Verb', power: 40, text: "A powerful, divine intervention that sharply lowers the user's Attack after use.", effect: { type: 'stat', stat: 'attack', amount: -2, target: 'self' } },
        'Red Herring': { name: 'Red Herring', type: 'Verb', power: 10, text: 'A distracting blow that has a high chance to confuse the foe.', effect: { type: 'status', status: 'confused', chance: 0.7 } },
        'Chekhov\'s Gun': { name: 'Chekhov\'s Gun', type: 'Noun', power: 15, text: 'A seemingly minor detail that strikes a critical weak point.' },
        'Fourth Wall Break': { name: 'Fourth Wall Break', type: 'Syntax', power: 0, text: "A bizarre move that shatters the foe's perception, confusing them.", effect: { type: 'status', status: 'confused', chance: 1.0 } },
        'Mood Shift': { name: 'Mood Shift', type: 'Adjective', power: 0, text: "The user alters the atmosphere, lowering the foe's Defense.", effect: { type: 'stat', stat: 'defense', amount: -1, target: 'opponent', chance: 1.0 } },
        'Climax Crash': { name: 'Climax Crash', type: 'Verb', power: 38, text: "A powerful, all-out attack that lowers the user's Defense after use.", effect: { type: 'stat', stat: 'defense', amount: -1, target: 'self' } },
        'Anaphora Arc': { name: 'Anaphora Arc', type: 'Syntax', power: 8, text: 'A repetitive strike that hits 2-5 times.' },
        'Motif Mangle': { name: 'Motif Mangle', type: 'Noun', power: 14, text: 'A recurring theme that strikes twice.' },
        'Juxtaposition Jolt': { name: 'Juxtaposition Jolt', type: 'Adjective', power: 18, text: "A contrasting blow that may lower the foe's Defense.", effect: { type: 'stat', stat: 'defense', amount: -1, target: 'opponent', chance: 0.3 } },
        'Allusion Assault': { name: 'Allusion Assault', type: 'Syntax', power: 18, text: 'A referential blow that may confuse the opponent.', effect: { type: 'status', status: 'confused', chance: 0.3 } },
        'Paradox Pulse': { name: 'Paradox Pulse', type: 'Syntax', power: 28, text: 'A contradictory blast that deals recoil damage to the user.' },
        'Apostrophe Pierce': { name: 'Apostrophe Pierce', type: 'Syntax', power: 16, text: "A possessive jab with a high critical-hit ratio." },
        'Pathetic Fallacy': { name: 'Pathetic Fallacy', type: 'Adjective', power: 0, text: "The user's emotion affects the field, sharply raising its Attack.", effect: { type: 'stat', stat: 'attack', amount: 2, target: 'self' } },
        'Flashback Fade': { name: 'Flashback Fade', type: 'Verb', power: 0, text: "The user recalls a past success, raising its Defense.", effect: { type: 'stat', stat: 'defense', amount: 1, target: 'self' } },
        'Personification Punch': { name: 'Personification Punch', type: 'Verb', power: 15, text: "An inanimate concept strikes, lowering the foe's Defense.", effect: { type: 'stat', stat: 'defense', amount: -1, target: 'opponent', chance: 1.0 } },
    };

    const pokedexData = {
        'Synonymouse': 'A clever creature that evolves into the powerful Syntar.',
        'Syntar': 'A rare evolution of Synonymouse. It is a master of syntax and evolves into Paradoxos.',
        'Paradoxos': 'The final form of Synonymouse. A legendary creature whose very existence is a contradiction.',
        'Wordworm': 'Common in grassy areas, this creature consumes letters for sustenance.',
        'Grammargoyle': 'A stoic opponent that evolves into Dictionare.',
        'Dictionare': 'The evolved form of Grammargoyle. It is a living dictionary that evolves into Enigmalith.',
        'Enigmalith': 'The final form of Grammargoyle. A being of pure, unbreakable grammar.',
        'SimileSlime': 'A gooey creature that is *like* a puddle but *as* solid as a rock.',
        'CommaLeon': 'This creature can pause, adapt, and blend into any sentence structure.',
        'Adjectlizard': 'A reptile that describes its foes into submission with powerful adjectives.',
        'Haiku-na': 'A serene creature that attacks in a pattern of 5, then 7, then 5 syllables.',
        'EpicAvis': 'When Haiku-na evolves, it becomes a master of long-form poetry and epic tales.',
        'Metaphorpillar': 'It believes it IS a leaf, consuming knowledge until it transforms.',
        'Analofly': 'The beautiful evolution of Metaphorpillar. It draws comparisons to overwhelm its foes.',
        'Hyper-bole': 'This creature is the BIGGEST, STRONGEST, and FASTEST creature in the entire universe! (Or so it claims).',
        'PronounProwler': 'A swift hunter that replaces its prey\'s name with "it" before it strikes.',
        'VerbViper': 'This serpent moves with decisive action, striking with a powerful verb-al assault.',
        'Lexiconstruct': 'A legendary golem of pure language, said to hold the secrets of all stories.',
        'Antonymph': 'A legendary fairy of opposition, its very presence inverts the world around it.',
        'Nomenowl': 'This wise creature can name anything it sees, making it a master of nouns.',
        'Rhymoceros': 'With a horn as hard as a perfect rhyme, it charges with poetic force.',
        'Adjectoad': 'Its colorful skin changes to describe its mood. A truly expressive creature.',
        'Stalagmight': 'Formed over centuries in deep caves, its body is as solid as grammatical law.',
        'Conjun-gull': 'This seabird connects ideas as it soars, linking thoughts across the sky.',
        'Allegator': 'Its stories and growls often have a hidden, deeper meaning.',
        'Alliteration': 'The two heads of this creature constantly create cunning, complex consonances.',
        'Fablion': 'A proud creature whose roars tell tales with strong moral lessons.',
        'Mythical': 'An evolution of Fablion, its very existence is a story passed down through generations, explaining natural phenomena.',
        'Pun-guin': 'It uses clever wordplay and puns to confuse its opponents in battle.',
        'Irony': 'Its battle style is the opposite of what you\'d expect, making it a tricky and unpredictable foe.',
        'Buzzword': "This small, insectoid creature communicates entirely through buzzing onomatopoeia. It's often found in noisy, bustling places.",
        'Droneme': "The evolution of Buzzword. Its constant, rhythmic droning can mesmerize opponents, making it difficult to focus in battle.",
        'Omen': "A mysterious, spectral creature that appears briefly before important events. Its presence is considered a sign of things to come.",
        'Racecar': "A strange, mechanical creature that moves with incredible speed, both forwards and backwards. It's perfectly symmetrical.",
        'Gerundile': 'This creature is in constant motion, rolling on its wheel-like feet. It represents a verb acting as a noun.',
        'Infinotaur': 'The evolved form of Gerundile. A powerful being that embodies the core concept of a verb: to be, or to do.',
        'Dramask': 'This creature of the stage can mimic the actions of its opponents. It is a master of verbs.',
        'Catalist': 'A feisty creature that loves to start things. Its very presence can be the catalyst for a chain of events.',
        'Chain Re-Action': 'The evolution of Catalist. A single one of its actions can cause a cascade of consequences for its opponents.',
        'Finnegan': "A creature of pure narrative flow, it swims through stories as if they were water. It's often found near sources of inspiration.",
        'Debait': "This creature acts as bait, luring in bigger ideas with its tempting arguments.",
        'Argubass': "A master of debate, it attacks with sharp, cutting arguments that are hard to refute.",
        'Cliché': "A very common creature found in most bodies of water. Its predictability is its main weakness.",
        'Archetype': "The evolution of Cliché. It has shed its predictable nature to become a foundational concept, powerful and timeless.",
        'Quotlet': "This small, owl-like creature mimics the speech of others, often trapping words in quotation marks.",
        'Speechawk': "A majestic evolution of Quotlet. It delivers powerful orations that can buffet opponents with pure rhetoric.",
        'Punc-tuft': "A timid creature that often pauses in battle. Its tail is shaped like a comma.",
        'Semicolonel': "An evolution of Punc-tuft, it has mastered the art of connecting related ideas with powerful, balanced attacks.",
        'Fablion': "A proud creature whose roars tell tales with strong moral lessons.",
        'Mythical': "An evolution of Fablion, its very existence is a story passed down through generations, explaining natural phenomena.",
    };

    const itemsDB = {
        'potions': { name: 'Potion', description: "A spray that restores a creature's health, or its 'main idea.'" },
        'wordballs': { name: 'Word Ball', description: "A device for capturing and storing the essence of wild literary creatures.", bonus: 1.0 },
        'greatphrases': { name: 'Great Phrase', description: "A well-crafted sentence with a higher chance of capturing a creature.", bonus: 1.5 },
        'ultrasentences': { name: 'Ultra Sentence', description: "A complex, high-performance sentence with a very high capture rate.", bonus: 2.0 },
        'masterthesis': { name: 'Master Thesis', description: "The ultimate literary device. It will capture any creature without fail.", bonus: 255 },
        'lexiconLollies': { name: 'Lexicon Lolly', description: "A sweet treat that instantly raises a creature's level by one." },
        'adjectiveElixirs': { name: 'Adjective Elixir', description: "A descriptive drink that temporarily boosts a creature's Attack stat." },
        'thesaurusTeas': { name: 'Thesaurus Tea', description: "A soothing brew that cures any status conditions by finding an alternative 'state of being.'" },
        'escapeVerbs': { name: 'Escape Verb', description: "An action-packed phrase that guarantees a swift escape from a wild encounter." },
        'LH01LuminousHyperbole': { name: 'LH01 L. Hyperbole', description: "An incredibly powerful turn of phrase that can illuminate the darkest of places." },
        'LH02LyricalHightail': { name: 'LH02 L. Hightail', description: "A poetic verse that lets you instantly travel to any previously visited Word Center." },
        'airplanePropeller': { name: 'Airplane Propeller', description: "A crucial component for a small aircraft's engine." },
        'overdueBook': { name: 'Overdue Book', description: "A rare copy of 'The Epic of Gilgamesh'. The librarian wants this back!"},
        'deliciousDefinitions': { name: 'Delicious Definition', description: "A tasty treat used to lure rare creatures in the Wild Word Reserve." },
        'luckyLure': { name: 'Lucky Lure', description: "A shiny, well-crafted fishing lure. It looks important to someone." },
        'oldRod': { name: 'Old Rod', description: "A simple fishing rod. Lets you fish from piers and shores." },
    };

    const pokemonDB = {
        'Synonymouse': { sprite: 'synonymouse', types: ['Noun'], evolvesAt: 10, evolvesTo: 'Syntar', learnset: [{ level: 7, move: 'Synonym Slam' }, {level: 9, move: 'Possessive Jab'}], catchDifficulty: 45 },
        'Syntar': { sprite: 'syntar', types: ['Syntax', 'Verb'], evolvesAt: 25, evolvesTo: 'Paradoxos', learnset: [{level: 22, move: 'Thesis Thrust'}, {level: 28, move: 'Chekhov\'s Gun'}, {level: 32, move: 'Apostrophe Pierce'}], catchDifficulty: 25 },
        'Paradoxos': { sprite: 'paradoxos', types: ['Syntax', 'Adjective'], learnset: [{level: 30, move: 'Plot Twist'}, {level: 40, move: 'Antithesis'}, {level: 50, move: 'Fourth Wall Break'}, {level: 55, move: 'Paradox Pulse'}], catchDifficulty: 10 },
        'Wordworm': { sprite: 'wordworm', types: ['Noun'], catchDifficulty: 255 },
        'Grammargoyle': { sprite: 'grammargoyle', types: ['Syntax'], evolvesAt: 10, evolvesTo: 'Dictionare', catchDifficulty: 45 },
        'Dictionare': { sprite: 'dictionare', types: ['Syntax', 'Noun'], evolvesAt: 25, evolvesTo: 'Enigmalith', learnset: [{level: 30, move: 'Etymology Etch'}, {level: 35, move: 'Symbolic Strike'}], catchDifficulty: 20 },
        'Enigmalith': { sprite: 'enigmalith', types: ['Syntax', 'Noun'], learnset: [{level: 60, move: 'Deus Ex Machina'}, {level: 65, move: 'Climax Crash'}], catchDifficulty: 10 },
        'SimileSlime': { sprite: 'simileslime', types: ['Adjective'], catchDifficulty: 190 },
        'CommaLeon': { sprite: 'commaleon', types: ['Adjective'], learnset: [{level: 15, move: 'Satire Slap'}, {level: 18, move: 'Mood Shift'}], catchDifficulty: 90 },
        'Adjectlizard': {sprite: 'adjectlizard', types: ['Adjective', 'Noun'], learnset: [{level: 9, move: 'Scale Shot'}, {level: 12, move: 'Dazzling Gleam'}], catchDifficulty: 45 },
        'Haiku-na': { sprite: 'haikuna', types: ['Syntax'], evolvesAt: 20, evolvesTo: 'EpicAvis', learnset: [{level: 18, move: 'Iambic Kick'}, {level: 22, move: 'Couplet Cut'}], catchDifficulty: 75 },
        'EpicAvis': { sprite: 'epicavis', types: ['Syntax', 'Noun'], learnset: [{level: 25, move: 'Homeric Hymn'}, {level: 30, move: 'Foreshadowing Flash'}], catchDifficulty: 40 },
        'Metaphorpillar': { sprite: 'metaphorpillar', types: ['Adjective'], evolvesAt: 12, evolvesTo: 'Analofly', catchDifficulty: 255 },
        'Analofly': { sprite: 'analofly', types: ['Adjective', 'Syntax'], catchDifficulty: 120 },
        'Hyper-bole': { sprite: 'hyperbole', types: ['Adjective'], catchDifficulty: 120 },
        'PronounProwler': { sprite: 'pronounprowler', types: ['Noun'], catchDifficulty: 90 },
        'VerbViper': { sprite: 'verbviper', types: ['Verb'], learnset: [{level: 20, move: 'Vernacular Venom'}, {level: 25, move: 'Antagonist Ambush'}], catchDifficulty: 90 },
        'Lexiconstruct': { sprite: 'lexiconstruct', types: ['Syntax'], isLegendary: true, catchDifficulty: 3 },
        'Antonymph': { sprite: 'antonymph', types: ['Syntax'], isLegendary: true, catchDifficulty: 3 },
        'Nomenowl': { sprite: 'nomenowl', types: ['Noun'], catchDifficulty: 220 },
        'Rhymoceros': { sprite: 'rhymoceros', types: ['Syntax'], learnset: [{level: 22, move: 'Iambic Kick'}], catchDifficulty: 60 },
        'Adjectoad': { sprite: 'adjectoad', types: ['Adjective'], catchDifficulty: 180 },
        'Stalagmight': { sprite: 'stalagmight', types: ['Noun', 'Syntax'], catchDifficulty: 100 },
        'Conjun-gull': { sprite: 'conjungull', types: ['Verb'], catchDifficulty: 150 },
        'Allegator': { sprite: 'allegator', types: ['Noun'], evolvesAt: 16, evolvesTo: 'Alliteration', learnset: [{level: 18, move: 'Vernacular Venom'}], catchDifficulty: 75 },
        'Alliteration': { sprite: 'alliteration', types: ['Noun', 'Syntax'], learnset: [{level: 20, move: 'Anaphora Arc'}], catchDifficulty: 45 },
        'Fablion': { sprite: 'fablion', types: ['Noun'], evolvesAt: 22, evolvesTo: 'Mythical', catchDifficulty: 60 },
        'Mythical': { sprite: 'mythical', types: ['Noun', 'Verb'], learnset: [{level: 35, move: 'Protagonist Power'}, {level: 40, move: 'Allusion Assault'}], catchDifficulty: 30 },
        'Pun-guin': { sprite: 'penguin', types: ['Syntax'], evolvesAt: 28, evolvesTo: 'Irony', catchDifficulty: 90 },
        'Irony': { sprite: 'irony', types: ['Syntax', 'Adjective'], learnset: [{level: 32, move: 'Plot Twist'}, {level: 36, move: 'Satire Slap'}, {level: 40, move: 'Dramatic Irony'}, {level: 45, move: 'Juxtaposition Jolt'}], catchDifficulty: 45 },
        'Buzzword': { sprite: 'buzzword', types: ['Noun', 'Syntax'], evolvesAt: 24, evolvesTo: 'Droneme', catchDifficulty: 190 },
        'Droneme': { sprite: 'droneme', types: ['Noun', 'Syntax'], catchDifficulty: 90 },
        'Omen': { sprite: 'omen', types: ['Syntax'], catchDifficulty: 120 },
        'Racecar': { sprite: 'racecar', types: ['Noun', 'Verb'], catchDifficulty: 60 },
        'Gerundile': { sprite: 'gerundile', types: ['Verb', 'Noun'], evolvesAt: 18, evolvesTo: 'Infinotaur', catchDifficulty: 100 },
        'Infinotaur': { sprite: 'infinotaur', types: ['Verb', 'Noun'], learnset: [{level: 30, move: 'Red Herring'}, {level: 35, move: 'Flashback Fade'}], catchDifficulty: 50 },
        'Dramask': { sprite: 'dramask', types: ['Verb', 'Syntax'], learnset: [{level: 25, move: 'Foil Fence'}, {level: 30, move: 'Pathetic Fallacy'}], catchDifficulty: 75 },
        'Catalist': { sprite: 'catalist', types: ['Verb'], evolvesAt: 26, evolvesTo: 'Chain Re-Action', catchDifficulty: 80 },
        'Chain Re-Action': { sprite: 'chainreaction', types: ['Verb', 'Syntax'], catchDifficulty: 40 },
        'Finnegan': { sprite: 'finnegan', types: ['Noun', 'Verb'], catchDifficulty: 190 },
        'Debait': { sprite: 'debait', types: ['Noun', 'Verb'], evolvesAt: 22, evolvesTo: 'Argubass', catchDifficulty: 150 },
        'Argubass': { sprite: 'argubass', types: ['Noun', 'Syntax'], catchDifficulty: 75 },
        'Cliché': { sprite: 'cliche', types: ['Noun'], evolvesAt: 20, evolvesTo: 'Archetype', learnset: [{level: 8, move: 'Noun Swarm'}], catchDifficulty: 180 },
        'Archetype': { sprite: 'archetype', types: ['Noun', 'Syntax'], learnset: [{level: 25, move: 'Concrete Slam'}, {level: 30, 'move': 'Poetic Justice'}, {level: 35, move: 'Motif Mangle'}], catchDifficulty: 80 },
        'Quotlet': { sprite: 'quotlet', types: ['Syntax', 'Noun'], evolvesAt: 22, evolvesTo: 'Speechawk', learnset: [{level: 10, move: 'Leer'}, {level: 15, move: 'Interjection Burst'}], catchDifficulty: 190 },
        'Speechawk': { sprite: 'speechawk', types: ['Syntax', 'Verb'], learnset: [{level: 25, move: 'Run-on Rant'}, {level: 30, 'move': 'Imperative Command'}], catchDifficulty: 90 },
        'Punc-tuft': { sprite: 'punctuft', types: ['Syntax'], evolvesAt: 26, evolvesTo: 'Semicolonel', learnset: [{level: 12, move: 'Comma Splice'}, {level: 18, move: 'Parenthetical Pinch'}], catchDifficulty: 180 },
        'Semicolonel': { sprite: 'semicolonel', types: ['Syntax', 'Verb'], learnset: [{level: 30, move: 'Semicolon Splice'}, {level: 36, 'move': 'Clause Connector'}], catchDifficulty: 85 },
    };
    
    const createPokemon = (species, level) => {
        let baseHp = 15, baseAtk = 8, baseDef = 5, attacks = ['Tackle'];
        switch(species) {
            case 'Synonymouse': baseHp = 20; baseAtk = 10; baseDef = 6; attacks = ['Tackle', 'Word Strike', 'Growl']; break;
            case 'Syntar': baseHp = 40; baseAtk = 18; baseDef = 17; attacks = ['Vicious Lunge', 'Proper Power', 'Roar of Knowledge', 'Paradigm Shift']; break;
            case 'Paradoxos': baseHp = 60; baseAtk = 28; baseDef = 25; attacks = ['Cosmic Prose', 'Poetic Justice', 'Sharpen', 'Paradigm Shift']; break;
            case 'Grammargoyle': baseHp = 30; baseAtk = 14; baseDef = 10; attacks = ['Headlunge', 'Leer', 'Grammar Shield', 'Jumbled Jargon']; break;
            case 'Dictionare': baseHp = 50; baseAtk = 20; baseDef = 25; attacks = ['Synonym Slam', 'Definition Strike', 'Ink Stain', 'Parenthetical Pinch']; break;
            case 'Enigmalith': baseHp = 70; baseAtk = 25; baseDef = 35; attacks = ['Heavy Tome', 'Roar of Knowledge', 'Thesis Thrust', 'Grammar Shield']; break;
            case 'Wordworm': baseHp = 15; baseAtk = 6; baseDef = 4; attacks = ['Tackle', 'Growl']; break;
            case 'SimileSlime': baseHp = 18; baseAtk = 7; baseDef = 8; attacks = ['Gooey Touch', 'Dull Drone', 'Vague Description']; break;
            case 'CommaLeon': baseHp = 22; baseAtk = 9; baseDef = 7; attacks = ['Fragmented Strike', 'Chameleon Color', 'Vivid Flash']; break;
            case 'Adjectlizard': baseHp = 30; baseAtk = 12; baseDef = 9; attacks = ['Tackle', 'Leer', 'Scale Shot', 'Piercing Gaze']; break;
            case 'Haiku-na': baseHp = 20; baseAtk = 11; baseDef = 6; attacks = ['Tackle', 'Dull Drone', 'Descriptive Verse']; break;
            case 'EpicAvis': baseHp = 42; baseAtk = 23; baseDef = 14; attacks = ['Proper Power', 'Action Verb', 'Swift Sentence']; break;
            case 'Metaphorpillar': baseHp = 16; baseAtk = 5; baseDef = 12; attacks = ['Tackle', 'Solid Stance']; break;
            case 'Analofly': baseHp = 35; baseAtk = 15; baseDef = 20; attacks = ['Chameleon Color', 'Gooey Touch', 'Vivid Flash', 'Comparative Clash']; break;
            case 'Hyper-bole': baseHp = 12; baseAtk = 14; baseDef = 3; attacks = ['Headlunge', 'Pun Power', 'Exclamatory Cry']; break;
            case 'PronounProwler': baseHp = 25; baseAtk = 13; baseDef = 7; attacks = ['Tackle', 'Leer', 'Fragmented Strike', 'Accelerate']; break;
            case 'VerbViper': baseHp = 28; baseAtk = 15; baseDef = 6; attacks = ['Possessive Jab', 'Vicious Lunge', 'Imperative Urge', 'Action Verb']; break;
            case 'Lexiconstruct': baseHp = 100; baseAtk = 50; baseDef = 50; attacks = ['Cosmic Prose', 'Heavy Tome', 'Grammar Shield', 'Personification Punch']; break;
            case 'Antonymph': baseHp = 100; baseAtk = 50; baseDef = 50; attacks = ['Cosmic Prose', 'Foil Fence', 'Antithesis', 'Poetic Justice']; break;
            case 'Nomenowl': baseHp = 18; baseAtk = 9; baseDef = 5; attacks = ['Tackle', 'Leer', 'Abstract Idea']; break;
            case 'Rhymoceros': baseHp = 35; baseAtk = 15; baseDef = 12; attacks = ['Concrete Slam', 'Synonym Slam', 'Proper Punch']; break;
            case 'Adjectoad': baseHp = 20; baseAtk = 8; baseDef = 10; attacks = ['Gooey Touch', 'Growl', 'Solid Stance', 'Colorful Curse']; break;
            case 'Stalagmight': baseHp = 25; baseAtk = 10; baseDef = 20; attacks = ['Tackle', 'Sharpen', 'Solid Stance', 'Concrete Slam']; break;
            case 'Conjun-gull': baseHp = 22; baseAtk = 12; baseDef = 8; attacks = ['Tackle', 'Vicious Lunge', 'Linking Verb']; break;
            case 'Allegator': baseHp = 28; baseAtk = 14; baseDef = 10; attacks = ['Tackle', 'Leer', 'Collective Crush']; break;
            case 'Alliteration': baseHp = 45; baseAtk = 22; baseDef = 18; attacks = ['Noun Swarm', 'Action Rush', 'Synonym Slam']; break;
            case 'Fablion': baseHp = 32; baseAtk = 16; baseDef = 9; attacks = ['Tackle', 'Roar of Knowledge', 'Sharp Wit']; break;
            case 'Mythical': baseHp = 50; baseAtk = 25; baseDef = 15; attacks = ['Vicious Lunge', 'Proper Power', 'Superlative Strike']; break;
            case 'Pun-guin': baseHp = 25; baseAtk = 10; baseDef = 13; attacks = ['Gooey Touch', 'Growl', 'Pun Power']; break;
            case 'Irony': baseHp = 48; baseAtk = 20; baseDef = 22; attacks = ['Synonym Slam', 'Chameleon Color', 'Paradigm Shift', 'Rhetorical Question']; break;
            case 'Buzzword': baseHp = 20; baseAtk = 11; baseDef = 8; attacks = ['Tackle', 'Growl', 'Interjection Burst']; break;
            case 'Droneme': baseHp = 40; baseAtk = 22; baseDef = 16; attacks = ['Vicious Lunge', 'Run-on Rant', 'Commanding Voice']; break;
            case 'Omen': baseHp = 30; baseAtk = 15; baseDef = 5; attacks = ['Leer', 'Dull Drone', 'Comma Splice']; break;
            case 'Racecar': baseHp = 25; baseAtk = 18; baseDef = 10; attacks = ['Tackle', 'Vicious Lunge', 'Accelerate']; break;
            case 'Gerundile': baseHp = 28; baseAtk = 15; baseDef = 11; attacks = ['Tackle', 'Gerund Grind', 'Vicious Lunge']; break;
            case 'Infinotaur': baseHp = 52; baseAtk = 26; baseDef = 20; attacks = ['Intransitive Strike', 'Imperative Urge', 'Vicious Lunge']; break;
            case 'Dramask': baseHp = 26; baseAtk = 12; baseDef = 14; attacks = ['Leer', 'Jumbled Jargon', 'Vivid Flash', 'Sharp Wit']; break;
            case 'Catalist': baseHp = 27; baseAtk = 16; baseDef = 9; attacks = ['Tackle', 'Sharpen', 'Accelerate']; break;
            case 'Chain Re-Action': baseHp = 50; baseAtk = 28; baseDef = 18; attacks = ['Vicious Lunge', 'Synonym Slam', 'Transitive Takedown']; break;
            case 'Finnegan': baseHp = 22; baseAtk = 10; baseDef = 8; attacks = ['Tackle', 'Descriptive Verse']; break;
            case 'Debait': baseHp = 25; baseAtk = 13; baseDef = 10; attacks = ['Tackle', 'Leer', 'Rhetorical Question']; break;
        case 'Argubass': baseHp = 48; baseAtk = 24; baseDef = 19; attacks = ['Vicious Lunge', 'Semicolon Splice', 'Synonym Slam']; break;
        case 'Cliché': baseHp = 22; baseAtk = 9; baseDef = 11; attacks = ['Tackle', 'Gooey Touch']; break;
        case 'Archetype': baseHp = 45; baseAtk = 20; baseDef = 22; attacks = ['Synonym Slam', 'Concrete Slam', 'Grammar Shield']; break;
        case 'Quotlet': baseHp = 24; baseAtk = 12; baseDef = 7; attacks = ['Tackle', 'Dialogue Dash', 'Leer']; break;
        case 'Speechawk': baseHp = 46; baseAtk = 24; baseDef = 16; attacks = ['Vicious Lunge', 'Dialogue Dash', 'Commanding Voice']; break;
        case 'Punc-tuft': baseHp = 26; baseAtk = 10; baseDef = 14; attacks = ['Tackle', 'Leer', 'Comma Splice']; break;
        case 'Semicolonel': baseHp = 50; baseAtk = 22; baseDef = 25; attacks = ['Vicious Lunge', 'Semicolon Splice', 'Grammar Shield']; break;
        }
        return { 
            species, name: species, level, 
            types: pokemonDB[species].types,
            currentHp: baseHp + (level * 5), maxHp: baseHp + (level * 5), 
            attack: baseAtk + (level * 2), defense: baseDef + (level * 2),
            xp: 0, xpToNextLevel: 100, 
            attacks: attacks.map(a => attacksDB[a]), 
            sprite: pokemonDB[species] ? pokemonDB[species].sprite : species.toLowerCase(),
            statMods: { attack: 0, defense: 0 },
            hasEvolved: false,
            status: null,
            statusTurns: 0,
        };
    };

    const trainersDB = {
        'hikerTom': { name: "Hiker Tom", pokemon: [{species: 'Wordworm', level: 6}], preBattle: ["A trainer! Finally a challenge! Let's battle!"], postBattle: ["Huff... puff... you're pretty strong. Keep it up!"], reward: 60 },
        'readerSue': { name: "Reader Sue", pokemon: [{species: 'SimileSlime', level: 7}], preBattle: ["Oh! You want to battle? My SimileSlime is as ready as a spring day!"], postBattle: ["Wow! Your skills are like a roaring fire!"], reward: 70 },
        'bookwormBarry': { name: "Bookworm Barry", pokemon: [{species: 'PronounProwler', level: 15}], preBattle: ["I've read about every creature! Let's see if your skills are textbook!"], postBattle: ["Wow, a real-world lesson! You're tougher than the texts said."], reward: 150 },
        'artistAdeline': { name: "Artist Adeline", pokemon: [{species: 'VerbViper', level: 17}], preBattle: ["I'm painting a picture of a perfect battle. You're my subject!"], postBattle: ["Such vivid action! You've inspired my next masterpiece."], reward: 170 },
        'profGrendel': { name: "Professor Grendel", pokemon: [{species: 'Dictionare', level: 25}, {species: 'VerbViper', level: 28}], preBattle: ["You dare challenge the master of semantics? Your story ends here!"], postBattle: ["Hmph. A mere fluke. You have not seen the last of my literary might!"], reward: 300 },
        'gymLeaderRhonda': { name: "Gym Leader Rhonda", pokemon: [{species: 'Haiku-na', level: 12}, {species: 'Adjectlizard', level: 14}], preBattle: ["Rhonda: 'To earn my badge, you have to climb,'", "'And beat my team in a rhyme-fueled crime!'"], postBattle: ["Your skills are sharp, your victory's prime,", "Here's the Rhyme Badge, for your time!"], reward: 400 },
        'gymLeaderLex': { name: "Gym Leader Lex", pokemon: [{species: 'Dictionare', level: 30}, {species: 'Grammargoyle', level: 28}], preBattle: ["Welcome to the grand library of battle! Let's see if your lexicon is as mighty as your creatures!"], postBattle: ["Astounding! Your command of language is impressive! You've earned this!"], reward: 500 },
        'caveExplorerDon': { name: "Explorer Don", pokemon: [{species: 'Grammargoyle', level: 22}], preBattle: ["This cave is full of rare grammar! Don't get in my way!"], postBattle: ["Hmph. Fine, you can pass. But I'll find the rarest ones first!"], reward: 220 },
        'goblinBoss': { name: "Goblin Grunt", pokemon: [{species: 'Dictionare', level: 32}], preBattle: ["GRAR! You found me! But you won't stop me from finding the legendary creature of language!"], postBattle: ["Grah! Beaten... But the master will succeed... You'll need this to get out of here."], reward: 1000 },
        'shipwreckedPilot': { name: "Disoriented Pilot", pokemon: [{species: 'Hyper-bole', level: 35}], preBattle: ["Who... who are you? Is this my ship? Get away from my ship!"], postBattle: ["Ugh... my head... a plane crash... I've been here for years...", "My love... in Lexington City... I have to get back!", "You... you saved me from my delirium. Take this. It's a special technique.", "I should have used it to fly home ages ago... I must see her!"], reward: 600 },
        'finalBosses': { name: "Goblin Rulers", pokemon: [{species: 'Dictionare', level: 50}, {species: 'Enigmalith', level: 55}], preBattle: [], postBattle: [], reward: 3500 },
        'finalRival': { name: "Champion Andy", pokemon: [{species: 'Enigmalith', level: 65}, {species: 'Antonymph', level: 70}], preBattle: ["We've come a long way. Let's see who the real champion of ELA Quest is!"], postBattle: ["Wow... You really are the best. It's been an honor."], reward: 5000 },
    };

    const elaQuestions = [
        { q: "Which word is a synonym for 'happy'?", a: ["Joyful", "Sad", "Angry", "Tired"], c: "Joyful" },
        { q: "What opposes the protagonist?", a: ["Antagonist", "Ally", "Narrator", "Mentor"], c: "Antagonist" },
        { q: "Identify the verb: 'The cat quickly climbed the tree.'", a: ["climbed", "quickly", "cat", "tree"], c: "climbed" },
        { q: "'The wind whispered' is an example of...?", a: ["Personification", "Metaphor", "Simile", "Hyperbole"], c: "Personification" },
        { q: "Which word is an antonym for 'begin'?", a: ["Finish", "Start", "Create", "Open"], c: "Finish" },
        { q: "Which is spelled correctly?", a: ["Definitely", "Definately", "Definitly", "Definantly"], c: "Definitely" },
        { q: "What is the main idea of a story?", a: ["Theme", "Plot", "Setting", "Conflict"], c: "Theme" },
        { q: "'As brave as a lion' is an example of...?", a: ["Simile", "Metaphor", "Allusion", "Irony"], c: "Simile" },
        { q: "Choose the correct pronoun: '___ and I went to the store.'", a: ["He", "Him", "His", "Them"], c: "He" },
        { q: "Which sentence is a compound sentence?", a: ["I like pizza, and I like tacos.", "I like pizza.", "Because I like pizza, I ate it.", "I like pizza, tacos, and burgers."], c: "I like pizza, and I like tacos." },
        { q: "What is an 'adjective'?", a: ["A word that describes a noun", "A word for an action", "A person, place, or thing", "A word that describes a verb"], c: "A word that describes a noun" },
        { q: "Which of these is NOT a genre of literature?", a: ["Mathematics", "Fantasy", "Mystery", "Biography"], c: "Mathematics" },
        { q: "'Her smile is the sun' is an example of...?", a: ["Metaphor", "Simile", "Personification", "Hyperbole"], c: "Metaphor" },
        { q: "Find the error: 'Their going to the park.'", a: ["Their", "going", "to", "park"], c: "Their" },
        { q: "What is the climax of a story?", a: ["The most exciting point", "The beginning", "The ending", "The setting"], c: "The most exciting point" },
        { q: "Which is spelled correctly?", a: ["Receive", "Recieve", "Reiceve", "Receeve"], c: "Receive" },
        { q: "What is an adverb?", a: ["A word describing a verb", "A word describing a noun", "A short exclamation", "A connecting word"], c: "A word describing a verb" },
        { q: "What type of conflict is a character struggling against nature?", a: ["Character vs. Nature", "Character vs. Self", "Character vs. Society", "Character vs. Character"], c: "Character vs. Nature" },
        { q: "Which punctuation mark ends a question?", a: ["?", ".", "!", ","], c: "?" },
        { q: "An 'allusion' in literature is...", a: ["A reference to another work", "An illusion or trick", "The main character's goal", "A type of rhyme"], c: "A reference to another work" },
        { q: "Which word is a synonym for 'brave'?", a: ["Courageous", "Cowardly", "Meek", "Timid"], c: "Courageous" },
        { q: "What is a 'protagonist'?", a: ["The main character", "The villain", "The narrator", "A side character"], c: "The main character" },
        { q: "'The car engine coughed and sputtered' is an example of...?", a: ["Personification", "Simile", "Metaphor", "Onomatopoeia"], c: "Personification" },
        { q: "Which is spelled correctly?", a: ["Separate", "Seperate", "Saperate", "Seperete"], c: "Separate" },
        { q: "A 'biography' is a story of a person's life written by...", a: ["Someone else", "The person themselves", "A novelist", "An unknown author"], c: "Someone else" },
        { q: "What is the setting of a story?", a: ["When and where it takes place", "The main problem", "The list of characters", "The lesson learned"], c: "When and where it takes place" },
        { q: "Which word is an antonym for 'ancient'?", a: ["Modern", "Old", "Aged", "Past"], c: "Modern" },
        { q: "'The world is a stage' is an example of...?", a: ["Metaphor", "Simile", "Alliteration", "Irony"], c: "Metaphor" },
        { q: "Choose the correct use of 'its' or 'it's': 'The dog wagged ___ tail.'", a: ["its", "it's", "it is", "its'"], c: "its" },
        { q: "Identify the noun: 'The quick brown fox jumps.'", a: ["fox", "quick", "brown", "jumps"], c: "fox" },
        { q: "What does 'hyperbole' mean?", a: ["Exaggeration for effect", "A comparison using 'like'", "Giving human qualities to objects", "A question with no answer"], c: "Exaggeration for effect" },
        { q: "'I'm so hungry I could eat a horse' is an example of...?", a: ["Hyperbole", "Simile", "Understatement", "Irony"], c: "Hyperbole" },
        { q: "Which is spelled correctly?", a: ["Necessary", "Necesary", "Neccessary", "Necassary"], c: "Necessary" },
        { q: "A story's sequence of events is its...", a: ["Plot", "Theme", "Setting", "Character arc"], c: "Plot" },
        { q: "What is a 'haiku'?", a: ["A three-line poem with a 5-7-5 syllable structure", "A four-line rhyming poem", "A long epic story", "A funny short story"], c: "A three-line poem with a 5-7-5 syllable structure" },
        { q: "Which word is a synonym for 'look'?", a: ["Gaze", "Speak", "Listen", "Feel"], c: "Gaze" },
        { q: "The perspective from which a story is told is the...", a: ["Point of View", "Climax", "Resolution", "Exposition"], c: "Point of View" },
        { q: "What is the correct spelling?", a: ["Conscience", "Concience", "Consience", "Conscence"], c: "Conscience" },
        { q: "The struggle between opposing forces in a story is the...", a: ["Conflict", "Theme", "Setting", "Dialogue"], c: "Conflict" },
        { q: "'The buzzing bee flew by' is an example of...?", a: ["Onomatopoeia", "Metaphor", "Simile", "Allusion"], c: "Onomatopoeia" },
        { q: "What is a 'verb'?", a: ["An action or state of being", "A person, place, or thing", "A descriptive word", "A connecting word"], c: "An action or state of being" },
        { q: "Which word is an antonym of 'difficult'?", a: ["Easy", "Hard", "Challenging", "Complex"], c: "Easy" },
        { q: "What does the prefix 'un-' mean in 'unhappy'?", a: ["Not", "Very", "Again", "Before"], c: "Not" },
        { q: "What is the correct spelling?", a: ["Embarrass", "Embarass", "Embarras", "Embaras"], c: "Embarrass" },
        { q: "A 'sonnet' is a poem of...", a: ["14 lines", "10 lines", "20 lines", "5 lines"], c: "14 lines" },
        { q: "What type of sentence makes a command?", a: ["Imperative", "Declarative", "Interrogative", "Exclamatory"], c: "Imperative" },
        { q: "'Peter Piper picked a peck of pickled peppers' is an example of...?", a: ["Alliteration", "Assonance", "Metaphor", "Simile"], c: "Alliteration" },
        { q: "Which word is a synonym for 'big'?", a: ["Enormous", "Tiny", "Small", "Weak"], c: "Enormous" },
        { q: "A hint or clue about what will happen later in a story is...", a: ["Foreshadowing", "Flashback", "Symbolism", "Imagery"], c: "Foreshadowing" },
        { q: "What is the correct spelling?", a: ["Weird", "Wierd", "Wiered", "Weired"], c: "Weird" },
        { q: "The general feeling or atmosphere of a story is its...", a: ["Mood", "Tone", "Theme", "Genre"], c: "Mood" },
        { q: "An author's attitude towards a subject is their...", a: ["Tone", "Mood", "Style", "Voice"], c: "Tone" },
        { q: "Choose the correct word: 'Please put the book over ___.'", a: ["there", "their", "they're", "theyr"], c: "there" },
        { q: "Which of these is a preposition?", a: ["under", "run", "beautiful", "quickly"], c: "under" },
        { q: "A comparison between two unlike things WITHOUT using 'like' or 'as' is a...", a: ["Metaphor", "Simile", "Analogy", "Allegory"], c: "Metaphor" },
        { q: "What is the plural of 'goose'?", a: ["geese", "gooses", "geeses", "goose"], c: "geese" },
        { q: "Which word is a homophone for 'ate'?", a: ["eight", "eat", "late", "it"], c: "eight" },
        { q: "The main character in a story is called the...", a: ["Protagonist", "Antagonist", "Foil", "Narrator"], c: "Protagonist" },
        { q: "What is the purpose of an exclamation mark (!)?", a: ["To show strong feeling", "To end a question", "To create a pause", "To list items"], c: "To show strong feeling" },
        { q: "Which is an example of a simple sentence?", a: ["The dog barked.", "The dog barked, and the cat ran.", "When the dog barked, the cat ran.", "The dog barked loudly."], c: "The dog barked." },
        { q: "What is the definition of 'irony'?", a: ["A contrast between expectation and reality", "A funny or amusing situation", "A sad or tragic event", "A description of a person"], c: "A contrast between expectation and reality" },
        { q: "The words 'affect' and 'effect' are often confused. 'Affect' is usually a...", a: ["Verb", "Noun", "Adjective", "Pronoun"], c: "Verb" },
        { q: "A group of lines in a poem is called a...", a: ["Stanza", "Paragraph", "Sentence", "Chapter"], c: "Stanza" },
        { q: "Which is spelled correctly?", a: ["Accommodation", "Acommodation", "Accomodation", "Acomodation"], c: "Accommodation" },
        { q: "The author's main message or moral is the story's...", a: ["Theme", "Plot", "Setting", "Climax"], c: "Theme" },
        { q: "What is the past tense of 'run'?", a: ["ran", "runned", "running", "runs"], c: "ran" },
        { q: "A 'foil' character is a character who...", a: ["Contrasts with another character", "Is the hero's best friend", "Tells the story", "Is secretly the villain"], c: "Contrasts with another character" },
        { q: "Which punctuation is used to show possession?", a: ["Apostrophe", "Comma", "Period", "Semicolon"], c: "Apostrophe" },
        { q: "What is the synonym for 'smart'?", a: ["Intelligent", "Foolish", "Brave", "Kind"], c: "Intelligent" },
        { q: "'The sun smiled down on us' is an example of...", a: ["Personification", "Metaphor", "Alliteration", "Onomatopoeia"], c: "Personification" },
        { q: "What does the suffix '-ful' mean in 'beautiful'?", a: ["Full of", "Without", "Able to be", "In the style of"], c: "Full of" },
        { q: "Which sentence uses 'your' and 'you're' correctly?", a: ["You're going to love your new creature.", "Your going to love you're new creature.", "You're going to love you're new creature.", "Your going to love your new creature."], c: "You're going to love your new creature." },
        { q: "What is the purpose of a paragraph?", a: ["To group related sentences", "To make the text longer", "To end a chapter", "To introduce a character"], c: "To group related sentences" },
        { q: "The word 'autobiography' means the story of a person's life written by...", a: ["Themselves", "Someone else", "A historian", "A journalist"], c: "Themselves" },
        { q: "What part of speech is 'happily' in 'She skipped happily'?", a: ["Adverb", "Verb", "Adjective", "Noun"], c: "Adverb" },
        { q: "An 'antonym' is a word that has the ___ meaning.", a: ["opposite", "same", "similar", "related"], c: "opposite" },
        { q: "Which is spelled correctly?", a: ["Mischievous", "Mischevious", "Mischievious", "Mischeivous"], c: "Mischievous" },
        { q: "A 'symbol' in literature is an object that...", a: ["Represents a larger idea", "Is described in great detail", "Is a main part of the plot", "Talks to the characters"], c: "Represents a larger idea" },
        { q: "What is a 'conjunction'?", a: ["A word that connects words or phrases", "A descriptive word", "A person, place, or thing", "A word of action"], c: "A word that connects words or phrases" },
        { q: "Which of the following is a coordinating conjunction?", a: ["but", "because", "although", "while"], c: "but" },
        { q: "The end of the story where the conflict is resolved is the...", a: ["Resolution", "Climax", "Exposition", "Rising Action"], c: "Resolution" },
        { q: "A 'first-person' narrator uses which pronouns?", a: ["I, me, my", "He, she, they", "You, your", "It, its"], c: "I, me, my" },
        { q: "Which is the correct spelling?", a: ["Privilege", "Privelege", "Privilage", "Priviledge"], c: "Privilege" },
        { q: "The use of 'and' or 'but' to join two simple sentences creates a...", a: ["Compound sentence", "Complex sentence", "Simple sentence", "Fragment"], c: "Compound sentence" },
        { q: "What is the antonym of 'expand'?", a: ["Contract", "Grow", "Widen", "Stretch"], c: "Contract" },
        { q: "The reason an author writes something is their...", a: ["Purpose", "Audience", "Genre", "Format"], c: "Purpose" },
        { q: "'Bam!' and 'Swoosh!' are examples of...", a: ["Onomatopoeia", "Alliteration", "Assonance", "Simile"], c: "Onomatopoeia" },
        { q: "What is the superlative form of 'good'?", a: ["best", "better", "gooder", "goodest"], c: "best" },
        { q: "Choose the correct word: 'I have ___ homework to do.'", a: ["too much", "to much", "two much", "twoo much"], c: "too much" },
        { q: "A story passed down through generations is often called...", a: ["Folklore", "A novel", "A biography", "An essay"], c: "Folklore" },
        { q: "What is a 'rhyme scheme'?", a: ["The pattern of rhymes in a poem", "A type of stanza", "The rhythm of a poem", "A poem with no rhymes"], c: "The pattern of rhymes in a poem" },
        { q: "Which is spelled correctly?", a: ["Rhythm", "Rythm", "Rhythim", "Rhythem"], c: "Rhythm" },
        { q: "A 'dramatic monologue' is a speech by...", a: ["One character to a silent audience", "Two characters to each other", "The narrator of a story", "A group of characters"], c: "One character to a silent audience" },
        { q: "The dictionary definition of a word is its...", a: ["Denotation", "Connotation", "Etymology", "Context"], c: "Denotation" },
        { q: "The feeling or idea a word suggests is its...", a: ["Connotation", "Denotation", "Syllable", "Pronunciation"], c: "Connotation" },
        { q: "What is an 'oxymoron'?", a: ["A figure of speech with contradictory terms", "An extreme exaggeration", "A reference to another work", "A funny comparison"], c: "A figure of speech with contradictory terms" },
        { q: "Which of these is an oxymoron?", a: ["Jumbo shrimp", "Huge mouse", "Brave lion", "Fast turtle"], c: "Jumbo shrimp" },
        { q: "What is the plural of 'cactus'?", a: ["cacti", "cactuses", "cactus", "cactuss"], c: "cacti" },
        { q: "Which is spelled correctly?", a: ["Conscientious", "Conciencious", "Consentious", "Conscentious"], c: "Conscientious" },
        { q: "The repetition of vowel sounds in nearby words is...", a: ["Assonance", "Alliteration", "Consonance", "Rhyme"], c: "Assonance" },
        { q: "What is a 'euphemism'?", a: ["A mild phrase used for a harsh one", "A word that sounds like its meaning", "A long and boring speech", "A logical fallacy"], c: "A mild phrase used for a harsh one" },
        { q: "What is the comparative form of 'bad'?", a: ["worse", "badder", "more bad", "worst"], c: "worse" },
        { q: "The main point of a non-fiction text is the...", a: ["Central Idea", "Theme", "Plot", "Conclusion"], c: "Central Idea" },
        { q: "Which sentence is punctuated correctly?", a: ["Let's eat, Grandma.", "Lets eat Grandma.", "Let's eat Grandma.", "Lets eat, Grandma."], c: "Let's eat, Grandma." },
        { q: "A word that imitates a sound is an...", a: ["Onomatopoeia", "Adjective", "Interjection", "Pronoun"], c: "Onomatopoeia" },
        { q: "In 'To Kill a Mockingbird', who is the narrator?", a: ["Scout", "Atticus", "Jem", "Boo Radley"], c: "Scout" },
        { q: "What is a 'palindrome'?", a: ["A word read the same forwards and backward", "A word with multiple meanings", "A rhyming couplet", "A type of metaphor"], c: "A word read the same forwards and backward" },
        { q: "Which word is a palindrome?", a: ["level", "word", "grammar", "test"], c: "level" },
        { q: "What is a 'verb tense'?", a: ["It shows the time an action occurred", "It shows who performed an action", "It describes the action", "It modifies the action"], c: "It shows the time an action occurred" },
        { q: "Which is spelled correctly?", a: ["Irresistible", "Irresistable", "Iresistible", "Iresisteble"], c: "Irresistible" },
        { q: "The 'rising action' of a plot is where...", a: ["The conflict builds", "The story concludes", "The characters are introduced", "The conflict is resolved"], c: "The conflict builds" },
        { q: "Choose the correct word: 'The book had a profound ___ on me.'", a: ["effect", "affect", "affects", "effects"], c: "effect" },
        { q: "What is the opposite of 'transparent'?", a: ["Opaque", "Clear", "Bright", "Shiny"], c: "Opaque" },
        { q: "What is the term for a word's emotional or cultural association?", a: ["Connotation", "Denotation", "Definition", "Origin"], c: "Connotation" },
        { q: "Which of these is a 'modal verb'?", a: ["might", "run", "is", "eat"], c: "might" },
        { q: "A 'dynamic character' is one who...", a: ["Changes over the course of a story", "Stays the same throughout the story", "Is the main character", "Is a minor character"], c: "Changes over the course of a story" },
        { q: "Which is spelled correctly?", a: ["Exaggerate", "Exagerate", "Exadgerate", "Exaggerat"], c: "Exaggerate" },
        { q: "What does the root 'aud' mean, as in 'audible'?", a: ["Hear", "See", "Touch", "Smell"], c: "Hear" },
        { q: "'The silence was deafening' is an example of an...", a: ["Oxymoron", "Onomatopoeia", "Allusion", "Analogy"], c: "Oxymoron" },
        { q: "A comparison of two things for the purpose of explanation is an...", a: ["Analogy", "Metaphor", "Simile", "Allegory"], c: "Analogy" },
        { q: "Choose the correct word: 'I would rather eat cake ___ pie.'", a: ["than", "then", "their", "there"], c: "than" },
        { q: "A story where characters and events are symbols for ideas is an...", a: ["Allegory", "Anecdote", "Autobiography", "Article"], c: "Allegory" },
        { q: "What is the plural of 'analysis'?", a: ["analyses", "analysises", "analysae", "analysis"], c: "analyses" },
        { q: "Which punctuation mark is used to join two closely related independent clauses?", a: ["Semicolon", "Comma", "Dash", "Colon"], c: "Semicolon" },
        { q: "Which is spelled correctly?", a: ["Grateful", "Greatful", "Gratefull", "Greatfull"], c: "Grateful" },
        { q: "The word 'bibliophile' refers to a lover of...", a: ["Books", "Music", "Art", "Nature"], c: "Books" },
        { q: "What is a 'gerund'?", a: ["A verb ending in '-ing' that acts as a noun", "A verb ending in '-ed'", "The main verb of a sentence", "A helping verb"], c: "A verb ending in '-ing' that acts as a noun" },
        { q: "In the sentence 'Swimming is fun,' what is the gerund?", a: ["Swimming", "is", "fun", "None"], c: "Swimming" },
        { q: "What is 'hubris' in literature?", a: ["Excessive pride or self-confidence", "A character's fatal flaw", "The main character's goal", "A feeling of sadness"], c: "Excessive pride or self-confidence" },
        { q: "Which is spelled correctly?", a: ["Cemetery", "Cematery", "Cemetary", "Cematery"], c: "Cemetery" },
        { q: "What is a 'non sequitur'?", a: ["A conclusion that does not logically follow", "The main point of an argument", "A supporting detail", "A counter-argument"], c: "A conclusion that does not logically follow" },
        { q: "The main character of a story is the...", a: ["Protagonist", "Antagonist", "Narrator", "Foil"], c: "Protagonist" },
        { q: "'Flashback' is a literary device that...", a: ["Shows an event from the past", "Hints at future events", "Creates a sad mood", "Compares two things"], c: "Shows an event from the past" },
        { q: "What is an 'infinitive' form of a verb?", a: ["To + verb (e.g., to run)", "The past tense form", "The present tense form", "The '-ing' form"], c: "To + verb (e.g., to run)" },
        { q: "Which is spelled correctly?", a: ["Fahrenheit", "Farenheit", "Fahrenhiet", "Farenhiet"], c: "Fahrenheit" },
        { q: "What is 'satire'?", a: ["Using humor or irony to criticize people's stupidity", "A sad story with a moral", "A story about magical creatures", "A type of rhyming poem"], c: "Using humor or irony to criticize people's stupidity" },
        { q: "The author's choice of words is known as...", a: ["Diction", "Syntax", "Tone", "Mood"], c: "Diction" },
        { q: "What is the arrangement of words into sentences and phrases?", a: ["Syntax", "Diction", "Grammar", "Punctuation"], c: "Syntax" },
        { q: "What is a 'soliloquy'?", a: ["A speech by a character alone on stage", "A conversation between two characters", "The narrator's commentary", "A rhyming couplet"], c: "A speech by a character alone on stage" },
        { q: "Which is spelled correctly?", a: ["Playwright", "Playwrite", "Playrite", "Plawright"], c: "Playwright" },
        { q: "The phrase 'all hands on deck' (where 'hands' represent sailors) is an example of...", a: ["Synecdoche", "Metonymy", "Hyperbole", "Irony"], c: "Synecdoche" },
        { q: "What is the literary term for a release of emotional tension?", a: ["Catharsis", "Climax", "Epiphany", "Denouement"], c: "Catharsis" },
        { q: "Which punctuation mark is used to indicate an omission of words?", a: ["Ellipsis (...)", "Semicolon (;)", "Colon (:)", "En dash (–)"], c: "Ellipsis (...)" },
        { q: "A 'dangling modifier' is an error where a descriptive phrase...", a: ["Doesn't logically modify anything in the sentence", "Is placed at the end of a sentence", "Is too long", "Uses incorrect grammar"], c: "Doesn't logically modify anything in the sentence" },
        { q: "Which word means 'lasting for a very short time'?", a: ["Ephemeral", "Eternal", "Permanent", "Ubiquitous"], c: "Ephemeral" },
        { q: "Which is spelled correctly?", a: ["Connoisseur", "Connoiseur", "Connaisseur", "Connoisser"], c: "Connoisseur" },
        { q: "The 'subjunctive mood' is used to express...", a: ["Wishes, hypotheticals, or non-factual statements", "Commands and requests", "Statements of fact", "Strong emotions"], c: "Wishes, hypotheticals, or non-factual statements" },
        { q: "What does the root 'chron' mean, as in 'chronological'?", a: ["Time", "Life", "Earth", "Write"], c: "Time" },
        { q: "An 'epiphany' is a moment of...", a: ["Sudden realization or insight", "Great sadness", "Intense action", "Humorous relief"], c: "Sudden realization or insight" },
        { q: "Which word is the opposite of 'esoteric'?", a: ["Commonplace", "Mysterious", "Difficult", "Hidden"], c: "Commonplace" },
        { q: "A 'red herring' in a story is a clue that is intended to be...", a: ["Misleading or distracting", "Extremely important", "Symbolic", "A type of foreshadowing"], c: "Misleading or distracting" },
        { q: "What is a 'tercet' in poetry?", a: ["A stanza of three lines", "A stanza of two lines", "A stanza of four lines", "A single line"], c: "A stanza of three lines" },
        { q: "Which is spelled correctly?", a: ["Liaison", "Liason", "Laision", "Liaeson"], c: "Liaison" },
        { q: "What part of speech is a 'participle'?", a: ["A verb form that acts as an adjective", "A verb form that acts as a noun", "A possessive pronoun", "A type of conjunction"], c: "A verb form that acts as an adjective" },
        { q: "The saying 'This is the beginning of the end' is an example of a...", a: ["Paradox", "Tautology", "Euphemism", "Cliché"], c: "Paradox" },
        { q: "Choose the correct word: 'The new rules will not ___ the final outcome.'", a: ["affect", "effect", "affects", "effects"], c: "affect" },
        { q: "What does the root word 'path' mean, as in 'empathy'?", a: ["Feeling or disease", "Foot", "Light", "Life"], c: "Feeling or disease" },
        { q: "What is the term for a writer's unique style of expression?", a: ["Voice", "Tone", "Mood", "Diction"], c: "Voice" },
        { q: "Which is spelled correctly?", a: ["Bureaucracy", "Beauocracy", "Bureacracy", "Beauracracy"], c: "Bureaucracy" },
        { q: "Addressing an absent person or an inanimate object is a literary device called...", a: ["Apostrophe", "Allusion", "Analogy", "Allegory"], c: "Apostrophe" },
        { q: "A 'deus ex machina' is a plot device where...", a: ["A seemingly unsolvable problem is suddenly resolved", "The hero dies unexpectedly", "The story ends on a cliffhanger", "Two characters fall in love"], c: "A seemingly unsolvable problem is suddenly resolved" },
        { q: "Which word means 'present, appearing, or found everywhere'?", a: ["Ubiquitous", "Scarce", "Unique", "Ephemeral"], c: "Ubiquitous" },
        { q: "What is a 'trope'?", a: ["A common or overused theme or device", "The main message of a story", "A type of character", "The historical context of a text"], c: "A common or overused theme or device" },
        { q: "What is a 'portmanteau'?", a: ["A word blending the sounds of two others", "A very long sentence", "A type of poetic meter", "An ancient manuscript"], c: "A word blending the sounds of two others" },
        { q: "Which is spelled correctly?", a: ["Acquiesce", "Acqueisce", "Acquiesse", "Acqueise"], c: "Acquiesce" },
        { q: "The 'denouement' of a plot is the...", a: ["Final part where strands are drawn together", "The highest point of tension", "The introduction of characters", "A misleading clue"], c: "Final part where strands are drawn together" },
        { q: "What does the Latin root 'mal' mean, as in 'malevolent'?", a: ["Bad or evil", "Good", "Small", "Large"], c: "Bad or evil" },
        { q: "An 'anachronism' is an element in a story that is...", a: ["Out of its proper time period", "Symbolic of a larger idea", "A recurring theme", "The hero's primary goal"], c: "Out of its proper time period" },
        { q: "Which sentence uses an 'appositive' phrase correctly?", a: ["My brother, a skilled artist, painted that.", "My brother a skilled artist painted that.", "My brother painted that, a skilled artist.", "A skilled artist, my brother he painted that."], c: "My brother, a skilled artist, painted that." },
        { q: "What is 'verisimilitude' in fiction?", a: ["The appearance of being true or real", "A story's hidden moral", "The use of rhyming words", "A predictable plot"], c: "The appearance of being true or real" },
        { q: "Which is spelled correctly?", a: ["Sacrilegious", "Sacreligious", "Sacriligious", "Sacrilegeous"], c: "Sacrilegious" },
        { q: "A 'doppelgänger' is a character that is a...", a: ["Look-alike or double of another character", "Character who cannot speak", "Wise old mentor", "Mythical beast"], c: "Look-alike or double of another character" },
        { q: "Which of the following is a 'past participle'?", a: ["broken", "broke", "breaking", "breaks"], c: "broken" },
        { q: "A story that is a 'parody' aims to...", a: ["Imitate and mock another work for comic effect", "Tell a serious historical account", "Teach a straightforward moral lesson", "Create a feeling of suspense"], c: "Imitate and mock another work for comic effect" },
        { q: "What does the prefix 'ambi-' mean, as in 'ambidextrous'?", a: ["Both", "Against", "Before", "Around"], c: "Both" },
        { q: "Which is spelled correctly?", a: ["Pharaoh", "Pharoah", "Phaorah", "Pharoh"], c: "Pharaoh" },
        { q: "The phrase 'darkness visible' from Milton's *Paradise Lost* is an example of a...", a: ["Paradox", "Simile", "Euphemism", "Cliché"], c: "Paradox" },
        { q: "What is the study of word origins called?", a: ["Etymology", "Entomology", "Ecology", "Etiquette"], c: "Etymology" },
        { q: "A 'spoonerism' is an error in speech where...", a: ["Initial sounds of words are swapped", "Words are spoken backwards", "A speaker uses too many puns", "A story has no clear ending"], c: "Initial sounds of words are swapped" },
        { q: "Which of the following is an 'indefinite pronoun'?", a: ["Anyone", "He", "Them", "Your"], c: "Anyone" },
        { q: "A 'zeugma' is a figure of speech where a word applies to two others in different senses. Which is an example?", a: ["She broke his car and his heart.", "The wind howled loudly.", "He is as strong as an ox.", "The pen is mightier than the sword."], c: "She broke his car and his heart." },
        { q: "Which is spelled correctly?", a: ["Millennium", "Millenium", "Milennium", "Millennuim"], c: "Millennium" },
        { q: "The term 'in medias res' means to begin a story...", a: ["In the middle of the action", "At the very beginning", "With a description of the setting", "With the character's backstory"], c: "In the middle of the action" },
        { q: "What does the root 'spec' mean, as in 'spectator'?", a: ["To see or look", "To speak", "To feel", "To carry"], c: "To see or look" },
        { q: "A 'Pyrrhic victory' is a victory that...", a: ["Comes at too great a cost", "Is achieved with no effort", "Is celebrated by everyone", "Was predicted long ago"], c: "Comes at too great a cost" },
        { q: "Which punctuation mark is also known as a 'solidus'?", a: ["Forward slash (/)", "Hyphen (-)", "Ampersand (&)", "Asterisk (*)"], c: "Forward slash (/)" },
        { q: "A 'tautology' is the...", a: ["Needless repetition of an idea in different words", "Use of humor to criticize", "Main argument of a paper", "Final sentence of a paragraph"], c: "Needless repetition of an idea in different words" },
        { q: "Which is spelled correctly?", a: ["Supersede", "Supercede", "Superceed", "Superside"], c: "Supersede" }
    ];
    let currentBattle = null;

    const sprites = {
        player: '👨‍🎤', mom: '👩', professor: '👨‍🏫', rival: '😒', friend: '😊', villager: '🧔', villager2: '👱‍♀️', hiker: '🥾', poeFan: '🧛', nurse: '👩‍⚕️', shopkeep: '🏪', gymLeader: '🏆', chef: '👨‍🍳',
        poet: '✒️', computer: '💻', bookworm: '🐛', sign: '🪧', lightbulb: '💡', boat: '⛵️', boulder: '🪨', pilot: '👨‍✈️',
        pokeball: '🔴', tree: '🌳', door: '🚪', bed: '🛏️', tv: '📺', bookshelf: '📚', table: '🍽️', dictionary: '📖', palmTree: '🌴',
        gate: '🚧', stairsUp: '⬆️', ladder: '🪜', flower: '🌼', graduate: '🧑‍🎓', hole: '⚫️', goblin: '👺', ranger: '🤠', bait: '🍎',
        synonymouse: '🐭', syntar: '🐀', paradoxos: '👾', thesaurusrex: '🦖', wordworm: '🐛', grammargoyle: '👹', dictionare: '🦍', enigmalith: '👿', simileslime: '💧', commaleon: '🦎', adjectlizard: '🐊',
        haikuna: '🕊️', epicavis: '🦅', metaphorpillar: '🦋', analofly: '🪲', hyperbole: '🐂', pronounprowler: '🐆', verbviper: '🐍', lexiconstruct: '🗿', antonymph: '🧚',
        'chainreaction': '🐅',
        fisherman: '🎣', finnegan: '🐠', debait: '🐟', argubass: '🦈',
        cliche: '🐡', archetype: '🐙', quotlet: '🦉', speechawk: '🦅', punctuft: '🦔', semicolonel: '🦡', fablion: '🦁', mythical: '🐉'
    };

    const drawSprite = (spriteKey, x, y, walkOffset = 0) => { 
        ctx.font = `${tileSize * 0.8}px serif`; 
        ctx.textAlign = 'center'; 
        ctx.textBaseline = 'middle'; 
        ctx.fillText(sprites[spriteKey], x * tileSize + tileSize / 2, y * tileSize + tileSize / 2 + walkOffset); 
    };

    // --- Interaction Handlers ---
    // Moved all handle... functions here to be defined before `maps` object.

    function handleBedInteraction() { if (gameState.playerParty.length > 0) { gameState.playerParty.forEach(p => p.currentHp = p.maxHp); return ["You took a short nap.", "Your team is fully healed!"]; } return "A comfy bed."; }

    function handlePCInteraction() {
        const choices = [
            { text: "Access Storage", callback: () => {
                gameState.inDialogue = false;
                messageText.textContent = '';
                updatePCUI();
                openScene(pcScene);
            }},
            { text: "Save Game", callback: () => {
                saveGame();
                startDialogue("Game saved successfully!");
            }}
        ];

        if (gameState.teleportUnlocked) {
            choices.push({ text: "Home Warp", callback: () => {
                startDialogue(["You connected to the home network...", "Warping complete!"], () => {
                    changeMap('playerHouse', 4, 4);
                });
            }});
        }

        choices.push({ text: "Cancel", callback: () => {
            gameState.inDialogue = false;
            messageText.textContent = '';
        }});

        showChoices("A PC. What would you like to do?", choices);
        return null;
    }
    
    function handleProfessorInteraction() {
        if (gameState.playerParty.length > 0) {
            return "Now that you have a partner, a great adventure begins! Go on, get out there!";
        }
        startDialogue([
            "Ah, you're here! I'm Professor Lexicon.",
            "Your rival, Andy, and the other trainers were early and took the first pickings...",
            "But I saved one special creature just for you!",
            "It's a Synonymouse! Please, take good care of it.",
        ], () => {
            const newPokemon = createPokemon("Synonymouse", 5);
            addPokemonToParty(newPokemon);
            saveGame();
            startDialogue([
                "You got a SYNONYMOUSE!",
                "Synonymouse was added to your party."
            ]);
        });
        return null;
    }

    function handleGateInteraction() {
        if (gameState.devModeActive || gameState.rivalDefeated) {
             changeMap('route1', 7, 4);
             return null;
        }
        if (gameState.playerParty.length === 0) return "The gate is locked tight.";
        if (gameState.inBattle || gameState.inDialogue) return;
        startDialogue([ "Andy: 'Hold it right there!'", "'I've been studying! I challenge you to a battle!'" ], () => startBattle([createPokemon('Grammargoyle', 7)], 'Andy'));
        return null;
    }

    function handleHoleEntrance() {
        if (gameState.earthquake1Triggered) {
            changeMap('caveLevel1', 2, 2);
            return null;
        }
        return null; // No interaction before earthquake
    }
    
    function handleBoulderInteraction() {
        if (gameState.earthquake2Triggered && !pokemonDB['Lexiconstruct'].caught) {
            maps.caveLevel1.layout[3][14] = 28; // Make boulder passable
            return "The boulder crumbles away!";
        } else if (pokemonDB['Lexiconstruct'].caught) {
            return "The path to the legendary is clear."
        }
        return "A massive boulder blocks the path. It won't budge.";
    }

    function handleLegendaryBattle() {
        if(gameState.pokedex['Lexiconstruct']?.caught) {
            return "The pedestal is empty. The legendary creature is gone."
        }
        startDialogue(["A huge stone creature stirs...", "It's the Legendary LEXICONSTRUCT!"], () => {
            startBattle([createPokemon('Lexiconstruct', 70)], "Wild Lexiconstruct");
        });
        return null;
    }
    
    function handleFinalRivalBattle() {
        if (gameState.defeatedTrainers.includes('finalRival')) {
            return "Andy: 'That was the best battle of my life. Thanks, friend.'";
        }
        if (!gameState.pokedex['Lexiconstruct']?.caught) {
            return "Andy: 'I'm waiting for a true challenge. Prove your mastery by catching the legendary Lexiconstruct first!'";
        }
        
        // If the player has the legendary and hasn't been defeated, start the battle.
        startDialogue([
            "Andy: 'Whoa, you caught it! Amazing!'", 
            ...trainersDB.finalRival.preBattle
        ], () => {
             startBattle(trainersDB.finalRival.pokemon.map(p => createPokemon(p.species, p.level)), trainersDB.finalRival.name, 'finalRival');
        });
        return null;
    }

    function handleCaptainInteraction() {
        if (gameState.inventory.engineCog > 0) {
            gameState.inventory.engineCog = 0;
            const captainObject = maps.homeBay.objects['9,5'];
            captainObject.interaction = startSailingSequence;
            saveGame();
            return ["Arr, what's this? This is the exact Engine Cog I need for me engine! You found it!", "Give me a moment...", "All fixed! We can set sail whenever you're ready! (Talk to me again to leave)."];
        }
        if (gameState.defeatedTrainers.includes('goblinBoss') && gameState.inventory.engineCog === 0) {
            startSailingSequence();
            return null;
        }

        return "Arr, my boat's engine is sputtering. It's out of order right now. But I have a feeling it will be important later... that's called foreshadowing.";
    }
    
    function startSailingSequence() {
        startDialogue(["Captain: All aboard!"], () => {
            startDialogue(["You set sail on the open sea...", "The water is calm and the sky is clear."], () => {
                setTimeout(() => {
                    startDialogue(["Suddenly, the sea begins to churn! Another earthquake!"], () => {
                        shakeScreen(3000);
                        setTimeout(() => {
                            gameState.earthquake2Triggered = true;
                            startDialogue(["A colossal wave crashes over the boat!", "Everything goes black..."], () => {
                                gameState.playerParty.forEach(p => { if (p.currentHp > 1) p.currentHp = Math.ceil(p.currentHp / 4); });
                                changeMap('desertedIsland', 3, 7);
                                startDialogue("You wake up on a sandy beach, your creatures weak...");
                            });
                        }, 3000);
                    });
                }, 2000);
            });
        });
        return null;
    }

    function handleNurseInteraction() { 
        if(gameState.playerParty.length > 0) { 
            gameState.playerParty.forEach(p => p.currentHp = p.maxHp); 
            saveGame();
            return "Your team has been restored to full health!"; 
        } 
        return "Welcome to the Word Center!"; 
    }
    
    function confirmPurchase(itemName, price, description, onConfirm) {
        showChoices(`${itemName}: ${description} It costs $${price}. Buy it?`, [
            { text: "Yes", callback: () => {
                if (gameState.money >= price) {
                    gameState.money -= price;
                    onConfirm();
                    saveGame();
                    startDialogue(`You bought one ${itemName}.`, () => handleShopInteraction());
                } else {
                    startDialogue("Sorry, you don't have enough money.", () => handleShopInteraction());
                }
            }},
            { text: "No", callback: () => handleShopInteraction() }
        ]);
    }

    function handleShopInteraction() {
        showChoices("Welcome! What can I get for you?", [
            { text: "Potion", callback: () => confirmPurchase("Potion", 25, itemsDB.potions.description, () => gameState.inventory.potions++) },
            { text: "Word Ball", callback: () => confirmPurchase("Word Ball", 50, itemsDB.wordballs.description, () => gameState.inventory.wordballs++) },
            { text: "Great Phrase", callback: () => confirmPurchase("Great Phrase", 200, itemsDB.greatphrases.description, () => gameState.inventory.greatphrases++) },
            { text: "Ultra Sentence", callback: () => confirmPurchase("Ultra Sentence", 500, itemsDB.ultrasentences.description, () => gameState.inventory.ultrasentences++) },
            { text: "Leave", callback: () => startDialogue("Come again!") }
        ]); return null;
    }

    const poeQuotes = [ "Quoth the Raven, 'Nevermore.'", "All that we see or seem is but a dream within a dream.", "The boundaries which divide Life from Death are at best shadowy and vague.", "I was never really insane except upon occasions when my heart was touched.", "Words have no power to impress the mind without the exquisite horror of their reality.", "To be buried alive is, beyond question, the most terrific of these extremes which has ever fallen to the lot of mere mortality.", "I have great faith in fools - self-confidence my friends call it.", "The true genius shudders at incompleteness.", "I became insane, with long intervals of horrible sanity.", "Beauty of whatever kind, in its supreme development, invariably excites the sensitive soul to tears.", "Believe nothing you hear, and only one half that you see.", "The death of a beautiful woman is, unquestionably, the most poetical topic in the world.", "Men have called me mad; but the question is not yet settled.", "That which you mistake for madness is but over-acuteness of the senses.", "From childhood's hour I have not been as others were.", "I have no faith in human perfectibility. I think that human exertion will have no appreciable effect upon humanity.", "Sleep, those little slices of death — how I loathe them.", "The scariest monsters are the ones that lurk within our souls.", "There is no exquisite beauty without some strangeness in the proportion.", "To vilify a great man is the readiest way in which a little man can himself attain greatness." ];
    function handlePoeInteraction() { return poeQuotes[Math.floor(Math.random() * poeQuotes.length)]; }
    
    function handleDeathMasheenInteraction() {
        if (!gameState.hasMetDeathMasheen) {
            startDialogue(
                ["DeathMasheen34: 'Leveled Up Learning is the future!'"],
                () => {
                    gameState.hasMetDeathMasheen = true;
                    const gamerObject = maps.cityHouse3.objects['2,3'];
                    gamerObject.sprite = 'graduate';
                    gamerObject.interaction = "Tom: 'I'm going to be a principal some day. Gamification rules!'";
                }
            );
            return null;
        }
        return "Tom: 'I'm going to be a principal some day. Gamification rules!'";
    }

    function handleGymLeaderInteraction() {
        if (gameState.gymBadges.rhyme) return "You've earned the Rhyme Badge. Continue your journey!";
        if (gameState.playerParty.length === 0) return "You need a partner to challenge a gym!";
        if (gameState.playerParty.length > 0 && gameState.playerParty.every(p => p.level < 10)) return ["My rhymes are tough, my rhythm's tight,", "A level 10 you'll need to fight!"];
        startDialogue(trainersDB.gymLeaderRhonda.preBattle, () => startBattle(trainersDB.gymLeaderRhonda.pokemon.map(p => createPokemon(p.species, p.level)), 'Gym Leader Rhonda', 'gymLeaderRhonda'));
    }

    function handleSynonymGymLeaderInteraction() {
        if (gameState.gymBadges.synonym) return "Your vocabulary is truly vast. Go and continue your quest.";
        if (gameState.playerParty.length === 0) return "You need a partner to challenge a gym!";
        if (gameState.playerParty.length > 0 && gameState.playerParty.every(p => p.level < 25)) return ["My words are weighty, my knowledge deep.", "Return when your team's level has made a leap.", "(Recommended Level: 25+)"];
        startDialogue(trainersDB.gymLeaderLex.preBattle, () => startBattle(trainersDB.gymLeaderLex.pokemon.map(p => createPokemon(p.species, p.level)), 'Gym Leader Lex', 'gymLeaderLex'));
    }

    function handleNorthGate() {
        if (gameState.devModeActive) { changeMap('route2', 7, 13); return null; }
        if(!gameState.gymBadges.rhyme) return "A guard blocks the way. 'Only trainers who have earned the Rhyme Badge may pass!'";
        if(!gameState.rivalDefeatedPostGym) {
            startDialogue(["Andy: 'You got a gym badge? Hah! Just lucky!'", "'Let's see how you handle a REAL battle!'"], () => {
                startBattle([createPokemon('Grammargoyle', 13), createPokemon('CommaLeon', 12)], 'Andy');
            });
            return null;
        }
        changeMap('route2', 7, 13);
        return null;
    }

    function handleTrainerBattle(trainerId) {
        if(gameState.defeatedTrainers.includes(trainerId)) {
            startDialogue(trainersDB[trainerId].postBattle);
            if (trainerId === 'shipwreckedPilot') {
                 startDialogue(["Pilot: It's time for me to go home."], () => {
                     changeMap('village', 10, 10);
                     startDialogue("The pilot drops you off and flies away towards Lexington City.");
                 });
            }
            return null;
        }
        startDialogue(trainersDB[trainerId].preBattle, () => {
            const opponentPokemons = trainersDB[trainerId].pokemon.map(p => createPokemon(p.species, p.level));
            startBattle(opponentPokemons, `Trainer ${trainersDB[trainerId].name}`, trainerId);
        });
        return null;
    }

    function handleLHItem() {
        if (gameState.inventory.LH01LuminousHyperbole > 0) {
            return "An empty pedestal. You already took the item here.";
        }
        gameState.inventory.LH01LuminousHyperbole = 1;
        delete maps.adjectiveWoods.objects['14,8'];
        saveGame();
        return [ "You found LH01 (Luminous Hyperbole)!", itemsDB.LH01LuminousHyperbole.description ];
    }

    function handlePoetInteraction() {
        if (gameState.quests.poetInspiration === 'completed') {
            return "Thank you again. My mind is overflowing with verses!";
        }

        const hasHaikuna = gameState.playerParty.some(p => p.species === 'Haiku-na');

        if (gameState.quests.poetInspiration === 'started' && hasHaikuna) {
            startDialogue([
                "Poet: Is that... a Haiku-na? Its form... so perfect!",
                "Five syllables... then seven... then five once more...",
                "Oh, inspiration flows! Thank you, young wordsmith!",
                "Please, take this for your troubles."
            ], () => {
                gameState.quests.poetInspiration = 'completed';
                gameState.inventory.greatphrases += 1;
                gameState.money += 200;
                saveGame();
                startDialogue("You received a Great Phrase and $200!");
            });
            return null;
        }

        if (gameState.quests.poetInspiration === 'started') {
            return "Please, find me a Haiku-na. The sight of one would be a symphony to my soul.";
        }

        showChoices("Poet: Alas, my muse has fled! I long to see a living poem... a Haiku-na! If only I could see one, my inspiration would surely return! Will you help me?", [
            {
                text: "Yes",
                callback: () => {
                    gameState.quests.poetInspiration = 'started';
                    saveGame();
                    startDialogue("Poet: Oh, thank you! I shall await the day you return with that graceful creature.");
                }
            },
            {
                text: "No",
                callback: () => {
                    startDialogue("Poet: *sigh* I understand. Art cannot be rushed.");
                }
            }
        ]);
        return null;
    }

    function handleChefInteraction() {
        if (gameState.quests.chefsMenu === 'completed') {
            return "Chef: The customers love the new menu! It's all thanks to you!";
        }

        const hasAdjectlizard = gameState.playerParty.some(p => p.species === 'Adjectlizard');

        if (gameState.quests.chefsMenu === 'started' && hasAdjectlizard) {
            startDialogue([
                "Chef: Magnifique! An Adjectlizard! Look at its descriptive colors, its detailed scales!",
                "It's... it's... magnificent! Scaly! Colorful! It's perfect!",
                "Now I know what to write! 'A *magnificent*, *scaly* sea bass with *colorful* vegetables!'",
                "You have saved my restaurant! Please, take this for your help."
            ], () => {
                gameState.quests.chefsMenu = 'completed';
                gameState.inventory.lexiconLollies += 3;
                gameState.money += 300;
                saveGame();
                startDialogue("You received 3 Lexicon Lollies and $300!");
            });
            return null;
        }

        if (gameState.quests.chefsMenu === 'started') {
            return "Chef: My menu... so bland. Please, I need to see an Adjectlizard to get some descriptive words!";
        }

        showChoices("Chef: Mon dieu! My menu is a disaster! 'Good soup', 'Nice steak'... it's so... boring! I need powerful adjectives! A creature that embodies description... like an Adjectlizard! Could you show me one?", [
            {
                text: "Oui, chef!",
                callback: () => {
                    gameState.quests.chefsMenu = 'started';
                    saveGame();
                    startDialogue("Chef: Merci! I will be waiting with bated breath!");
                }
            },
            {
                text: "Non.",
                callback: () => {
                    startDialogue("Chef: *Sigh* The world will never know the true beauty of my cooking.");
                }
            }
        ]);
        return null;
    }

    function handleFishermanInteraction() {
        if (gameState.quests.fishermansLure === 'completed') {
            return "The fish are bitin' today! Thanks to you!";
        }

        if (gameState.inventory.luckyLure > 0) {
            startDialogue([
                "Fisherman: My Lucky Lure! You found it! I can't believe it!",
                "Thank you, thank you! I knew a sharp-eyed trainer like you could find it.",
                "Here, as a reward, take my trusty Old Rod. She's served me well."
            ], () => {
                gameState.inventory.luckyLure--;
                gameState.inventory.oldRod++;
                gameState.quests.fishermansLure = 'completed';
                saveGame();
                startDialogue("You got an Old Rod! You can now fish from piers.");
            });
            return null;
        }

        if (gameState.quests.fishermansLure === 'started') {
            return "Any luck finding that lure? It's a shiny one... probably washed up on a beach somewhere after that storm.";
        }

        showChoices("Fisherman: *Sigh*... Not a single bite. Ever since I lost my Lucky Lure in that big storm, the fish just aren't interested. Say, you're a traveler, right? Could you keep an eye out for it?", [
            {
                text: "I'll help you find it.",
                callback: () => {
                    gameState.quests.fishermansLure = 'started';
                    saveGame();
                    startDialogue("Fisherman: You will? Oh, thank you! I'll be waiting right here for good news.");
                }
            },
            {
                text: "Sorry, I'm busy.",
                callback: () => {
                    startDialogue("Fisherman: Ah, well. Can't blame a busy adventurer. The offer stands if you change your mind.");
                }
            }
        ]);
        return null;
    }

    function startFishingSequence() {
        if (gameState.inDialogue || gameState.inBattle) return;
        startDialogue(["You cast your line into the water..."], () => {
            setTimeout(() => {
                const rand = Math.random();
                let species;
                if (rand < 0.5) { // 50%
                    species = 'Cliché';
                } else if (rand < 0.8) { // 30%
                    species = 'Finnegan';
                } else if (rand < 0.95) { // 15%
                    species = 'Debait';
                } else { // 5%
                    species = 'SimileSlime';
                }
                const level = Math.floor(Math.random() * 11) + 5; // Level 5-15
                startDialogue(["A bite! You reeled something in!"], () => startBattle([createPokemon(species, level)], `Wild ${species}`));
            }, 2000);
        });
    }

    function startFinalBattle() {
        startDialogue([
            "Goblin Boss: You're too late! The final earthquake will bring our master!",
            "Goblin King: And you won't live to see it!",
            "Andy: We'll see about that! Let's get 'em!",
        ], () => {
            const finalBossPokemon = trainersDB.finalBosses.pokemon.map(p => createPokemon(p.species, p.level));
            startBattle(finalBossPokemon, trainersDB.finalBosses.name, 'finalBosses');
        });
        return null;
    }

    const maps = {
        playerRoom: { layout: [[1,1,1,1,1,1,1,1],[1,22,22,22,22,22,22,1],[1,11,0,0,10,0,9,1],[1,0,0,0,0,0,0,1],[1,22,22,0,0,22,22,1],[1,1,1,2,2,1,1,1]], objects: { '4,2': { sprite: 'bed', interaction: handleBedInteraction }, '6,2': { sprite: 'tv', interaction: "'The course of true love never did run smooth.' It's 'A Midsummer Night's Dream.'" }, '1,2': { interaction: "You see strange creatures hopping in the tall grass." }, '3,5': { target: 'playerHouse', x: 4, y: 5 }, '4,5': { target: 'playerHouse', x: 4, y: 5 } } },
        playerHouse: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,13,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,23,0,0,23,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,1': { sprite: 'bookshelf', interaction: "It's an old children's book. 'The Language of the World.' It says that all living things were born from words spoken at the beginning of time. It mentions creatures made of pure ideas." }, '1,3': { sprite: 'mom', interaction: () => gameState.playerParty.length > 0 ? "Be careful out there!" : "Hurry, dear! Professor Lexicon is waiting." }, '2,3': { sprite: 'dictionary', interaction: "Onomatopoeia: (n.) the formation of a word from a sound associated with what is named (e.g., cuckoo, sizzle)." }, '3,6': { target: 'village', x: 10, y: 9 }, '4,6': { target: 'village', x: 10, y: 9 }, '4,1': { sprite: 'stairsUp', target: 'playerRoom', x: 4, y: 4 }, '6,1': { sprite: 'computer', interaction: handlePCInteraction } } },
        village: { 
            layout: [
                [8,8,8,8,8,8,0,0,0,8,8,8,8,8,8,8],
                [8,7,7,7,7,7,0,0,0,7,7,7,7,7,7,8],
                [8,7,6,4,6,7,0,0,0,7,6,4,6,7,7,8],
                [8,7,3,5,3,7,0,0,0,7,3,5,3,7,7,8],
                [8,7,3,2,3,7,0,0,0,7,3,2,3,7,7,8],
                [8,7,7,0,0,0,0,0,0,0,0,0,0,7,7,8],
                [8,7,7,7,6,4,6,7,7,6,4,6,0,7,7,8],
                [8,7,7,7,3,5,3,7,7,3,5,3,0,7,7,8],
                [8,7,7,7,3,2,3,0,0,3,2,3,0,7,7,8],
                [8,7,7,7,7,0,0,0,0,0,0,0,0,7,7,8],
                [8,7,16,7,7,0,0,0,0,0,0,0,0,16,7,8],
                [8,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8],
                [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8]
            ],
            objects: {
                '3,4': { target: 'rivalsHouse', x: 4, y: 5, symbol: '🏠', symbolOffsetY: -2 },
                '11,4': { target: 'profHouse', x: 4, y: 5, symbol: '🔬', symbolOffsetY: -2 },
                '5,8': { target: 'villagerHouse1', x: 4, y: 5, symbol: '🏠', symbolOffsetY: -2 },
                '10,8': { target: 'playerHouse', x: 4, y: 5, symbol: '🏠', symbolOffsetY: -2 },
                '2,9': { sprite: 'villager', interaction: "Lowering an opponent's stats can be more effective than a direct attack!" },
                '7,0': { sprite: 'gate', interaction: handleGateInteraction },
                '8,0': { sprite: 'gate', interaction: handleGateInteraction },
                '10,10': { sprite: 'sign', interaction: 'Village of Beginnings' },
                '7,12': { target: 'homeBay', x: 7, y: 1 },
                '8,12': { target: 'homeBay', x: 8, y: 1 },
                '4,5': { interaction: handleHoleEntrance },
                '12,10': { sprite: 'pokeball', interaction: () => handleFoundItem('villageHiddenPotion', 'potions', 'Potion') }
            },
            encounters: []
        },
        profHouse: { layout: [[1,1,1,1,1,1,1,1],[1,12,0,0,0,0,12,1],[1,0,0,0,0,0,0,1],[1,0,15,0,15,0,15,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '4,2': { sprite: 'professor', interaction: handleProfessorInteraction }, '2,3': { sprite: 'pokeball', interaction: "It's an empty Word Ball case." }, '4,3': { sprite: 'pokeball', interaction: "It's an empty Word Ball case." }, '6,3': { sprite: 'pokeball', interaction: "It's an empty Word Ball case." }, '3,5': { target: 'village', x: 11, y: 5 }, '4,5': { target: 'village', x: 11, y: 5 } } },
        rivalsHouse: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'mom', interaction: "My son, Andy, is already out training. He's so eager!" }, '6,2': { sprite: 'table', interaction: "A textbook on 'Advanced Antonyms' is left open." }, '4,1': { sprite: 'stairsUp', target: 'rivalsRoom', x: 4, y: 4 }, '3,5': { target: 'village', x: 3, y: 5 }, '4,5': { target: 'village', x: 3, y: 5 } } },
        rivalsRoom: {
            layout: [
                [1,1,1,1,1,1,1,1],
                [1,22,22,22,22,22,22,1],
                [1,11,0,0,10,0,9,1],
                [1,0,0,0,0,0,0,1],
                [1,22,22,0,0,22,22,1],
                [1,1,1,2,2,1,1,1]
            ],
            objects: {
                '6,2': { sprite: 'tv', interaction: "The screen shows a creepy doll shop. A girl who looks just like one of the dolls touches it, and her soul is sucked inside, trapping her forever. The doll is then placed in the window, awaiting its next victim. It gives you chills." },
                '4,2': { sprite: 'bed', interaction: "Your rival's bed. It's surprisingly neat." },
                '1,2': { sprite: 'rival', interaction: handleFinalRivalBattle },
                '3,5': { target: 'rivalsHouse', x: 4, y: 1 },
                '4,5': { target: 'rivalsHouse', x: 4, y: 1 }
            }
        },
        route1: { 
            layout: [ 
                [8,8,8,7,7,0,0,0,0,7,7,8,8,8,8,8], 
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8], 
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8], 
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8], 
                [8,8,8,7,7,0,0,0,0,7,7,8,8,8,8,8], 
                [8,8,8,8,8,0,0,0,0,8,8,8,8,8,8,8] 
            ], 
            objects: { 
                '2,2': { sprite: 'hiker', interaction: () => handleTrainerBattle('hikerTom') }, 
                '13,2': { sprite: 'villager', interaction: () => handleTrainerBattle('readerSue') },
                '5,5': { target: 'village', x: 7, y: 1 }, '6,5': { target: 'village', x: 8, y: 1 }, 
                '5,0': { target: 'lexingtonCity', x: 7, y: 13 }, '6,0': { target: 'lexingtonCity', x: 8, y: 13 }, 
                '7,0': { target: 'lexingtonCity', x: 7, y: 13 }, '8,0': { target: 'lexingtonCity', x: 8, y: 13 }, 
                '8,4': { sprite: 'sign', interaction: 'Route 1' },
                '1,1': { sprite: 'pokeball', interaction: () => handleFoundItem('route1Lolly', 'lexiconLollies', 'Lexicon Lolly') }
            }, 
            encounters: ['Wordworm', 'SimileSlime', 'Nomenowl', 'Fablion'] 
        },
        lexingtonCity: { 
            layout: [ 
                [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8], 
                [8,0,16,0,6,19,19,6,0,6,21,21,6,0,16,8], 
                [8,0,4,4,3,18,18,3,0,3,20,20,3,0,4,8], 
                [8,0,3,3,3,18,18,3,0,3,20,20,3,0,3,8], 
                [8,0,2,0,3,2,5,3,0,3,2,5,3,0,2,8], 
                [8,0,16,0,6,19,19,6,0,6,21,21,6,0,16,8], 
                [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8], 
                [8,0,4,4,0,0,0,0,0,0,0,0,4,4,0,8], 
                [8,0,3,3,0,0,0,0,0,0,0,0,3,3,0,8], 
                [8,0,2,0,0,0,0,0,0,0,0,0,0,2,0,8], 
                [8,0,16,0,0,0,0,0,0,0,0,0,0,16,0,8], 
                [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8], 
                [8,0,16,0,0,16,0,0,0,16,0,0,16,0,0,8], 
                [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8] 
            ], 
            objects: { 
                '2,4': { symbol: '❤️', symbolOffsetY: -2 }, '2,5': { target: 'pokecenter', x: 4, y: 5 }, 
                '5,4': { symbol: '🛒', symbolOffsetY: -2 }, '5,5': { target: 'shop', x: 4, y: 5 }, 
                '10,4': { symbol: '🏆', symbolOffsetY: -2 }, '10,5': { target: 'gym', x: 4, y: 5 }, 
                '13,4': { symbol: '🏠', symbolOffsetY: -2 }, '13,5': { target: 'cityHouse1', x: 4, y: 5 }, 
                '2,9': { symbol: '🏠', symbolOffsetY: -2 }, '2,10': { target: 'cityHouse2', x: 4, y: 5 }, 
                '13,9': { symbol: '🏠', symbolOffsetY: -2 }, '13,10': { target: 'cityHouse3', x: 4, y: 5 },
                '3,1': { sprite: 'poeFan', interaction: handlePoeInteraction }, 
                '1,10': { sprite: 'poet', interaction: handlePoetInteraction },
                '7,0': { sprite: 'gate', interaction: handleNorthGate }, '8,0': { sprite: 'gate', interaction: handleNorthGate },
                '7,13': { target: 'route1', x: 7, y: 0 }, 
                '8,13': { target: 'route1', x: 8, y: 0 },
                '9,12': { sprite: 'sign', interaction: 'Lexington City' }
            } 
        },
        pokecenter: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'nurse', interaction: handleNurseInteraction }, '1,2': { sprite: 'computer', interaction: handlePCInteraction }, '2,2': { sprite: 'synonymouse', interaction: "A healthy-looking Synonymouse is resting here." }, '3,5': { target: 'lexingtonCity', x: 2, y: 5 }, '4,5': { target: 'lexingtonCity', x: 2, y: 5 } } },
        shop: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'shopkeep', interaction: handleShopInteraction }, '3,5': { target: 'lexingtonCity', x: 5, y: 5 }, '4,5': { target: 'lexingtonCity', x: 5, y: 5 } } },
        gym: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '4,1': { sprite: 'gymLeader', interaction: handleGymLeaderInteraction }, '3,5': { target: 'lexingtonCity', x: 10, y: 5 }, '4,5': { target: 'lexingtonCity', x: 10, y: 5 } } },
        cityHouse1: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,13,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '2,3': { sprite: 'villager', interaction: "The gym leader here, Rhonda, loves rhymes. A well-constructed couplet might impress her!" }, '3,5': { target: 'lexingtonCity', x: 13, y: 5 }, '4,5': { target: 'lexingtonCity', x: 13, y: 5 } } },
        cityHouse2: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,13,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '2,3': { sprite: 'villager2', interaction: "She looks out the window. 'The waves are so restless today... I hope my sailor returns from the sea soon.'" }, '3,5': { target: 'lexingtonCity', x: 2, y: 10 }, '4,5': { target: 'lexingtonCity', x: 2, y: 10 } } },
        cityHouse3: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,13,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '2,3': { sprite: 'rival', interaction: handleDeathMasheenInteraction }, '3,5': { target: 'lexingtonCity', x: 13, y: 10 }, '4,5': { target: 'lexingtonCity', x: 13, y: 10 } } },
        villagerHouse1: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,1': { sprite: 'bookshelf', interaction: "A collection of poetry. 'The road not taken...' seems well-read." }, '1,3': { sprite: 'villager', interaction: "So many young trainers starting their journey." }, '3,3': { sprite: 'table', interaction: "A half-eaten plate of grammar-ham crackers." }, '3,5': { target: 'village', x: 5, y: 9 }, '4,5': { target: 'village', x: 5, y: 9 } } },
        route2: {
            layout: [
                [8,8,8,7,7,0,0,0,0,7,7,8,8,8,8,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,8,8,8,8,0,0,0,0,8,8,8,8,8,8,8]
            ],
            objects: {
                '7,13': { target: 'lexingtonCity', x: 7, y: 0 },
                '8,13': { target: 'lexingtonCity', x: 8, y: 0 },
                '7,0': { target: 'adjectiveWoods', x: 7, y: 13 },
                '8,0': { target: 'adjectiveWoods', x: 8, y: 13 },
                '2,7': { sprite: 'bookworm', interaction: () => handleTrainerBattle('bookwormBarry') },
                '9,12': { sprite: 'sign', interaction: 'Route 2 - Path to the Woods' }
            },
            encounters: ['PronounProwler', 'VerbViper', 'Rhymoceros', 'Haiku-na', 'Quotlet']
        },
        adjectiveWoods: {
            layout: [
                [8,8,8,8,8,8,0,0,0,8,8,8,8,8,8,8],
                [8,0,8,7,7,7,7,8,8,8,8,7,7,7,8,8],
                [8,0,8,7,8,8,8,8,7,7,7,7,8,7,7,8],
                [8,0,0,0,8,7,7,0,0,0,8,8,8,7,8,8],
                [8,8,8,0,8,7,8,8,8,0,8,7,7,7,7,8],
                [8,7,7,0,0,0,0,0,8,0,8,7,8,8,8,8],
                [8,7,8,8,8,8,8,0,8,0,8,7,7,7,0,8],
                [8,7,7,0,0,0,8,0,8,0,8,8,8,8,0,8],
                [8,8,8,8,8,0,8,0,8,0,7,7,7,7,7,8],
                [8,7,7,7,8,0,8,0,8,8,8,8,8,8,8,8],
                [8,7,8,7,8,0,8,0,0,0,0,0,0,0,7,8],
                [8,7,8,7,8,0,8,8,8,8,8,8,8,0,7,8],
                [8,7,8,7,7,0,0,0,0,0,0,0,8,0,7,8],
                [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8]
            ],
            objects: {
                '7,13': { target: 'route2', x: 7, y: 0 },
                '8,13': { target: 'route2', x: 8, y: 13 },
                '1,2': { sprite: 'villager2', interaction: () => handleTrainerBattle('artistAdeline') },
                '8,0': { target: 'synonymCity', x: 8, y: 13 },
                '7,0': { target: 'synonymCity', x: 7, y: 13 },
                '9,12': { sprite: 'sign', interaction: 'Adjective Woods - Watch your descriptions!' },
                '14,8': { sprite: 'lightbulb', interaction: handleLHItem },
                '14,7': { sprite: 'pokeball', interaction: () => handleFoundItem('adjectiveWoodsLolly', 'lexiconLollies', 'Lexicon Lolly') }
            },
            encounters: ['Metaphorpillar', 'PronounProwler', 'Adjectoad', 'Adjectlizard', 'Punc-tuft']
        },
        synonymCity: {
            layout: [
                [8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],
                [8,0,0,0,0,6,19,19,6,0,0,0,0,0,0,8],
                [8,0,0,0,0,3,18,18,3,0,0,0,0,0,0,8],
                [8,0,0,0,0,3,2,2,3,0,0,0,0,0,0,8],
                [8,0,16,0,0,0,0,0,0,6,21,21,6,0,16,8],
                [8,0,4,4,3,18,18,3,0,3,20,20,3,0,4,8],
                [8,0,3,3,3,18,18,3,0,3,20,20,3,0,3,8],
                [8,0,2,0,3,2,5,3,0,3,2,5,3,0,2,8],
                [8,0,16,0,0,0,0,0,0,0,0,0,0,16,0,8],
                [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
                [8,0,19,19,0,16,0,0,0,16,0,0,16,0,0,8],
                [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
                [8,3,2,2,3,16,0,0,0,16,0,0,16,0,0,8],
                [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8]
            ],
            objects: {
                '2,7': { symbol: '🍴', symbolOffsetY: -2 }, '2,8': { target: 'restaurant', x: 4, y: 5 },
                '5,7': { symbol: '🛒', symbolOffsetY: -2 }, '5,8': { target: 'synonymCityShop', x: 4, y: 5 }, 
                '10,7': { symbol: '❤️', symbolOffsetY: -2 }, '10,8': { target: 'synonymCityCenter', x: 4, y: 5 }, 
                '14,10': { sprite: 'bookworm', interaction: "Synonym City is famous for its library, the largest in the region!" },
                '7,13': { target: 'adjectiveWoods', x: 7, y: 0 },
                '8,13': { target: 'adjectiveWoods', x: 8, y: 0 },
                '9,12': { sprite: 'sign', interaction: 'Synonym City - The City of Similar Words' },
                '7,2': { symbol: '🏆', symbolOffsetY: -2 }, 
                '6,3': { target: 'synonymCityGym', x: 4, y: 5 },
                '7,3': { target: 'synonymCityGym', x: 4, y: 5 },
                '1,10': { symbol: '📚', symbolOffsetY: -2 },
                '2,12': { target: 'library', x: 4, y: 5 },
                '3,12': { target: 'library', x: 4, y: 5 },
                '14,12': { sprite: 'pokeball', interaction: () => handleFoundItem('synonymCityLolly', 'lexiconLollies', 'Lexicon Lolly') }
            }
        },
        synonymCityGym: {
            layout: [[1,1,1,1,1,1,1,1],[1,12,0,0,0,0,12,1],[1,0,0,0,0,0,0,1],[1,12,0,0,0,0,12,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]],
            objects: {
                '4,1': { sprite: 'gymLeader', interaction: handleSynonymGymLeaderInteraction },
                '2,1': { sprite: 'bookshelf', interaction: "Books on advanced synonyms and etymology." },
                '6,1': { sprite: 'bookshelf', interaction: "A complete collection of Roget's Thesaurus." },
                '3,5': { target: 'synonymCity', x: 6, y: 3 },
                '4,5': { target: 'synonymCity', x: 7, y: 3 }
            }
        },
        synonymCityCenter: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'nurse', interaction: handleNurseInteraction }, '1,2': { sprite: 'computer', interaction: handlePCInteraction }, '3,5': { target: 'synonymCity', x: 10, y: 8 }, '4,5': { target: 'synonymCity', x: 10, y: 8 } } },
        synonymCityShop: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'shopkeep', interaction: handleShopInteraction }, '3,5': { target: 'synonymCity', x: 5, y: 8 }, '4,5': { target: 'synonymCity', x: 5, y: 8 } } },
        library: {
            layout: [
                [1,1,1,1,1,1,1,1],
                [1,12,0,12,0,12,0,1],
                [1,0,0,0,0,0,0,1],
                [1,12,0,0,0,0,12,1],
                [1,0,0,0,0,0,0,1],
                [1,1,1,2,2,1,1,1]
            ],
            objects: {
                '4,2': { sprite: 'professor', interaction: ["Dr Powers: Shh! I'm on the verge of a scientific breakthrough!"] },
                '1,1': { sprite: 'bookshelf', interaction: "From 'A Natural History of ELA': 'The creatures of this land are not flesh and bone... They are linguistic constructs, given form by a powerful, unseen energy that resonates with the concepts they embody.'" },
                '3,1': { sprite: 'bookshelf', interaction: "'On the Goblins': '...these crude beings lack sophisticated language. They communicate in grunts and snarls. It is theorized they resent the structured nature of our world and seek to return it to a state of pre-linguistic chaos.'" },
                '5,1': { sprite: 'bookshelf', interaction: "A forbidden text, 'The Un-Spelling.' It speaks of a 'Syntactic Core' at the world's center. 'To shatter the Core,' it reads, 'is to shatter meaning itself. The recent seismic activity is a worrying omen...'" },
                '1,3': { sprite: 'bookshelf', interaction: "'The Evolution of Ideas': '...as a Synonymouse gains experience, its understanding of language deepens. This conceptual growth triggers its physical evolution into a Syntar, a being that can manipulate the very rules of grammar.'" },
                '6,3': { sprite: 'bookshelf', interaction: "'The Legendary Golems': 'Ancient texts speak of two beings, Lexiconstruct and Antonymph, who act as guardians of the Syntactic Core. They are living language, embodying the principles of definition and opposition.'" },
                '2,3': { sprite: 'bookshelf', interaction: "'A Hero With A Thousand Faces' - it's a classic." },
                '3,5': { target: 'synonymCity', x: 2, y: 12 },
                '4,5': { target: 'synonymCity', x: 3, y: 12 }
            }
        },
        restaurant: {
            layout: [[1,1,1,1,1,1,1,1],[1,0,13,0,13,0,0,1],[1,0,0,0,0,0,0,1],[1,13,0,0,0,13,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]],
            objects: {
                '2,2': { sprite: 'chef', interaction: handleChefInteraction },
                '1,3': { sprite: 'table' },
                '5,3': { sprite: 'table' },
                '3,5': { target: 'synonymCity', x: 2, y: 8 },
                '4,5': { target: 'synonymCity', x: 2, y: 8 }
            }
        },
        homeBay: {
            layout: [
                [24,24,24,24,24,24,24,0,0,24,24,24,24,24,24,24],
                [23,23,23,23,23,24,24,0,0,24,24,23,23,23,23,23],
                [24,24,24,24,24,24,24,2,2,24,24,24,24,24,24,24],
                [24,24,24,24,24,24,24,2,2,24,24,24,24,24,24,24],
                [24,24,24,24,24,24,24,2,2,24,24,24,24,24,24,24],
                [24,24,24,24,24,24,2,2,2,2,2,2,2,24,24,24],
                [24,24,24,24,24,24,2,24,24,24,24,2,24,24,24,24],
                [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],
                [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],
                [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],
            ],
            objects: {
                '7,0': { target: 'village', x: 7, y: 12 },
                '8,0': { target: 'village', x: 8, y: 12 },
                '10,1': { sprite: 'sign', interaction: 'Village Bay' },
                '11,5': { sprite: 'boat', interaction: "It's the captain's boat. Looks like it's seen many voyages." },
                '9,5': { sprite: 'villager', interaction: handleCaptainInteraction },
                '6,5': { sprite: 'fisherman', interaction: handleFishermanInteraction },
            }
        },
        caveLevel1: {
            layout: [
                [27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27],
                [27,28,28,28,27,28,28,28,28,28,28,28,28,28,28,27],
                [27,28,27,28,27,28,27,27,27,27,27,27,27,27,28,27],
                [27,28,27,28,28,28,28,28,28,28,28,28,28,27,28,27],
                [27,28,27,27,27,27,27,28,27,27,27,27,28,27,28,27],
                [27,28,28,28,28,28,27,28,27,28,28,28,28,28,28,27],
                [27,27,27,27,27,28,27,28,27,28,27,27,27,27,27,27],
                [27,28,28,28,27,28,27,28,28,28,28,28,28,28,28,27],
                [27,28,27,28,27,28,27,27,27,27,27,28,27,27,28,27],
                [27,28,27,28,28,28,28,28,28,28,27,28,28,28,28,27],
                [27,28,27,27,27,27,27,27,27,28,27,27,27,27,28,27],
                [27,28,28,28,28,28,28,28,28,28,28,28,28,27,28,27],
                [27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27],
            ],
            objects: {
                '2,2': { sprite: 'ladder', target: 'village', x: 4, y: 7 },
                '4,8': { sprite: 'hiker', interaction: () => handleTrainerBattle('caveExplorerDon') },
                '10,2': { sprite: 'goblin', interaction: () => handleTrainerBattle('goblinBoss') },
                '14,2': { sprite: 'boulder', interaction: handleBoulderInteraction },
                '14,3': { sprite: 'lexiconstruct', interaction: handleLegendaryBattle },
                '1,11': { sprite: 'pokeball', interaction: () => handleFoundItem('cave1GreatPhrase', 'greatphrases', 'Great Phrase') }
            },
            encounters: ['Grammargoyle', 'VerbViper', 'Stalagmight']
        },
        desertedIsland: {
            layout: [
                [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],
                [24,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24],
                [24,23,29,29,23,29,29,23,23,29,29,23,29,29,23,24],
                [24,23,29,23,23,23,29,23,23,29,23,23,23,29,23,24],
                [24,23,23,23,29,23,23,23,23,23,23,29,23,23,23,24],
                [24,23,29,23,23,23,29,23,23,29,23,23,23,29,23,24],
                [24,23,29,29,23,29,29,23,23,29,29,23,29,29,23,24],
                [24,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24],
                [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],
            ],
            objects: {
                '8,4': { sprite: 'rival', interaction: ["Andy: We're... alive. Unbelievable.", "We have to work together to figure out where we are. And how to get off this island."] },
                '13,2': { sprite: 'pilot', interaction: () => handleTrainerBattle('shipwreckedPilot') },
                '1,7': { sprite: 'pokeball', interaction: () => handleFoundItem('islandLolly', 'lexiconLollies', 'Lexicon Lolly') },
                '2,1': { sprite: 'pokeball', interaction: () => handleFoundItem('luckyLureIsland', 'luckyLure', 'Lucky Lure') }
            },
            encounters: ['Hyper-bole', 'PronounProwler', 'Conjun-gull']
        },
        finalCave: {
            layout: [
                [27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27],
                [27,28,28,28,28,28,28,28,28,28,28,28,28,28,28,27],
                [27,28,27,27,27,28,27,27,27,27,27,27,27,27,28,27],
                [27,28,27,28,28,28,28,28,28,28,28,28,28,27,28,27],
                [27,28,28,28,27,27,27,27,27,27,27,27,28,27,28,27],
                [27,27,27,28,27,28,28,28,28,28,28,28,28,28,28,27],
                [27,28,28,28,27,28,27,27,27,27,27,28,27,27,27,27],
                [27,28,27,27,27,28,27,28,28,28,27,28,28,28,28,27],
                [27,28,28,28,28,28,27,28,27,28,27,27,27,27,28,27],
                [27,27,27,27,27,27,27,28,27,28,28,28,28,28,28,27],
                [27,28,28,28,28,28,28,28,27,27,27,27,27,27,28,27],
                [27,28,27,27,27,27,27,27,27,28,28,28,28,28,28,27],
                [27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27],
            ],
            objects: {
                '14,11': { sprite: 'ladder', target: 'village', x: 7, y: 9 }, // Exit ladder
                '8,2': { sprite: 'goblin', interaction: startFinalBattle },
                '7,2': { sprite: 'goblin', interaction: startFinalBattle },
                '1,6': { sprite: 'pokeball', interaction: () => handleFoundItem('finalCaveUltraSentence', 'ultrasentences', 'Ultra Sentence') }
            }
        }
    };
    
    const tileTypes = { 0: { color: '#d3d3d3' }, 1: { color: '#605040', solid: true }, 2: { color: '#c0a080' }, 3: { color: '#D2B48C', solid: true }, 4: { color: '#B22222', solid: true }, 5: { color: '#87CEEB', solid: true }, 6: { color: '#8B4513', solid: true }, 7: { color: '#38a169', isTallGrass: true }, 8: { color: '#2f855a', solid: true }, 9: { color: '#c0a080', solid: true }, 10: { color: '#333333', solid: true }, 11: { color: '#a0e0f0', isWindow: true }, 12: { color: '#806040', solid: true }, 13: { color: '#f0d0b0', solid: true }, 14: { color: '#4a5568', solid: true }, 15: { color: '#e2e8f0', solid: true }, 16: { color: '#FFD700' }, 18: { color: '#F5F5DC', solid: true }, 19: { color: '#4169E1', solid: true }, 20: { color: '#708090', solid: true }, 21: { color: '#2F4F4F', solid: true }, 22: { color: '#deb887'}, 23: { color: '#f5f5dc'}, 24: { color: '#4682B4', solid: true }, 25: { color: '#4a5568', solid: true }, 26: { color: '#2d3748' }, 27: { color: '#4a2a0c', solid: true }, 28: { color: '#8b5a2b' }, 29: { color: '#228B22', isTallGrass: true } };

    function getTile(map, x, y) { if (y >= 0 && y < map.layout.length && x >= 0 && x < map.layout[y].length) return map.layout[y][x]; return -1; }

    function gameLoop() { 
        if (gameState.activeScene !== 'title') {
            draw(); 
        }
        requestAnimationFrame(gameLoop); 
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const mapData = maps[gameState.currentMap];
        if (!mapData) return;
        const offsetX = -gameState.player.x * tileSize + canvas.width / 2;
        const offsetY = -gameState.player.y * tileSize + canvas.height / 2;
        ctx.save();
        ctx.translate(offsetX, offsetY);
        for (let y = 0; y < mapData.layout.length; y++) {
            for (let x = 0; x < mapData.layout[y].length; x++) {
                const tileId = mapData.layout[y][x];
                const tile = tileTypes[tileId];
                if (tile) { 
                    ctx.fillStyle = tile.color; 
                    ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize); 
                    if (tile.isWindow) {
                        ctx.fillStyle = '#a0e0f0';
                        ctx.fillRect(x * tileSize + 4, y * tileSize + 4, tileSize - 8, tileSize - 8);
                        ctx.fillStyle = '#605040';
                        ctx.fillRect(x * tileSize + tileSize/2 - 2, y * tileSize, 4, tileSize);
                        ctx.fillRect(x * tileSize, y * tileSize + tileSize/2 - 2, tileSize, 4);
                    }
                }
                if(tileId === 8) drawSprite('tree', x, y);
                if(tileId === 16) drawSprite('flower', x, y);
                 if (mapData.encounters && (mapData.encounters.includes('Hyper-bole') || mapData.encounters.includes('PronounProwler')) && tileId === 29) {
                      drawSprite('palmTree', x, y);
                }
            }
        }
        for (const key in mapData.objects) {
            const [x, y] = key.split(',').map(Number);
            const obj = mapData.objects[key];
            if (obj.sprite) drawSprite(obj.sprite, x, y);
            if (obj.symbol) {
                ctx.font = `${tileSize * 0.9}px serif`;
                const offsetY = obj.symbolOffsetY || -2;
                ctx.fillText(obj.symbol, x * tileSize + tileSize / 2, (y + offsetY) * tileSize + tileSize/2);
            }
        }
        if(gameState.currentMap === 'village' && gameState.earthquake1Triggered) {
             drawSprite('hole', 4, 5);
        }

        const walkBob = Math.sin(gameState.player.walkFrame / 2) * 2;
        drawSprite(gameState.player.sprite, gameState.player.x, gameState.player.y, walkBob);
        ctx.restore();

        // Darkness Effect
        if ((gameState.currentMap === 'caveLevel1' || gameState.currentMap === 'finalCave') && gameState.inventory.LH01LuminousHyperbole === 0) {
            const playerCanvasX = canvas.width / 2;
            const playerCanvasY = canvas.height / 2;
            
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.rect(0, 0, canvas.width, canvas.height);
            ctx.arc(playerCanvasX, playerCanvasY, tileSize * 2, 0, Math.PI * 2, true);
            ctx.fill();
        }
    }

    function handleConfirmAction() {
        if (gameState.inDialogue && !waitingForChoice) {
            advanceDialogue();
        } else if (!gameState.activeScene && !gameState.inBattle && !gameState.inDialogue) {
            checkForInteraction();
        }
    }

    function handleCancelAction() {
        if (gameState.activeScene) {
            closeAllMenus();
        } else if (gameState.inDialogue) {
            dialogueQueue = []; // Clear the queue
            const cb = dialogueCallback;
            gameState.inDialogue = false;
            messageText.textContent = '';
            dialogueCallback = null;
        }
    }


    function handleInput(key) {
        // Universal cancel action
        if (key === 'b' || key === 'x' || key === 'Backspace' || key === 'Escape') {
            handleCancelAction();
            return;
        }

        // Universal confirm action
        if (key === 'a' || key === 'z' || key === 'Enter') {
            handleConfirmAction();
            return;
        }
        
        // Block movement during any UI state
        if (gameState.inDialogue || gameState.inBattle || gameState.activeScene) return;

        // Handle movement
        let {x, y} = gameState.player;
        switch(key) {
            case 'ArrowUp': y--; break;
            case 'ArrowDown': y++; break;
            case 'ArrowLeft': x--; break;
            case 'ArrowRight': x++; break;
            case 'm': toggleMenu(); return;
        }
        movePlayer(x,y);
    }
    
    // Canvas click for dev mode toggle
    canvas.addEventListener('click', (event) => {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;

        const canvasX = (event.clientX - rect.left) * scaleX;
        const canvasY = (event.clientY - rect.top) * scaleY;

        const offsetX = -gameState.player.x * tileSize + canvas.width / 2;
        const offsetY = -gameState.player.y * tileSize + canvas.height / 2;

        const mapX = Math.floor((canvasX - offsetX) / tileSize);
        const mapY = Math.floor((canvasY - offsetY) / tileSize);
        
        // Original dev mode toggle
        if (gameState.currentMap === 'village' && mapX === 0 && mapY === 0) {
            toggleDevMode();
        }

        // Earthquake dev trigger in Synonym City Gym
        if (gameState.currentMap === 'synonymCityGym' && mapX === 0 && mapY === 0) {
            triggerEarthquake();
        }
        
        // Cave boss dev trigger
        if (gameState.currentMap === 'caveLevel1' && mapX === 0 && mapY === 0 && gameState.devModeActive) {
            if (gameState.inventory.engineCog === 0) {
                gameState.inventory.engineCog = 1;
                if(!gameState.defeatedTrainers.includes('goblinBoss')) {
                    gameState.defeatedTrainers.push('goblinBoss');
                }
                startDialogue("Dev Trigger: Obtained the Engine Cog!");
            } else {
                startDialogue("You already have the Engine Cog.");
            }
        }
        
        // Island boss dev trigger
        if (gameState.currentMap === 'desertedIsland' && mapX === 0 && mapY === 0 && gameState.devModeActive) {
            if (gameState.inventory.LH02LyricalHightail === 0) {
                gameState.inventory.LH02LyricalHightail = 1;
                if(!gameState.defeatedTrainers.includes('shipwreckedPilot')) {
                    gameState.defeatedTrainers.push('shipwreckedPilot');
                }
                startDialogue(["Dev Trigger: Obtained LH02 Lyrical Hightail!"], () => {
                    changeMap('village', 10, 10);
                    triggerFinalBattleScene();
                    startDialogue("You use the pilot's plane to fly home.");
                });
            } else {
                startDialogue("You already have LH02 Lyrical Hightail.");
            }
        }

        // Final Cave boss dev trigger
        if (gameState.currentMap === 'finalCave' && mapX === 0 && mapY === 0 && gameState.devModeActive) {
            if (!gameState.finalBossDefeated) {
                gameState.finalBossDefeated = true;
                gameState.inventory.masterthesis = 1;
                if(!gameState.defeatedTrainers.includes('finalBosses')) {
                    gameState.defeatedTrainers.push('finalBosses');
                }
                delete maps.finalCave.objects['8,2'];
                delete maps.finalCave.objects['7,2'];
                delete maps.village.objects['6,8']; // Andy's object after the battle
                startDialogue([
                    "DEV TRIGGER: Final Boss Defeated!",
                    "You got the Master Thesis!",
                    "The path is clear."
                ]);
            } else {
                startDialogue("Final boss already defeated.");
            }
        }
    });

    function toggleDevMode() {
        gameState.devModeActive = !gameState.devModeActive;
        if (gameState.devModeActive) {
            startDialogue("Dev Mode Activated! Event barriers are unlocked.");
        } else {
            startDialogue("Dev Mode Deactivated. Barriers restored to normal.");
        }
    }

    window.addEventListener('keydown', (e) => {
        // Prevent default browser actions (like scrolling) for game keys
        const gameKeys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter', 'z', 'x', 'm', 'Backspace', 'Escape'];
        if (gameKeys.includes(e.key)) {
            e.preventDefault();
        }

        let key = e.key;
        if(key === 'z') key = 'a';
        if(key === 'x' || e.key === 'Backspace') key = 'b';
        handleInput(key);
    });

    // Touch Controls Setup
    const setupTouchButton = (id, key) => {
        const button = document.getElementById(id);
        if (button) button.addEventListener('click', () => handleInput(key));
    };

    // Movement
    setupTouchButton('touch-up', 'ArrowUp');
    setupTouchButton('touch-down', 'ArrowDown');
    setupTouchButton('touch-left', 'ArrowLeft');
    setupTouchButton('touch-right', 'ArrowRight');
    setupTouchButton('touch-up-lg', 'ArrowUp');
    setupTouchButton('touch-down-lg', 'ArrowDown');
    setupTouchButton('touch-left-lg', 'ArrowLeft');
    setupTouchButton('touch-right-lg', 'ArrowRight');

    // Actions
    setupTouchButton('touch-a', 'a');
    setupTouchButton('touch-a-lg', 'a');
    setupTouchButton('touch-b', 'b');
    setupTouchButton('touch-b-lg', 'b');
    
    document.getElementById('menu-btn').addEventListener('click', toggleMenu);
    
    messageBox.addEventListener('click', (e) => {
        if (e.target.closest('#choices-box')) return;
        if (gameState.inDialogue && !gameState.inBattle) {
            advanceDialogue();
        }
    });
    
    battleBox.addEventListener('click', (e) => { 
        if (e.target.closest('#battle-grid')) return;
        if (gameState.inDialogue && gameState.inBattle) {
            advanceDialogue();
        }
    });

    function movePlayer(newX, newY) {
        if (gameState.inDialogue || gameState.inBattle || gameState.activeScene) return;
        const map = maps[gameState.currentMap];
        if (!map) return;
        
        const object = map.objects[`${newX},${newY}`];

        // This collision check now runs for everyone, dev mode or not.
        if (object && object.interaction) {
            const res = typeof object.interaction === 'function' ? object.interaction() : object.interaction;
            if (res) startDialogue(res);
            return;
        }

        // Check for target transition first
        if (object && object.target) {
            changeMap(object.target, object.x, object.y);
            return;
        }

        // Now check map boundaries
        if (newY < 0 || newY >= map.layout.length || newX < 0 || newX >= map.layout[0].length) {
            return;
        }

        const tileId = getTile(map, newX, newY);
        const tile = tileTypes[tileId];

        // Standard collision
        if (tile.solid || (object && object.sprite)) {
            return;
        }
        
        // If we've reached this point, movement is allowed.
        gameState.player.x = newX; 
        gameState.player.y = newY;
        gameState.player.walkFrame = (gameState.player.walkFrame + 1) % 100; // Animate walk
        
        // Trigger wild battle
        if (tile.isTallGrass && gameState.playerParty.length > 0 && Math.random() < 0.2) {
            startWildBattle();
        }
    }

    function changeMap(mapName, newX, newY) {
        gameState.currentMap = mapName;
        gameState.player.x = newX;
        gameState.player.y = newY;
        if (!gameState.discoveredLocations.includes(mapName)) {
            gameState.discoveredLocations.push(mapName);
        }
    }

    let dialogueQueue = [], dialogueCallback = null;
    let typewriterInterval = null;
    let currentDialogueTarget = null;
    let currentDialogueText = '';
    let currentOnComplete = null;
    let waitingForChoice = false;
    let currentDialogueTargetElement = null;

    function displayTextScroll(text, targetElement, onComplete) {
        currentDialogueText = text;
        currentDialogueTarget = targetElement;
        currentOnComplete = onComplete;
        let i = 0;
        targetElement.textContent = '';
        
        if (typewriterInterval) {
            clearInterval(typewriterInterval);
        }

        typewriterInterval = setInterval(() => {
            if (i < text.length) {
                targetElement.textContent += text.charAt(i);
                i++;
            } else {
                clearInterval(typewriterInterval);
                typewriterInterval = null;
                currentDialogueTarget = null;
                if (currentOnComplete) {
                    currentOnComplete();
                    currentOnComplete = null;
                }
            }
        }, 30); // Adjust speed of text scroll here
    }

    function skipTextScroll() {
        if (typewriterInterval && currentDialogueTarget) {
            clearInterval(typewriterInterval);
            typewriterInterval = null;
            currentDialogueTarget.textContent = currentDialogueText;
            currentDialogueTarget = null;
            if (currentOnComplete) {
                currentOnComplete();
                currentOnComplete = null;
            }
        }
    }

    function startDialogue(messages, onComplete = null, isBattle = false) {
        waitingForChoice = false;
        dialogueQueue = Array.isArray(messages) ? [...messages] : [messages];
        dialogueCallback = onComplete;
        gameState.inDialogue = true;
        
        if (isBattle) {
            currentDialogueTargetElement = battleText;
            battleGrid.innerHTML = '';
        } else {
            currentDialogueTargetElement = messageText;
            choicesBox.innerHTML = '';
        }
        
        if (dialogueQueue.length > 0) {
            displayTextScroll(dialogueQueue.shift(), currentDialogueTargetElement);
        } else {
            gameState.inDialogue = false;
            if (currentDialogueTargetElement) currentDialogueTargetElement.textContent = '';
            if (onComplete) onComplete();
        }
    }

    function advanceDialogue() {
        if (waitingForChoice) return;

        if (typewriterInterval) {
            skipTextScroll();
            return;
        }

        if (dialogueQueue.length > 0) {
            displayTextScroll(dialogueQueue.shift(), currentDialogueTargetElement);
        } else {
            const cb = dialogueCallback;
            gameState.inDialogue = false;
            if(currentDialogueTargetElement) currentDialogueTargetElement.textContent = '';
            dialogueCallback = null;
            if (cb) cb();
        }
    }
    function showChoices(prompt, choices) {
        gameState.inDialogue = true;
        choicesBox.innerHTML = '';
    
        const displayChoices = () => {
            waitingForChoice = true;
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'w-full p-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-xl border-2 border-blue-700 shadow-md';
                btn.textContent = choice.text;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    waitingForChoice = false;
                    choicesBox.innerHTML = '';
                    if (choice.callback) choice.callback();
                };
                choicesBox.appendChild(btn);
            });
        }
    
        displayTextScroll(prompt, messageText, displayChoices);
    }

    function handleFoundItem(itemId, inventoryKey, itemName) {
        if (gameState.foundItems.includes(itemId)) {
            return "It's an empty item ball.";
        }
        gameState.inventory[inventoryKey]++;
        gameState.foundItems.push(itemId);
        saveGame();
        return `You found a ${itemName}!`;
    }

    function checkForInteraction() {
        const { x, y } = gameState.player, dirs = [[0,-1], [0,1], [-1,0], [1,0]];
        for (const [dx, dy] of dirs) {
            const key = `${x + dx},${y + dy}`;
            const obj = maps[gameState.currentMap].objects[key];
            const tileId = getTile(maps[gameState.currentMap], x + dx, y + dy);
            const tile = tileTypes[tileId];

            if (obj && obj.interaction) { 
                const res = typeof obj.interaction === 'function' ? obj.interaction() : obj.interaction; 
                if (res) startDialogue(res); 
                return;
            }
             if (tile && tile.isWindow) {
                 const windowObj = Object.values(maps[gameState.currentMap].objects).find(o => o.x === (x+dx) && o.y === (y+dy));
                 if(windowObj && windowObj.interaction) {
                     startDialogue(windowObj.interaction());
                 } else {
                     startDialogue("You look out the window.");
                 }
                return;
            }
        }
        // Fishing Interaction Check
        if (gameState.inventory.oldRod > 0 && gameState.currentMap === 'homeBay') {
            const playerX = gameState.player.x;
            const playerY = gameState.player.y;
            // Check if player is on the pier facing the water
            if (playerY === 5 && playerX >= 6 && playerX <= 11) {
                const facingTile = getTile(maps.homeBay, playerX, playerY + 1);
                if(facingTile === 24) { // Facing water tile
                    startFishingSequence();
                    return;
                }
            }
        }
    }
    
    function openScene(sceneElement) { closeAllMenus(true); gameState.activeScene = sceneElement.id; sceneElement.classList.remove('hidden'); }
    function closeAllMenus(silent = false) { 
        [menuScene, inventoryScene, pokemonStatsScene, pokedexScene, pcScene, mapScene, journalScene].forEach(s => s.classList.add('hidden')); 
        if (!silent) {
            gameState.activeScene = null;
            saveGame();
        }
    }
    function toggleMenu() { if(gameState.activeScene === 'menu-scene') closeAllMenus(); else openScene(menuScene); }
    
    document.getElementById('menu-close-btn').onclick = () => closeAllMenus();
    document.getElementById('menu-inventory-btn').onclick = () => { updateInventoryUI(); openScene(inventoryScene); };
    document.getElementById('menu-pokemon-btn').onclick = () => { updatePokemonStatsUI(); openScene(pokemonStatsScene); };
    document.getElementById('menu-pokedex-btn').onclick = () => { updatePokedexUI(); openScene(pokedexScene); };
    document.getElementById('menu-map-btn').onclick = () => { updateWorldMapUI(); openScene(mapScene); };
    document.getElementById('menu-journal-btn').onclick = () => { updateJournalUI(); openScene(journalScene); };
    document.getElementById('menu-save-btn').onclick = () => {
        saveGame();
        closeAllMenus();
        startDialogue("Your game has been saved!");
    };
    document.getElementById('menu-new-game-btn').onclick = () => {
        closeAllMenus();
        showChoices("Start a new game? All saved progress will be lost!", [
            { text: "Yes, start over", callback: () => {
                localStorage.removeItem('elaQuestSaveData');
                window.location.reload();
            }},
            { text: "No, cancel", callback: () => {
                gameState.inDialogue = false;
                messageText.textContent = '';
            }}
        ]);
    };
    
    // Explicitly set back button functionality for each scene
    document.getElementById('inventory-scene').querySelector('.ui-back-btn').onclick = () => openScene(menuScene);
    document.getElementById('pokemon-stats-scene').querySelector('.ui-back-btn').onclick = () => openScene(menuScene);
    document.getElementById('pokedex-scene').querySelector('.ui-back-btn').onclick = () => openScene(menuScene);
    document.getElementById('map-scene').querySelector('.ui-back-btn').onclick = () => openScene(menuScene);
    document.getElementById('journal-scene').querySelector('.ui-back-btn').onclick = () => openScene(menuScene);

    document.getElementById('pc-close-btn').onclick = () => closeAllMenus();


    function updateInventoryUI() {
        document.getElementById('inventory-money').textContent = `$${gameState.money}`;
        const itemsContainer = document.getElementById('inventory-items');
        itemsContainer.innerHTML = '';

        const createItemEntry = (key, count) => {
            if (count > 0) {
                const itemData = itemsDB[key];
                const div = document.createElement('div');
                div.className = 'grid grid-cols-3 gap-2 items-center text-xl';
                div.innerHTML = `<span class="col-span-2">${itemData.name} x${count}</span>`;
                
                const btn = document.createElement('button');
                btn.className = 'p-2 bg-blue-500 text-white rounded-lg';
                
                if (key === 'oldRod') {
                    btn.textContent = 'Use';
                    btn.onclick = () => {
                        closeAllMenus();
                        const { x, y } = gameState.player;
                        let canFish = false;
                        // Check for fishing spots
                        if (gameState.currentMap === 'homeBay' && y === 5 && (x >= 6 && x <= 11)) {
                             const dirs = [[0, 1], [0, -1], [1, 0], [-1, 0]];
                             for (const [dx, dy] of dirs) {
                                if (getTile(maps[gameState.currentMap], x + dx, y + dy) === 24) {
                                    canFish = true;
                                    break;
                                }
                             }
                        }

                        if (canFish) {
                            startFishingSequence();
                        } else {
                            startDialogue("You need to be by the water to use this.");
                        }
                    };
                } else {
                    btn.textContent = 'Check';
                    btn.onclick = () => {
                        closeAllMenus();
                        startDialogue(itemData.description);
                    };
                }
                
                div.appendChild(btn);
                itemsContainer.appendChild(div);
            }
        };

        Object.keys(gameState.inventory).forEach(key => createItemEntry(key, gameState.inventory[key]));

        if (itemsContainer.innerHTML === '') {
            itemsContainer.innerHTML = '<p class="text-xl text-center">No items.</p>';
        }
    }

    function getTypeBadges(types) {
        return types.map(t => `<span class="type-badge type-${t}">${t}</span>`).join('');
    }

    function updatePokemonStatsUI() {
        const content = document.getElementById('pokemon-stats-content');
        if (gameState.playerParty.length === 0) { 
            content.innerHTML = '<h2 class="text-2xl text-center">You have no Creatures!</h2>'; 
            return; 
        }

        content.innerHTML = '<h2 class="text-3xl text-center mb-4">Your Party</h2>';
        const partyGrid = document.createElement('div');
        partyGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
        
        gameState.playerParty.forEach(p => {
            const card = document.createElement('div');
            card.className = 'p-4 border rounded-lg border-gray-400';
            card.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="text-6xl">${sprites[p.sprite]}</div>
                    <div>
                        <h3 class="text-2xl flex items-center">${p.name} <span class="text-xl text-gray-500 ml-2">Lvl ${p.level}</span></h3>
                        <div>${getTypeBadges(p.types)}</div>
                        <p class="text-lg mt-2">HP: ${Math.ceil(p.currentHp)} / ${p.maxHp}</p>
                        <div class="w-full bg-gray-300 rounded-full h-4 my-1"><div class="bg-green-500 h-full rounded-full" style="width: ${p.currentHp/p.maxHp*100}%"></div></div>
                    </div>
                </div>
            `;
            partyGrid.appendChild(card);
        });

        content.appendChild(partyGrid);
    }
    
    function updatePokedexUI() {
        const entries = document.getElementById('pokedex-entries'); entries.innerHTML = '';
        const seenSpecies = Object.keys(gameState.pokedex).sort();
        if (seenSpecies.length === 0) { entries.innerHTML = '<p class="text-xl text-center">No data yet. Encounter creatures to add them!</p>'; return; }
        
        seenSpecies.forEach(species => {
            const entry = gameState.pokedex[species];
            const speciesData = pokemonDB[species];
            const entryDiv = document.createElement('div'); entryDiv.className = 'p-2 border rounded border-gray-400 grid grid-cols-4 gap-2 items-center';
            const caughtIcon = entry.caught ? sprites.pokeball : '○';
            entryDiv.innerHTML = ` <div class="text-5xl text-center">${sprites[speciesData ? speciesData.sprite : species.toLowerCase()]}</div> <div class="col-span-3"> <h3 class="text-2xl flex items-center">${species} ${caughtIcon}</h3> <div>${getTypeBadges(speciesData.types)}</div> <p class="text-sm mt-1">${pokedexData[species]}</p> </div> `;
            entries.appendChild(entryDiv);
        });
    }
    
    const worldMapLayout = [
        [null, null, 'synonymCity', null, null],
        [null, null, 'adjectiveWoods', null, null],
        [null, null, 'route2', null, null],
        ['desertedIsland', null, 'lexingtonCity', null, null],
        [null, null, 'route1', null, null],
        [null, 'homeBay', 'village', 'caveLevel1', null],
    ];

    function updateWorldMapUI() {
        const grid = document.getElementById('world-map-grid');
        grid.innerHTML = '';
        grid.style.gridTemplateRows = `repeat(${worldMapLayout.length}, minmax(0, 1fr))`;

        worldMapLayout.forEach(row => {
            row.forEach(cellId => {
                const cell = document.createElement('div');
                cell.className = 'map-cell';
                if (cellId && gameState.discoveredLocations.includes(cellId)) {
                    cell.classList.add('map-cell-discovered');
                    let displayName = cellId.replace(/([A-Z])/g, ' $1').replace(/(\d)/g, ' $1').trim();
                    displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
                    cell.textContent = displayName;

                    if (gameState.currentMap === cellId) {
                        cell.classList.add('map-cell-player');
                    }
                } else {
                    cell.classList.add('map-cell-undiscovered');
                    if (cellId) {
                       cell.textContent = '???';
                    }
                }
                grid.appendChild(cell);
            });
        });
    }

    function updateJournalUI() {
        const entriesContainer = document.getElementById('journal-entries');
        entriesContainer.innerHTML = '';

        const activeQuests = [];
        const completedQuests = [];

        for (const questId in gameState.quests) {
            const status = gameState.quests[questId];
            if (status !== 'notStarted') {
                const questInfo = questDB[questId];
                if (questInfo) {
                    if (status === 'completed') {
                        completedQuests.push(questInfo.completed);
                    } else if (questInfo[status]) {
                        activeQuests.push(questInfo[status]);
                    }
                }
            }
        }
        
        let html = '';
        if (activeQuests.length > 0) {
            html += '<h3 class="text-2xl text-yellow-700 border-b-2 border-yellow-700 mb-2">Active Quests</h3>';
            html += '<ul class="list-disc list-inside space-y-2">';
            activeQuests.forEach(desc => { html += `<li>${desc}</li>`; });
            html += '</ul>';
        }

        if (completedQuests.length > 0) {
            html += '<h3 class="text-2xl text-green-700 border-b-2 border-green-700 mt-4 mb-2">Completed Quests</h3>';
            html += '<ul class="list-disc list-inside space-y-2 text-gray-500">';
            completedQuests.forEach(desc => { html += `<li>${desc}</li>`; });
            html += '</ul>';
        }

        if (html === '') {
            html = '<p class="text-xl text-center">No active quests. Explore the world to find new adventures!</p>';
        }

        entriesContainer.innerHTML = html;
    }
   
    function startBattleDialogue(messages, onComplete = null) {
        waitingForChoice = false;
        dialogueQueue = Array.isArray(messages) ? [...messages] : [messages];
        dialogueCallback = onComplete;
        gameState.inDialogue = true;
        battleGrid.innerHTML = ''; // Clear battle grid options
        
        if (dialogueQueue.length > 0) {
            displayTextScroll(dialogueQueue.shift(), battleText);
        } else {
            gameState.inDialogue = false;
            if (onComplete) onComplete();
        }
    }
    function advanceBattleDialogue() {
        if (typewriterInterval) {
            skipTextScroll();
            return;
        }

        if (dialogueQueue.length > 0) {
            displayTextScroll(dialogueQueue.shift(), battleText);
        } else {
            const cb = dialogueCallback;
            gameState.inDialogue = false;
            battleText.textContent = '';
            dialogueCallback = null;
            if (cb) cb();
        }
    }
    
    function startWildBattle() {
        if (gameState.inBattle || gameState.inDialogue || gameState.inReserveMode) return;
        const currentMapData = maps[gameState.currentMap];
        const encounterList = currentMapData.encounters;
        if (!encounterList || encounterList.length === 0) return;

        const species = encounterList[Math.floor(Math.random() * encounterList.length)];
        const level = gameState.currentMap === 'route1' ? Math.floor(Math.random() * 3) + 3 : Math.floor(Math.random() * 3) + 8;
        startDialogue([`A wild ${species} appeared!`], () => startBattle([createPokemon(species, level)], `Wild ${species}`));
    }
    
    function startBattle(opponents, opponentName, trainerId = null) {
        if (gameState.playerParty.length === 0) { startDialogue("You have no creatures to battle with!"); return; }
        gameState.inBattle = true;
        
        const opponentParty = (Array.isArray(opponents) ? opponents : [opponents])
            .map(op => (op.species ? op : createPokemon(op.species, op.level)));
        
        const firstOpponent = opponentParty[0];

        if (!gameState.pokedex[firstOpponent.species]) gameState.pokedex[firstOpponent.species] = { seen: false, caught: false };
        gameState.pokedex[firstOpponent.species].seen = true;
        
        currentBattle = { 
            playerPokemon: gameState.playerParty.find(p => p.currentHp > 0), 
            opponentParty: opponentParty,
            currentOpponentIndex: 0,
            opponentName, 
            trainerId, 
            turn: 'player',
            participants: [gameState.playerParty.findIndex(p => p.currentHp > 0)]
        };
        
        currentBattle.playerPokemon.statMods = { attack: 0, defense: 0 };
        firstOpponent.statMods = { attack: 0, defense: 0 };

        battleScene.classList.remove('hidden');
        updateBattleSprites();
        updateBattleUI(); 
        nextBattleTurn();
    }
    
    async function nextBattleTurn() {
        if (!currentBattle) return;
        const currentOpponent = currentBattle.opponentParty[currentBattle.currentOpponentIndex];

        if (currentBattle.playerPokemon.currentHp <= 0) { await handlePlayerPokemonFaint(); return; }
        if (currentOpponent.currentHp <= 0) { await handleOpponentFaint(); return; }

        if (currentBattle.turn === 'player') {
            showMainBattleMenu();
        } else {
            await new Promise(resolve => setTimeout(resolve, 500));
            const attacker = currentOpponent;
            const target = currentBattle.playerPokemon;
            const atk = attacker.attacks[Math.floor(Math.random()*attacker.attacks.length)];
            
            let messages = [`${currentBattle.opponentName}'s ${attacker.name} used ${atk.name}!`];
            await new Promise(res => startDialogue(messages, res, true));
            await animateAttack(document.getElementById('opponent-sprite'), document.getElementById('player-sprite'), true);
            
            let result;
            if(atk.power > 0) {
                result = calculateDamage(atk, attacker, target);
                target.currentHp -= result.damage;
                messages = [`${target.name} took ${result.damage} damage!`];
            } else { messages = []; result = { message: '' }; }

            if(result.message) messages.push(result.message);
            messages.push(...applyAttackEffect(atk, attacker, target));

            updateBattleUI();
            startDialogue(messages, () => { currentBattle.turn = 'player'; nextBattleTurn(); }, true);
        }
    }

    async function handleOpponentFaint() {
        const faintedOpponent = currentBattle.opponentParty[currentBattle.currentOpponentIndex];
        await animateFaint(document.getElementById('opponent-sprite'));
        await new Promise(res => startDialogue([`${currentBattle.opponentName}'s ${faintedOpponent.name} fainted!`], res, true));
        
        currentBattle.currentOpponentIndex++;
        if(currentBattle.currentOpponentIndex < currentBattle.opponentParty.length){
            const newOpponent = currentBattle.opponentParty[currentBattle.currentOpponentIndex];
            newOpponent.statMods = { attack: 0, defense: 0 };
            updateBattleSprites(); updateBattleUI();
            startDialogue([`${currentBattle.opponentName} sent out ${newOpponent.name}!`], () => { currentBattle.turn = 'player'; nextBattleTurn(); }, true);
        } else {
            endBattle();
        }
    }

    async function handlePlayerPokemonFaint() {
        await animateFaint(document.getElementById('player-sprite'));
        await new Promise(res => startDialogue([`${currentBattle.playerPokemon.name} fainted!`], res, true));
        
        const canSwitch = gameState.playerParty.some(p => p.currentHp > 0);
        if (canSwitch) { showSwitchPokemonMenu(true); } else { endBattle(); }
    }
    
    function animateAttack(attackerEl, targetEl, isOpponent) {
        return new Promise(resolve => {
            attackerEl.classList.add(isOpponent ? 'attack-animation-opponent' : 'attack-animation');
            setTimeout(() => {
                targetEl.classList.add('damage-flash');
                setTimeout(() => {
                    attackerEl.classList.remove(isOpponent ? 'attack-animation-opponent' : 'attack-animation');
                    targetEl.classList.remove('damage-flash');
                    resolve();
                }, 300);
            }, 200);
        });
    }

    function animateFaint(spriteEl) {
        return new Promise(resolve => {
            spriteEl.classList.add('faint-animation');
            setTimeout(() => {
                spriteEl.classList.remove('faint-animation');
                resolve();
            }, 500);
        });
    }


    function showMainBattleMenu() {
        battleText.textContent = `What will ${currentBattle.playerPokemon.name} do?`; battleGrid.innerHTML = '';
        battleGrid.className = 'grid grid-cols-2 gap-4 mt-4 flex-shrink-0';
        const createBtn = (text, onClick) => {
            const btn = document.createElement('button');
            btn.className = 'p-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg text-lg border-2 border-slate-900';
            btn.textContent = text; btn.onclick = onClick; battleGrid.appendChild(btn);
        };
        createBtn('Fight', playerChooseAttack); createBtn('Item', showItemMenu);
        createBtn('Pokémon', () => showSwitchPokemonMenu(false)); 
        createBtn('Run', () => { 
            if(!currentBattle.trainerId) { startDialogue('Got away safely!', () => endBattle(true), true); } 
            else { startDialogue("Can't run from a trainer battle!", showMainBattleMenu, true); } 
        });
    }

    function showSwitchPokemonMenu(isForced = false) {
        battleText.textContent = "Choose a creature."; battleGrid.innerHTML = '';
        battleGrid.className = 'grid grid-cols-1 gap-2 mt-4 flex-shrink-0';
        const baseButtonClass = 'p-2 rounded text-lg flex justify-between items-center w-full border-2';
        gameState.playerParty.forEach((pokemon, index) => {
            const button = document.createElement('button');
            button.innerHTML = `<div>${sprites[pokemon.sprite]} ${pokemon.name} Lvl ${pokemon.level}</div><div>${Math.ceil(pokemon.currentHp)}/${pokemon.maxHp} HP</div>`;
            if (pokemon.currentHp <= 0) { 
                button.disabled = true; 
                button.className = `${baseButtonClass} bg-red-800 text-gray-400 opacity-60 border-red-900`; 
            } 
            else if (pokemon === currentBattle.playerPokemon) { 
                button.disabled = true; 
                button.className = `${baseButtonClass} bg-yellow-800 text-white border-yellow-900`; 
            } 
            else { 
                button.className = `${baseButtonClass} bg-slate-700 hover:bg-slate-600 text-white border-slate-900`;
                button.onclick = () => switchPlayerPokemon(index, isForced); 
            }
            battleGrid.appendChild(button);
        });
        if (!isForced) {
            const backBtn = document.createElement('button');
            backBtn.className = 'p-2 bg-yellow-500 hover:bg-yellow-600 text-black rounded-lg text-lg border-2 border-yellow-700';
            backBtn.textContent = 'Back'; backBtn.onclick = showMainBattleMenu; battleGrid.appendChild(backBtn);
        }
    }

    function switchPlayerPokemon(newIndex, isForced = false) {
        const oldPokemon = currentBattle.playerPokemon;
        const newPokemon = gameState.playerParty[newIndex];
        currentBattle.playerPokemon = newPokemon;
        currentBattle.playerPokemon.statMods = { attack: 0, defense: 0 };
        if (!currentBattle.participants.includes(newIndex)) currentBattle.participants.push(newIndex);
        updateBattleUI(); updateBattleSprites();
        if (isForced) { currentBattle.turn = 'player'; startDialogue([`Go, ${newPokemon.name}!`], nextBattleTurn, true); } 
        else { currentBattle.turn = 'opponent'; startDialogue([`${oldPokemon.name}, come back! Go, ${newPokemon.name}!`], nextBattleTurn, true); }
    }
    
    function usePotionInBattle() {
        if (gameState.inventory.potions > 0) {
            gameState.inventory.potions--;
            const playerPokemon = currentBattle.playerPokemon;
            const healAmount = 20;
            playerPokemon.currentHp = Math.min(playerPokemon.maxHp, playerPokemon.currentHp + healAmount);
            updateBattleUI();
            startDialogue([`You used a Potion.`, `${playerPokemon.name} recovered ${healAmount} HP!`], () => {
                currentBattle.turn = 'opponent';
                nextBattleTurn();
            }, true);
        }
    }

    async function attemptCatch(ballType) {
        if (currentBattle.trainerId) {
            startDialogue("You can't steal another trainer's creature!", showMainBattleMenu, true);
            return;
        }

        if (gameState.inventory[ballType] > 0) {
            gameState.inventory[ballType]--;

            const opponent = currentBattle.opponentParty[currentBattle.currentOpponentIndex];
            const ball = itemsDB[ballType];
            
            await new Promise(res => startDialogue([`You threw a ${ball.name}!`], res, true));
            
            const animationLayer = document.getElementById('animation-layer');
            const pokeballEl = document.createElement('div');
            pokeballEl.textContent = sprites.pokeball;
            pokeballEl.className = 'pokeball-sprite throw-animation';
            animationLayer.appendChild(pokeballEl);

            await new Promise(res => setTimeout(res, 800)); 

            const opponentSpriteEl = document.getElementById('opponent-sprite');
            opponentSpriteEl.classList.add('suck-in-effect');
            
            await new Promise(res => setTimeout(res, 500)); 
            opponentSpriteEl.style.visibility = 'hidden';
            opponentSpriteEl.classList.remove('suck-in-effect');

            pokeballEl.style.left = '75%';
            pokeballEl.style.bottom = '45%';
            pokeballEl.classList.remove('throw-animation');
            
            const maxHP = opponent.maxHp;
            const currentHP = opponent.currentHp;
            const catchRate = pokemonDB[opponent.species].catchDifficulty;
            const ballBonus = ball.bonus;
            
            const a = ((3 * maxHP - 2 * currentHP) * catchRate * ballBonus) / (3 * maxHP);
            const b = Math.floor(65536 / Math.sqrt(Math.sqrt(255 / a)));

            let caught = false;
            let wiggles = 0;
            for (let i = 0; i < 4; i++) {
                const rand = Math.floor(Math.random() * 65536);
                if (rand >= b) {
                    wiggles = i;
                    break;
                }
                if (i === 3) { caught = true; }
            }
            
            for (let i = 0; i < wiggles; i++) {
                pokeballEl.classList.add('wiggle-animation');
                await new Promise(res => setTimeout(res, 850));
                pokeballEl.classList.remove('wiggle-animation');
            }
            
            if (caught) {
                pokeballEl.classList.add('capture-success-animation');
                await new Promise(res => startDialogue([`Gotcha! ${opponent.name} was caught!`], res, true));
                addPokemonToParty(opponent);
                animationLayer.innerHTML = '';
                opponentSpriteEl.style.visibility = 'visible';
                endBattle(false, true);
            } else {
                animationLayer.innerHTML = '';
                opponentSpriteEl.style.visibility = 'visible';
                await new Promise(res => startDialogue([`Oh no! ${opponent.name} broke free!`], res, true));
                currentBattle.turn = 'opponent';
                nextBattleTurn();
            }
        }
    }


    function showItemMenu() {
        battleText.textContent = "Choose an item."; battleGrid.innerHTML = '';
        battleGrid.className = 'grid grid-cols-2 gap-4 mt-4 flex-shrink-0';
        const createItemButton = (text, onClick, count) => {
            if (count > 0) {
                const button = document.createElement('button');
                button.className = 'p-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg text-lg border-2 border-slate-900';
                button.textContent = text; button.onclick = onClick; battleGrid.appendChild(button);
            }
        };
        createItemButton(`Potion x${gameState.inventory.potions}`, usePotionInBattle, gameState.inventory.potions);
        if (!currentBattle.trainerId) {
            createItemButton(`Word Ball x${gameState.inventory.wordballs}`, () => attemptCatch('wordballs'), gameState.inventory.wordballs);
            createItemButton(`Great Phrase x${gameState.inventory.greatphrases}`, () => attemptCatch('greatphrases'), gameState.inventory.greatphrases);
            createItemButton(`Ultra Sentence x${gameState.inventory.ultrasentences}`, () => attemptCatch('ultrasentences'), gameState.inventory.ultrasentences);
            createItemButton(`Master Thesis x${gameState.inventory.masterthesis}`, () => attemptCatch('masterthesis'), gameState.inventory.masterthesis);
        }
        const backBtn = document.createElement('button');
        backBtn.className = 'p-2 bg-yellow-500 hover:bg-yellow-600 text-black rounded-lg text-lg border-2 border-yellow-700';
        backBtn.textContent = 'Back'; backBtn.onclick = showMainBattleMenu; battleGrid.appendChild(backBtn);
    }

    async function playerChooseAttack() {
        battleText.textContent = `Choose an attack.`; battleGrid.innerHTML = '';
        battleGrid.className = 'grid grid-cols-2 gap-4 mt-4 flex-shrink-0';
        currentBattle.playerPokemon.attacks.forEach(attack => {
            const button = document.createElement('button');
            button.className = 'p-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg text-lg border-2 border-slate-900 flex justify-between items-center';
            button.innerHTML = `<span>${attack.name}</span> <span class="type-badge type-${attack.type}">${attack.type}</span>`;
            button.onclick = () => { currentBattle.chosenAttack = attack; presentQuestion(); };
            battleGrid.appendChild(button);
        });
        const backBtn = document.createElement('button');
        backBtn.className = 'p-2 bg-yellow-500 hover:bg-yellow-600 text-black rounded-lg text-lg border-2 border-yellow-700';
        backBtn.textContent = 'Back'; backBtn.onclick = showMainBattleMenu; battleGrid.appendChild(backBtn);
    }
    
    function presentQuestion() {
        const q = elaQuestions[Math.floor(Math.random() * elaQuestions.length)];
        currentBattle.currentQuestion = q;
        battleText.textContent = q.q;
        battleGrid.innerHTML = '';
        battleGrid.className = 'grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4 flex-shrink-0';
        [...q.a].sort(() => Math.random() - 0.5).forEach(answer => {
            const btn = document.createElement('button');
            btn.className = 'p-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg text-base border-2 border-slate-900';
            btn.textContent = answer;
            btn.onclick = () => handleAnswer(answer);
            battleGrid.appendChild(btn);
        });
    }
    
    async function handleAnswer(answer) {
        battleGrid.innerHTML = ''; // Clear answers
        const opponent = currentBattle.opponentParty[currentBattle.currentOpponentIndex];
        let effectivenessMessage = '';

        if (answer === currentBattle.currentQuestion.c) {
            await new Promise(res => startDialogue([`Correct! ${currentBattle.playerPokemon.name} used ${currentBattle.chosenAttack.name}!`], res, true));
            await animateAttack(document.getElementById('player-sprite'), document.getElementById('opponent-sprite'), false);

            if (currentBattle.chosenAttack.power > 0) {
                const result = calculateDamage(currentBattle.chosenAttack, currentBattle.playerPokemon, opponent);
                opponent.currentHp -= result.damage;
                effectivenessMessage = result.message;
                await new Promise(res => startDialogue([`${currentBattle.opponentName}'s ${opponent.name} took ${result.damage} damage!`], res, true));
            }

            if (effectivenessMessage) {
                await new Promise(res => startDialogue([effectivenessMessage], res, true));
            }
            
            const effectMessages = applyAttackEffect(currentBattle.chosenAttack, currentBattle.playerPokemon, opponent);
            if (effectMessages.length > 0) {
                await new Promise(res => startDialogue(effectMessages, res, true));
            }

        } else {
            await new Promise(res => startDialogue([`Incorrect! ${currentBattle.playerPokemon.name}'s attack missed...`], res, true));
        }
        updateBattleUI();
        currentBattle.turn = 'opponent';
        nextBattleTurn();
    }

    function calculateDamage(attack, attacker, defender) {
        const attackStat = attacker.attack * (1 + attacker.statMods.attack * 0.25);
        const defenseStat = defender.defense * (1 + defender.statMods.defense * 0.25);
        const baseDamage = attack.power + (attackStat / 2);
        
        let effectiveness = 1;
        let message = '';
        const attackType = attack.type;
        const defenderTypes = defender.types;

        defenderTypes.forEach(defType => {
            if (typeChart[attackType]?.effective.includes(defType)) {
                effectiveness *= 2;
            }
            if (typeChart[attackType]?.ineffective.includes(defType)) {
                effectiveness *= 0.5;
            }
        });

        if (effectiveness > 1) {
            message = "It's super effective!";
        } else if (effectiveness < 1 && effectiveness > 0) {
            message = "It's not very effective...";
        }

        const finalDamage = Math.floor(Math.max(1, baseDamage - (defenseStat / 4)) * effectiveness);

        return { damage: Math.max(1, finalDamage), message };
    }

    function applyAttackEffect(attack, attacker, target) {
        const effectMessages = [];
        if (attack.effect) {
            const targetPokemon = (attack.effect.target === 'opponent') ? target : attacker;
            const targetName = (attack.effect.target === 'opponent') ? 'The opponent\'s' : 'Your';
            if (attack.effect.type === 'stat') {
                const { stat, amount } = attack.effect;
                targetPokemon.statMods[stat] = Math.max(-4, Math.min(4, targetPokemon.statMods[stat] + amount));
                effectMessages.push(`${targetName} ${targetPokemon.name}'s ${stat} ${amount < 0 ? 'fell' : 'rose'}!`);
            }
        }
        return effectMessages;
    }
    
    function updateBattleUI() {
        if (!currentBattle) return;
        const p = currentBattle.playerPokemon;
        const o = currentBattle.opponentParty[currentBattle.currentOpponentIndex];

        document.getElementById('player-hp').style.width = `${Math.max(0,(p.currentHp/p.maxHp)*100)}%`;
        document.getElementById('opponent-hp').style.width = `${Math.max(0,(o.currentHp/o.maxHp)*100)}%`;
        
        const playerNameContainer = document.getElementById('player-name-container');
        playerNameContainer.innerHTML = `<p class="text-2xl">${p.name} Lvl ${p.level}</p>${getTypeBadges(p.types)}`;
        
        const oppNameContainer = document.getElementById('opponent-name-container');
        oppNameContainer.innerHTML = `<p class="text-2xl">${o.name} Lvl ${o.level}</p>${getTypeBadges(o.types)}`;

        document.getElementById('player-hp-text').textContent = `HP: ${Math.ceil(p.currentHp)}/${p.maxHp}`;
    }

    function updateBattleSprites() {
        if (!currentBattle) return;
        document.getElementById('player-sprite').textContent = sprites[currentBattle.playerPokemon.sprite];
        document.getElementById('opponent-sprite').textContent = sprites[currentBattle.opponentParty[currentBattle.currentOpponentIndex].sprite];
    }
    
    async function endBattle(ranAway = false, caught = false) {
        if (!currentBattle && !ranAway) return;
        if (ranAway || caught) { gameState.inBattle = false; battleScene.classList.add('hidden'); currentBattle = null; saveGame(); return; }

        const playerWon = currentBattle.playerPokemon.currentHp > 0;
        const oldBattle = currentBattle; currentBattle = null;

        if (!playerWon) {
            await new Promise(res => startDialogue(["You are out of usable creatures!", "You blacked out..."], res, true));
            gameState.playerParty.forEach(p => p.currentHp = p.maxHp);
            changeMap('pokecenter', 4, 4);
        } else {
            const money = oldBattle.trainerId ? trainersDB[oldBattle.trainerId].reward : 15;
            let winMsg = [];
            gameState.money += money; 
            if (oldBattle.trainerId) {
                winMsg = [`You defeated ${oldBattle.opponentName}!`, `You won $${money}!`];
                if(!gameState.defeatedTrainers.includes(oldBattle.trainerId)) gameState.defeatedTrainers.push(oldBattle.trainerId);
            } else {
                 winMsg = [`You defeated the wild ${oldBattle.opponentParty[0].name}!`, `You won $${money}!`];
            }
            
            const xpGained = 50 * oldBattle.opponentParty.reduce((sum, p) => sum + p.level, 0) / oldBattle.opponentParty.length;
            const uniqueParticipants = [...new Set(oldBattle.participants)].map(index => gameState.playerParty[index]).filter(p => p.currentHp > 0);
            
            if (uniqueParticipants.length > 0) {
                winMsg.push(`${uniqueParticipants.map(p => p.name).join(' and ')} gained ${Math.floor(xpGained)} XP!`);
            }
             await new Promise(res => startDialogue(winMsg, res, true)); winMsg = [];

            for (const p of uniqueParticipants) {
                p.xp += xpGained;
                while (p.xp >= p.xpToNextLevel) {
                    p.level++; p.xp -= p.xpToNextLevel; p.xpToNextLevel = Math.floor(p.xpToNextLevel * 1.5);
                    p.maxHp += 5; p.attack += 2; p.defense += 1; p.currentHp = p.maxHp;
                    winMsg.push(`${p.name} grew to level ${p.level}!`);
                    const newMove = pokemonDB[p.species]?.learnset?.find(m => m.level === p.level);
                    if (newMove && p.attacks.length < 4) { p.attacks.push(attacksDB[newMove.move]); winMsg.push(`${p.name} learned ${newMove.move}!`); }
                }
            }
            if (winMsg.length > 0) await new Promise(res => startDialogue(winMsg, res, true)); winMsg = [];

            for (let i = 0; i < gameState.playerParty.length; i++) {
                const p = gameState.playerParty[i];
                const speciesData = pokemonDB[p.species];
                if (speciesData && speciesData.evolvesAt && p.level >= speciesData.evolvesAt && !p.hasEvolved) {
                    await new Promise(res => startDialogue([`What? ${p.name} is evolving!`], res, true));
                    const oldName = p.name; const newSpecies = speciesData.evolvesTo;
                    const newPokemon = createPokemon(newSpecies, p.level); newPokemon.xp = p.xp; newPokemon.hasEvolved = true;
                    gameState.playerParty[i] = newPokemon;
                    await new Promise(res => startDialogue([`Congratulations! Your ${oldName} evolved into ${newSpecies}!`], res, true));
                }
            }

            if (oldBattle.trainerId === 'gymLeaderRhonda' && !gameState.gymBadges.rhyme) {
                gameState.gymBadges.rhyme = true; winMsg.push("You received the Rhyme Badge!");
            }
            if (oldBattle.trainerId === 'gymLeaderLex' && !gameState.gymBadges.synonym) {
                gameState.gymBadges.synonym = true; winMsg.push("You received the Synonym Badge!");
                await new Promise(res => startDialogue(winMsg, res, true));
                triggerEarthquake(); return;
            }
            if (oldBattle.trainerId === 'goblinBoss') {
                winMsg.push("The Goblin dropped a strange metal object...");
                gameState.inventory.engineCog = 1;
            }
            if (oldBattle.trainerId === 'finalBosses') {
                gameState.finalBossDefeated = true;
                gameState.inventory.masterthesis = 1;
                delete maps.finalCave.objects['8,2'];
                delete maps.finalCave.objects['7,2'];
                delete maps.village.objects['6,8'];
                await new Promise(res => startDialogue([
                    "Andy: We did it! They dropped this... it looks powerful. You should have it. You earned it.",
                    "You got the Master Thesis!",
                    "Andy: Well, I guess this makes us friends, not just rivals. Go on, there's a legendary creature you need to catch."
                ], res, true));
            }
             if (oldBattle.trainerId === 'shipwreckedPilot') {
                winMsg.push("You got LH02 Lyrical Hightail!");
                gameState.inventory.LH02LyricalHightail = 1;
                await new Promise(res => startDialogue(winMsg, res, true)); winMsg = [];
                 startDialogue(["Pilot: It's time for me to go home."], () => {
                     changeMap('village', 10, 10);
                     triggerFinalBattleScene();
                     startDialogue("The pilot drops you off and flies away towards Lexington City.");
                 });
                return;
            }
            if (oldBattle.trainerId === 'finalRival') {
                showCredits();
                return;
            }
            if (oldBattle.opponentName === 'Andy' && !gameState.rivalDefeated) gameState.rivalDefeated = true;
            if (oldBattle.opponentName === 'Andy' && gameState.gymBadges.rhyme) gameState.rivalDefeatedPostGym = true;
            
            if(winMsg.length > 0) await new Promise(res => startDialogue(winMsg, res, true));
        }
        gameState.inBattle = false; battleScene.classList.add('hidden');
        saveGame();
    }

    function addPokemonToParty(pokemon) {
        if (!gameState.pokedex[pokemon.species]) gameState.pokedex[pokemon.species] = { seen: true, caught: false };
        gameState.pokedex[pokemon.species].caught = true;
        if (gameState.playerParty.length < 6) gameState.playerParty.push(pokemon);
        else gameState.pokemonBox.push(pokemon);
    }
    
    function shakeScreen(duration) {
        let startTime = Date.now();
        function shake() {
            let elapsed = Date.now() - startTime;
            if (elapsed < duration) {
                const x = (Math.random() - 0.5) * 10;
                const y = (Math.random() - 0.5) * 10;
                gameContainer.style.transform = `translate(${x}px, ${y}px)`;
                requestAnimationFrame(shake);
            } else {
                gameContainer.style.transform = 'translate(0, 0)';
            }
        }
        shake();
    }
    
    function triggerEarthquake() {
        if(gameState.earthquake1Triggered) return;
        startDialogue(["The ground begins to tremble violently!"], () => {
            shakeScreen(2000);
            setTimeout(() => {
                gameState.earthquake1Triggered = true;
                if(maps.village) {
                     maps.village.layout[5][4] = 26;
                     maps.village.objects['4,5'] = { target: 'caveLevel1', x: 2, y: 2 };
                     maps.village.objects['5,6'] = { 
                         sprite: 'professor', 
                         interaction: ["Geologist William Penn Budd IV: Fascinating! I've never seen anything like it!"]
                     };
                     maps.village.objects['3,6'] = {
                         sprite: 'rival',
                         interaction: [
                             "Andy: Whoa... did you feel that?",
                             "This hole... it's huge. Right in front of my house.",
                             "Look, I know we're rivals and all... but this is bigger than us.",
                             "On the battlefield, I'm still going to crush you.",
                             "But out here... if things are getting dangerous... we need to watch each other's backs. Got it?"
                         ]
                     };
                }
                startDialogue([
                    "B-b-brrrring! B-b-brrrring!",
                    "Your phone is ringing. It's Mom!",
                    "Mom: 'Sweetie, are you okay?! There was a huge earthquake! Please get home right away!'",
                    "'I've enabled the Home-Warp feature on the PC network. Use it to get back safely!'"
                ], () => {
                    gameState.teleportUnlocked = true;
                    saveGame();
                    startDialogue("The Home-Warp feature on PCs is now online!");
                });
            }, 2000);
        });
    }

    function triggerFinalBattleScene() {
        // Make the final hole and place NPCs
        maps.village.layout[7][7] = 26;
        maps.village.layout[7][8] = 26;
        maps.village.layout[8][7] = 26;
        maps.village.layout[8][8] = 26;
        
        const holeInteraction = { target: 'finalCave', x: 14, y: 11 };
        maps.village.objects['7,7'] = holeInteraction;
        maps.village.objects['8,7'] = holeInteraction;
        maps.village.objects['7,8'] = holeInteraction;
        maps.village.objects['8,8'] = holeInteraction;

        // Move Andy
        maps.village.objects['6,8'] = { 
            sprite: 'rival', 
            interaction: [
                "Andy: You're back! Another, bigger hole appeared!",
                "I saw two of those goblin things go down there. They look like they mean business.",
                "This has to be the source of the earthquakes. We have to stop them!",
                "I'll be right behind you!"
            ]
        };

        // Remove old NPCs
        delete maps.village.objects['3,6'];
        delete maps.village.objects['5,6'];
    }
    
    function showCredits() {
        document.getElementById('credits-container').classList.remove('hidden');
    }

    function init() {
        // Title Screen Logic
        gameState.activeScene = 'title';
        const continueBtn = document.getElementById('continue-btn');
        const newGameBtn = document.getElementById('new-game-title-btn');
        const titleOptions = document.getElementById('title-options');
        const pressKeyPrompt = document.getElementById('press-key-prompt');
        const newGameConfirm = document.getElementById('new-game-confirm');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');

        const showTitleOptions = () => {
            pressKeyPrompt.classList.add('hidden');
            titleOptions.classList.remove('hidden');
            if (!getSaveData()) {
                continueBtn.style.display = 'none';
            }
        };

        const keydownHandler = () => {
            showTitleOptions();
            window.removeEventListener('keydown', keydownHandler);
            window.removeEventListener('click', keydownHandler);
        };

        window.addEventListener('keydown', keydownHandler);
        window.addEventListener('click', keydownHandler);


        continueBtn.onclick = () => {
            if (loadGame()) {
                startGame(false); // Don't show intro dialogue
            }
        };

        newGameBtn.onclick = () => {
            titleOptions.classList.add('hidden');
            newGameConfirm.classList.remove('hidden');
        };

        confirmYesBtn.onclick = () => {
            localStorage.removeItem('elaQuestSaveData');
            gameState = getDefaultGameState(); // Reset state
            startGame(true); // Show intro dialogue
        };

        confirmNoBtn.onclick = () => {
            newGameConfirm.classList.add('hidden');
            titleOptions.classList.remove('hidden');
        };
    }
    
    function startGame(isNewGame) {
        titleScreen.classList.add('hidden');
        pageLayout.classList.remove('hidden');
        pageLayout.classList.add('flex');


        if (gameState.hasMetDeathMasheen) {
            const gamerObject = maps.cityHouse3.objects['2,3'];
            gamerObject.sprite = 'graduate';
            gamerObject.interaction = "Tom: 'I'm going to be a principal some day. Gamification rules!'";
        }

        if (isNewGame && !gameState.initialized) {
            startDialogue([ "You wake up.", "Mom (downstairs): 'Breakfast is ready!'", "(Arrows: Move | A/Enter: Interact | M: Menu)" ]); 
            gameState.initialized = true;
        } else {
             startDialogue("Welcome back!");
        }
        
        gameLoop(); 
    }

    init();
})();
</script>

</body>
</html>


























