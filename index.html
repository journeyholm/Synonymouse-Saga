<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ELA Quest: The Synonymouse Saga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #000;
            color: #fff;
            image-rendering: pixelated;
            overflow: hidden; /* Prevent scrolling */
        }
        #page-layout {
            width: 100vw;
            height: 100vh;
        }
        #game-container {
            width: 100%;
            max-width: 512px; /* Canvas base width */
            aspect-ratio: 16 / 14; /* Canvas aspect ratio */
            position: relative;
        }
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        .message-box {
            border: 8px solid #4a5568;
            border-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0 H80 V80 H0 Z' fill='%234a5568'/%3E%3Cpath d='M8 8 H72 V72 H8 Z' fill='white'/%3E%3C/svg%3E") 8 stretch;
            cursor: pointer;
            flex-shrink: 0;
        }
        .ui-scene {
            background-color: rgba(0,0,0,0.9);
        }
        .xp-bar-bg { background-color: #a0a0a0; }
        .xp-bar-fill { background-color: #60a5fa; }
        .pc-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .pc-item:hover {
            background-color: #e2e8f0;
        }
        .touch-btn {
            width: 60px;
            height: 60px;
            background-color: rgba(128, 128, 128, 0.5);
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        .touch-btn-a {
             width: 80px;
            height: 80px;
            background-color: rgba(239, 68, 68, 0.7);
        }
        .touch-btn-b {
             width: 70px;
            height: 70px;
            background-color: rgba(68, 138, 239, 0.7);
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="page-layout" class="flex flex-col lg:flex-row items-center justify-center lg:justify-evenly w-screen h-screen p-4 gap-4">
        
        <!-- D-Pad Container (Visible on LG screens and up) -->
        <div class="hidden lg:flex w-48 h-48 pointer-events-auto">
            <div class="grid grid-cols-3 grid-rows-3 gap-2 w-full h-full">
                <div></div>
                <button id="touch-up-lg" class="touch-btn">â–²</button>
                <div></div>
                <button id="touch-left-lg" class="touch-btn">â—€</button>
                <div></div>
                <button id="touch-right-lg" class="touch-btn">â–¶</button>
                <div></div>
                <button id="touch-down-lg" class="touch-btn">â–¼</button>
                <div></div>
            </div>
        </div>

        <!-- Main Game Area -->
        <div class="flex flex-col items-center justify-center">
            <div id="game-container">
                <canvas id="gameCanvas"></canvas>
                <button id="menu-btn" class="absolute top-2 right-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg border-4 border-white">Menu</button>
            </div>

            <div id="message-box" class="message-box w-full max-w-xl min-h-[8rem] p-4 mt-2 bg-white text-gray-800 rounded-lg text-xl leading-snug flex justify-between items-start">
                <p id="message-text">Welcome to ELA Quest!</p>
                <div id="choices-box" class="grid grid-cols-1 gap-2 overflow-y-auto max-h-32"></div>
            </div>
        </div>
        
        <!-- Action Buttons Container (Visible on LG screens and up) -->
        <div class="hidden lg:flex items-center gap-4 pointer-events-auto">
             <button id="touch-b-lg" class="touch-btn touch-btn-b text-3xl">B</button>
             <button id="touch-a-lg" class="touch-btn touch-btn-a text-3xl">A</button>
        </div>


        <!-- Mobile Touch Controls (Visible on smaller screens, hidden on LG and up) -->
        <div id="touch-controls" class="lg:hidden fixed bottom-0 left-0 right-0 p-4 flex justify-between items-end pointer-events-none">
            <div class="grid grid-cols-3 grid-rows-3 gap-2 w-48 h-48 pointer-events-auto">
                <div></div>
                <button id="touch-up" class="touch-btn">â–²</button>
                <div></div>
                <button id="touch-left" class="touch-btn">â—€</button>
                <div></div>
                <button id="touch-right" class="touch-btn">â–¶</button>
                <div></div>
                <button id="touch-down" class="touch-btn">â–¼</button>
                <div></div>
            </div>
            <div class="flex items-center gap-4 pointer-events-auto">
                <button id="touch-b" class="touch-btn touch-btn-b text-3xl">B</button>
                <button id="touch-a" class="touch-btn touch-btn-a text-3xl">A</button>
            </div>
        </div>
    </div>
    
    <div id="battle-scene" class="hidden absolute inset-0 bg-black bg-opacity-90 flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-4xl">
            <!-- Opponent Info -->
            <div class="flex justify-between items-end">
                <div id="opponent-sprite" class="text-8xl w-1/4 transform -scale-x-100"></div>
                <div class="text-right mb-4 w-3/4">
                    <p id="opponent-name" class="text-2xl"></p>
                    <div class="w-full bg-gray-600 rounded-full h-6 border-4 border-gray-400">
                        <div id="opponent-hp" class="bg-green-500 h-full rounded-full transition-all duration-500" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <!-- Player Info -->
            <div class="flex justify-between items-end mt-12">
                <div class="text-left w-3/4">
                    <p id="player-name" class="text-2xl"></p>
                    <div class="w-full bg-gray-600 rounded-full h-6 border-4 border-gray-400">
                        <div id="player-hp" class="bg-green-500 h-full rounded-full transition-all duration-500" style="width: 100%"></div>
                    </div>
                     <p id="player-hp-text" class="text-lg text-right"></p>
                </div>
                <div id="player-sprite" class="text-8xl w-1/4"></div>
            </div>
        </div>

        <!-- Actions / Question and Answers -->
        <div id="battle-box" class="message-box w-full max-w-4xl mx-auto min-h-48 p-4 mt-8 bg-white text-gray-800 rounded-lg">
            <p id="battle-text" class="text-xl mb-4"></p>
            <div id="battle-grid" class="grid grid-cols-2 gap-4">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>
    
    <!-- UI Scenes -->
    <div id="menu-scene" class="hidden ui-scene absolute inset-0 p-8 flex flex-col items-center justify-center">
        <div class="w-full max-w-sm bg-white text-black rounded-lg border-8 border-gray-500 p-6 grid grid-cols-1 gap-4">
            <h2 class="text-3xl text-center mb-2">Menu</h2>
            <button id="menu-pokedex-btn" class="w-full p-3 bg-blue-500 text-white rounded-lg text-2xl">Lexicon</button>
            <button id="menu-pokemon-btn" class="w-full p-3 bg-blue-500 text-white rounded-lg text-2xl">Creatures</button>
            <button id="menu-inventory-btn" class="w-full p-3 bg-blue-500 text-white rounded-lg text-2xl">Inventory</button>
            <button id="menu-close-btn" class="mt-4 w-full p-3 bg-red-500 text-white rounded-lg text-2xl">Close</button>
        </div>
    </div>
    
    <div id="inventory-scene" class="hidden ui-scene absolute inset-0 p-8 flex flex-col items-center justify-center">
        <div class="w-full max-w-2xl bg-white text-black rounded-lg border-8 border-gray-500 p-6">
            <h2 class="text-3xl text-center mb-4">Inventory</h2>
            <div class="text-2xl mb-6 flex justify-between">
                <span>Money:</span>
                <span id="inventory-money"></span>
            </div>
            <div id="inventory-items" class="space-y-4 min-h-[100px]"></div>
            <button class="ui-back-btn mt-6 w-full p-3 bg-yellow-500 text-black rounded-lg text-2xl">Back</button>
        </div>
    </div>

    <div id="pokemon-stats-scene" class="hidden ui-scene absolute inset-0 p-8 flex flex-col items-center justify-center">
        <div id="pokemon-stats-content" class="w-full max-w-3xl bg-white text-black rounded-lg border-8 border-gray-500 p-6">
             <!-- Stats will be dynamically inserted here -->
        </div>
    </div>

    <div id="pokedex-scene" class="hidden ui-scene absolute inset-0 p-8 flex flex-col items-center justify-center">
        <div class="w-full max-w-3xl bg-white text-black rounded-lg border-8 border-gray-500 p-6">
            <h2 class="text-3xl text-center mb-4">Lexicon</h2>
            <div id="pokedex-entries" class="space-y-4 max-h-[60vh] overflow-y-auto"></div>
            <button class="ui-back-btn mt-6 w-full p-3 bg-yellow-500 text-black rounded-lg text-2xl">Back</button>
        </div>
    </div>

    <div id="pc-scene" class="hidden ui-scene absolute inset-0 p-8 flex flex-col items-center justify-center">
        <div class="w-full max-w-4xl bg-white text-black rounded-lg border-8 border-gray-500 p-6">
            <h2 class="text-3xl text-center mb-4">Creature Storage</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <h3 class="text-2xl text-center">Party</h3>
                    <div id="pc-party" class="space-y-2 mt-2"></div>
                </div>
                <div>
                    <h3 class="text-2xl text-center">Box</h3>
                    <div id="pc-box" class="space-y-2 mt-2 max-h-[40vh] overflow-y-auto"></div>
                </div>
            </div>
            <button id="pc-close-btn" class="mt-6 w-full p-3 bg-red-500 text-white rounded-lg text-2xl">Close</button>
        </div>
    </div>


<script>
    // --- Game Setup ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const messageBox = document.getElementById('message-box');
    const messageText = document.getElementById('message-text');
    const choicesBox = document.getElementById('choices-box');
    const battleScene = document.getElementById('battle-scene');
    const battleBox = document.getElementById('battle-box');
    const battleText = document.getElementById('battle-text');
    const battleGrid = document.getElementById('battle-grid');
    
    const menuScene = document.getElementById('menu-scene');
    const inventoryScene = document.getElementById('inventory-scene');
    const pokemonStatsScene = document.getElementById('pokemon-stats-scene');
    const pokedexScene = document.getElementById('pokedex-scene');
    const pcScene = document.getElementById('pc-scene');

    const tileSize = 32;
    canvas.width = 16 * tileSize; canvas.height = 14 * tileSize;

    let gameState = {
        currentMap: 'playerRoom',
        player: { x: 4, y: 4, sprite: 'player' },
        inDialogue: false, inBattle: false, activeScene: null,
        money: 50,
        inventory: { potions: 3, wordballs: 5, greatphrases: 0, ultrasentences: 0, masterthesis: 0, adjectiveElixirs: 0, thesaurusTeas: 0, escapeVerbs: 0, LH01LuminousHyperbole: 0 },
        rivalDefeated: false,
        rivalDefeatedPostGym: false,
        rivalDefeatedInSynonymCity: false,
        defeatedTrainers: [],
        pokedex: {}, // { species: { seen: bool, caught: bool }}
        playerParty: [],
        pokemonBox: [],
        gymBadges: { rhyme: false, synonym: false },
        devModeActive: false,
        hasMetDeathMasheen: false,
    };
    
    const attacksDB = {
        'Tackle': { name: 'Tackle', power: 8, text: 'A basic physical strike.' },
        'Word Strike': { name: 'Word Strike', power: 10, text: 'Channels knowledge into a jab.' },
        'Synonym Slam': { name: 'Synonym Slam', power: 15, text: 'A blow backed by similar words.' },
        'Roar of Knowledge': { name: 'Roar of Knowledge', power: 22, text: 'A stunning cry of ancient truths.'},
        'Gooey Touch': { name: 'Gooey Touch', power: 7, text: 'A sticky, weak jab.'},
        'Chameleon Color': {name: 'Chameleon Color', power: 12, text: 'Changes color to land a surprising hit.'},
        'Scale Shot': {name: 'Scale Shot', power: 18, text: 'Fires sharp scales at the foe.'},
        'Leer': { name: 'Leer', power: 0, text: 'Lowers enemy defense.', effect: { type: 'stat', stat: 'defense', amount: -1, target: 'opponent' } },
        'Growl': { name: 'Growl', power: 0, text: 'Lowers enemy attack.', effect: { type: 'stat', stat: 'attack', amount: -1, target: 'opponent' } },
        'Sharpen': { name: 'Sharpen', power: 0, text: 'Raises the user\'s Attack stat.', effect: { type: 'stat', stat: 'attack', amount: 1, target: 'self' } }
    };

    const pokedexData = {
        'Synonymouse': 'A clever creature that finds strength in words with similar meanings.',
        'ThesaurusRex': 'The evolved form of Synonymouse. Its vast vocabulary gives it immense power.',
        'Wordworm': 'Common in grassy areas, this creature consumes letters for sustenance.',
        'Grammargoyle': 'A stoic opponent that strictly adheres to the rules of language.',
        'SimileSlime': 'A gooey creature that is *like* a puddle but *as* solid as a rock.',
        'CommaLeon': 'This creature can pause, adapt, and blend into any sentence structure.',
        'Adjectlizard': 'A reptile that describes its foes into submission with powerful adjectives.',
        'Haiku-na': 'A serene creature that attacks in a pattern of 5, then 7, then 5 syllables.',
        'Metaphorpillar': 'It believes it IS a leaf, consuming knowledge until it transforms.',
        'Hyper-bole': 'This creature is the BIGGEST, STRONGEST, and FASTEST creature in the entire universe! (Or so it claims).',
        'PronounProwler': 'A swift hunter that replaces its prey\'s name with "it" before it strikes.',
        'VerbViper': 'This serpent moves with decisive action, striking with a powerful verb-al assault.',
    };

    const itemsDB = {
        'wordballs': { name: 'Word Ball', bonus: 1.0 },
        'greatphrases': { name: 'Great Phrase', bonus: 1.5 },
        'ultrasentences': { name: 'Ultra Sentence', bonus: 2.0 },
        'masterthesis': { name: 'Master Thesis', bonus: 255 } // Represents a guaranteed catch
    };

    const pokemonDB = {
        'Synonymouse': { sprite: 'synonymouse', evolvesAt: 10, evolvesTo: 'ThesaurusRex', learnset: [{ level: 7, move: 'Synonym Slam' }], catchDifficulty: 45 },
        'ThesaurusRex': { sprite: 'thesaurusrex', learnset: [{ level: 12, move: 'Roar of Knowledge' }], catchDifficulty: 25 },
        'Wordworm': { sprite: 'wordworm', catchDifficulty: 255 },
        'Grammargoyle': { sprite: 'grammargoyle', catchDifficulty: 45 },
        'SimileSlime': { sprite: 'simileslime', catchDifficulty: 190 },
        'CommaLeon': { sprite: 'commaleon', catchDifficulty: 90 },
        'Adjectlizard': {sprite: 'adjectlizard', learnset: [{level: 9, move: 'Scale Shot'}], catchDifficulty: 45 },
        'Haiku-na': { sprite: 'haikuna', catchDifficulty: 75 },
        'Metaphorpillar': { sprite: 'metaphorpillar', catchDifficulty: 255 },
        'Hyper-bole': { sprite: 'hyperbole', catchDifficulty: 120 },
        'PronounProwler': { sprite: 'pronounprowler', catchDifficulty: 90 },
        'VerbViper': { sprite: 'verbviper', catchDifficulty: 90 },
    };
    
    const createPokemon = (species, level) => {
        let baseHp = 15, baseAtk = 8, baseDef = 5, attacks = ['Tackle'];
        switch(species) {
            case 'Synonymouse': baseHp = 20; baseAtk = 10; baseDef = 6; attacks = ['Tackle', 'Word Strike', 'Growl']; break;
            case 'ThesaurusRex': baseHp = 40; baseAtk = 20; baseDef = 15; attacks = ['Tackle', 'Word Strike', 'Synonym Slam']; break;
            case 'Grammargoyle': baseHp = 30; baseAtk = 14; baseDef = 10; attacks = ['Tackle', 'Leer', 'Sharpen']; break;
            case 'Wordworm': baseHp = 15; baseAtk = 6; baseDef = 4; attacks = ['Tackle', 'Growl']; break;
            case 'SimileSlime': baseHp = 18; baseAtk = 7; baseDef = 8; attacks = ['Gooey Touch']; break;
            case 'CommaLeon': baseHp = 22; baseAtk = 9; baseDef = 7; attacks = ['Tackle', 'Chameleon Color']; break;
            case 'Adjectlizard': baseHp = 30; baseAtk = 12; baseDef = 9; attacks = ['Tackle', 'Leer', 'Scale Shot']; break;
            case 'Haiku-na': baseHp = 20; baseAtk = 11; baseDef = 6; break;
            case 'Metaphorpillar': baseHp = 16; baseAtk = 5; baseDef = 12; break;
            case 'Hyper-bole': baseHp = 12; baseAtk = 14; baseDef = 3; break;
            case 'PronounProwler': baseHp = 25; baseAtk = 13; baseDef = 7; attacks = ['Tackle', 'Leer']; break;
            case 'VerbViper': baseHp = 28; baseAtk = 15; baseDef = 6; attacks = ['Tackle', 'Growl']; break;
        }
        return { 
            species, name: species, level, 
            currentHp: baseHp + (level * 5), maxHp: baseHp + (level * 5), 
            attack: baseAtk + (level * 2), defense: baseDef + (level * 2),
            xp: 0, xpToNextLevel: 100, 
            attacks: attacks.map(a => attacksDB[a]), 
            sprite: pokemonDB[species] ? pokemonDB[species].sprite : species.toLowerCase(),
            statMods: { attack: 0, defense: 0 },
            hasEvolved: false,
        };
    };

    const trainersDB = {
        'hikerTom': {
            name: "Hiker Tom",
            pokemon: [createPokemon('Wordworm', 6)],
            preBattle: ["A trainer! Finally a challenge! Let's battle!"],
            postBattle: ["Huff... puff... you're pretty strong. Keep it up!"],
            reward: 60
        },
        'readerSue': {
            name: "Reader Sue",
            pokemon: [createPokemon('SimileSlime', 7)],
            preBattle: ["Oh! You want to battle? My SimileSlime is as ready as a spring day!"],
            postBattle: ["Wow! Your skills are like a roaring fire!"],
            reward: 70
        },
        'bookwormBarry': {
            name: "Bookworm Barry",
            pokemon: [createPokemon('PronounProwler', 15)],
            preBattle: ["I've read about every creature! Let's see if your skills are textbook!"],
            postBattle: ["Wow, a real-world lesson! You're tougher than the texts said."],
            reward: 150
        },
        'artistAdeline': {
            name: "Artist Adeline",
            pokemon: [createPokemon('VerbViper', 17)],
            preBattle: ["I'm painting a picture of a perfect battle. You're my subject!"],
            postBattle: ["Such vivid action! You've inspired my next masterpiece."],
            reward: 170
        },
        'profGrendel': {
            name: "Professor Grendel",
            pokemon: [createPokemon('ThesaurusRex', 25), createPokemon('VerbViper', 28)],
            preBattle: ["You dare challenge the master of semantics? Your story ends here!"],
            postBattle: ["Hmph. A mere fluke. You have not seen the last of my literary might!"],
            reward: 300
        },
        'gymLeaderLex': {
            name: "Gym Leader Lex",
            pokemon: [createPokemon('ThesaurusRex', 30), createPokemon('Grammargoyle', 28)],
            preBattle: ["Welcome to the grand library of battle! Let's see if your lexicon is as mighty as your creatures!"],
            postBattle: ["Astounding! Your command of language is impressive! You've earned this!"],
            reward: 500
        }
    };

    const elaQuestions = [
        { q: "Which word is a synonym for 'happy'?", a: ["Joyful", "Sad", "Angry", "Tired"], c: "Joyful" },
        { q: "What opposes the protagonist?", a: ["Antagonist", "Ally", "Narrator", "Mentor"], c: "Antagonist" },
        { q: "Identify the verb: 'The cat quickly climbed the tree.'", a: ["climbed", "quickly", "cat", "tree"], c: "climbed" },
        { q: "'The wind whispered' is an example of...?", a: ["Personification", "Metaphor", "Simile", "Hyperbole"], c: "Personification" },
        { q: "Which word is an antonym for 'begin'?", a: ["Finish", "Start", "Create", "Open"], c: "Finish" },
        { q: "Which is spelled correctly?", a: ["Definitely", "Definately", "Definitly", "Definantly"], c: "Definitely" },
        { q: "What is the main idea of a story?", a: ["Theme", "Plot", "Setting", "Conflict"], c: "Theme" },
        { q: "'As brave as a lion' is an example of...?", a: ["Simile", "Metaphor", "Allusion", "Irony"], c: "Simile" },
        { q: "Choose the correct pronoun: '___ and I went to the store.'", a: ["He", "Him", "His", "Them"], c: "He" },
        { q: "Which sentence is a compound sentence?", a: ["I like pizza, and I like tacos.", "I like pizza.", "Because I like pizza, I ate it.", "I like pizza, tacos, and burgers."], c: "I like pizza, and I like tacos." },
        { q: "What is an 'adjective'?", a: ["A word that describes a noun", "A word for an action", "A person, place, or thing", "A word that describes a verb"], c: "A word that describes a noun" },
        { q: "Which of these is NOT a genre of literature?", a: ["Mathematics", "Fantasy", "Mystery", "Biography"], c: "Mathematics" },
        { q: "'Her smile is the sun' is an example of...?", a: ["Metaphor", "Simile", "Personification", "Hyperbole"], c: "Metaphor" },
        { q: "Find the error: 'Their going to the park.'", a: ["Their", "going", "to", "park"], c: "Their" },
        { q: "What is the climax of a story?", a: ["The most exciting point", "The beginning", "The ending", "The setting"], c: "The most exciting point" },
        { q: "Which is spelled correctly?", a: ["Receive", "Recieve", "Reiceve", "Receeve"], c: "Receive" },
        { q: "What is an adverb?", a: ["A word describing a verb", "A word describing a noun", "A short exclamation", "A connecting word"], c: "A word describing a verb" },
        { q: "What type of conflict is a character struggling against nature?", a: ["Character vs. Nature", "Character vs. Self", "Character vs. Society", "Character vs. Character"], c: "Character vs. Nature" },
        { q: "Which punctuation mark ends a question?", a: ["?", ".", "!", ","], c: "?" },
        { q: "An 'allusion' in literature is...", a: ["A reference to another work", "An illusion or trick", "The main character's goal", "A type of rhyme"], c: "A reference to another work" },
        { q: "Which word is a synonym for 'brave'?", a: ["Courageous", "Cowardly", "Meek", "Timid"], c: "Courageous" },
        { q: "What is a 'protagonist'?", a: ["The main character", "The villain", "The narrator", "A side character"], c: "The main character" },
        { q: "'The car engine coughed and sputtered' is an example of...?", a: ["Personification", "Simile", "Metaphor", "Onomatopoeia"], c: "Personification" },
        { q: "Which is spelled correctly?", a: ["Separate", "Seperate", "Saperate", "Seperete"], c: "Separate" },
        { q: "A 'biography' is a story of a person's life written by...", a: ["Someone else", "The person themselves", "A novelist", "An unknown author"], c: "Someone else" },
        { q: "What is the setting of a story?", a: ["When and where it takes place", "The main problem", "The list of characters", "The lesson learned"], c: "When and where it takes place" },
        { q: "Which word is an antonym for 'ancient'?", a: ["Modern", "Old", "Aged", "Past"], c: "Modern" },
        { q: "'The world is a stage' is an example of...?", a: ["Metaphor", "Simile", "Alliteration", "Irony"], c: "Metaphor" },
        { q: "What is the correct use of 'its' and 'it's'?", a: ["It's a beautiful day.", "The dog wagged its tail.", "Both are correct", "Both are incorrect"], c: "Both are correct" },
        { q: "Identify the noun: 'The quick brown fox jumps.'", a: ["fox", "quick", "brown", "jumps"], c: "fox" },
        { q: "What does 'hyperbole' mean?", a: ["Exaggeration for effect", "A comparison using 'like'", "Giving human qualities to objects", "A question with no answer"], c: "Exaggeration for effect" },
        { q: "'I'm so hungry I could eat a horse' is an example of...?", a: ["Hyperbole", "Simile", "Understatement", "Irony"], c: "Hyperbole" },
        { q: "Which is spelled correctly?", a: ["Necessary", "Necesary", "Neccessary", "Necassary"], c: "Necessary" },
        { q: "A story's sequence of events is its...", a: ["Plot", "Theme", "Setting", "Character arc"], c: "Plot" },
        { q: "What is a 'haiku'?", a: ["A three-line poem with a 5-7-5 syllable structure", "A four-line rhyming poem", "A long epic story", "A funny short story"], c: "A three-line poem with a 5-7-5 syllable structure" },
        { q: "Which word is a synonym for 'look'?", a: ["Gaze", "Speak", "Listen", "Feel"], c: "Gaze" },
        { q: "The perspective from which a story is told is the...", a: ["Point of View", "Climax", "Resolution", "Exposition"], c: "Point of View" },
        { q: "What is the correct spelling?", a: ["Conscience", "Concience", "Consience", "Conscence"], c: "Conscience" },
        { q: "The struggle between opposing forces in a story is the...", a: ["Conflict", "Theme", "Setting", "Dialogue"], c: "Conflict" },
        { q: "'The buzzing bee flew by' is an example of...?", a: ["Onomatopoeia", "Metaphor", "Simile", "Allusion"], c: "Onomatopoeia" },
        { q: "What is a 'verb'?", a: ["An action or state of being", "A person, place, or thing", "A descriptive word", "A connecting word"], c: "An action or state of being" },
        { q: "Which word is an antonym of 'difficult'?", a: ["Easy", "Hard", "Challenging", "Complex"], c: "Easy" },
        { q: "What does the prefix 'un-' mean in 'unhappy'?", a: ["Not", "Very", "Again", "Before"], c: "Not" },
        { q: "What is the correct spelling?", a: ["Embarrass", "Embarass", "Embarras", "Embaras"], c: "Embarrass" },
        { q: "A 'sonnet' is a poem of...", a: ["14 lines", "10 lines", "20 lines", "5 lines"], c: "14 lines" },
        { q: "What type of sentence makes a command?", a: ["Imperative", "Declarative", "Interrogative", "Exclamatory"], c: "Imperative" },
        { q: "'Peter Piper picked a peck of pickled peppers' is an example of...?", a: ["Alliteration", "Assonance", "Metaphor", "Simile"], c: "Alliteration" },
        { q: "Which word is a synonym for 'big'?", a: ["Enormous", "Tiny", "Small", "Weak"], c: "Enormous" },
        { q: "A hint or clue about what will happen later in a story is...", a: ["Foreshadowing", "Flashback", "Symbolism", "Imagery"], c: "Foreshadowing" },
        { q: "What is the correct spelling?", a: ["Weird", "Wierd", "Wiered", "Weired"], c: "Weird" }
    ];
    let currentBattle = null;

    const sprites = {
        player: 'ðŸ§‘', mom: 'ðŸ‘©', professor: 'ðŸ‘¨â€ðŸ«', rival: 'ðŸ˜ ', villager: 'ðŸ§”', villager2: 'ðŸ‘±â€â™€ï¸', hiker: 'ðŸ¥¾', poeFan: 'ðŸ§›', nurse: 'ðŸ‘©â€âš•ï¸', shopkeep: 'ðŸª', gymLeader: 'ðŸ†',
        poet: 'âœ’ï¸', computer: 'ðŸ’»', bookworm: 'ðŸ›', sign: 'ðŸª§', lightbulb: 'ðŸ’¡', boat: 'â›µï¸',
        pokeball: 'ðŸ”´', tree: 'ðŸŒ³', door: 'ðŸšª', bed: 'ðŸ›ï¸', tv: 'ðŸ“º', bookshelf: 'ðŸ“š', table: 'ðŸ½ï¸', dictionary: 'ðŸ“–',
        gate: 'ðŸš§', stairsUp: 'â¬†ï¸', flower: 'ðŸŒ¼', graduate: 'ðŸ§‘â€ðŸŽ“',
        synonymouse: 'ðŸ­', thesaurusrex: 'ðŸ¦–', wordworm: 'ðŸ›', grammargoyle: 'ðŸ‘¹', simileslime: 'ðŸ’§', commaleon: 'ðŸ¦Ž', adjectlizard: 'ðŸŠ',
        haikuna: 'ðŸ•Šï¸', metaphorpillar: 'ðŸ¦‹', hyperbole: 'ðŸ‚', pronounprowler: 'ðŸ†', verbviper: 'ðŸ',
    };

    const drawSprite = (spriteKey, x, y) => { ctx.font = `${tileSize * 0.8}px serif`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(sprites[spriteKey], x * tileSize + tileSize / 2, y * tileSize + tileSize / 2); };

    const maps = {
        playerRoom: { layout: [[1,1,1,1,1,1,1,1],[1,22,22,22,22,22,22,1],[1,11,0,0,10,0,9,1],[1,0,0,0,0,0,0,1],[1,22,22,0,0,22,22,1],[1,1,1,2,2,1,1,1]], objects: { '4,2': { sprite: 'bed', interaction: handleBedInteraction }, '6,2': { sprite: 'tv', interaction: "'The course of true love never did run smooth.' It's 'A Midsummer Night's Dream.'" }, '1,2': { interaction: "You see strange creatures hopping in the tall grass." }, '3,5': { target: 'playerHouse', x: 4, y: 5 }, '4,5': { target: 'playerHouse', x: 4, y: 5 } } },
        playerHouse: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,13,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,23,0,0,23,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,1': { sprite: 'bookshelf', interaction: "Tales of adventure: 'The Odyssey' and 'Treasure Island'." }, '1,3': { sprite: 'mom', interaction: () => gameState.playerParty.length > 0 ? "Be careful out there!" : "Hurry, dear! Professor Lexicon is waiting." }, '2,3': { sprite: 'dictionary', interaction: "Onomatopoeia: (n.) the formation of a word from a sound associated with what is named (e.g., cuckoo, sizzle)." }, '3,6': { target: 'village', x: 10, y: 9 }, '4,6': { target: 'village', x: 10, y: 9 }, '4,1': { sprite: 'stairsUp', target: 'playerRoom', x: 4, y: 4 }, '6,1': { sprite: 'computer', interaction: handlePCInteraction } } },
        village: { 
            layout: [
                [8,8,8,8,8,8,0,0,0,8,8,8,8,8,8,8],
                [8,7,7,7,7,7,0,0,0,7,7,7,7,7,7,8],
                [8,7,6,4,6,7,0,0,0,7,6,4,6,7,7,8],
                [8,7,3,5,3,7,0,0,0,7,3,5,3,7,7,8],
                [8,7,3,2,3,7,0,0,0,7,3,2,3,7,7,8],
                [8,7,7,0,0,0,0,0,0,0,0,0,0,7,7,8],
                [8,7,7,7,6,4,6,7,7,6,4,6,0,7,7,8],
                [8,7,7,7,3,5,3,7,7,3,5,3,0,7,7,8],
                [8,7,7,7,3,2,3,0,0,3,2,3,0,7,7,8],
                [8,7,7,7,7,0,0,0,0,0,0,0,0,7,7,8],
                [8,7,16,7,7,0,0,0,0,0,0,0,0,16,7,8],
                [8,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8],
                [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8]
            ],
            objects: {
                '3,4': { target: 'rivalsHouse', x: 4, y: 5, symbol: 'ðŸ ', symbolOffsetY: -2 },
                '11,4': { target: 'profHouse', x: 4, y: 5, symbol: 'ðŸ”¬', symbolOffsetY: -2 },
                '5,8': { target: 'villagerHouse1', x: 4, y: 5, symbol: 'ðŸ ', symbolOffsetY: -2 },
                '10,8': { target: 'playerHouse', x: 4, y: 5, symbol: 'ðŸ ', symbolOffsetY: -2 },
                '2,9': { sprite: 'villager', interaction: "Lowering an opponent's stats can be more effective than a direct attack!" },
                '7,0': { sprite: 'gate', interaction: handleGateInteraction },
                '8,0': { sprite: 'gate', interaction: handleGateInteraction },
                '10,10': { sprite: 'sign', interaction: 'Village of Beginnings' },
                '7,12': { target: 'homeBay', x: 7, y: 1 },
                '8,12': { target: 'homeBay', x: 8, y: 1 }
            },
            encounters: []
        },
        profHouse: { layout: [[1,1,1,1,1,1,1,1],[1,12,0,0,0,0,12,1],[1,0,0,0,0,0,0,1],[1,0,15,0,15,0,15,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '4,2': { sprite: 'professor', interaction: handleProfessorInteraction }, '2,3': { sprite: 'pokeball', interaction: "It's an empty Word Ball case." }, '4,3': { sprite: 'pokeball', interaction: "It's an empty Word Ball case." }, '6,3': { sprite: 'pokeball', interaction: "It's an empty Word Ball case." }, '3,5': { target: 'village', x: 11, y: 5 }, '4,5': { target: 'village', x: 11, y: 5 } } },
        rivalsHouse: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'mom', interaction: "My son, Andy, is already out training. He's so eager!" }, '6,2': { sprite: 'table', interaction: "A textbook on 'Advanced Antonyms' is left open." }, '4,1': { sprite: 'stairsUp', target: 'rivalsRoom', x: 4, y: 4 }, '3,5': { target: 'village', x: 3, y: 5 }, '4,5': { target: 'village', x: 3, y: 5 } } },
        rivalsRoom: {
            layout: [
                [1,1,1,1,1,1,1,1],
                [1,22,22,22,22,22,22,1],
                [1,11,0,0,10,0,9,1],
                [1,0,0,0,0,0,0,1],
                [1,22,22,0,0,22,22,1],
                [1,1,1,2,2,1,1,1]
            ],
            objects: {
                '6,2': { sprite: 'tv', interaction: "The screen shows a creepy doll shop. A girl who looks just like one of the dolls touches it, and her soul is sucked inside, trapping her forever. The doll is then placed in the window, awaiting its next victim. It gives you chills." },
                '4,2': { sprite: 'bed', interaction: "Your rival's bed. It's surprisingly neat." },
                '1,2': { interaction: "The window looks out over the town." },
                '3,5': { target: 'rivalsHouse', x: 4, y: 1 },
                '4,5': { target: 'rivalsHouse', x: 4, y: 1 }
            }
        },
        route1: { 
            layout: [ 
                [8,8,8,7,7,0,0,0,0,7,7,8,8,8,8,8], 
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8], 
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8], 
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8], 
                [8,8,8,7,7,0,0,0,0,7,7,8,8,8,8,8], 
                [8,8,8,8,8,0,0,0,0,8,8,8,8,8,8,8] 
            ], 
            objects: { 
                '2,2': { sprite: 'hiker', interaction: () => handleTrainerBattle('hikerTom') }, 
                '13,2': { sprite: 'villager', interaction: () => handleTrainerBattle('readerSue') },
                '5,5': { target: 'village', x: 7, y: 1 }, '6,5': { target: 'village', x: 8, y: 1 }, 
                '5,0': { target: 'lexingtonCity', x: 7, y: 13 }, '6,0': { target: 'lexingtonCity', x: 8, y: 13 }, 
                '7,0': { target: 'lexingtonCity', x: 7, y: 13 }, '8,0': { target: 'lexingtonCity', x: 8, y: 13 }, 
                '8,4': { sprite: 'sign', interaction: 'Route 1' }
            }, 
            encounters: ['Wordworm', 'SimileSlime', 'CommaLeon', 'Hyper-bole', 'Metaphorpillar', 'Haiku-na'] 
        },
        lexingtonCity: { 
            layout: [ 
                [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8], 
                [8,0,16,0,6,19,19,6,0,6,21,21,6,0,16,8], 
                [8,0,4,4,3,18,18,3,0,3,20,20,3,0,4,8], 
                [8,0,3,3,3,18,18,3,0,3,20,20,3,0,3,8], 
                [8,0,2,0,3,2,5,3,0,3,2,5,3,0,2,8], 
                [8,0,16,0,6,19,19,6,0,6,21,21,6,0,16,8], 
                [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8], 
                [8,0,4,4,0,0,0,0,0,0,0,0,4,4,0,8], 
                [8,0,3,3,0,0,0,0,0,0,0,0,3,3,0,8], 
                [8,0,2,0,0,0,0,0,0,0,0,0,0,2,0,8], 
                [8,0,16,0,0,0,0,0,0,0,0,0,0,16,0,8], 
                [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8], 
                [8,0,16,0,0,16,0,0,0,16,0,0,16,0,0,8], 
                [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8] 
            ], 
            objects: { 
                '2,4': { symbol: 'â¤ï¸', symbolOffsetY: -2 }, '2,5': { target: 'pokecenter', x: 4, y: 5 }, 
                '5,4': { symbol: 'ðŸ›’', symbolOffsetY: -2 }, '5,5': { target: 'shop', x: 4, y: 5 }, 
                '10,4': { symbol: 'ðŸ†', symbolOffsetY: -2 }, '10,5': { target: 'gym', x: 4, y: 5 }, 
                '13,4': { symbol: 'ðŸ ', symbolOffsetY: -2 }, '13,5': { target: 'cityHouse1', x: 4, y: 5 }, 
                '2,9': { symbol: 'ðŸ ', symbolOffsetY: -2 }, '2,10': { target: 'cityHouse2', x: 4, y: 5 }, 
                '13,9': { symbol: 'ðŸ ', symbolOffsetY: -2 }, '13,10': { target: 'cityHouse3', x: 4, y: 5 },
                '3,1': { sprite: 'poeFan', interaction: handlePoeInteraction }, 
                '1,10': { sprite: 'poet', interaction: ["A 5-7-5 syllable structure...", "The haiku is a gentle art.", "Even a battle can be poetry."] },
                '7,0': { sprite: 'gate', interaction: handleNorthGate }, '8,0': { sprite: 'gate', interaction: handleNorthGate },
                '7,13': { target: 'route1', x: 7, y: 0 }, 
                '8,13': { target: 'route1', x: 8, y: 0 },
                '9,12': { sprite: 'sign', interaction: 'Lexington City' }
            } 
        },
        pokecenter: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'nurse', interaction: handleNurseInteraction }, '1,2': { sprite: 'computer', interaction: handlePCInteraction }, '2,2': { sprite: 'synonymouse', interaction: "A healthy-looking Synonymouse is resting here." }, '3,5': { target: 'lexingtonCity', x: 2, y: 5 }, '4,5': { target: 'lexingtonCity', x: 2, y: 5 } } },
        shop: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'shopkeep', interaction: handleShopInteraction }, '3,5': { target: 'lexingtonCity', x: 5, y: 5 }, '4,5': { target: 'lexingtonCity', x: 5, y: 5 } } },
        gym: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '4,1': { sprite: 'gymLeader', interaction: handleGymLeaderInteraction }, '3,5': { target: 'lexingtonCity', x: 10, y: 5 }, '4,5': { target: 'lexingtonCity', x: 10, y: 5 } } },
        cityHouse1: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,13,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '2,3': { sprite: 'villager', interaction: "The gym leader here, Rhonda, loves rhymes. A well-constructed couplet might impress her!" }, '3,5': { target: 'lexingtonCity', x: 13, y: 5 }, '4,5': { target: 'lexingtonCity', x: 13, y: 5 } } },
        cityHouse2: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,13,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '2,3': { sprite: 'villager2', interaction: "She looks out the window. 'The waves are so restless today... I hope my sailor returns from the sea soon.'" }, '3,5': { target: 'lexingtonCity', x: 2, y: 10 }, '4,5': { target: 'lexingtonCity', x: 2, y: 10 } } },
        cityHouse3: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,13,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '2,3': { sprite: 'rival', interaction: handleDeathMasheenInteraction }, '3,5': { target: 'lexingtonCity', x: 13, y: 10 }, '4,5': { target: 'lexingtonCity', x: 13, y: 10 } } },
        villagerHouse1: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,1': { sprite: 'bookshelf', interaction: "A collection of poetry. 'The road not taken...' seems well-read." }, '1,3': { sprite: 'villager', interaction: "So many young trainers starting their journey." }, '3,3': { sprite: 'table', interaction: "A half-eaten plate of grammar-ham crackers." }, '3,5': { target: 'village', x: 5, y: 9 }, '4,5': { target: 'village', x: 5, y: 9 } } },
        route2: {
            layout: [
                [8,8,8,7,7,0,0,0,0,7,7,8,8,8,8,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,7,7,7,7,0,0,0,0,7,7,7,7,7,7,8],
                [8,7,16,7,7,0,0,0,0,7,7,16,7,7,7,8],
                [8,8,8,8,8,0,0,0,0,8,8,8,8,8,8,8]
            ],
            objects: {
                '7,13': { target: 'lexingtonCity', x: 7, y: 0 },
                '8,13': { target: 'lexingtonCity', x: 8, y: 0 },
                '7,0': { target: 'adjectiveWoods', x: 7, y: 13 },
                '8,0': { target: 'adjectiveWoods', x: 8, y: 13 },
                '2,7': { sprite: 'bookworm', interaction: () => handleTrainerBattle('bookwormBarry') },
                '9,12': { sprite: 'sign', interaction: 'Route 2 - Path to the Woods' }
            },
            encounters: ['PronounProwler', 'VerbViper']
        },
        adjectiveWoods: {
            layout: [
                [8,8,8,8,8,8,0,0,0,8,8,8,8,8,8,8],
                [8,0,8,7,7,7,7,8,8,8,8,7,7,7,8,8],
                [8,0,8,7,8,8,8,8,7,7,7,7,8,7,7,8],
                [8,0,0,0,8,7,7,0,0,0,8,8,8,7,8,8],
                [8,8,8,0,8,7,8,8,8,0,8,7,7,7,7,8],
                [8,7,7,0,0,0,0,0,8,0,8,7,8,8,8,8],
                [8,7,8,8,8,8,8,0,8,0,8,7,7,7,0,8],
                [8,7,7,0,0,0,8,0,8,0,8,8,8,8,0,8],
                [8,8,8,8,8,0,8,0,8,0,7,7,7,7,7,8],
                [8,7,7,7,8,0,8,0,8,8,8,8,8,8,8,8],
                [8,7,8,7,8,0,8,0,0,0,0,0,0,0,7,8],
                [8,7,8,7,8,0,8,8,8,8,8,8,8,0,7,8],
                [8,7,8,7,7,0,0,0,0,0,0,0,8,0,7,8],
                [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8]
            ],
            objects: {
                '7,13': { target: 'route2', x: 7, y: 0 },
                '8,13': { target: 'route2', x: 8, y: 0 },
                '1,2': { sprite: 'villager2', interaction: () => handleTrainerBattle('artistAdeline') },
                '8,0': { target: 'synonymCity', x: 8, y: 13 },
                '7,0': { target: 'synonymCity', x: 7, y: 13 },
                '9,12': { sprite: 'sign', interaction: 'Adjective Woods - Watch your descriptions!' },
                '14,8': { sprite: 'lightbulb', interaction: handleLHItem }
            },
            encounters: ['Metaphorpillar', 'PronounProwler']
        },
        synonymCity: {
            layout: [
                [8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],
                [8,0,0,0,0,6,19,19,6,0,0,0,0,0,0,8],
                [8,0,0,0,0,3,18,18,3,0,0,0,0,0,0,8],
                [8,0,0,0,0,3,2,2,3,0,0,0,0,0,0,8],
                [8,0,16,0,0,0,0,0,0,6,21,21,6,0,16,8],
                [8,0,4,4,3,18,18,3,0,3,20,20,3,0,4,8],
                [8,0,3,3,3,18,18,3,0,3,20,20,3,0,3,8],
                [8,0,2,0,3,2,5,3,0,3,2,5,3,0,2,8],
                [8,0,16,0,0,0,0,0,0,0,0,0,0,16,0,8],
                [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
                [8,0,19,19,0,16,0,0,0,16,0,0,16,0,0,8],
                [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
                [8,3,2,2,3,16,0,0,0,16,0,0,16,0,0,8],
                [8,8,8,8,8,8,8,0,0,8,8,8,8,8,8,8]
            ],
            objects: {
                '5,7': { symbol: 'ðŸ›’', symbolOffsetY: -2 }, '5,8': { target: 'synonymCityShop', x: 4, y: 5 }, 
                '10,7': { symbol: 'â¤ï¸', symbolOffsetY: -2 }, '10,8': { target: 'synonymCityCenter', x: 4, y: 5 }, 
                '14,10': { sprite: 'bookworm', interaction: "Synonym City is famous for its library, the largest in the region!" },
                '7,13': { target: 'adjectiveWoods', x: 7, y: 0 },
                '8,13': { target: 'adjectiveWoods', x: 8, y: 0 },
                '9,12': { sprite: 'sign', interaction: 'Synonym City - The City of Similar Words' },
                '7,2': { symbol: 'ðŸ†', symbolOffsetY: -2 }, 
                '6,3': { target: 'synonymCityGym', x: 4, y: 5 },
                '7,3': { target: 'synonymCityGym', x: 4, y: 5 },
                '1,10': { symbol: 'ðŸ“š', symbolOffsetY: -2 },
                '2,12': { target: 'library', x: 4, y: 5 },
                '3,12': { target: 'library', x: 4, y: 5 }
            }
        },
        synonymCityGym: {
            layout: [[1,1,1,1,1,1,1,1],[1,12,0,0,0,0,12,1],[1,0,0,0,0,0,0,1],[1,12,0,0,0,0,12,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]],
            objects: {
                '4,1': { sprite: 'gymLeader', interaction: handleSynonymGymLeaderInteraction },
                '2,1': { sprite: 'bookshelf', interaction: "Books on advanced synonyms and etymology." },
                '6,1': { sprite: 'bookshelf', interaction: "A complete collection of Roget's Thesaurus." },
                '3,5': { target: 'synonymCity', x: 6, y: 3 },
                '4,5': { target: 'synonymCity', x: 7, y: 3 }
            }
        },
        synonymCityCenter: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'nurse', interaction: handleNurseInteraction }, '1,2': { sprite: 'computer', interaction: handlePCInteraction }, '3,5': { target: 'synonymCity', x: 10, y: 8 }, '4,5': { target: 'synonymCity', x: 10, y: 8 } } },
        synonymCityShop: { layout: [[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,13,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,2,2,1,1,1]], objects: { '3,2': { sprite: 'shopkeep', interaction: handleShopInteraction }, '3,5': { target: 'synonymCity', x: 5, y: 8 }, '4,5': { target: 'synonymCity', x: 5, y: 8 } } },
        library: {
            layout: [
                [1,1,1,1,1,1,1,1],
                [1,12,0,12,0,12,0,1],
                [1,0,0,0,0,0,0,1],
                [1,12,0,0,0,0,12,1],
                [1,0,0,0,0,0,0,1],
                [1,1,1,2,2,1,1,1]
            ],
            objects: {
                '4,2': { sprite: 'professor', interaction: "'Shh! I'm Dr. Powers, and I'm on the verge of a breakthrough! My research into the etymological origins of creature names is about to bear fruit!'" },
                '1,1': { sprite: 'bookshelf', interaction: "A book titled 'The Quantum Linguistics Field Guide'." },
                '3,1': { sprite: 'bookshelf', interaction: "It's a dusty old tome on forgotten dialects." },
                '5,1': { sprite: 'bookshelf', interaction: "Research papers on creature vocalization patterns." },
                '1,3': { sprite: 'bookshelf', interaction: "The shelves are filled with dictionaries from around the world." },
                '6,3': { sprite: 'bookshelf', interaction: "A complete encyclopedia of literary devices." },
                '2,3': { sprite: 'bookshelf', interaction: "'A Hero With A Thousand Faces' - it's a classic." },
                '3,5': { target: 'synonymCity', x: 2, y: 12 },
                '4,5': { target: 'synonymCity', x: 3, y: 12 }
            }
        },
        homeBay: {
            layout: [
                [24,24,24,24,24,24,24,0,0,24,24,24,24,24,24,24],
                [23,23,23,23,23,24,24,0,0,24,24,23,23,23,23,23],
                [24,24,24,24,24,24,24,2,2,24,24,24,24,24,24,24],
                [24,24,24,24,24,24,24,2,2,24,24,24,24,24,24,24],
                [24,24,24,24,24,24,24,2,2,24,24,24,24,24,24,24],
                [24,24,24,24,24,24,2,2,2,2,2,2,2,24,24,24],
                [24,24,24,24,24,24,2,24,24,24,24,2,24,24,24,24],
                [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],
                [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],
                [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],
            ],
            objects: {
                '7,0': { target: 'village', x: 7, y: 12 },
                '8,0': { target: 'village', x: 8, y: 12 },
                '10,1': { sprite: 'sign', interaction: 'Village Bay' },
                '11,5': { sprite: 'boat', interaction: "It's the captain's boat. Looks like it's seen many voyages." },
                '9,5': { sprite: 'villager', interaction: "Arr, my boat's engine is sputtering. It's out of order right now. But I have a feeling it will be important later... that's called foreshadowing." },
            }
        }
    };
    
    const tileTypes = { 0: { color: '#d3d3d3' }, 1: { color: '#605040', solid: true }, 2: { color: '#c0a080' }, 3: { color: '#D2B48C', solid: true }, 4: { color: '#B22222', solid: true }, 5: { color: '#87CEEB', solid: true }, 6: { color: '#8B4513', solid: true }, 7: { color: '#38a169', isTallGrass: true }, 8: { color: '#2f855a', solid: true }, 9: { color: '#c0a080', solid: true }, 10: { color: '#333333', solid: true }, 11: { color: '#a0e0f0', isWindow: true }, 12: { color: '#806040', solid: true }, 13: { color: '#f0d0b0', solid: true }, 14: { color: '#4a5568', solid: true }, 15: { color: '#e2e8f0', solid: true }, 16: { color: '#FFD700' }, 18: { color: '#F5F5DC', solid: true }, 19: { color: '#4169E1', solid: true }, 20: { color: '#708090', solid: true }, 21: { color: '#2F4F4F', solid: true }, 22: { color: '#deb887'}, 23: { color: '#f5f5dc'}, 24: { color: '#4682B4', solid: true }, 25: { color: '#4a5568', solid: true }};

    function getTile(map, x, y) { if (y >= 0 && y < map.layout.length && x >= 0 && x < map.layout[y].length) return map.layout[y][x]; return -1; }

    function gameLoop() { draw(); requestAnimationFrame(gameLoop); }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const mapData = maps[gameState.currentMap];
        if (!mapData) return; // Prevent crash if map is missing
        const offsetX = -gameState.player.x * tileSize + canvas.width / 2;
        const offsetY = -gameState.player.y * tileSize + canvas.height / 2;
        ctx.save();
        ctx.translate(offsetX, offsetY);
        for (let y = 0; y < mapData.layout.length; y++) {
            for (let x = 0; x < mapData.layout[y].length; x++) {
                const tileId = mapData.layout[y][x];
                const tile = tileTypes[tileId];
                if (tile) { 
                    ctx.fillStyle = tile.color; 
                    ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize); 
                    if (tile.isWindow) {
                        ctx.fillStyle = '#a0e0f0';
                        ctx.fillRect(x * tileSize + 4, y * tileSize + 4, tileSize - 8, tileSize - 8);
                        ctx.fillStyle = '#605040';
                        ctx.fillRect(x * tileSize + tileSize/2 - 2, y * tileSize, 4, tileSize);
                        ctx.fillRect(x * tileSize, y * tileSize + tileSize/2 - 2, tileSize, 4);
                    }
                }
                if(tileId === 8) drawSprite('tree', x, y);
                if(tileId === 16) drawSprite('flower', x, y);
            }
        }
        for (const key in mapData.objects) {
            const [x, y] = key.split(',').map(Number);
            const obj = mapData.objects[key];
            if (obj.sprite) drawSprite(obj.sprite, x, y);
            if (obj.symbol) {
                ctx.font = `${tileSize * 0.9}px serif`;
                const offsetY = obj.symbolOffsetY || -2;
                ctx.fillText(obj.symbol, x * tileSize + tileSize / 2, (y + offsetY) * tileSize + tileSize/2);
            }
        }
        drawSprite(gameState.player.sprite, gameState.player.x, gameState.player.y);
        ctx.restore();
    }

    function handleConfirmAction() {
        if (gameState.inDialogue && choicesBox.children.length === 0) {
            advanceDialogue();
        } else if (!gameState.activeScene && !gameState.inBattle && !gameState.inDialogue) {
            checkForInteraction();
        }
    }

    function handleCancelAction() {
        if (gameState.activeScene) {
            closeAllMenus();
        } else if (gameState.inDialogue) {
            dialogueQueue = []; // Clear the queue
            const cb = dialogueCallback;
            gameState.inDialogue = false;
            messageText.textContent = '';
            dialogueCallback = null;
        }
    }


    function handleInput(key) {
        // Universal cancel action
        if (key === 'b' || key === 'x' || key === 'Backspace' || key === 'Escape') {
            handleCancelAction();
            return;
        }

        // Universal confirm action
        if (key === 'a' || key === 'z' || key === 'Enter') {
            handleConfirmAction();
            return;
        }
        
        // Block movement during any UI state
        if (gameState.inDialogue || gameState.inBattle || gameState.activeScene) return;

        // Handle movement
        let {x, y} = gameState.player;
        switch(key) {
            case 'ArrowUp': y--; break;
            case 'ArrowDown': y++; break;
            case 'ArrowLeft': x--; break;
            case 'ArrowRight': x++; break;
            case 'm': toggleMenu(); return;
        }
        movePlayer(x,y);
    }
    
    // Canvas click for dev mode toggle
    canvas.addEventListener('click', (event) => {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;

        const canvasX = (event.clientX - rect.left) * scaleX;
        const canvasY = (event.clientY - rect.top) * scaleY;

        const offsetX = -gameState.player.x * tileSize + canvas.width / 2;
        const offsetY = -gameState.player.y * tileSize + canvas.height / 2;

        const mapX = Math.floor((canvasX - offsetX) / tileSize);
        const mapY = Math.floor((canvasY - offsetY) / tileSize);
        
        if (gameState.currentMap === 'village' && mapX === 0 && mapY === 0) {
            toggleDevMode();
        }
    });

    function toggleDevMode() {
        gameState.devModeActive = !gameState.devModeActive;
        if (gameState.devModeActive) {
            startDialogue("Dev Mode Activated! Event barriers are unlocked.");
        } else {
            startDialogue("Dev Mode Deactivated. Barriers restored to normal.");
        }
    }

    window.addEventListener('keydown', (e) => {
        let key = e.key;
        if(key === 'z') key = 'a';
        if(key === 'x' || e.key === 'Backspace') key = 'b';
        handleInput(key)
    });

    // Touch Controls Setup
    const setupTouchButton = (id, key) => {
        const button = document.getElementById(id);
        if (button) button.addEventListener('click', () => handleInput(key));
    };

    // Movement
    setupTouchButton('touch-up', 'ArrowUp');
    setupTouchButton('touch-down', 'ArrowDown');
    setupTouchButton('touch-left', 'ArrowLeft');
    setupTouchButton('touch-right', 'ArrowRight');
    setupTouchButton('touch-up-lg', 'ArrowUp');
    setupTouchButton('touch-down-lg', 'ArrowDown');
    setupTouchButton('touch-left-lg', 'ArrowLeft');
    setupTouchButton('touch-right-lg', 'ArrowRight');

    // Actions
    setupTouchButton('touch-a', 'a');
    setupTouchButton('touch-a-lg', 'a');
    setupTouchButton('touch-b', 'b');
    setupTouchButton('touch-b-lg', 'b');
    
    document.getElementById('menu-btn').addEventListener('click', toggleMenu);
    
    messageBox.addEventListener('click', (e) => {
        if (e.target.closest('#choices-box')) return;
        if (gameState.inDialogue && !gameState.inBattle) {
            advanceDialogue();
        }
    });
    
    battleBox.addEventListener('click', (e) => { 
        if (e.target.closest('#battle-grid')) return;
        if (gameState.inDialogue && gameState.inBattle) {
            advanceBattleDialogue();
        }
    });

    function movePlayer(newX, newY) {
        if (gameState.inDialogue || gameState.inBattle || gameState.activeScene) return;
        const map = maps[gameState.currentMap];
        if (!map) return;
        
        const object = map.objects[`${newX},${newY}`];

        // Check for target transition first. This allows for objects placed on "out of bounds" tiles.
        if (object && object.target) {
            changeMap(object.target, object.x, object.y);
            return;
        }

        // Now check map boundaries
        if (newY < 0 || newY >= map.layout.length || newX < 0 || newX >= map.layout[0].length) {
            return;
        }

        const tileId = getTile(map, newX, newY);
        const tile = tileTypes[tileId];

        // This collision check now runs for everyone, dev mode or not.
        if (tile.solid || (object && object.sprite)) {
            return;
        }
        
        // If we've reached this point, movement is allowed.
        gameState.player.x = newX; 
        gameState.player.y = newY;
        
        // Trigger wild battle in tall grass
        if (tile.isTallGrass && gameState.playerParty.length > 0 && Math.random() < 0.2) {
            startWildBattle();
        }
    }

    function changeMap(mapName, newX, newY) { 
        gameState.currentMap = mapName; 
        gameState.player.x = newX;
        gameState.player.y = newY; 
    }

    let dialogueQueue = [], dialogueCallback = null;
    function startDialogue(messages, onComplete = null) {
        dialogueQueue = Array.isArray(messages) ? [...messages] : [messages];
        dialogueCallback = onComplete; gameState.inDialogue = true;
        messageText.textContent = dialogueQueue.shift() || ''; choicesBox.innerHTML = '';
    }
    function advanceDialogue() {
        if (dialogueQueue.length > 0) { messageText.textContent = dialogueQueue.shift(); } 
        else { const cb = dialogueCallback; gameState.inDialogue = false; messageText.textContent = ''; dialogueCallback = null; if (cb) cb(); }
    }
    function showChoices(prompt, choices) {
        gameState.inDialogue = true; 
        messageText.textContent = prompt; 
        choicesBox.innerHTML = '';
        choices.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = 'p-2 bg-gray-200 hover:bg-yellow-300 border-2 border-gray-400 rounded text-gray-800 text-lg';
            btn.textContent = choice.text; 
            btn.onclick = (e) => { 
                e.stopPropagation();
                choicesBox.innerHTML = ''; 
                if (choice.callback) choice.callback(); 
            };
            choicesBox.appendChild(btn);
        });
    }

    function checkForInteraction() {
        const { x, y } = gameState.player, dirs = [[0,-1], [0,1], [-1,0], [1,0]];
        for (const [dx, dy] of dirs) {
            const key = `${x + dx},${y + dy}`;
            const obj = maps[gameState.currentMap].objects[key];
            const tileId = getTile(maps[gameState.currentMap], x + dx, y + dy);
            const tile = tileTypes[tileId];

            if (obj && obj.interaction) { 
                const res = typeof obj.interaction === 'function' ? obj.interaction() : obj.interaction; 
                if (res) startDialogue(res); 
                return;
            }
             if (tile && tile.isWindow) {
                 const windowObj = Object.values(maps[gameState.currentMap].objects).find(o => o.x === (x+dx) && o.y === (y+dy));
                 if(windowObj && windowObj.interaction) {
                    startDialogue(windowObj.interaction());
                 } else {
                    startDialogue("You look out the window.");
                 }
                return;
            }
        }
    }
    
    function openScene(sceneElement) { closeAllMenus(true); gameState.activeScene = sceneElement.id; sceneElement.classList.remove('hidden'); }
    function closeAllMenus(silent = false) { [menuScene, inventoryScene, pokemonStatsScene, pokedexScene, pcScene].forEach(s => s.classList.add('hidden')); if (!silent) gameState.activeScene = null; }
    function toggleMenu() { if(gameState.activeScene === 'menu-scene') closeAllMenus(); else openScene(menuScene); }
    
    document.getElementById('menu-close-btn').onclick = () => closeAllMenus();
    document.getElementById('menu-inventory-btn').onclick = () => { updateInventoryUI(); openScene(inventoryScene); };
    document.getElementById('menu-pokemon-btn').onclick = () => { updatePokemonStatsUI(); openScene(pokemonStatsScene); };
    document.getElementById('menu-pokedex-btn').onclick = () => { updatePokedexUI(); openScene(pokedexScene); };
    document.querySelectorAll('.ui-back-btn').forEach(btn => btn.onclick = () => openScene(menuScene));
    document.getElementById('pc-close-btn').onclick = () => closeAllMenus();


    function updateInventoryUI() {
        document.getElementById('inventory-money').textContent = `$${gameState.money}`;
        const items = document.getElementById('inventory-items'); items.innerHTML = '';
        const createItem = (name, count, onUse) => {
            if(count > 0){
                const div = document.createElement('div'); div.className = 'flex justify-between items-center text-xl';
                div.innerHTML = `<span>${name} x${count}</span>`;
                if(onUse){ const btn = document.createElement('button'); btn.className = 'p-2 bg-green-500 text-white rounded-lg'; btn.textContent = 'Use'; btn.onclick = onUse; div.appendChild(btn); }
                items.appendChild(div);
            }
        };
        createItem('Potion', gameState.inventory.potions, usePotion);
        createItem('Word Ball', gameState.inventory.wordballs);
        createItem('Great Phrase', gameState.inventory.greatphrases);
        createItem('Ultra Sentence', gameState.inventory.ultrasentences);
        createItem('Master Thesis', gameState.inventory.masterthesis);
        createItem('Adjective Elixir', gameState.inventory.adjectiveElixirs);
        createItem('Thesaurus Tea', gameState.inventory.thesaurusTeas);
        createItem('Escape Verb', gameState.inventory.escapeVerbs);
        createItem('LH01 L. Hyperbole', gameState.inventory.LH01LuminousHyperbole);
        if(items.innerHTML === '') items.innerHTML = '<p class="text-xl text-center">No items.</p>';
    }
    
    function usePotion() {
        if (gameState.inventory.potions > 0 && gameState.playerParty.length > 0 && gameState.playerParty[0].currentHp < gameState.playerParty[0].maxHp) {
            gameState.inventory.potions--;
            const heal = Math.floor(gameState.playerParty[0].maxHp * 0.5);
            gameState.playerParty[0].currentHp = Math.min(gameState.playerParty[0].maxHp, gameState.playerParty[0].currentHp + heal);
            closeAllMenus(); startDialogue(`${gameState.playerParty[0].name} was healed!`);
        } else startDialogue(gameState.playerParty[0] && gameState.playerParty[0].currentHp === gameState.playerParty[0].maxHp ? "Already at full health!" : "You have no potions!");
    }

    function updatePokemonStatsUI() {
        const content = document.getElementById('pokemon-stats-content');
        if (gameState.playerParty.length === 0) { 
            content.innerHTML = '<h2 class="text-2xl text-center">You have no Creatures!</h2> <button class="ui-back-btn mt-6 w-full p-3 bg-yellow-500 text-black rounded-lg text-2xl">Back</button>'; 
            content.querySelector('.ui-back-btn').onclick = () => openScene(menuScene);
            return; 
        }

        content.innerHTML = '<h2 class="text-3xl text-center mb-4">Your Party</h2>';
        const partyGrid = document.createElement('div');
        partyGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
        
        gameState.playerParty.forEach(p => {
            const card = document.createElement('div');
            card.className = 'p-4 border rounded-lg border-gray-400';
            card.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="text-6xl">${sprites[p.sprite]}</div>
                    <div>
                        <h3 class="text-2xl">${p.name} <span class="text-xl text-gray-500">Lvl ${p.level}</span></h3>
                        <p class="text-lg">HP: ${Math.ceil(p.currentHp)} / ${p.maxHp}</p>
                        <div class="w-full bg-gray-300 rounded-full h-4 my-1"><div class="bg-green-500 h-full rounded-full" style="width: ${p.currentHp/p.maxHp*100}%"></div></div>
                    </div>
                </div>
            `;
            partyGrid.appendChild(card);
        });

        content.appendChild(partyGrid);
        
        const backButton = document.createElement('button');
        backButton.className = "ui-back-btn mt-6 w-full p-3 bg-yellow-500 text-black rounded-lg text-2xl";
        backButton.textContent = "Back";
        backButton.onclick = () => openScene(menuScene);
        content.appendChild(backButton);
    }
    
    function updatePokedexUI() {
        const entries = document.getElementById('pokedex-entries'); entries.innerHTML = '';
        const seenSpecies = Object.keys(gameState.pokedex).sort();
        if (seenSpecies.length === 0) { entries.innerHTML = '<p class="text-xl text-center">No data yet. Encounter creatures to add them!</p>'; return; }
        
        seenSpecies.forEach(species => {
            const entry = gameState.pokedex[species];
            const entryDiv = document.createElement('div'); entryDiv.className = 'p-2 border rounded border-gray-400 grid grid-cols-4 gap-2 items-center';
            const caughtIcon = entry.caught ? sprites.pokeball : 'â—‹';
            entryDiv.innerHTML = ` <div class="text-5xl text-center">${sprites[pokemonDB[species] ? pokemonDB[species].sprite : species.toLowerCase()]}</div> <div class="col-span-3"> <h3 class="text-2xl">${species} ${caughtIcon}</h3> <p class="text-sm">${pokedexData[species]}</p> </div> `;
            entries.appendChild(entryDiv);
        });
    }

    function handleBedInteraction() { if (gameState.playerParty.length > 0) { gameState.playerParty.forEach(p => p.currentHp = p.maxHp); return ["You took a short nap.", "Your team is fully healed!"]; } return "A comfy bed."; }
    
    function handleProfessorInteraction() {
        if (gameState.playerParty.length > 0) {
            return "Now that you have a partner, a great adventure begins! Go on, get out there!";
        }
        startDialogue([
            "Ah, you're here! I'm Professor Lexicon.",
            "Your rival, Andy, and the other trainers were early and took the first pickings...",
            "But I saved one special creature just for you!",
            "It's a Synonymouse! Please, take good care of it.",
        ], () => {
            const newPokemon = createPokemon("Synonymouse", 5);
            addPokemonToParty(newPokemon);
            startDialogue([
                "You got a SYNONYMOUSE!",
                "Synonymouse was added to your party."
            ]);
        });
        return null;
    }

    function handlePokeballChoice() {
        if (gameState.playerParty.length > 0) return "You should leave those for the Professor.";
        return "These belong to the Professor. He said he has one for you!";
    }
    function handleGateInteraction() {
        if (gameState.devModeActive || gameState.rivalDefeated) {
             changeMap('route1', 7, 4); // Allow passage
             return null;
        }
        if (gameState.playerParty.length === 0) return "The gate is locked tight.";
        if (gameState.inBattle || gameState.inDialogue) return;
        startDialogue([ "Andy: 'Hold it right there!'", "'I've been studying! I challenge you to a battle!'" ], () => startBattle(createPokemon('Grammargoyle', 7), 'Andy'));
        return null;
    }
    function handleNurseInteraction() { 
        if(gameState.playerParty.length > 0) { 
            gameState.playerParty.forEach(p => p.currentHp = p.maxHp); 
            return "Your team has been restored to full health!"; 
        } 
        return "Welcome to the Word Center!"; 
    }
    
    function confirmPurchase(itemName, price, description, onConfirm) {
        showChoices(`${itemName}: ${description} It costs $${price}. Buy it?`, [
            { text: "Yes", callback: () => {
                if (gameState.money >= price) {
                    gameState.money -= price;
                    onConfirm();
                    startDialogue(`You bought one ${itemName}.`, () => handleShopInteraction());
                } else {
                    startDialogue("Sorry, you don't have enough money.", () => handleShopInteraction());
                }
            }},
            { text: "No", callback: () => handleShopInteraction() }
        ]);
    }

    function handleShopInteraction() {
        showChoices("Welcome! What can I get for you?", [
            { text: "Potion", callback: () => confirmPurchase("Potion", 25, "Restores 50% HP.", () => gameState.inventory.potions++) },
            { text: "Word Ball", callback: () => confirmPurchase("Word Ball", 50, "Used to catch wild creatures.", () => gameState.inventory.wordballs++) },
            { text: "Great Phrase", callback: () => confirmPurchase("Great Phrase", 200, "A ball with a better catch rate.", () => gameState.inventory.greatphrases++) },
            { text: "Ultra Sentence", callback: () => confirmPurchase("Ultra Sentence", 500, "A high-performance ball.", () => gameState.inventory.ultrasentences++) },
            { text: "Adj. Elixir", callback: () => confirmPurchase("Adj. Elixir", 100, "Boosts Attack for one battle.", () => gameState.inventory.adjectiveElixirs++) },
            { text: "Thesaurus Tea", callback: () => confirmPurchase("Thesaurus Tea", 75, "Cures status conditions.", () => gameState.inventory.thesaurusTeas++) },
            { text: "Escape Verb", callback: () => confirmPurchase("Escape Verb", 150, "Guarantees escape from a wild battle.", () => gameState.inventory.escapeVerbs++) },
            { text: "Leave", callback: () => startDialogue("Come again!") }
        ]); return null;
    }

    const poeQuotes = [ "Quoth the Raven, 'Nevermore.'", "All that we see or seem is but a dream within a dream.", "The boundaries which divide Life from Death are at best shadowy and vague.", "I was never really insane except upon occasions when my heart was touched.", "Words have no power to impress the mind without the exquisite horror of their reality.", "To be buried alive is, beyond question, the most terrific of these extremes which has ever fallen to the lot of mere mortality.", "I have great faith in fools - self-confidence my friends call it.", "The true genius shudders at incompleteness.", "I became insane, with long intervals of horrible sanity.", "Beauty of whatever kind, in its supreme development, invariably excites the sensitive soul to tears.", "Believe nothing you hear, and only one half that you see.", "The death of a beautiful woman is, unquestionably, the most poetical topic in the world.", "Men have called me mad; but the question is not yet settled.", "That which you mistake for madness is but over-acuteness of the senses.", "From childhood's hour I have not been as others were.", "I have no faith in human perfectibility. I think that human exertion will have no appreciable effect upon humanity.", "Sleep, those little slices of death â€” how I loathe them.", "The scariest monsters are the ones that lurk within our souls.", "There is no exquisite beauty without some strangeness in the proportion.", "To vilify a great man is the readiest way in which a little man can himself attain greatness." ];
    function handlePoeInteraction() { return poeQuotes[Math.floor(Math.random() * poeQuotes.length)]; }
    
    function handleDeathMasheenInteraction() {
        if (!gameState.hasMetDeathMasheen) {
            startDialogue(
                ["DeathMasheen34: 'Leveled Up Learning is the future!'"],
                () => {
                    gameState.hasMetDeathMasheen = true;
                    const gamerObject = maps.cityHouse3.objects['2,3'];
                    gamerObject.sprite = 'graduate';
                    gamerObject.interaction = "Tom: 'I'm going to be a principal some day. Gamification rules!'";
                }
            );
            return null;
        }
    }

    function handleGymLeaderInteraction() {
        if (gameState.gymBadges.rhyme) return "You've earned the Rhyme Badge. Continue your journey!";
        if (gameState.playerParty.length === 0) return "You need a partner to challenge a gym!";
        if (gameState.playerParty[0].level < 7) return ["My rhymes are tough, my rhythm's tight,", "A level 7 you'll need to fight!"];
        startDialogue(["Rhonda: 'To earn my badge, you have to climb,'", "'And beat my team in a rhyme-fueled crime!'"], () => startBattle([createPokemon('Haiku-na', 12), createPokemon('Adjectlizard', 14)], 'Gym Leader Rhonda'));
    }

    function handleSynonymGymLeaderInteraction() {
        if (gameState.gymBadges.synonym) return "Your vocabulary is truly vast. Go and continue your quest.";
        if (gameState.playerParty.length === 0) return "You need a partner to challenge a gym!";
        if (gameState.playerParty[0].level < 25) return ["My words are weighty, my knowledge deep.", "Return when your team's level has made a leap.", "(Recommended Level: 25+)"];
        startDialogue(trainersDB.gymLeaderLex.preBattle, () => startBattle(trainersDB.gymLeaderLex.pokemon.map(p => createPokemon(p.species, p.level)), 'Gym Leader Lex'));
    }

    function handleNorthGate() {
        // Dev mode bypasses event triggers
        if (gameState.devModeActive) {
            changeMap('route2', 7, 13);
            return null;
        }

        // Normal progression checks
        if(!gameState.gymBadges.rhyme) {
            return "A guard blocks the way. 'Only trainers who have earned the Rhyme Badge may pass!'";
        }
        if(!gameState.rivalDefeatedPostGym) {
            startDialogue(["Andy: 'You got a gym badge? Hah! Just lucky!'", "'Let's see how you handle a REAL battle!'"], () => {
                startBattle([createPokemon('Grammargoyle', 13), createPokemon('CommaLeon', 12)], 'Andy');
            });
            return null;
        }
        
        // If all checks pass, change map
        changeMap('route2', 7, 13);
        return null;
    }

    function handleTrainerBattle(trainerId) {
        if(gameState.defeatedTrainers.includes(trainerId)) {
            startDialogue(trainersDB[trainerId].postBattle);
            return null;
        }
        startDialogue(trainersDB[trainerId].preBattle, () => {
            const opponent = trainersDB[trainerId].pokemon[0];
            startBattle(createPokemon(opponent.species, opponent.level), `Trainer ${trainersDB[trainerId].name}`, trainerId);
        });
        return null;
    }

    function handleLHItem() {
        if (gameState.inventory.LH01LuminousHyperbole > 0) {
            return "An empty pedestal. You already took the item here.";
        }
        gameState.inventory.LH01LuminousHyperbole = 1;
        delete maps.adjectiveWoods.objects['14,8'];
        return [ "You found LH01 (Luminous Hyperbole)!", "It's an incredibly bright turn of phrase that can illuminate even the darkest of caves." ];
    }

    function handlePCInteraction() {
        showChoices("A PC. What would you like to do?", [
            { text: "Access Storage", callback: () => {
                gameState.inDialogue = false;
                messageText.textContent = '';
                updatePCUI();
                openScene(pcScene);
            }},
            /* { text: "Teleport Home", callback: () => {
                startDialogue(["You connected to the home network...", "Warping complete!"], () => {
                    changeMap('playerHouse', 4, 4);
                });
            }}, */
            { text: "Cancel", callback: () => {
                gameState.inDialogue = false;
                messageText.textContent = '';
            }}
        ]);
        return null;
    }

    function updatePCUI() {
        const partyContainer = document.getElementById('pc-party');
        const boxContainer = document.getElementById('pc-box');
        partyContainer.innerHTML = '';
        boxContainer.innerHTML = '';

        // Populate Party List
        gameState.playerParty.forEach((pokemon, index) => {
            const div = document.createElement('div');
            div.className = 'pc-item p-2 border rounded';
            div.innerHTML = `<span>${sprites[pokemon.sprite]} ${pokemon.name} Lvl ${pokemon.level}</span>`;
            div.onclick = () => moveFromPartyToBox(index);
            partyContainer.appendChild(div);
        });

        // Populate Box List
        gameState.pokemonBox.forEach((pokemon, index) => {
            const div = document.createElement('div');
            div.className = 'pc-item p-2 border rounded';
            div.innerHTML = `<span>${sprites[pokemon.sprite]} ${pokemon.name} Lvl ${pokemon.level}</span>`;
            div.onclick = () => moveFromBoxToParty(index);
            boxContainer.appendChild(div);
        });
    }

    function moveFromPartyToBox(index) {
        if (gameState.playerParty.length <= 1) {
            startDialogue("You can't deposit your last creature!");
            closeAllMenus();
            return;
        }
        const [movedPokemon] = gameState.playerParty.splice(index, 1);
        gameState.pokemonBox.push(movedPokemon);
        updatePCUI();
    }

    function moveFromBoxToParty(index) {
        if (gameState.playerParty.length >= 6) {
            startDialogue("Your party is full!");
            closeAllMenus();
            return;
        }
        const [movedPokemon] = gameState.pokemonBox.splice(index, 1);
        gameState.playerParty.push(movedPokemon);
        updatePCUI();
    }

    function startBattleDialogue(messages, onComplete = null) {
        dialogueQueue = Array.isArray(messages) ? [...messages] : [messages]; dialogueCallback = onComplete; gameState.inDialogue = true;
        battleText.textContent = dialogueQueue.shift(); battleGrid.innerHTML = '';
    }
    function advanceBattleDialogue() { if (dialogueQueue.length > 0) { battleText.textContent = dialogueQueue.shift(); } else { const cb = dialogueCallback; gameState.inDialogue = false; battleText.textContent = ''; dialogueCallback = null; if (cb) cb(); } }
    
    function startWildBattle() {
        if (gameState.inBattle || gameState.inDialogue) return;
        const currentMapData = maps[gameState.currentMap];
        const encounterList = currentMapData.encounters;
        if (!encounterList || encounterList.length === 0) return;

        const species = encounterList[Math.floor(Math.random() * encounterList.length)];
        const level = gameState.currentMap === 'route1' ? Math.floor(Math.random() * 3) + 3 : Math.floor(Math.random() * 3) + 8;
        startDialogue([`A wild ${species} appeared!`], () => startBattle(createPokemon(species, level), `Wild ${species}`));
    }
    
    function startBattle(opponent, opponentName, trainerId = null) {
        if (gameState.playerParty.length === 0) {
            startDialogue("You have no creatures to battle with!");
            return;
        }
        gameState.inBattle = true;
        const currentOpponent = Array.isArray(opponent) ? opponent[0] : opponent;
        
        if (!gameState.pokedex[currentOpponent.species]) gameState.pokedex[currentOpponent.species] = { seen: false, caught: false };
        gameState.pokedex[currentOpponent.species].seen = true;
        
        currentBattle = { 
            playerPokemon: gameState.playerParty.find(p => p.currentHp > 0), 
            opponentPokemon: Array.isArray(opponent) ? opponent : [opponent],
            currentOpponentIndex: 0,
            opponentName, 
            trainerId, 
            turn: 'player',
            participants: [gameState.playerParty.findIndex(p => p.currentHp > 0)]
        };
        
        currentBattle.playerPokemon.statMods = { attack: 0, defense: 0 };
        currentOpponent.statMods = { attack: 0, defense: 0 };

        battleScene.classList.remove('hidden');
        updateBattleSprites();
        updateBattleUI(); 
        nextBattleTurn();
    }
    
    function nextBattleTurn() {
        if (!currentBattle) return;
        if (currentBattle.playerPokemon.currentHp <= 0) {
            handlePlayerPokemonFaint();
            return;
        }
        if (currentBattle.opponentPokemon[currentBattle.currentOpponentIndex].currentHp <= 0) {
            endBattle(); 
            return; 
        }

        if (currentBattle.turn === 'player') {
            showMainBattleMenu();
        } else {
            setTimeout(() => {
                const attacker = currentBattle.opponentPokemon[currentBattle.currentOpponentIndex];
                const atk = attacker.attacks[Math.floor(Math.random()*attacker.attacks.length)];
                
                let messages = [`${currentBattle.opponentName}'s ${attacker.name} used ${atk.name}!`];
                
                if(atk.power > 0) {
                    const dmg = calculateDamage(atk, attacker, currentBattle.playerPokemon);
                    currentBattle.playerPokemon.currentHp -= dmg;
                    messages.push(`${currentBattle.playerPokemon.name} took ${dmg} damage!`);
                }

                const effectMessages = applyAttackEffect(atk, attacker, currentBattle.playerPokemon);
                messages.push(...effectMessages);

                updateBattleUI();
                startBattleDialogue(messages, () => { currentBattle.turn = 'player'; nextBattleTurn(); });
            }, 1000);
        }
    }

    function handlePlayerPokemonFaint() {
        startBattleDialogue([`${currentBattle.playerPokemon.name} fainted!`], () => {
            const canSwitch = gameState.playerParty.some(p => p.currentHp > 0);
            if (canSwitch) {
                showSwitchPokemonMenu(true);
            } else {
                endBattle();
            }
        });
    }

    function showMainBattleMenu() {
        battleText.textContent = `What will ${currentBattle.playerPokemon.name} do?`; battleGrid.innerHTML = '';
        const createBtn = (text, onClick) => {
            const btn = document.createElement('button');
            btn.className = 'p-2 bg-gray-200 hover:bg-yellow-300 border-4 border-gray-400 rounded text-gray-800 text-lg';
            btn.textContent = text; btn.onclick = onClick; battleGrid.appendChild(btn);
        };
        createBtn('Fight', playerChooseAttack); 
        createBtn('Item', showItemMenu);
        createBtn('PokÃ©mon', () => showSwitchPokemonMenu(false)); 
        createBtn('Run', () => { 
            if(!currentBattle.trainerId){
                startBattleDialogue('Got away safely!', () => endBattle(true) )
            } else {
                startBattleDialogue("Can't run from a trainer battle!", showMainBattleMenu)
            } 
        });
    }

    function showSwitchPokemonMenu(isForced = false) {
        battleText.textContent = "Choose a creature.";
        battleGrid.innerHTML = '';
        gameState.playerParty.forEach((pokemon, index) => {
            const button = document.createElement('button');
            button.className = 'p-2 border-4 border-gray-400 rounded text-gray-800 text-lg flex justify-between items-center';
            button.innerHTML = `
                <div>${sprites[pokemon.sprite]} ${pokemon.name} Lvl ${pokemon.level}</div>
                <div>${Math.ceil(pokemon.currentHp)}/${pokemon.maxHp} HP</div>
            `;
            
            if (pokemon.currentHp <= 0) {
                button.disabled = true;
                button.classList.add('bg-red-300', 'opacity-50');
            } else if (pokemon === currentBattle.playerPokemon) {
                 button.disabled = true;
                 button.classList.add('bg-yellow-200');
            } else {
                button.classList.add('bg-gray-200', 'hover:bg-yellow-300');
                button.onclick = () => switchPlayerPokemon(index, isForced);
            }
            battleGrid.appendChild(button);
        });

        if (!isForced) {
            const backBtn = document.createElement('button');
            backBtn.className = 'p-2 bg-yellow-400 hover:bg-yellow-500 border-4 border-gray-400 rounded text-gray-800 text-lg';
            backBtn.textContent = 'Back';
            backBtn.onclick = showMainBattleMenu;
            battleGrid.appendChild(backBtn);
        }
    }

    function switchPlayerPokemon(newIndex, isForced = false) {
        const oldPokemon = currentBattle.playerPokemon;
        const newPokemon = gameState.playerParty[newIndex];
        
        currentBattle.playerPokemon = newPokemon;
        currentBattle.playerPokemon.statMods = { attack: 0, defense: 0 };

        if (!currentBattle.participants.includes(newIndex)) {
            currentBattle.participants.push(newIndex);
        }
        
        updateBattleUI();
        updateBattleSprites();

        if (isForced) {
            currentBattle.turn = 'player';
            startBattleDialogue([`Go, ${newPokemon.name}!`], nextBattleTurn);
        } else {
            currentBattle.turn = 'opponent';
            startBattleDialogue([`${oldPokemon.name}, come back! Go, ${newPokemon.name}!`], nextBattleTurn);
        }
    }

    function showItemMenu() {
        battleText.textContent = "Choose an item.";
        battleGrid.innerHTML = '';

        const createItemButton = (text, onClick, count) => {
            if (count > 0) {
                const button = document.createElement('button');
                button.className = 'p-2 bg-gray-200 hover:bg-green-300 border-4 border-gray-400 rounded text-gray-800 text-lg';
                button.textContent = text;
                button.onclick = onClick;
                battleGrid.appendChild(button);
            }
        };

        createItemButton(`Potion x${gameState.inventory.potions}`, usePotionInBattle, gameState.inventory.potions);

        // Only show catching items in wild battles
        if (!currentBattle.trainerId) {
            createItemButton(`Word Ball x${gameState.inventory.wordballs}`, () => attemptCatch('wordballs'), gameState.inventory.wordballs);
            createItemButton(`Great Phrase x${gameState.inventory.greatphrases}`, () => attemptCatch('greatphrases'), gameState.inventory.greatphrases);
            createItemButton(`Ultra Sentence x${gameState.inventory.ultrasentences}`, () => attemptCatch('ultrasentences'), gameState.inventory.ultrasentences);
            createItemButton(`Master Thesis x${gameState.inventory.masterthesis}`, () => attemptCatch('masterthesis'), gameState.inventory.masterthesis);
        }

        const backBtn = document.createElement('button');
        backBtn.className = 'p-2 bg-yellow-400 hover:bg-yellow-500 border-4 border-gray-400 rounded text-gray-800 text-lg';
        backBtn.textContent = 'Back';
        backBtn.onclick = showMainBattleMenu;
        battleGrid.appendChild(backBtn);
    }

    function usePotionInBattle() {
         if (gameState.inventory.potions > 0 && currentBattle.playerPokemon.currentHp < currentBattle.playerPokemon.maxHp) {
            gameState.inventory.potions--;
            const healAmount = Math.floor(currentBattle.playerPokemon.maxHp * 0.5);
            currentBattle.playerPokemon.currentHp = Math.min(currentBattle.playerPokemon.maxHp, currentBattle.playerPokemon.currentHp + healAmount);
            updateBattleUI();
            currentBattle.turn = 'opponent';
            startBattleDialogue([`You used a Potion.`, `${currentBattle.playerPokemon.name} recovered health!`], nextBattleTurn);
        } else {
            startBattleDialogue(currentBattle.playerPokemon.currentHp === currentBattle.playerPokemon.maxHp ? "It won't have any effect!" : "You have no potions!", showMainBattleMenu);
        }
    }

    async function attemptCatch(ballKey) {
        const ball = itemsDB[ballKey];
        const opponent = currentBattle.opponentPokemon[currentBattle.currentOpponentIndex];

        if (gameState.inventory[ballKey] <= 0) {
            startBattleDialogue("You don't have any of those!", showItemMenu);
            return;
        }

        gameState.inventory[ballKey]--;

        await new Promise(res => startBattleDialogue(`You threw a ${ball.name}!`, res));
        
        const maxHp = opponent.maxHp;
        const currentHp = opponent.currentHp;
        const catchRate = pokemonDB[opponent.species].catchDifficulty || 45; 
        
        let a = (((3 * maxHp - 2 * currentHp) * catchRate * ball.bonus) / (3 * maxHp));
        if (ball.bonus === 255) a = 255; // Master ball logic

        const shakeCheck = () => a >= 255 || Math.floor(Math.random() * 256) < a;

        let shakes = 0;
        for (let i = 0; i < 4; i++) {
            if (shakeCheck()) {
                shakes++;
                await new Promise(res => setTimeout(res, 750)); // Pause for suspense
                if (i < 3) await new Promise(res => startBattleDialogue("...", res));
            } else {
                break;
            }
        }

        if (shakes === 4) {
            // SUCCESS
            const caughtPokemon = opponent;
            await new Promise(res => startBattleDialogue("Gotcha!", res));
            
            addPokemonToParty(caughtPokemon);
            
            await new Promise(res => startBattleDialogue(`${caughtPokemon.name} was caught!`, res));
            
            if (gameState.playerParty.length <= 6) {
                await new Promise(res => startBattleDialogue(`${caughtPokemon.name} was added to your party.`, res));
            } else {
                await new Promise(res => startBattleDialogue(`${caughtPokemon.name} was sent to the PC.`, res));
            }
            endBattle(false, true); 
        } else {
            // FAILURE
            await new Promise(res => startBattleDialogue("Oh no! The creature broke free!", res));
            currentBattle.turn = 'opponent';
            nextBattleTurn();
        }
    }


    function playerChooseAttack() {
        battleText.textContent = `Choose an attack.`; battleGrid.innerHTML = '';
        currentBattle.playerPokemon.attacks.forEach(attack => {
            const button = document.createElement('button');
            button.className = 'p-2 bg-gray-200 hover:bg-yellow-300 border-4 border-gray-400 rounded text-gray-800 text-lg';
            button.textContent = attack.name; button.onclick = () => { currentBattle.chosenAttack = attack; presentQuestion(); }; battleGrid.appendChild(button);
        });
        const backBtn = document.createElement('button');
        backBtn.className = 'p-2 bg-yellow-400 hover:bg-yellow-500 border-4 border-gray-400 rounded text-gray-800 text-lg';
        backBtn.textContent = 'Back'; backBtn.onclick = showMainBattleMenu; battleGrid.appendChild(backBtn);
    }
    
    function presentQuestion() {
        const q = elaQuestions[Math.floor(Math.random() * elaQuestions.length)];
        currentBattle.currentQuestion = q; battleText.textContent = q.q; battleGrid.innerHTML = '';
        [...q.a].sort(() => Math.random() - 0.5).forEach(answer => {
            const btn = document.createElement('button'); btn.className = 'p-2 bg-gray-200 hover:bg-yellow-300 border-4 border-gray-400 rounded text-gray-800 text-lg';
            btn.textContent = answer; btn.onclick = () => handleAnswer(answer); battleGrid.appendChild(btn);
        });
    }
    
    function handleAnswer(answer) {
        let messages = [];
        if (answer === currentBattle.currentQuestion.c) {
            messages.push(`Correct! ${currentBattle.playerPokemon.name} used ${currentBattle.chosenAttack.name}!`);
            if (currentBattle.chosenAttack.power > 0) {
                const dmg = calculateDamage(currentBattle.chosenAttack, currentBattle.playerPokemon, currentBattle.opponentPokemon[currentBattle.currentOpponentIndex]);
                currentBattle.opponentPokemon[currentBattle.currentOpponentIndex].currentHp -= dmg;
                messages.push(`${currentBattle.opponentName}'s ${currentBattle.opponentPokemon[currentBattle.currentOpponentIndex].name} took ${dmg} damage!`);
            }
            const effectMessages = applyAttackEffect(currentBattle.chosenAttack, currentBattle.playerPokemon, currentBattle.opponentPokemon[currentBattle.currentOpponentIndex]);
            messages.push(...effectMessages);
        } else {
            messages.push(`Incorrect! ${currentBattle.playerPokemon.name}'s attack missed...`);
        }
        updateBattleUI(); 
        currentBattle.turn = 'opponent'; 
        startBattleDialogue(messages, nextBattleTurn);
    }

    function calculateDamage(attack, attacker, defender) {
        const attackStat = attacker.attack * (1 + attacker.statMods.attack * 0.25);
        const defenseStat = defender.defense * (1 + defender.statMods.defense * 0.25);
        const baseDamage = attack.power + (attackStat / 2);
        const damage = Math.max(1, Math.floor(baseDamage - (defenseStat / 4)));
        return damage;
    }

    function applyAttackEffect(attack, attacker, target) {
        const effectMessages = [];
        if (attack.effect) {
            const targetPokemon = (attack.effect.target === 'opponent') ? target : attacker;
            const targetName = (attack.effect.target === 'opponent') ? 'The opponent\'s' : 'Your';
            
            if (attack.effect.type === 'stat') {
                const { stat, amount } = attack.effect;
                targetPokemon.statMods[stat] = Math.max(-4, Math.min(4, targetPokemon.statMods[stat] + amount));
                
                if (amount < 0) {
                    effectMessages.push(`${targetName} ${targetPokemon.name}'s ${stat} fell!`);
                } else {
                    effectMessages.push(`${targetName} ${targetPokemon.name}'s ${stat} rose!`);
                }
            }
        }
        return effectMessages;
    }
    
    function updateBattleUI() {
        if (!currentBattle) return;
        const p = currentBattle.playerPokemon;
        const o = currentBattle.opponentPokemon[currentBattle.currentOpponentIndex];
        document.getElementById('player-hp').style.width = `${Math.max(0,(p.currentHp/p.maxHp)*100)}%`;
        document.getElementById('opponent-hp').style.width = `${Math.max(0,(o.currentHp/o.maxHp)*100)}%`;
        document.getElementById('player-name').textContent = `${p.name} Lvl ${p.level}`;
        document.getElementById('opponent-name').textContent = `${currentBattle.opponentName} Lvl ${o.level}`;
        document.getElementById('player-hp-text').textContent = `HP: ${Math.ceil(p.currentHp)}/${p.maxHp}`;
    }

    function updateBattleSprites() {
        if (!currentBattle) return;
        document.getElementById('player-sprite').textContent = sprites[currentBattle.playerPokemon.sprite];
        document.getElementById('opponent-sprite').textContent = sprites[currentBattle.opponentPokemon[currentBattle.currentOpponentIndex].sprite];
    }
    
    async function endBattle(ranAway = false, caught = false) {
        if (!currentBattle && !ranAway) return;
        
        if (ranAway || caught) {
             gameState.inBattle = false;
             battleScene.classList.add('hidden');
             currentBattle = null;
             return;
        }

        const playerWon = currentBattle.playerPokemon.currentHp > 0;
        const oldBattle = currentBattle; 
        currentBattle = null;

        if (!playerWon) {
            await new Promise(res => startBattleDialogue(["You are out of usable creatures!", "You blacked out..."], res));
            gameState.playerParty.forEach(p => p.currentHp = p.maxHp > 0 ? p.maxHp : 1);
            if(gameState.defeatedTrainers.length > 0) {
                changeMap('pokecenter', 4, 4);
            } else {
                changeMap('playerHouse', 4, 4);
            }
        } else {
            const money = oldBattle.trainerId ? trainersDB[oldBattle.trainerId].reward : 15;
            let winMsg = [];
            gameState.money += money; 
            winMsg = [`${oldBattle.opponentName} was defeated!`, `You won $${money}!`];
            
            if(oldBattle.trainerId && !gameState.defeatedTrainers.includes(oldBattle.trainerId)){
                gameState.defeatedTrainers.push(oldBattle.trainerId);
            }

            const xpGained = 50;
            const uniqueParticipantsIndexes = [...new Set(oldBattle.participants)];
            const participantPokemon = uniqueParticipantsIndexes.map(index => gameState.playerParty[index]).filter(p => p.currentHp > 0);
            
            if (participantPokemon.length > 0) {
                winMsg.push(`${participantPokemon.map(p => p.name).join(' and ')} gained ${xpGained} XP!`);
                await new Promise(res => startBattleDialogue(winMsg, res));
                winMsg = [];
            }

            for (const p of participantPokemon) {
                p.xp += xpGained;
                while (p.xp >= p.xpToNextLevel) {
                    p.level++; 
                    p.xp -= p.xpToNextLevel;
                    p.xpToNextLevel = Math.floor(p.xpToNextLevel * 1.5);
                    p.maxHp += 5; p.attack += 2; p.defense += 1; 
                    p.currentHp = p.maxHp;
                    winMsg.push(`${p.name} grew to level ${p.level}!`);
                    
                    const speciesData = pokemonDB[p.species];
                    if (speciesData && speciesData.learnset) {
                        const newMove = speciesData.learnset.find(m => m.level === p.level);
                        if (newMove && p.attacks.length < 4) { 
                            p.attacks.push(attacksDB[newMove.move]); 
                            winMsg.push(`${p.name} learned ${newMove.move}!`); 
                        }
                    }
                }
            }
            if (winMsg.length > 0) await new Promise(res => startBattleDialogue(winMsg, res));
            winMsg = [];

            for (let i = 0; i < gameState.playerParty.length; i++) {
                const p = gameState.playerParty[i];
                if (uniqueParticipantsIndexes.includes(i) && p.currentHp > 0) {
                    const speciesData = pokemonDB[p.species];
                    if (speciesData && speciesData.evolvesAt && p.level >= speciesData.evolvesAt && !p.hasEvolved) {
                        const oldName = p.name;
                        const oldSpecies = p.species;
                        const newSpecies = speciesData.evolvesTo;
                        await new Promise(res => startBattleDialogue([`What? ${oldName} is evolving!`], res));

                        const newPokemon = createPokemon(newSpecies, p.level);
                        newPokemon.xp = p.xp;
                        newPokemon.hasEvolved = true;
                        gameState.playerParty[i] = newPokemon;

                        await new Promise(res => startBattleDialogue([`Congratulations! Your ${oldName} evolved into ${newSpecies}!`], res));
                    }
                }
            }

            if (oldBattle.opponentName === 'Andy' && !gameState.rivalDefeated) {
                gameState.rivalDefeated = true; winMsg.push("Andy: 'Hmph! Lucky shot!'");
            }
             if (oldBattle.opponentName === 'Andy' && gameState.gymBadges.rhyme) {
                gameState.rivalDefeatedPostGym = true;
            }
            if (oldBattle.opponentName.includes('Gym Leader Rhonda') && !gameState.gymBadges.rhyme) {
                gameState.gymBadges.rhyme = true; winMsg.push("You received the Rhyme Badge!");
            }
            if (oldBattle.opponentName.includes('Gym Leader Lex') && !gameState.gymBadges.synonym) {
                gameState.gymBadges.synonym = true; winMsg.push("You received the Synonym Badge!");
            }
            if(winMsg.length > 0) await new Promise(res => startBattleDialogue(winMsg, res));
        }
        gameState.inBattle = false; battleScene.classList.add('hidden');
    }

    function addPokemonToParty(pokemon) {
        if (!gameState.pokedex[pokemon.species]) gameState.pokedex[pokemon.species] = { seen: true, caught: false };
        gameState.pokedex[pokemon.species].caught = true;

        if (gameState.playerParty.length < 6) {
            gameState.playerParty.push(pokemon);
        } else {
            gameState.pokemonBox.push(pokemon);
        }
    }


    function init() {
        if (gameState.hasMetDeathMasheen) {
            const gamerObject = maps.cityHouse3.objects['2,3'];
            gamerObject.sprite = 'graduate';
            gamerObject.interaction = "Tom: 'I'm going to be a principal some day. Gamification rules!'";
        }
        startDialogue([ "You wake up.", "Mom (downstairs): 'Breakfast is ready!'", "(Arrows: Move | Z/Enter: Interact | M: Menu)" ]); 
        gameLoop(); 
    }
    init();
</script>

</body>
</html>

